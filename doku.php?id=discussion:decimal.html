<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>discussion:decimal [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=discussion:decimal&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=discussion" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=discussion:decimal&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=discussion:decimal&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2007-08-01T23:50:11+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=discussion:decimal&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">discussion:decimal</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="discussion:decimal" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="discussion:decimal" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:catchalls.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:catchalls">catchalls</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:classes_as_structural_types_with_branding.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:classes_as_structural_types_with_branding">classes_as_structural_types_with_branding</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:date_and_time.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:date_and_time">date_and_time</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:date_literal_syntax.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:date_literal_syntax">date_literal_syntax</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=discussion:decimal.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:decimal">decimal</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="clear"><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:decimal.html#assorted_issues" class="toc">Assorted Issues</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:decimal.html#note_on_precision" class="toc">Note on precision</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:decimal.html#comments" class="toc">Comments</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:decimal.html#note_on_pragmas" class="toc">Note on pragmas</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:decimal.html#selectable_precision" class="toc">Selectable precision?</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:decimal.html#old_proposal_and_discussion" class="toc">Old proposal and discussion</a></span></li>
</ul>
</div>
</div>

<p>
This is the discussion page for <a href="doku.php%3Fid=proposals:decimal.html" class="wikilink1" title="proposals:decimal" onclick="return svchk()" onkeypress="return svchk()">decimal</a>.
</p>

<a name="assorted_issues"></a><h2>Assorted Issues</h2>
<div class="level2">

<p>
 I&rsquo;ve been working with QA on testing the decimal additions to Tamarin.  Several questions have come up.  There was some discussion within the ActionScript team, but it was agreed that things should be opened up to discussion with a wider audience.  Here are issues in no particular order: 
</p>
<ul>
<li class="level1"><div class="li">  1.  What should typeof(x) return for var x:decimal?  It is currently the case in AS3 that typeof() returns &ldquo;Number&rdquo; for things of type Number, int, and uint.  Lars suggests that typeof() should return Number for things of type decimal as well.</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li">  2.  There is currently a public definition of Infinity to be </div>
</li>
</ul>
<pre class="code"> public const Infinity:Number = 1/0;</pre>

<p>
 There is a declaration in the decimal class of 
</p>
<pre class="code">public const POSITIVE_INFINITY = 1m / 0m;</pre>

<p>
 The two infinities can be losslessly interchanged, but typeof() returns different values (of course if the answer to 1. above is &ldquo;Number&rdquo;, then that problem goes away).
</p>
<ul>
<li class="level1"><div class="li"> 3. What should be the behavior of === when comparing variables of different number types?  Currently in AS3, if a Number (aka double in ES4) has an integral value, it is === to an int or uint with that value.  I could certainly do the same for decimal vs int or uint.  For double vs decimal, there is the problem that the space of representable numeric values has regions of non-overlap.  My current code just says no for an === compare between double and decimal, but if === returns true with integral values it should probably work if the double and decimal are integral.  The == code converts  the double to the closest decimal and compares the result.</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> 4. What about the toString(radix) method on the decimal class?  The internal discussion suggests that it should truncate to an integral value before conversion.</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> 5. It is my understanding that operations like bitand and bitor will convert the decimal to an int before doing the &amp; or |.  Do you folks agree?</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> 6. What does use precision affect?  Consider the following code:</div>
</li>
</ul>
<pre class="code">var x: decimal = 1 / 3m;

{ use precision 5;
  var y: decimal = x;
  trace(y); // writes out 34 3's
  trace(y + 0); // writes out 5 3's
}</pre>

<p>
 In my current implementation, the precision pragma applies to the result of arithmetic operations.  It does not apply to assignments. 
</p>
<ul>
<li class="level1"><div class="li"> 7. I added a number of useful methods to the decimal class.  I understand there is discussion about whether the Math.mumble() functions should be polymorphic, but for now, they are typed to return Number so I duplicated the ones I wanted in the decimal class.</div>
</li>
</ul>
<pre class="code">use precision 5;
var x = decimal.sqrt(2);
trace(x); // prints out 34 digits
trace(x+0); // prints out 5 digits</pre>

<p>
 Again, this behavior is consistent with precision applying to the arithmetic operations.  To make the methods in the decimal class obey the pragma (which are statically scoped) I would have to secretly supply the pragma inforation as an additional parameter.  That doesn&rsquo;t strike me as a good idea.  &mdash; <em><a href="mailto:%26%23x73%3B%26%23x77%3B%26%23x65%3B%26%23x65%3B%26%23x74%3B%26%23x40%3B%26%23x61%3B%26%23x64%3B%26%23x6f%3B%26%23x62%3B%26%23x65%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x73;&#x77;&#x65;&#x65;&#x74;&#x40;&#x61;&#x64;&#x6f;&#x62;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">Dick Sweet</a> 2007/07/24 16:16</em> 
</p>
<ul>
<li class="level1"><div class="li"> 8. IEEE754R specifies minNum and maxNum operations on decimal floating point as follows:  </div>
</li>
</ul>
<pre class="code">minNum(x,y) is the canonical floating-point number x if x &lt; y, y if y &lt; x, 
the canonicalized floatingpoint number if one operand is a floating-point 
number and the other a NaN. Otherwise it is either x or y.

maxNum(x,y) is the canonical floating-point number y if x &lt; y, x if y &lt; x, 
the canonicalized floatingpoint number if one operand is a floating-point 
number and the other a NaN. Otherwise it is either x or y.</pre>

<p>
 on the other hand, Ecma-262 defines min and max for Numbers with the requirement: &ldquo;If any value is NaN, the result is NaN&rdquo;.  My question is should the behavior decimal.min and decimal.max agree with the IEEE spec or model what ES has done with doubles in the past? &mdash; <em><a href="mailto:%26%23x73%3B%26%23x77%3B%26%23x65%3B%26%23x65%3B%26%23x74%3B%26%23x40%3B%26%23x61%3B%26%23x64%3B%26%23x6f%3B%26%23x62%3B%26%23x65%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x73;&#x77;&#x65;&#x65;&#x74;&#x40;&#x61;&#x64;&#x6f;&#x62;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">Dick Sweet</a> 2007/07/25 10:59</em>
</p>

<p>
At <a href="doku.php%3Fid=meetings:minutes_jul_31_2007.html" class="wikilink1" title="meetings:minutes_jul_31_2007" onclick="return svchk()" onkeypress="return svchk()">minutes_jul_31_2007</a> I believe we agreed to stick with ECMA-262 and not IEEE on <code>NaN</code> poisoning the well for <code>Math.min</code> and <code>Math.max</code>.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/08/01 13:46</em>
</p>

<p>
According to Wikipedia, 
</p>
<pre class="code"> In order to support operations such as windowing in which a NaN input 
 should be quietly replaced with one of the end points, min and max are 
 defined to select a number, x, in preference to a quiet NaN:</pre>
<ul>
<li class="level1"><div class="li"> min(x,NaN) = min(NaN,x) = x</div>
</li>
<li class="level2"><div class="li"> max(x,NaN) = max(NaN,x) = x</div>
</li>
</ul>
<pre class="code"> In the current draft, these functions are called minnum and maxnum to 
 indicate their preference for a number over a NaN.</pre>

<p>
 I could see having <code>Math.min</code> and <code>Math.max</code> and <code>Math.minnum</code> and  <code>Math.maxnum</code>, providing both sets of <code>NaN</code> behavior. I doubt that it is worth it. I think <code>minnum</code> looks like a misspelling of <code>minimum</code>.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2d%3B%26%23x69%3B%26%23x6e%3B%26%23x63%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x72;&#x6f;&#x63;&#x6b;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2d;&#x69;&#x6e;&#x63;&#x2e;&#x63;&#x6f;&#x6d;">Douglas Crockford</a> 2007/08/01 16:41</em>
</p>

</div>

<a name="note_on_precision"></a><h2>Note on precision</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> There 64-bit binary fp numbers which don&rsquo;t map to 128-bit decimal numbers:</div>
<ul>
<li class="level2"><div class="li"> Quoting a conversation from <acronym title="Internet Relay Chat">IRC</acronym>:</div>
<ul>
<li class="level3"><div class="li"> <code>&lt;tbrownaw&gt; 2^-n is 10^-n*5^n. So in base10, 2^-n takes ~.699n (log(5)/log(10)) digits to represent precisely</code></div>
</li>
<li class="level3"><div class="li"> <code>&lt;tbrownaw&gt; any 2^-n with n&gt;50 will need more than 34 decimal digits</code></div>
</li>
</ul>
</li>
<li class="level2"><div class="li"> So we likely have to use a decimal which is wider than IEEE754r decimal128.</div>
</li>
</ul>
</li>
</ul>
<hr noshade="noshade" size="1" />

<p>
It&rsquo;s true that to represent a 53-bit binary floating-point (BFP) number exactly you need 53 decimal digits in the decimal floating-point (DFP) number (you get one power of two in each digit).  However, far fewer are needed for a safe reversible conversion (BFP &rarr; DFP &rarr; BFP giving the identical BFP to that which one started with).  It&rsquo;s 17.  
</p>

<p>
Why 17?  Think of the significand as a 53-bit integer.  This can have (simplifying slightly, but erring on the safe side) 2^53 different values.  All we need to do is convert each of those values to a different decimal string (and ensure that converting back gives us the original binary integer).  To do that we need a decimal number that can encode more than 2^53 values.
</p>

<p>
2^53 is 9007199254740992, which has 16 digits.  For various reasons (&rsquo;jitter&rsquo; at the right-hand digit is a way of explaining it) we need one more digit than that, which is 17 digits.
</p>

<p>
For lots more on this, see the &lsquo;Conversions&rsquo; section of links at: <a href="http://www2.hursley.ibm.com/decimal/#links" class="urlextern" target="_blank" title="http://www2.hursley.ibm.com/decimal/#links" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">http://www2.hursley.ibm.com/decimal/#links</a>, especially Steele &amp; White&rsquo;s paper.   As for the exact conversion, see <a href="http://www2.hursley.ibm.com/decimal/decifaq1.html#inexact" class="urlextern" target="_blank" title="http://www2.hursley.ibm.com/decimal/decifaq1.html#inexact" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">http://www2.hursley.ibm.com/decimal/decifaq1.html#inexact</a> item 2 for a couple of examples where you need over 50 digits for the <em>exact</em> conversion of a BFP double.
</p>

<p>
And here&rsquo;s a brief proof-by-example:
</p>

<p>
Consider the binary double which has all ones and an exponent of zero; that is, the binary fraction 1.1111111....  (53 ones in all).  That&rsquo;s 2^0 + 2^-1 + 2^-2 + .... + 2^-52.
</p>

<p>
Now consider the first and last terms of this (no term is smaller than 2^-52, no term is larger than the first, and we know the total will be less than 2.0): 
</p>
<pre class="code">2^0 = 1</pre>
<pre class="code">2^-52 = 0.0000000000000002220446049250313080847263336181640625</pre>

<p>
 The sum of these is: 
</p>
<pre class="code">1.0000000000000002220446049250313080847263336181640625</pre>

<p>
 which has (surprise!) 53 digits.
</p>

<p>
[Mike Cowlishaw]   
</p>
<hr noshade="noshade" size="1" />

<p>
From further correspondence with Mike:
</p>
<pre class="code">
It's safe in the sense that there won't have been mixed BFP/DFP in the 
past, so nothing will break.  There might be a tiny loss of precision (if 
X is 64-bit), but if a computation is about to take place that's unlikely 
to be a big deal, and would only be detectable in the case of aligned 
fractional adds, which would be very rare.  If X is 128-bit I can't see 
any real problem at all. 
</pre>

<p>
I&rsquo;m comfortable considering this an expert recommendation, and simply promoting to decimal128, accepting (and noting for users) that there can be some small loss of precision in the conversion, and if they are deeply concerned they should either: 
</p>
<ul>
<li class="level1"><div class="li"> Avoid using decimal numbers, if you feel the need for the extra precision of binary FP bits.</div>
</li>
<li class="level1"><div class="li"> Start with decimal numbers, rather than convert from doubles.</div>
</li>
</ul>

<p>
  &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/05/19 14:05</em>
</p>

</div>

<a name="comments"></a><h1>Comments</h1>
<div class="level1">

</div>

<a name="note_on_pragmas"></a><h2>Note on pragmas</h2>
<div class="level2">

<p>
 At the risk of introducing complexity where it&rsquo;s not needed, might it be good to decouple &ldquo;use decimal&rdquo; from specifying the rounding?  Consider a program:
</p>
<pre class="code javascript">   <span class="kw2">var</span> x : Array&lt;decimal&gt; = f<span class="br0">&#40;</span><span class="br0">&#41;</span>;
   <span class="kw2">var</span> y : decimal = <span class="nu0">0</span>.0m;
   <span class="kw1">for</span> <span class="br0">&#40;</span> let i : int = <span class="nu0">0</span> ; i &lt; f.<span class="me1">length</span> / <span class="nu0">2</span> ; i++ <span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw2">use</span> decimal<span class="br0">&#40;</span>ROUND_UP<span class="br0">&#41;</span>;
      y += x<span class="br0">&#91;</span>i*<span class="nu0">2</span><span class="br0">&#93;</span>;
   <span class="br0">&#125;</span></pre>
<p>
By the rules of the current proposal the computation <code>i*2</code> in the loop body must be done using decimal if I am not mistaken, but the intention of the pragma is just to handle the rounding in the sum of the elements of <code>x</code>.
</p>

<p>
I would propose that we introduce pragmas along the line of <code>use rounding up</code> instead of piggybacking directly on <code>use decimal</code>.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/04/10 00:51</em>
</p>

<p>
Agreed, though I&rsquo;m not sure all the rounding modes are implemented in most binary fp hardware. I guess we can select a subset.
</p>

<p>
(Yes, BFP uses just 4 of the modes.  Decimal needs at leasat 1 more (as added in the IEEE 754r draft), although Java and other implementations (including our forthcoming hardware) supply all 7 modes. [mfc])
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/04/10 11:37</em>
</p>

<p>
Corrected.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/04/13 17:25</em>
</p>

</div>

<a name="selectable_precision"></a><h2>Selectable precision?</h2>
<div class="level2">

<p>
 Mike Cowlishaw&rsquo;s spec explains that <em>precision</em> is part of the user-modifiable arithmetic context (just like rounding).  A few places in the same writeup there is the vague implication that the changing the precision is a useful technique and perhaps even that users will expect such a facility to be available. 
</p>
<ul>
<li class="level1"><div class="li"> Do we want to support user-selectable precision?  (<code>use precision 9</code>)</div>
</li>
<li class="level1"><div class="li"> Are hardware implementations of decimal arithmetic expected to support selectable precision?</div>
</li>
</ul>

<p>
  &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/05/12 04:26</em>
</p>

<p>
 I&rsquo;m not sure how crucial it is; I imagine most real world (legal) precision requirements are met by the quad-or-larger decimal types we&rsquo;re discussing here, but if it&rsquo;s a general package we&rsquo;re using (eg. the decNumber type) then I also don&rsquo;t see a problem with letting the user pick their precision. So long as the default is big enough to keep the bug reports down; It seems very unlikely the user will care about speed, at least in web content.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/05/12 15:55</em>
</p>

<p>
It&rsquo;s not just about getting more precision, but about getting less.  Sometimes you don&rsquo;t want to keep more precision in the numbers than you know you have in the input.
</p>

<p>
(I am probably opposed to including arbitrary-precision Decimal in ECMAScript.  Even 256-bit seems excessive <acronym title="In my opinion">IMO</acronym>.)
</p>

<p>
&ndash;lars
</p>

<p>
Would you want less precision in the numbers due to wanting to use fewer computer resources? Or is there an arithmetical rationale?
</p>

<p>
I agree that 256-bit is probably absurdly large. But I don&rsquo;t quite know what to make of Mike&rsquo;s comments above wrt. conversion. The point of coercing a BFP up to a DFP is not just to convert it <em>back</em>; the point is to produce a DFP number which denotes the same number as your BFP, such that it can participate in arithmetic operations with other DFP numbers.
</p>

<p>
As far as I can tell, we only have two options: 
</p>
<ol>
<li class="level1"><div class="li"> Use a DFP form which supports at least 53 digits, to preserve all BFPs on promotion</div>
</li>
<li class="level1"><div class="li"> Accept that some BFPs will be lost on promotion</div>
<ul>
<li class="level2"><div class="li"> Possibly introduce an exception type to handle this</div>
</li>
<li class="level2"><div class="li"> Possibly tell the user to live with it</div>
</li>
<li class="level2"><div class="li"> Possibly something else?</div>
</li>
</ul>
</li>
</ol>

<p>
  &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/05/16 12:08</em>
</p>

<p>
Computational resources is a big deal for me.  This has several aspects.  For a SW implementation I would like to support a format that is useful to many users without wasting precious resources (memory, CPU) on smaller systems.  But I would also like us to choose a format that stands a chance of seeing a hardware implementation if DFP becomes popular (as I believe it ought to become, now that I&rsquo;ve read some about it).  My gut feeling, and I hope others will feel free to correct me on this as appropriate, is that I doubt arbitrary-precision DFP will be directly supported in hardware, and though I am more uncertain about 256-bit DFP, that sounds like a rather large datum to support directly in hardware too.
</p>
<pre class="code"></pre>

<p>
128-bit DFP seems like a decent compromise.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/05/20 06:23</em>
</p>

<p>
We (IBM) will definitely be directly supporting 128-bit DFP in hardware (see, for example [<a href="http://news.zdnet.com/2100-9584_22-6124451.html" class="urlextern" target="_blank" title="http://news.zdnet.com/2100-9584_22-6124451.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">http://news.zdnet.com/2100-9584_22-6124451.html</a>]).  I agree that 256-bit is unlikely (in fact the IEEE 754r draft does not even define such a format).  &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/05/29 23:47</em>
</p>

<p>
One question on the <em>decimal_precision N</em> pragma:  the proposal currently allows N to be &lsquo;any positive integer between 0 and 34.  This should read 1 through 34?  Also I&rsquo;d recommend adding some sort of &lsquo;health warning&rsquo; along the following lines:
</p>

<p>
*Note that small values of <em>N</em> (for example, values less than 6) are generally only useful for very specialized applications.  The setting of <em>N</em> affects all decimal computations, so even the operation of loops may be affected by rounding if small values are used.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/10/18 02:53</em>
</p>

</div>

<a name="old_proposal_and_discussion"></a><h1>Old proposal and discussion</h1>
<div class="level1">

<p>
 This proposal involves providing a number type which performs arithmetic in decimal floating point, not binary.
</p>

<p>
It has the following components: 
</p>
<ul>
<li class="level1"><div class="li"> A decimal floating point type, disjoint from the double type.</div>
</li>
<li class="level1"><div class="li"> Possibly addition of some form of pragma to switch the interpretation of &ldquo;unadorned&rdquo; number literals for the current compilation unit, package, class, file, or similar entity.</div>
</li>
<li class="level1"><div class="li"> Possibly lexemes for specifically decimal literals (or make them the default and simply add a function to convert decimal&rarr;binary when you want it)</div>
</li>
<li class="level1"><div class="li"> Rules governing the interaction of decimal with the other number types. Since all binary fp numbers can be accurately represented (possibly inefficiently) as decimal fp numbers, we assume &ldquo;promote to decimal&rdquo; will be the guideline. </div>
</li>
</ul>
<hr noshade="noshade" size="1" />

<p>
Some conclusions from discussion: 
</p>
<ul>
<li class="level1"><div class="li"> a literal for decimal numbers</div>
</li>
<li class="level1"><div class="li"> no pragma for operators</div>
</li>
<li class="level1"><div class="li"> automatic conversion from integer and double values to decimal when used in expressions with a decimal</div>
</li>
<li class="level1"><div class="li"> implicit conversion on assignment among all number types (current behavior in AS3)</div>
</li>
<li class="level1"><div class="li"> user-defined cast operators to force a certain representation</div>
</li>
</ul>

<p>
  &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/03/16 17:37</em>
</p>

<p>
C# uses a suffix &lsquo;m&rsquo; for decimal literals, they otherwise follow the floating-point syntax.  Is there any good reason not to follow C#?  
</p>

<p>
C# reference for decimal is <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/csspec/html/vclrfcsharpspec_4_1.asp" class="urlextern" target="_blank" title="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/csspec/html/vclrfcsharpspec_4_1.asp" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">here</a> (click on the link &ldquo;The decimal type&rdquo;).
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/03/17 10:43</em>
</p>

<p>
The decimal format used by C# is described at <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemdecimalclasstopic.asp" class="urlextern" target="_blank" title="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemdecimalclasstopic.asp" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">here</a>
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x72%3B%26%23x6f%3B%26%23x6b%3B%26%23x79%3B%26%23x75%3B%26%23x40%3B%26%23x6d%3B%26%23x69%3B%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x73%3B%26%23x6f%3B%26%23x66%3B%26%23x74%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x72;&#x6f;&#x6b;&#x79;&#x75;&#x40;&#x6d;&#x69;&#x63;&#x72;&#x6f;&#x73;&#x6f;&#x66;&#x74;&#x2e;&#x63;&#x6f;&#x6d;">Rok Yu</a> 2006/03/17 14:20</em>
</p>

<p>
Cameron Purdy again, very funny: <a href="http://jroller.com/page/cpurdy?entry=the_seven_habits_of_highly1" class="urlextern" target="_blank" title="http://jroller.com/page/cpurdy?entry=the_seven_habits_of_highly1" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">In your face! BigDecimal, BigInteger and BigMistake</a>.  See the <a href="http://jroller.com/page/cpurdy?entry=the_seven_habits_of_highly1&amp;popup=true#comments" class="urlextern" target="_blank" title="http://jroller.com/page/cpurdy?entry=the_seven_habits_of_highly1&amp;popup=true#comments" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">comments</a> for the punchline.
</p>

<p>
From the C# example, an initializer for a <code>decimal</code>-typed variable need not use the <code>m</code> suffix.  Does any Edition 4 prototype interpret literal initializer according to its initialized variable&rsquo;s type annotation?
</p>

<p>
More real-world motivation for decimal <a href="http://www.mikeindustries.com/blog/archive/2004/08/apple-calculator" class="urlextern" target="_blank" title="http://www.mikeindustries.com/blog/archive/2004/08/apple-calculator" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">here</a> (not that we need more!).
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2006/03/17 22:49</em>
</p>

<p>
A couple of comments on the above:
</p>

<p>
C# literals: Unfortunately, Cameron&rsquo;s C# example is not valid.  If you try and compile it, you get several messages of the form: 
</p>
<pre class="code">tryJRoller.cs(12,20): error CS0664: Literal of type double cannot be implicitly
  converted to type 'decimal'; use an 'M' suffix to create a literal of
  this type</pre>

<p>
 The <acronym title="International Organization for Standardization">ISO</acronym> C committee decided that an &lsquo;m&rsquo; suffix or equivalent is too clumsy (though they do define and allow such suffixes); they invented a &lsquo;translation time data type&rsquo; &ndash; see the <a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1154.pdf" class="urlextern" target="_blank" title="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1154.pdf" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">N1154 Technical Report draft</a> section 7.1 (p16 of the <acronym title="Portable Document Format">PDF</acronym>).
</p>

<p>
On real-world motivation: Professor Kahan also showed some of the problems that Excel has in this area at <a href="http://arith17.polito.it/" class="urlextern" target="_blank" title="http://arith17.polito.it/" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Arith 17</a> last year. See <a href="http://www.cs.berkeley.edu/~wkahan/ARITH_17.pdf" class="urlextern" target="_blank" title="http://www.cs.berkeley.edu/~wkahan/ARITH_17.pdf" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">his invited paper</a>, starting at p7.  
</p>

<p>
For other decimal issues and lots of links, <em>etc.</em>, see <a href="http://www2.hursley.ibm.com/decimal/" class="urlextern" target="_blank" title="http://www2.hursley.ibm.com/decimal/" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">my web page</a>, and in particular the <a href="http://www2.hursley.ibm.com/decimal/decifaq.html" class="urlextern" target="_blank" title="http://www2.hursley.ibm.com/decimal/decifaq.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">FAQ</a>.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/03/20 01:43</em> 
</p>

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        discussion/decimal.txt &middot; Last modified: 2007/08/01 23:50 by crock      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="discussion:decimal" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="discussion:decimal" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="discussion:decimal" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="discussion:decimal" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=discussion:decimal.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=discussion%253Adecimal&amp;1454275581" width="1" height="1" alt=""  /></body>
</html>
