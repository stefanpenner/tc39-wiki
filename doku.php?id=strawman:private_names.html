<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>strawman:private_names [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=strawman:private_names&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=strawman" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=strawman:private_names&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=strawman:private_names&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2011-05-18T01:49:15+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=strawman:private_names&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">strawman:private_names</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="strawman:private_names" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:private_names" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:gc_semantics.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:gc_semantics">gc_semantics</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:weak_references.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:weak_references">weak_references</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:weak_refs.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:weak_refs">weak_refs</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:inherited_explicit_soft_fields.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:inherited_explicit_soft_fields">inherited_explicit_soft_fields</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=strawman:private_names.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:private_names">private_names</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#private_namesunique_unforgable_property_names" class="toc">Private Names: Unique Unforgable Property Names</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#private_name_values" class="toc">Private Name values</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#the_private_declaration" class="toc">The private declaration</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#using_private_identifiers" class="toc">Using Private Identifiers</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#private_identifiers_in_object_literals" class="toc">Private Identifiers in Object Literals</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#private_declaration_scoping" class="toc">Private Declaration Scoping</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#private_declarations_exist_in_a_separate_name_space_parallel_to_the_variable_binding_environment" class="toc">Private Declarations Exist in a Separate &quot;Name Space&quot; Parallel to the Variable Binding Environment</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#accessing_private_names_as_values" class="toc">Accessing Private Names as Values</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#conflict-free_object_extension_using_private_names" class="toc">Conflict-Free Object Extension Using Private Names</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#enumeration_and_reflection" class="toc">Enumeration and Reflection</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#private_name_properties_provide_a_weak_but_usful_form_of_information_hiding" class="toc">Private Name Properties Provide a Weak But Usful Form of Information Hiding</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#interactions_with_other_harmony_proposals" class="toc">Interactions with other Harmony Proposals</a></span><ul class="toc">
<li class="clear"><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#enhanced_object_literals" class="toc">Enhanced Object Literals</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#proxies" class="toc">Proxies</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#modules" class="toc">Modules</a></span></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#references" class="toc">References</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#discussion" class="toc">Discussion</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:private_names.html#scratch_pad" class="toc">Scratch Pad</a></span></li>
</ul>
</div>
</div>

<a name="private_namesunique_unforgable_property_names"></a><h1>Private Names: Unique Unforgable Property Names</h1>
<div class="level1">

<p>
 Updated  &mdash; <em><a href="mailto:%26%23x41%3B%26%23x6c%3B%26%23x6c%3B%26%23x65%3B%26%23x6e%3B%26%23x40%3B%26%23x57%3B%26%23x69%3B%26%23x72%3B%26%23x66%3B%26%23x73%3B%26%23x2d%3B%26%23x42%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x41;&#x6c;&#x6c;&#x65;&#x6e;&#x40;&#x57;&#x69;&#x72;&#x66;&#x73;&#x2d;&#x42;&#x72;&#x6f;&#x63;&#x6b;&#x2e;&#x63;&#x6f;&#x6d;">Allen Wirfs-Brock</a> 2011/03/10 00:39</em> <em>2010/12/08 15:16</em> <br/>
  <em>Revised proposal by Allen Wirfs-Brock<br/>

Original proposal by Dave Herman and Sam Tobin-Hochstadt is <a href="doku.php%3Fid=strawman:names.html" class="wikilink1" title="strawman:names" onclick="return svchk()" onkeypress="return svchk()">here</a>.</em>
</p>

<p>
In existing ECMAScript, property names are just strings. It is not possible to create unique, unforgable property names that are only known to a limited or controlled set of property accessors. It is possible to create non-enumerable properties, but they can still be discovered by guessing their string-valued property name. The <a href="doku.php%3Fid=proposals:proposals.html" class="urlextern" target="_blank" title="http://wiki.ecmascript.org/doku.php?id=proposals:proposals" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">proposed es4</a> facility for addressing this shortcoming was namespaces, which were complex and suffered from ambiguity and efficiency problems.
</p>

<p>
This strawman proposes three related changes to support unique, unforgable property names. 
</p>
<ol>
<li class="level1"><div class="li"> a new, ECMAScript language type (or possibly object <code>[Class]</code>) <em>Private Name</em></div>
</li>
<li class="level1"><div class="li"> generalizing the ES5 <em>property name</em> concept to include either a string (as in ES5) or a <em>Private Name</em> value</div>
</li>
<li class="level1"><div class="li"> a <code>private</code> keyword for automatic use of <em>Private Name</em> values instead of strings in syntactic contexts in a lexically scoped fashion.</div>
</li>
</ol>

<p>
 In addition to supporting various information hiding scenarios, this also allows properties to be added to existing objects without the possibility of interference with the existing properties, or with other uncoordinated additions by any other code.
</p>

</div>

<a name="private_name_values"></a><h1>Private Name values</h1>
<div class="level1">

<p>
 <code>Private Name</code> is a new ECMAScript language type that will be defined in section 8 of the specification. The <code>Private Name</code> type is an open set of  distinct <code>Private Name</code> values that can be used as the names of object properties.  <code>Private Name</code> values do not have any corresponding literal representation within ECMAScript code. Distinct <code>Private Name</code> values are created by the <code>CreatePrivateName</code> abstract operation. Each call to <code>CreatePrivateName</code> returns a new distinct <code>Private Name</code> value. If <code>x</code> and <code>y</code> are <code>Private Name</code> values then the abstract operation <code>SameValue(x,y)</code> returns true if and only <code>x</code> and <code>y</code> are the same <code>Private Name</code> value created by a single specific call to <code>CreatePrivateName</code>.
</p>

<p>
A <code>Private Name</code> value can be used as the value of the <code>P</code> argument to any of the object internal methods defined in section 8.12 of the ECMAScript specification.
</p>
<table class="inline">
	<tr>
		<td><sup><img src="lib/images/smileys/icon_exclaim.gif" align="middle" alt=":!:" /></sup>If a new ECMAScript type is added then the <code>typeof</code> operator will also need to be extended to return a new string value that identifies values of that type. Concerns have been expressed that extending <code>typeof</code> in this manner could break existing code that expects to deal with a fixed set of <code>typeof</code> values. We need to make a global decision about adding new non-object types and the impact upon <code>typeof</code>.</td>
	</tr>
	<tr>
		<td><sup><img src="lib/images/smileys/icon_exclaim.gif" align="middle" alt=":!:" /></sup>Object values could be used as an alternative to defining a new ECMAScript type to represent <code>Private Name</code> values. Each <code>Private Name</code> would simply be a distinct object.  <code>Private Name</code> objects would have a distinct <code>[Class]</code> value. To avoid such objects being used for back-channel communication or property garbage dumps they should be created frozen.  Conceivably they could all have <code>null</code> as their prototype.  This may have some benefit if such names are passed between global contexts as it would prevent use of their prototype value as means of identifying their origin context. Throughout the rest of this spec. &ldquo;private name value&rdquo; should be read as meaning whichever form is ultimately used. </td>
	</tr>
</table>
<br />

</div>

<a name="the_private_declaration"></a><h1>The private declaration</h1>
<div class="level1">

<p>
 The <code>private</code> declaration creates a new <code>Private Name</code> value by calling <code>CreatePrivateName</code> and binds that value to a program identifier that may be used in specific syntactic contexts within the lexical scope of the declaration. An identifier that appears in a <code>private</code> declaration is call a <code>private identifier</code>.
</p>
<pre class="code javascript"><span class="kw2">private</span> unique;  <span class="co1">//create a new ''Private Name'' that is bound to the private identifier ''unique''.</span>
<span class="kw2">private</span> _x,_y;   <span class="co1">//create two ''Private Name'' values bound to two private identifiers</span></pre><table class="inline">
	<tr>
		<td><sup><img src="lib/images/smileys/icon_question.gif" align="middle" alt=":?:" /></sup> Can the names defined in a <code>private</code> declaration be any <em>IdentifierName</em> or should they be restricted to being an <em>Identifier</em> (ie, not a reserved name)? ES5 allows any <em>IdentifierName</em> to be used after a dot or as a property name in an object literal so it may be reasonable to allow any <em>IdetnifierName</em>. However that will permit strange look formulations such as: <code>private private;</code></td>
	</tr>
</table>
<br />

</div>

<a name="using_private_identifiers"></a><h1>Using Private Identifiers</h1>
<div class="level1">

<p>
 When a private identifier appears as the <em>IdentifierName</em> of a <em>CallExpression</em> : <em>CallExpression</em> . <em>IdentifierName</em> production or of a <em>CallExpression</em> : <em>CallExpression</em> . <em>IdentifierName</em> production, the <code>Private Name</code> value that is bound to the private identifier is used as the value of the <em>IdentifierName</em>. If the identifier in one of these productions is not a private identifier then the identifier name string is used as the value of <em>IdentifierName</em>, just as in ECMAScript 5.
</p>

<p>
This permits object properties to be created whose names are <code>Private Name</code> values. It also allows  for the values of such properties to be accessed.
</p>
<pre class="code javascript"><span class="kw2">function</span> makeObj<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="kw2">private</span> unique;
   <span class="kw2">var</span> obj = <span class="br0">&#123;</span><span class="br0">&#125;</span>;
   obj.<span class="me1">unique</span> = <span class="nu0">42</span>;  <span class="co1">//obj has a single property whose name is a Private Name value</span>
   <span class="kw3">print</span><span class="br0">&#40;</span>obj.<span class="me1">unique</span><span class="br0">&#41;</span>;<span class="co1">//42 -- the private identifier can be used in scope to access the property's value</span>
   <span class="kw3">print</span><span class="br0">&#40;</span>obj<span class="br0">&#91;</span><span class="st0">"unique"</span><span class="br0">&#93;</span><span class="br0">&#41;</span>; <span class="co1">//undefined -- the name of the property is not the string &quot;unique&quot;</span>
   <span class="kw1">return</span> obj;
<span class="br0">&#125;</span>
<span class="kw2">var</span> obj=makeObj<span class="br0">&#40;</span><span class="br0">&#41;</span>;
<span class="kw3">print</span><span class="br0">&#40;</span>obj<span class="br0">&#91;</span><span class="st0">"unique"</span><span class="br0">&#93;</span><span class="br0">&#41;</span>; <span class="co1">//undefined -- the name of the property is still not the string &quot;unique&quot;</span>
<span class="kw3">print</span><span class="br0">&#40;</span>obj.<span class="me1">unique</span><span class="br0">&#41;</span>;    <span class="co1">//undefined -- this statement is not in the scope of the private declaration so the</span>
                      <span class="co1">//string value &quot;unique&quot; is used to look up the property.  It does not match the Private Name value</span></pre>
<p>
This technique can be used to define &ldquo;instances-only&rdquo; visibility for properties.  Each instance uses a unique property name and only code that is associated with the instance knows the unique name:
</p>
<pre class="code javascript"><span class="kw2">function</span> Thing<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">private</span> key;   <span class="co1">// each invocation will use a new unique private key value</span>
    <span class="kw1">this</span>.<span class="me1">key</span> = <span class="st0">"instance private value"</span>;
    <span class="kw1">this</span>.<span class="me1">hasKey</span> = <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> x.<span class="me1">key</span> === <span class="kw1">this</span>.<span class="me1">key</span>;  <span class="co1">//x.key should be undefined if x!==this</span>
    <span class="br0">&#125;</span>;
    <span class="kw1">this</span>.<span class="me1">getThingKey</span> = <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> x.<span class="me1">key</span>;
    <span class="br0">&#125;</span>;
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">var</span> thing1 = <span class="kw2">new</span> Thing;
<span class="kw2">var</span> thing2 = <span class="kw2">new</span> Thing;
&nbsp;
<span class="kw3">print</span><span class="br0">&#40;</span><span class="st0">"key"</span> <span class="kw1">in</span> thing1<span class="br0">&#41;</span>;       <span class="co1">// false</span>
<span class="kw3">print</span><span class="br0">&#40;</span>thing2.<span class="me1">key</span><span class="br0">&#41;</span>;            <span class="co1">//undefined</span>
<span class="kw3">print</span><span class="br0">&#40;</span>thing1.<span class="me1">hasKey</span><span class="br0">&#40;</span>thing1<span class="br0">&#41;</span><span class="br0">&#41;</span>; <span class="co1">// true</span>
<span class="kw3">print</span><span class="br0">&#40;</span>thing1.<span class="me1">hasKey</span><span class="br0">&#40;</span>thing2<span class="br0">&#41;</span><span class="br0">&#41;</span>; <span class="co1">// false</span></pre>
<p>
By changing the scope of the private declaration a similar technique can be used to define &ldquo;class-only&rdquo; visibility properties.  Each instance uses the same unique property key and knowledge of the key is shared by the all the instances so they can mutually access each others private named properties:
</p>
<pre class="code javascript"><span class="kw2">private</span> key;  <span class="co1">//the same private name value is used by every invocation of Thing</span>
<span class="kw2">function</span> Thing<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">this</span>.<span class="me1">key</span> = <span class="st0">"class private value"</span>;
    <span class="kw1">this</span>.<span class="me1">hasKey</span> = <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> x.<span class="me1">key</span> === <span class="kw1">this</span>.<span class="me1">key</span>;
    <span class="br0">&#125;</span>;
    <span class="kw1">this</span>.<span class="me1">getThingKey</span> = <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> x.<span class="me1">key</span>;
    <span class="br0">&#125;</span>;
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">var</span> thing1 = <span class="kw2">new</span> Thing;
<span class="kw2">var</span> thing2 = <span class="kw2">new</span> Thing;
&nbsp;
<span class="kw3">print</span><span class="br0">&#40;</span><span class="st0">"key"</span> <span class="kw1">in</span> thing1<span class="br0">&#41;</span>;       <span class="co1">// false</span>
<span class="kw3">print</span><span class="br0">&#40;</span>thing1.<span class="me1">hasKey</span><span class="br0">&#40;</span>thing1<span class="br0">&#41;</span><span class="br0">&#41;</span>; <span class="co1">// true</span>
<span class="kw3">print</span><span class="br0">&#40;</span>thing1.<span class="me1">hasKey</span><span class="br0">&#40;</span>thing2<span class="br0">&#41;</span><span class="br0">&#41;</span>; <span class="co1">// true</span></pre>
<p>
Friend visibility similar to that provided by c++ can be obtained by using private declarations that are visible to several related object literals, object constructors or factory functions enclosed in an outer function and returned from it (directly, or stored as effects in objects).
</p>

</div>

<a name="private_identifiers_in_object_literals"></a><h1>Private Identifiers in Object Literals</h1>
<div class="level1">

<p>
 A private identifier may also appear as the <em>IdentifierName</em> of a <em>PropertyName</em> production in an <em>ObjectLiteral</em>. If the identifier in such a productions is not a private identifier then the identifier name string is used as the value of <em>IdentifierName</em>, just as in ECMAScript 5.
</p>

<p>
With this feature, object literals can be used as an alternative expression of the previous three examples: 
</p>
<pre class="code javascript"><span class="kw2">function</span> makeObj<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="kw2">private</span> unique;
   <span class="kw2">var</span> obj = <span class="br0">&#123;</span>unique: <span class="nu0">42</span><span class="br0">&#125;</span>;
   <span class="kw3">print</span><span class="br0">&#40;</span>obj.<span class="me1">unique</span><span class="br0">&#41;</span>;<span class="co1">//42 -- the private identifier can be used in scope to access the property's value</span>
   <span class="kw3">print</span><span class="br0">&#40;</span>obj<span class="br0">&#91;</span><span class="st0">"unique"</span><span class="br0">&#93;</span><span class="br0">&#41;</span>; <span class="co1">//undefined -- the name of the property is not the string &quot;unique&quot;</span>
   <span class="kw1">return</span> obj;
<span class="br0">&#125;</span></pre><pre class="code javascript"><span class="kw2">function</span> Thing<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">private</span> key;
    <span class="kw1">return</span> <span class="br0">&#123;</span>
       key : <span class="st0">"instance private value"</span>,
       hasKey : <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span>
          <span class="kw1">return</span> x.<span class="me1">key</span> === <span class="kw1">this</span>.<span class="me1">key</span>;  <span class="co1">//x.key should be undefined if x!==this</span>
       <span class="br0">&#125;</span>,
       getThingKey : <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span>
          <span class="kw1">return</span> x.<span class="me1">key</span>;
       <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>;
<span class="br0">&#125;</span></pre><pre class="code javascript"><span class="kw2">private</span> key;
<span class="kw2">function</span> Thing<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">return</span> <span class="br0">&#123;</span>
       key : <span class="st0">"class private value"</span>,
       hasKey : <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span>
          <span class="kw1">return</span> x.<span class="me1">key</span> === <span class="kw1">this</span>.<span class="me1">key</span>;  <span class="co1">//x.key should be undefined if x!==this</span>
       <span class="br0">&#125;</span>,
       getThingKey : <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span>
          <span class="kw1">return</span> x.<span class="me1">key</span>;
       <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>;
<span class="br0">&#125;</span></pre>
</div>

<a name="private_declaration_scoping"></a><h1>Private Declaration Scoping</h1>
<div class="level1">

<p>
 <code>private</code> declarations are lexically scoped, like all declarations in Harmony. Inner <code>private</code> declarations shadow access to like-named <code>private</code> declarations in outer scopes.  Within a block, the scoping rules for <code>private</code> declarations are the same as for <code>const</code> declarations.
</p>
<pre class="code javascript"><span class="kw2">function</span> outer<span class="br0">&#40;</span>obj<span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="kw2">private</span> <span class="kw3">name</span>;
   <span class="kw2">function</span> inner<span class="br0">&#40;</span>obj<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw2">private</span> <span class="kw3">name</span>;
      obj.<span class="kw3">name</span> = <span class="st0">"inner name"</span>;
      <span class="kw3">print</span><span class="br0">&#40;</span>obj.<span class="kw3">name</span><span class="br0">&#41;</span>;   <span class="co1">//&quot;inner name&quot; because outer name declaration is shadowed</span>
   <span class="br0">&#125;</span>
   obj.<span class="kw3">name</span> = <span class="st0">"outer name"</span>;
   inner<span class="br0">&#40;</span>obj<span class="br0">&#41;</span>
   <span class="kw3">print</span><span class="br0">&#40;</span>obj.<span class="kw3">name</span><span class="br0">&#41;</span>;      <span class="co1">//&quot;outer name&quot;</span>
<span class="br0">&#125;</span>
<span class="kw2">var</span> obj = <span class="br0">&#123;</span><span class="br0">&#125;</span>;
obj.<span class="kw3">name</span> = <span class="st0">"public name"</span>;
outer<span class="br0">&#40;</span>obj<span class="br0">&#41;</span>;
<span class="kw3">print</span><span class="br0">&#40;</span>obj.<span class="kw3">name</span><span class="br0">&#41;</span>;            <span class="co1">//&quot;public name&quot;</span></pre>
<p>
After executing the above code, the object that was created will have three own properties:
</p>
<table class="inline">
	<tr>
		<th>Property Name </th><th> Property Value </th>
	</tr>
	<tr>
		<td>&ldquo;name&rdquo;</td><td>&ldquo;public name&rdquo;</td>
	</tr>
	<tr>
		<td>private name<sub>outer</sub></td><td>&ldquo;outer name&rdquo;</td>
	</tr>
	<tr>
		<td>private name<sub>inner</sub></td><td>&ldquo;inner name&rdquo;</td>
	</tr>
</table>
<br />

<p>
 However, the above is not a very realistic example. After execution of the above code, the two private named properties could not be directly accessed because the private identifier bindings that contain their property names are no longer accessible.  More typically a private identifier binding will be shared by several functions (methods) that need to have shared access to a private named property.
</p>

</div>

<a name="private_declarations_exist_in_a_separate_name_space_parallel_to_the_variable_binding_environment"></a><h1>Private Declarations Exist in a Separate &quot;Name Space&quot; Parallel to the Variable Binding Environment</h1>
<div class="level1">

<p>
 Consider the following very common idiom used in a constructor declaration: 
</p>
<pre class="code javascript"><span class="kw2">function</span> Point<span class="br0">&#40;</span>x,y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="kw1">this</span>.<span class="me1">x</span> = x;
   <span class="kw1">this</span>.<span class="me1">y</span> = y;
   <span class="co1">//... methods that use x and y properties</span>
<span class="br0">&#125;</span>
<span class="kw2">var</span> pt = <span class="kw2">new</span> Point<span class="br0">&#40;</span><span class="nu0">1</span>,<span class="nu0">2</span><span class="br0">&#41;</span>;</pre>
<p>
The identifiers <code>x</code> and <code>y</code> each have two distinct bindings within the scope of function <code>Point</code>.  On the right-hand side of the two assignment operators, <code>x</code> and <code>y</code> are identifier references (ES5 11.1.2) that bind to the formal parameter declarations for <code>Point</code>.  Accessing them produces the values <code>1</code> and <code>2</code>.  However, on the right-hand side of <code>.</code> within the left-hand sides of those assignment expressions, <code>x</code> and <code>y</code> are used as <em>IdentifierNames</em> in Property Accessors (ES5 11.2.1) and bind to the constant string values <code>&ldquo;x&rdquo;</code> and <code>&ldquo;y&rdquo;</code>.
</p>

<p>
One way to view this is that there are two distinct naming environments in ES5 programs: one used to resolve identifiers as <em>PrimaryExpressions</em> and the other used to resolve identifiers as <em>PropertyAccessors</em>.  The environemnt of expressions has nested scoping contours corresponding to the local declaration of nested functions.  However, in ES5 the environment for resolving <em>PropertyAccessor</em> identifiers is not particularly interesting because it is just a single  global contour that implicitly binds all identifiers to the string value that is the <em>IdentifierName</em> of the identifier. 
</p>

<p>
When a private declaration is added to the above example, we need to preserve the same basic semantics that we have in ES5.
</p>
<pre class="code javascript"><span class="kw2">function</span> Point<span class="br0">&#40;</span>x,y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="kw2">private</span> x, y;
   <span class="kw1">this</span>.<span class="me1">x</span> = x;
   <span class="kw1">this</span>.<span class="me1">y</span> = y;
   <span class="co1">//... methods that use private x and y properties</span>
<span class="br0">&#125;</span>
<span class="kw2">var</span> pt = <span class="kw2">new</span> Point<span class="br0">&#40;</span><span class="nu0">1</span>,<span class="nu0">2</span><span class="br0">&#41;</span>;</pre>
<p>
On the right-hand side of the assignments <code>x</code> and <code>y</code> still need to refer to the formal parameter bindings, even though there is a local declaration for private names <code>x</code> and <code>y</code>.  Similarly, on the left-hand side <em>PropertyAccessors</em>, <code>x</code> and <code>y</code> should bind to the private names introduced by the <code>private</code> declaration and not bind to the formal parameters.
</p>

<p>
As with ES5 this can be explained by using distinct naming environments for <em>PrimaryExpressions</em> vs. <em>PropertyAccessors</em>.  However, the property name environment is no longer a flat set of identifier bindings.  Instead it is a lexically scoped hierarchy of bindings that map from identifiers either to string values or to private name values. The hierarchical structure exactly parallels the <em>PrimaryExpression</em> environment hierarchy.
</p>

<p>
Another way to view this is that each EnvironmentRecord (ES5 10.2.1) has a second set of bindings that are used to map identifiers to property names. <code>private</code> declarations create such bindings in the current environment.  Syntactic contexts such as <em>PropertyAccess</em> and Object Literal <em>PropertyName</em> look up identifiers using a new abstract operations GetPrivateName that is exactly like GetIdentiferReference except that it uses the property name bindings.  At the top level is an the set of identifier bindings that map all identifiers to the string values of their identifier names.  
</p>

</div>

<a name="accessing_private_names_as_values"></a><h1>Accessing Private Names as Values</h1>
<div class="level1">

<p>
 The <code>private</code> declaration normally both creates a new private name value and introduces a name binding that can be used only in &ldquo;property name&rdquo; syntactic contexts to access the new private name value by the lexically bound name.
</p>

<p>
However, in some circumstances it is necessary to access the actual private name value as an expression value, not as a property name on the right of <code>.</code> or the left of <code>:</code> in an object initialiser. This requires a special form than can be used in an expression to access the private name value binding of a private identifier.  The syntactic form is <code><strong>#.</strong></code> <em>IdentifierName</em>.  This may be used as a <em>PrimaryExpression</em> and yields the property name value of the <em>IdentifierName</em>.  This may be either a private name value or a string value, depending upon whether the expression is within the scope of a <code>private</code> declaration for that <em>IdentifierName</em>;
</p>
<pre class="code javascript"><span class="kw2">function</span> addPrivateProperty<span class="br0">&#40;</span>obj, init<span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="kw2">private</span> pname;     <span class="co1">//create a new private name</span>
   obj.<span class="me1">pname</span> = init;  <span class="co1">//add initialize a property with that private name</span>
   <span class="kw1">return</span> #.<span class="me1">pname</span>;    <span class="co1">//return the private name value to the requestor</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">var</span> myObj = <span class="br0">&#123;</span><span class="br0">&#125;</span>;
<span class="kw2">var</span> answerKey = addPrivateProperty<span class="br0">&#40;</span>myObj, <span class="nu0">42</span><span class="br0">&#41;</span>;
<span class="kw3">print</span><span class="br0">&#40;</span>myObj<span class="br0">&#91;</span>answerKey<span class="br0">&#93;</span><span class="br0">&#41;</span>;   <span class="co1">//42,  note that answerKey is a regular variable so [ ] must be used to access the property</span>
<span class="co1">//myObj can now be made globally available but answerKey can be selectively passed to privileged code</span></pre>
<p>
Note that simply assigning a private name value to a variable does not make that variable a private identifier. For example, in the above example, the print statement could not validly be replaced with: 
</p>
<pre class="code javascript"><span class="kw3">print</span><span class="br0">&#40;</span>myObj.<span class="me1">answerKey</span><span class="br0">&#41;</span>;</pre>
<p>
 This would produce <code>&ldquo;undefined&rdquo;</code> because it would access the non-existent property whose string valued property name would be <code>&ldquo;answerKey&rdquo;</code>.  Only identifiers that have been explicitly declared using <code>private</code> are private identifiers.
</p>

<p>
Enabling the use of [ ] with private name values requires a minor change to the ES5 specification.  In 11.2.1, step 6 must be changed to call ToPropertyName rather than ToString.  <code>ToPropertyName(name)</code> is defined as follows:
</p>
<ol>
<li class="level1"><div class="li"> If name is a private name value, return name.</div>
</li>
<li class="level1"><div class="li"> Return the result of ToString(name).</div>
</li>
</ol>

<p>
 This will not change the semantics of any existing JavaScript code because such code will not contain any use of private name values.
</p>

<p>
The only operators that can be successfully be applied to a private name value are == and === both of which return true when both operands is the same private name value.
</p>

<p>
Private name values can be converted to strings using the internal <code>ToString</code> abstract operation.  However, the string value does not have any correspondence to the identifier in the <code>private</code> declaration that created the private name value.  The string value produced by such a string conversion is simply <code>&ldquo;Private Name&rdquo;</code>.
</p>

<p>
<sup><img src="lib/images/smileys/icon_question.gif" align="middle" alt=":?:" /></sup>It may be useful to allow <code>&ldquo;Private Name&rdquo;</code> to be followed by additional implementation dependent text.  This might be used to provide additional identifying information such as a source text line number or a unique serial number that would be useful for debugging.
</p>

<p>
 If <code><strong>#.</strong></code> is not within the scope of a <code>private</code> declaration for its <em>IdentifierName</em> then the value produced is the string value of the <em>IdentifierName</em>.  In other words, <code><strong>#.</strong></code> <em>IdentiferName</em> always produces the same value as would be used as the property name in a <em>PropertyAccess</em> using that same <em>IdentifierName</em>.
</p>

<p>
As an expressive convenience, <code>private</code> declarations can be used to associate a private identifier with an already existing private name value.  This is done by using a <code>private</code> declaration of the form:
</p>

<p>
 <strong><code>private</code></strong> <em>Identifier</em> <strong><code>=</code></strong> <em>Initialiser</em> <strong><code>;</code></strong> <br/>
 
</p>

<p>
 If <em>Initialiser</em> does not evaluate to a private name value, a TypeError exception is thrown. (<sup><img src="lib/images/smileys/icon_question.gif" align="middle" alt=":?:" /></sup>  <em>for uniformity, should string values be allowed?  In that case, local private name bindings could be string valued.</em>)
</p>
<pre class="code javascript"><span class="kw2">private</span> name1;   <span class="co1">//value is a new private name</span>
<span class="kw2">private</span> name2 = #.<span class="me1">name1</span>  <span class="co1">//name2 can be used to access the same property name as name1</span></pre>
</div>

<a name="conflict-free_object_extension_using_private_names"></a><h1>Conflict-Free Object Extension Using Private Names</h1>
<div class="level1">

<p>
 Some JavaScript frameworks and libraries extend built-in objects by adding new properties to built-in prototype objects.  For example, a framework might choose to add a <code>clone</code> method to <code>Object.prototype</code> that may be used to make a copy of any object.  Problems occur when two or more frameworks both try to add a method named <code>clone</code>.  Private names can be used to avoid such conflicts.  If each framework uses a private name rather than than a string property name than each can install a <code>clone</code> method on <code>Object.prototype</code> without interfering with the other.
</p>

<p>
For example, someone might create library that does recursive deep copying of object structures that was organized something like this: 
</p>
<pre class="code javascript"><span class="kw2">function</span> installCloneLibrary<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="kw2">private</span> clone;   <span class="co1">// the private name for clone methods</span>
&nbsp;
   <span class="co1">// Install clone methods in key built-in prototypes:</span>
   Object.<span class="me1">prototype</span>.<span class="me1">clone</span> = <span class="kw2">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span>;
   Array.<span class="me1">prototype</span>.<span class="me1">clone</span> = <span class="kw2">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
       ...
       <span class="me1">target</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span> = <span class="kw1">this</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span>.<span class="me1">clone</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;  <span class="co1">// recur on clone method</span>
       ...
   <span class="br0">&#125;</span>
   String.<span class="me1">prototype</span>.<span class="me1">clone</span> = <span class="kw2">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>...<span class="br0">&#125;</span>
   ...
   <span class="kw1">return</span> #.<span class="me1">clone</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="co1">// Example usage of CloneLibrary:</span>
<span class="kw2">private</span> clone = installCloneLibrary<span class="br0">&#40;</span><span class="br0">&#41;</span>;
installAnotherLibrary<span class="br0">&#40;</span><span class="br0">&#41;</span>;
<span class="kw2">var</span> twin = <span class="br0">&#91;</span><span class="br0">&#123;</span>a:<span class="nu0">0</span><span class="br0">&#125;</span>, <span class="br0">&#123;</span>b:<span class="nu0">1</span><span class="br0">&#125;</span><span class="br0">&#93;</span>.<span class="me1">clone</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;</pre>
<p>
The above client of the <code>CloneLibrary</code> will work even if the other library also defines a method named <code>clone</code> on <code>Object.prototype</code>.  The second library would not have visibility of the private name used for <code>clone</code> so it would either use a string property name or a different private name for the method.  In either case there would be no conflict with the method defined by <code>CloneLibrary</code>. 
</p>

</div>

<a name="enumeration_and_reflection"></a><h1>Enumeration and Reflection</h1>
<div class="level1">

<p>
 Properties whose property names are private name values have all the same attributes as a property whose property name is a string value and the same defaults attribute are generally used. However, in most cases it is likely that properties defined using private names should not show up in for-in enumerations. For this reason, the semantics of the standard internal <code>[[Put]]</code> method are modified for cases where a property is created by <code>[[Put]]</code> using a Private Name value as the property name.  In this case the <code>[[Enumerable]]</code> attribute of the newly created property is initially set to <strong>false</strong>.  This change in made ES5 8.12.5, step 6.a. 
</p>

<p>
For example: 
</p>
<pre class="code javascript"><span class="kw2">private</span> b;
<span class="kw2">var</span> obj = <span class="br0">&#123;</span><span class="br0">&#125;</span>;
obj.<span class="me1">a</span> = <span class="nu0">1</span>;
obj.<span class="me1">b</span> = <span class="nu0">2</span>;
obj.<span class="me1">c</span> = <span class="nu0">3</span>;
&nbsp;
<span class="kw2">var</span> names = <span class="br0">&#91;</span><span class="br0">&#93;</span>;
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw2">var</span> p <span class="kw1">in</span> obj<span class="br0">&#41;</span> names.<span class="me1">push</span><span class="br0">&#40;</span>obj<span class="br0">&#91;</span>p<span class="br0">&#93;</span><span class="br0">&#41;</span>;
<span class="kw3">print</span><span class="br0">&#40;</span>names.<span class="me1">toString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;    <span class="co1">// &quot;1,3&quot; -- private name &quot;b&quot; was not enumerated</span></pre>
<p>
Properties with private names that are created using object literals also are created with their <code>[[Enumerable]]</code> attribute <strong>false</strong>.  So <code>obj</code> could have been created to produce the same result by saying:
</p>
<pre class="code javascript"><span class="kw2">private</span> b;
<span class="kw2">var</span> obj = <span class="br0">&#123;</span>
   a: <span class="nu0">1</span>,
   b: <span class="nu0">2</span>,
   c: <span class="nu0">3</span>
<span class="br0">&#125;</span></pre>
<p>
Because object literal properties are specified using <code>[[DefineOwnProperty]]</code> rather than <code>[[Put]]</code> all property descriptors used in ES5 11.1.5 will be updated to set <code>[[Enumerable]]</code> to <strong>false</strong> whenever a <em>PropertyName</em> is a private name value. 
</p>
<table class="inline">
	<tr>
		<td><sup><img src="lib/images/smileys/icon_exclaim.gif" align="middle" alt=":!:" /></sup> Need to check all other uses of <code>[[DefineOwnProperty]]</code> and determine whether any of them should have special treatment of private name values. </td>
	</tr>
</table>
<br />

<p>
 Creating a private named property that is enumerable requires use of <code>Object.defineProperty</code> and the <code><strong>#.</strong></code> prefix. For example:
</p>
<pre class="code javascript"><span class="kw2">private</span> b;
<span class="kw2">var</span> obj = <span class="br0">&#123;</span><span class="br0">&#125;</span>;
obj.<span class="me1">a</span> = <span class="nu0">1</span>;
obj.<span class="me1">b</span> = <span class="nu0">2</span>;
Object.<span class="me1">defineProperty</span><span class="br0">&#40;</span>obj, #.<span class="me1">b</span>, <span class="br0">&#123;</span>enumerable: <span class="kw2">true</span><span class="br0">&#125;</span><span class="br0">&#41;</span>;
obj.<span class="me1">c</span> = <span class="nu0">3</span>;
&nbsp;
<span class="kw2">var</span> names = <span class="br0">&#91;</span><span class="br0">&#93;</span>;
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw2">var</span> p <span class="kw1">in</span> obj<span class="br0">&#41;</span> names.<span class="me1">push</span><span class="br0">&#40;</span>obj<span class="br0">&#91;</span>p<span class="br0">&#93;</span><span class="br0">&#41;</span>;
<span class="kw3">print</span><span class="br0">&#40;</span>names.<span class="me1">toString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;    <span class="co1">// &quot;1,2,3&quot; -- private name &quot;b&quot; is now enumerated</span></pre>
<p>
<code>Object.prototype.hasOwnProperty</code> (ES5 15.2.4.5), <code>Object.prototype.PropertyIsEnumerable</code> (ES5 15.2.4.7) and the <code>in</code> operator (ES5 11.8.7) are all extended to accept private name values in addition to string values as property names.  Where they currently call ToString on property names they will instead call ToPropertyName. The <code>JSON.stringify</code> algorithm (ES5 15.12.3) will be modified such that it does not process enumerable properties that have private name values as their property names.
</p>

<p>
All the Object reflection functions defined in ES5 section 15.2.3 that accept property names as arguments or return property names are extended to accept or produce private name values in addition to string values as property names. A private name value may appear as a property name in the collection of property descriptors passed to <code>Object.create</code> and <code>Object.defineProperties</code>.  If an object has private named properties then their private name values will appear in the arrays returned by <code>Object.getOwnPropertyNames</code> and <code>Object.keys</code> (if the corresponding properties are enumerable). 
</p>
<table class="inline">
	<tr>
		<td><sup><img src="lib/images/smileys/icon_exclaim.gif" align="middle" alt=":!:" /></sup> In ES5 <code>Object.defineProperties</code> and <code>Object.create</code> are specified to look only at the enumerable own properties of the object that is passed containing property descriptors.  Usually this object is specified using an object literal.  However, we have already specified above that private named properties in object literals are always created as non-enumerable properties.  This would generally preclude the use of private name values in the object literals passed to these methods.  It may be necessary to modify the specification of <code>Object.defineProperty</code> and <code>Object.create</code> to process also as property definitions any non-enumerable private named own properties that appear in such objects. <pre class="code javascript"><span class="co1">// Object.defineProperty probably needs to accept descriptors such as:</span>
<span class="kw2">private</span> a, b; 
Object.<span class="me1">defineProperties</span><span class="br0">&#40;</span>obj, <span class="br0">&#123;</span>
   a: <span class="br0">&#123;</span>configurable: <span class="kw2">true</span><span class="br0">&#125;</span>, <span class="co1">// ES5 ignores non-enumerable properties </span>
   b: <span class="br0">&#123;</span>writable: <span class="kw2">true</span><span class="br0">&#125;</span>      <span class="co1">// that appear in such descriptors</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span>;</pre></td>
	</tr>
</table>
<br />

<p>
 An important use case for reflection using private name values is algorithms that need to perform meta-level processing of all properties of any object.  For example, a &ldquo;universal&rdquo; object copy function might be coded as:
</p>
<pre class="code javascript"><span class="kw2">function</span> copyObject<span class="br0">&#40;</span>obj<span class="br0">&#41;</span> <span class="br0">&#123;</span>
   <span class="co1">// This doesn't deal with other special [[Class]] objects:</span>
   <span class="kw2">var</span> copy = Object.<span class="me1">isArray</span><span class="br0">&#40;</span>obj<span class="br0">&#41;</span> ? <span class="br0">&#91;</span><span class="br0">&#93;</span> : Object.<span class="me1">create</span><span class="br0">&#40;</span>Object.<span class="me1">getPrototypeOf</span><span class="br0">&#40;</span>obj<span class="br0">&#41;</span><span class="br0">&#41;</span>;
   <span class="kw2">var</span> props = Object.<span class="me1">getOwnPropertyNames</span><span class="br0">&#40;</span>obj<span class="br0">&#41;</span>;
   <span class="kw2">var</span> pname;
   <span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw2">var</span> i = <span class="nu0">0</span>; i &lt; props.<span class="me1">length</span>; i++<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      pname = props<span class="br0">&#91;</span>i<span class="br0">&#93;</span>;
      Object.<span class="me1">defineProperty</span><span class="br0">&#40;</span>copy, pname, Object.<span class="me1">getOwnPropertyDescriptor</span><span class="br0">&#40;</span>obj,pname<span class="br0">&#41;</span><span class="br0">&#41;</span>;
   <span class="br0">&#125;</span>
   <span class="kw1">return</span> obj;
<span class="br0">&#125;</span></pre>
<p>
This function will duplicate all properties, including any that have private name values as their property names. It does not need to have any specific declarations for or knowledge of such private names.
</p>

<p>
Some reflection function could potentially be used to discover private name values used for an object&rsquo;s properties that would not have otherwise been known to the caller to the reflection function. Some environment, particularly sandboxes may wish to precluded such discovery. This can be done by replace the built-in reflection functions with wrapper that filter access to private name keyed properties.  This is similar in concept to the wrapping that some environments do to secure functions such as eval or the Function constructor.
</p>

</div>

<a name="private_name_properties_provide_a_weak_but_usful_form_of_information_hiding"></a><h1>Private Name Properties Provide a Weak But Usful Form of Information Hiding</h1>
<div class="level1">

<p>
 Private names are a simple and pragmatic way to support information hiding within ECMAScript objects without requiring programmers to change their fundamental conceptualization of JavaScript objects. They make available unforgable unique values that can be used to name properties. While private names are unforagable, there are no mechanisms that guarantee that a private name can never leak to an unintended agent within a program.
</p>

<p>
Private named properties do not provide and are not intended to provide strong impenetrable encapsulation of object state. For example, various reflection operations can be used to access an object&rsquo;s properties that have private names. Private names are instead intended as a simple extensions of the classic JavaScript object model that enables straight-forward encapsulation in non-hostile environments. The design preserves the ability to manipulate all properties of an objects at a meta level using reflection and the ability to perform &ldquo;monkey patching&rdquo; when it is necessary. Encapsulation via closure capture should continue to be used for situations where strong encapsulation that can not be penetrated by a hostile attacker is actually needed.
</p>

<p>
Sand-boxing environments that already need to restrict the use of certain reflection operations can use similar technique to limit access to private named properties.  For example, a sandbox implementation might replace <code>Object.getOwnPropertyNames</code> with a version that filters out any private name values.
</p>

<p>
For situation where strong information hiding is required private names can be used in conjunction with <a href="doku.php%3Fid=strawman:instance_variables.html" class="wikilink1" title="strawman:instance_variables" onclick="return svchk()" onkeypress="return svchk()">Instance Variables</a> to secure data from all forms of reflective discovery and access.
</p>

</div>

<a name="interactions_with_other_harmony_proposals"></a><h1>Interactions with other Harmony Proposals</h1>
<div class="level1">

<p>
 There are potential feature interactions and opportunities for feature integration involving private names and several other Harmony proposals. As features are accepted into Harmony and their details are filled in these interactions need to be resolved.
</p>

</div>

<a name="enhanced_object_literals"></a><h3>Enhanced Object Literals</h3>
<div class="level3">

<p>
 The <a href="doku.php%3Fid=strawman:object_initialiser_extensions.html" class="wikilink1" title="strawman:object_initialiser_extensions" onclick="return svchk()" onkeypress="return svchk()">Object Initialiser Extensions</a> include a <a href="doku.php%3Fid=strawman:private_names_in_object_initialisers.html" class="wikilink1" title="strawman:private_names_in_object_initialisers" onclick="return svchk()" onkeypress="return svchk()">Private Names in Object Initialisers</a> proposal that integrates private name declarations with extended object literals.
</p>

</div>

<a name="proxies"></a><h3>Proxies</h3>
<div class="level3">

<p>
All uses of string valued property names in proxy handlers would need to be extended to accept/produce private name values in addition to string values.
</p>

<p>
As covered above, ECMAScript reflection capabilities provides a means to break the encapsulation of an object&rsquo;s private named properties. Where this is a concern, it can be mitigated by replacing the reflection functions with versions that filter access to private name values. The Proxy proposal provides an additional means to break such encapsulation.  If an attacker suspects that some object has private named properties it might sniff out those values by creating a proxy for the object whose handler consisted of traps that monitored all calls looking for private name argument values before delegating the operation to the original object.
</p>

<p>
One possible mitigation for this attach would be the same as for the other reflection functions. The Proxy object could be replaced with an alternative implementation that added an additional handler layer that would wrapper all private name values passed through its traps.  The wrappers would be opaque encapsulations of each private name value and provide a method that could be used to test whether the encapsulated private name was === to an argument value.  This would permit handlers to process known private name values but would prevent exposing arbitrary private name values to the handlers. 
</p>

<p>
If there is sufficient concern about proxies exposing private name values in this manner, such wrapping of private names could be built into the primitive trap invocation mechanism.
</p>

</div>

<a name="modules"></a><h3>Modules</h3>
<div class="level3">

<p>
 It is reasonable to expect that modules will want to define and export private name values. For example, a module might want to add methods to a built-in prototype object using private names and then make those method names available to other modules.  Within the present definition of the simple module system that might be done as follows:
</p>
<pre class="code javascript">&lt;script type=<span class="st0">"harmony"</span>&gt;
module ExtendedObject <span class="br0">&#123;</span>
   <span class="kw2">import</span> Builtins.<span class="me1">Object</span>;       <span class="co1">// however access to Object is obtained.</span>
   <span class="kw2">private</span> clone;                <span class="co1">// the private name for clone methods</span>
   <span class="kw2">export</span> <span class="kw2">const</span> clone = #.<span class="me1">clone</span>; <span class="co1">// export a constant with the private name value;</span>
&nbsp;
   Object.<span class="me1">prototype</span>.<span class="me1">clone</span> = <span class="kw2">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span>;
<span class="br0">&#125;</span>
&lt;/script&gt;</pre>
<p>
 A consumer of this module might look like: 
</p>
<pre class="code javascript">&lt;script type=<span class="st0">"harmony"</span>&gt;
<span class="kw2">import</span> ExtendedObject.<span class="me1">clone</span>;
<span class="kw2">private</span> clone = clone;
<span class="kw2">var</span> anotherObj = someObj.<span class="me1">clone</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
&lt;/script&gt;</pre>
<p>
 The above formulation would work without any additional extensions to the simple module proposal. However, it would be even more convenient if the module system was extended to understand private declarations and the parallel property name environment.  In that case this example might be written as: 
</p>
<pre class="code javascript">&lt;script type=<span class="st0">"harmony"</span>&gt;
module ExtendedObject <span class="br0">&#123;</span>
   <span class="kw2">import</span> Builtins.<span class="me1">Object</span>;     <span class="co1">// however access to Object is obtained.</span>
   <span class="kw2">export</span> <span class="kw2">private</span> clone;       <span class="co1">// export private name for clone methods</span>
&nbsp;
   Object.<span class="me1">prototype</span>.<span class="me1">clone</span> = <span class="kw2">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span>;
<span class="br0">&#125;</span>
&lt;/script&gt;</pre><pre class="code javascript">&lt;script type=<span class="st0">"harmony"</span>&gt;
<span class="kw2">import</span> <span class="kw2">private</span> ExtendedObject.<span class="me1">clone</span>;
<span class="kw2">var</span> anotherObj = someObj.<span class="me1">clone</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
&lt;/script&gt;</pre>
<p>
 In these example the use of <code>import</code> and <code>export</code> prefixing <code>private</code> declarations forces use of the property name environment of the named module.  For dynamic access to the exported property name environment of first-class module instances another mechnism would perhaps be needed:
</p>
<pre class="code javascript">&lt;script type=<span class="st0">"harmony"</span>&gt;
module <span class="kw2">private</span> ExtendedObject_names = ExtendedObject;
&nbsp;
<span class="kw2">private</span> cloneEX = ExtendedObject_names.<span class="me1">clone</span>;  <span class="co1">//get private name value bound to ''clone'' in reified module ''ExtendedObject''</span>
<span class="kw2">var</span> yetAnotherObj = someObj.<span class="me1">cloneEX</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
&lt;/script&gt;</pre>
</div>

<a name="references"></a><h1>References</h1>
<div class="level1">

<p>
 Private name values are akin to what is returned by <code>gensym</code> of Lisp and Scheme, and analogous to a capability in object-capability languages.
</p>

<p>
The inspiration for <code>private</code> is Racket&rsquo;s <a href="http://docs.racket-lang.org/reference/createclass.html?q=define-local-member-name#%28form._%28%28lib._racket/private/class-internal..rkt%29._define-local-member-name%29%29" class="urlextern" target="_blank" title="http://docs.racket-lang.org/reference/createclass.html?q=define-local-member-name#%28form._%28%28lib._racket/private/class-internal..rkt%29._define-local-member-name%29%29" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">define-local-member-name</a> and &ldquo;selector namespaces&rdquo; for <a href="http://www.smalltalksystems.com/publications/subsys.pdf" class="urlextern" target="_blank" title="http://www.smalltalksystems.com/publications/subsys.pdf" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Smalltalk</a> and <a href="http://www.sapphire-lang.org/wiki/1/Selector_namespaces" class="urlextern" target="_blank" title="http://www.sapphire-lang.org/wiki/1/Selector_namespaces" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Ruby</a> . 
</p>

</div>

<a name="discussion"></a><h1>Discussion</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=strawman:names_vs_soft_fields.html" class="wikilink1" title="strawman:names_vs_soft_fields" onclick="return svchk()" onkeypress="return svchk()">names vs soft fields</a> (markm) &ndash; compares names to <a href="doku.php%3Fid=strawman:inherited_explicit_soft_fields.html" class="wikilink1" title="strawman:inherited_explicit_soft_fields" onclick="return svchk()" onkeypress="return svchk()">inherited explicit soft fields</a>.</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> At the March meeting, there was a suggestion that the ability to create a private name be exposed as a library function which could be used by &lsquo;text/javascript&rsquo; code.  Exposing an &lsquo;Object.createPrivateName(name)&rsquo; function would appear to be all that&rsquo;s needed beyond the above proposal.  This could be used in &lsquo;text/javascript&rsquo; and could be feature-detected with a reasonable fallback.  An example included below.     &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x75%3B%26%23x6b%3B%26%23x65%3B%26%23x68%3B%26%23x40%3B%26%23x6d%3B%26%23x69%3B%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x73%3B%26%23x6f%3B%26%23x66%3B%26%23x74%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x75;&#x6b;&#x65;&#x68;&#x40;&#x6d;&#x69;&#x63;&#x72;&#x6f;&#x73;&#x6f;&#x66;&#x74;&#x2e;&#x63;&#x6f;&#x6d;">Luke Hoban</a> 2011/05/18 01:42</em></div>
</li>
</ul>
<pre class="code">
function Point(x,y) {
   var _x = Object.createPrivateName(&quot;x&quot;);
   var _y = Object.createPrivateName(&quot;y&quot;);
   this[_x] = x;
   this[_y] = y;
   //... methods that use private x and y properties
}
var pt = new Point(1,2);
</pre>

</div>

<a name="scratch_pad"></a><h1>Scratch Pad</h1>
<div class="level1">

<p>
<a href="doku.php%3Fid=strawman:unique_string_values.html" class="wikilink1" title="strawman:unique_string_values" onclick="return svchk()" onkeypress="return svchk()">Unique String Values</a> 
</p>

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        strawman/private_names.txt &middot; Last modified: 2011/05/18 01:49 by lukeh      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="strawman:private_names" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:private_names" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="strawman:private_names" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="strawman:private_names" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=strawman:private_names.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=strawman%253Aprivate_names&amp;1454275641" width="1" height="1" alt=""  /></body>
</html>
