<html>
<head>
  <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=strawman:derived_traps_forwarding_handler&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=strawman" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=strawman:derived_traps_forwarding_handler&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=strawman:derived_traps_forwarding_handler&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="robots" content="noindex,nofollow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />
</head>
<body>
<div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:derived_traps_forwarding_handler&amp;do=export_html.html#derived_traps_of_default_forwarding_handler" class="toc">Derived Traps of Default Forwarding Handler</a></span><ul class="toc">
<li class="clear"><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:derived_traps_forwarding_handler&amp;do=export_html.html#context" class="toc">Context</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:derived_traps_forwarding_handler&amp;do=export_html.html#analysis" class="toc">Analysis</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:derived_traps_forwarding_handler&amp;do=export_html.html#proposal" class="toc">Proposal</a></span></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:derived_traps_forwarding_handler&amp;do=export_html.html#references" class="toc">References</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:derived_traps_forwarding_handler&amp;do=export_html.html#feedback" class="toc">Feedback</a></span></li>
</ul>
</div>
</div>

<a name="derived_traps_of_default_forwarding_handler"></a><h1>Derived Traps of Default Forwarding Handler</h1>
<div class="level1">

<p>
 The default Proxy <a href="doku.php%3Fid=harmony:proxy_defaulthandler.html" class="wikilink1" title="harmony:proxy_defaulthandler" onclick="return svchk()" onkeypress="return svchk()">forwarding handler</a> provides an implementation for all fundamental and all derived traps. For the derived traps, two possible default implementations are possible, and it is not entirely obvious which one is better.
</p>

</div>
<!-- SECTION [1-327] -->
<a name="context"></a><h3>Context</h3>
<div class="level3">

<p>
 David Bruant, while experimenting with <a href="https://github.com/DavidBruant/HarmonyProxyLab/tree/master/ProxyArray" class="urlextern" target="_blank" title="https://github.com/DavidBruant/HarmonyProxyLab/tree/master/ProxyArray" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">proxied Arrays</a>, came across the following situation: his proxied Array uses a default forwarding handler to forward all operations to a target Array instance, but overrides the <code>defineProperty</code> trap. However, assignments to the array of the form <code>proxiedArray[i] = val</code> did not trigger his overridden <code>defineProperty</code> trap, since the default forwarding handler provides a derived <code>set</code> trap that just forwards the operation to the wrapped array.
</p>

<p>
To make this use case work, one has to either override <code>set</code> in conjunction with <code>defineProperty</code>, or delete the default <code>set</code> trap of <code>Proxy.Handler</code>. When the derived trap is deleted, the implementation correctly falls back on the (overridden) fundamental <code>defineProperty</code> trap.
</p>
<pre class="code javascript"><span class="kw2">var</span> target = <span class="br0">&#123;</span>...<span class="br0">&#125;</span>;
<span class="kw2">var</span> h = <span class="kw2">new</span> Proxy.<span class="me1">Handler</span><span class="br0">&#40;</span>target<span class="br0">&#41;</span>;
h.<span class="me1">defineProperty</span> = <span class="kw2">function</span><span class="br0">&#40;</span><span class="kw3">name</span>, pd<span class="br0">&#41;</span> <span class="br0">&#123;</span>...<span class="br0">&#125;</span>; <span class="co1">// override a fundamental trap</span>
<span class="kw2">var</span> p = Proxy.<span class="me1">create</span><span class="br0">&#40;</span>h<span class="br0">&#41;</span>;
&nbsp;
p<span class="br0">&#91;</span><span class="st0">"foo"</span><span class="br0">&#93;</span> = <span class="st0">"bar"</span>; <span class="co1">// triggers default forwarding 'set' trap. Sets &quot;foo&quot; on target.</span>
<span class="co1">// programmer may have expected this to trigger overridden fundamental trap instead</span>
&nbsp;
<span class="kw1">delete</span> Object.<span class="me1">getPrototypeOf</span><span class="br0">&#40;</span>h<span class="br0">&#41;</span>.<span class="me1">set</span>;
p<span class="br0">&#91;</span><span class="st0">"foo"</span><span class="br0">&#93;</span> = <span class="st0">"bar"</span>; <span class="co1">// triggers overridden defineProperty trap</span></pre>
</div>
<!-- SECTION [328-1656] -->
<a name="analysis"></a><h3>Analysis</h3>
<div class="level3">

<p>
 There are two possible default implementations for the derived traps of the <a href="doku.php%3Fid=harmony:proxy_defaulthandler.html" class="wikilink1" title="harmony:proxy_defaulthandler" onclick="return svchk()" onkeypress="return svchk()">default forwarding handler</a>:
</p>
<ul>
<li class="level1"><div class="li"> &ldquo;forwarding&rdquo; semantics: forward the derived operation to the <code>target</code> (that is how they are currently specified)</div>
</li>
<li class="level1"><div class="li"> &ldquo;fallback&rdquo; semantics: implement the &ldquo;default&rdquo; semantics in terms of the fundamental forwarding traps (or equivalently, state that the default forwarding handler does not define any derived traps)</div>
</li>
</ul>

<p>
 The issue with &ldquo;forwarding semantics&rdquo; is that overriding a fundamental trap requires developers to override all dependent derived traps in sync. The relationship between fundamental and dependent derived traps may not be immediately obvious to developers, so this could lead to surprising behavior in practice. <acronym title="On the other hand">OTOH</acronym>, in many situations developers will want to override the derived traps anyway to allow for a more efficient implementation.
</p>

<p>
The issue with &ldquo;fallback semantics&rdquo; is that if the <code>target</code> object to which the proxy forwards is itself a proxy <code>p2</code>, then <code>p2</code>&lsquo;s derived traps will never be called. Instead, only <code>p2</code>&lsquo;s fundamental traps will be called. Things won&rsquo;t break, but it is suboptimal if <code>p2</code> has ad hoc (presumably more efficient) implementations for its derived traps. Presumably, even if &ldquo;target&rdquo; is a native object, &ldquo;forwarding semantics&rdquo; is more efficient than &ldquo;fallback semantics&rdquo;.
</p>
<pre class="code javascript"><span class="kw2">var</span> p2 = Proxy.<span class="me1">create</span><span class="br0">&#40;</span>h2<span class="br0">&#41;</span>;
<span class="kw2">var</span> h = <span class="kw2">new</span> Proxy.<span class="me1">Handler</span><span class="br0">&#40;</span>p2<span class="br0">&#41;</span>; <span class="co1">// p forwards to p2</span>
<span class="kw2">var</span> p = Proxy.<span class="me1">create</span><span class="br0">&#40;</span>h<span class="br0">&#41;</span>;
&nbsp;
p<span class="br0">&#91;</span><span class="st0">"foo"</span><span class="br0">&#93;</span> = <span class="st0">"bar"</span>; <span class="co1">// assuming &quot;h.set&quot; is undefined, this triggers h.defineProperty</span>
<span class="co1">// which in turn calls Object.defineProperty(p2, &quot;foo&quot;, {value: &quot;bar&quot;});</span>
<span class="co1">// which in turn triggers h2's &quot;defineProperty&quot; trap, not its &quot;set&quot; trap</span></pre>
</div>
<!-- SECTION [1657-3411] -->
<a name="proposal"></a><h3>Proposal</h3>
<div class="level3">

<p>
 It is difficult to come up with a solution that provides support for both forwarding and fallback semantics.
</p>

<p>
One proposal is to:
</p>
<ol>
<li class="level1"><div class="li"> Add a <code>Proxy.BaseHandler</code> that defines no derived traps, only fundamental traps (i.e. <code>Proxy.BaseHandler</code> supports fallback semantics).</div>
</li>
<li class="level1"><div class="li"> Modify <code>Proxy.Handler</code> so that it inherits its fundamental traps from <code>BaseHandler</code> and adds forwarding derived traps (i.e. <code>Proxy.Handler</code> then supports forwarding semantics).</div>
</li>
</ol>

<p>
 Depending on the required semantics, developers can make their custom handler inherit from either one. The question is whether the advantage of choice outweighs the complexity cost of this proposed <acronym title="Application Programming Interface">API</acronym>.
</p>

<p>
Another option is to simply live with the dependency between fundamental and derived traps and to properly document the relationships between traps, and the hazards of not overriding the traps in sync.
</p>

<p>
&mdash; <em><a href="mailto:%26%23x74%3B%26%23x6f%3B%26%23x6d%3B%26%23x76%3B%26%23x63%3B%26%23x2e%3B%26%23x62%3B%26%23x65%3B%26%23x40%3B%26%23x67%3B%26%23x6d%3B%26%23x61%3B%26%23x69%3B%26%23x6c%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x74;&#x6f;&#x6d;&#x76;&#x63;&#x2e;&#x62;&#x65;&#x40;&#x67;&#x6d;&#x61;&#x69;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;">Tom Van Cutsem</a> 2011/02/28 07:37</em>
</p>

</div>
<!-- SECTION [3412-4365] -->
<a name="references"></a><h1>References</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> <a href="https://mail.mozilla.org/pipermail/es-discuss/2011-January/012695.html" class="urlextern" target="_blank" title="https://mail.mozilla.org/pipermail/es-discuss/2011-January/012695.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Discussion thread</a> on es-discuss.</div>
</li>
<li class="level1"><div class="li"> <a href="http://code.google.com/p/es-lab/source/browse/trunk/src/proxies/Handler.js" class="urlextern" target="_blank" title="http://code.google.com/p/es-lab/source/browse/trunk/src/proxies/Handler.js" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Prototype implementation</a> of the proposed object hierarchy, works in Firefox 4.</div>
</li>
</ul>

</div>
<!-- SECTION [4366-4665] -->
<a name="feedback"></a><h1>Feedback</h1>
<div class="level1">

<p>
 Discussed at the March 2011 TC39 meeting. Dave, Brendan: like the proposed solution because it helps developers better understand the <acronym title="Application Programming Interface">API</acronym>. It&rsquo;s nice to be able to map the distinction between fundamental vs derived traps onto a familiar concept such as an inheritance hierarchy.
</p>

<p>
&mdash; <em><a href="mailto:%26%23x74%3B%26%23x6f%3B%26%23x6d%3B%26%23x76%3B%26%23x63%3B%26%23x2e%3B%26%23x62%3B%26%23x65%3B%26%23x40%3B%26%23x67%3B%26%23x6d%3B%26%23x61%3B%26%23x69%3B%26%23x6c%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x74;&#x6f;&#x6d;&#x76;&#x63;&#x2e;&#x62;&#x65;&#x40;&#x67;&#x6d;&#x61;&#x69;&#x6c;&#x2e;&#x63;&#x6f;&#x6d;">Tom Van Cutsem</a> 2011/03/30 13:05</em> 
</p>

</div>
<!-- SECTION [4666-] -->
<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/4/4048ac660753d2f39fde164cc5c0938c.xhtml used -->
</body>
</html>
