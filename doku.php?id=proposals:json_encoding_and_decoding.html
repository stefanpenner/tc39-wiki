<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>proposals:json_encoding_and_decoding [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=proposals:json_encoding_and_decoding&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=proposals" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=proposals:json_encoding_and_decoding&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=proposals:json_encoding_and_decoding&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2007-09-27T00:54:15+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=proposals:json_encoding_and_decoding&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">proposals:json_encoding_and_decoding</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="proposals:json_encoding_and_decoding" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="proposals:json_encoding_and_decoding" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:versioning.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:versioning">versioning</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:meta_objects.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:meta_objects">meta_objects</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:date_and_time.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:date_and_time">date_and_time</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:string.prototype.trim.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:string.prototype.trim">string.prototype.trim</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=proposals:json_encoding_and_decoding.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:json_encoding_and_decoding">json_encoding_and_decoding</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    
<a name="json_encoding_and_decoding"></a><h1>JSON encoding and decoding</h1>
<div class="level1">

<p>
 The following built-in functions facilitate handling JSON data, as specified in <a href="http://www.ietf.org/rfc/rfc4627.txt?number=4627" class="urlextern" target="_blank" title="http://www.ietf.org/rfc/rfc4627.txt?number=4627" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Douglas Crockford's RFC 4627</a>.
</p>

<p>
<a href="http://bugs.ecmascript.org/ticket/212" class="urlextern" target="_blank" title="http://bugs.ecmascript.org/ticket/212" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Ticket #212</a> proposes that we remove JSON support from ES4.
</p>

</div>

<a name="encoding"></a><h2>Encoding</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <code>Object.prototype.toJSONString(</code> <em>[pretty]</em> <code>)</code></div>
</li>
</ul>

<p>
 Returns a String containing the JSON representation of an object. The <code>[[Prototype]]</code> internal property is not used when finding members. An object is serialized as a a sequence of comma separated pairs wrapped in curly braces. During the course of the serialization, the <code>toJSONString</code> methods of the values will be used to obtain their JSON textual representations. 
</p>

<p>
Values which are not directly represented in JSON (such as <code>undefined</code>, functions, and unknown types) will be skipped. The value <code>null</code> is serialized as the unquoted string <code>null</code>. 
</p>
<hr noshade="noshade" size="1" />

<p>
 There needs to be a better spec for what should be skipped, as the only non-Object types in ES are <code>null</code> and <code>undefined</code>.  I understand <code>function</code> could be in the skipped set but &ldquo;unknown types&rdquo; doesn&rsquo;t mean anything.  It would be better to have an exhaustive list of the types that should be included, and why.  For example, if I subclass Object for my &ldquo;Point&rdquo; class, should it be included, even if it has no interesting methods?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/09/24 21:14</em>
</p>

<p>
We also need to have a notion of encodable and unencodable names.  This came up before, and <acronym title="If I remember correctly">IIRC</acronym> we decided that only &ldquo;plain&rdquo; names could be encoded (presumably, anything represented as string or uint, and a Name object if its namespace is empty/public but not otherwise).
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/09/24 21:23</em>
</p>
<hr noshade="noshade" size="1" />

<p>
A new <code>EncodingError</code> instance will be thrown if <code>this</code> contains a cyclical structure. Recurring objects that do not cause cycles are allowed, but will produce a complete text for each occurrence.
</p>

<p>
If the optional <em>pretty</em> parameter is <code>true</code>, then linefeeds are inserted after each <code>{</code> and <code>,</code> and before <code>}</code> , and multiples of 4 spaces are inserted to indicate the level of nesting, and one space will be inserted after <code>:</code>. Otherwise, no whitespace is inserted between the tokens. 
</p>
<ul>
<li class="level1"><div class="li"> <code>Array.prototype.toJSONString(</code> <em>[pretty]</em> <code>)</code></div>
</li>
</ul>

<p>
 Returns a String containing the JSON representation of an array. An array is serialized as a sequence of comma separated values wrapped in square braces. During the course of the serialization, the <code>toString</code> methods of the values will be used to obtain their JSON textual representations.
</p>

<p>
Values which are not directly represented in JSON (such as <code>undefined</code> , functions, and unknown types) will be skipped. This means that holes in arrays, and array <code>length</code>, are not preserved. The value <code>null</code> is serialized as the unquoted string <code>null</code>.
</p>

<p>
A new <code>EncodingError</code> instance will be thrown if <code>this</code> contains a cyclical structure. Recurring objects that do not cause cycles are allowed, but will produce a complete text for each occurrence.
</p>

<p>
If the optional <em>pretty</em> parameter is <code>true</code>, then linefeeds are inserted after each <code>[</code> and <code>,</code> and before <code>]</code>, and multiples of 4 spaces are inserted to indicate the level of nesting. Otherwise, no whitespace is inserted between the tokens.  
</p>
<ul>
<li class="level1"><div class="li"> <code>Date.prototype.toJSONString()</code></div>
</li>
</ul>

<p>
 Returns a String containing the representation of a date. A Date object is serialized as an <acronym title="International Organization for Standardization">ISO</acronym> date string in double quotes.  
</p>
<ul>
<li class="level1"><div class="li"> <code>String.prototype.toJSONString()</code></div>
</li>
</ul>

<p>
 Returns a String containing the JSON representation of a string. A String is serialized as a quoted string with backslash escapement.  
</p>
<ul>
<li class="level1"><div class="li"> <code>Number.prototype.toJSONString()</code></div>
</li>
</ul>

<p>
 Returns a String containing the JSON representation of a number. A finite number is serialized as an unquoted radix 10 string. Non-finite numbers are serializes as the unquoted string <code>null</code>. 
</p>
<ul>
<li class="level1"><div class="li"> <code>Boolean.prototype.toJSONString()</code></div>
</li>
</ul>

<p>
 Returns a String containing the JSON representation of a boolean value, an unquoted string <code>true</code> or <code>false</code>. 
</p>
<ul>
<li class="level1"><div class="li"> <code>EncodingError</code> is a new exception type. It contains a <code>name</code> property with value <code>&ldquo;EncodingError&rdquo;</code> and a <code>message</code> (an implementation-defined string).  </div>
</li>
</ul>

</div>

<a name="decoding"></a><h2>Decoding</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <code>String.prototype.parseJSON(</code> [<em>filter</em>] <code>)</code></div>
</li>
</ul>

<p>
 Returns the value represented by the string. A <code>syntaxError</code> is thrown if the string was not a strict JSON text.
</p>

<p>
The optional <em>filter</em> function will be called for each value found. It is passed each key and value. Its return value will be used instead of the original value in the final structure.
</p>

<p>
For example, this will transform all members whose keys contain the substring &lsquo;date&rsquo; into <code>Date</code> objects. 
</p>
<pre class="code">          myData = text.parseJSON(function (key, value) {
              return key.indexOf('date') &gt;= 0 ? new Date(value) : value;
          });</pre>
<hr noshade="noshade" size="1" />

<p>
Is the filter called also for each array element (with the key being the array index), or just for fields of encoded objects?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/09/27 00:52</em>
</p>

</div>

<a name="commentsdiscussion"></a><h2>Comments/Discussion</h2>
<div class="level2">

<p>
 Both <code>toJSONString</code> methods should throw an error upon discovering a cycle or a join point, I think.  Doug should correct me here if the join point check is too stringent.  Cycle detection at a minimum is necessary to avoid recursive runaway DoS attacks.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2006/09/22 20:56</em>
</p>

<p>
I suggest that both <code>toJSONString</code> methods should accept an optional filtering predicate that takes two parameters, an object and a property name, and return a boolean.  If the predicate returns false (or perhaps, a false value) the property with that name will not be serialized for that object.
</p>

<p>
The use case for this is data structures that are deserialized, processed, and reserialized, but where the processing may add temporary data to the nodes that we do not want to be saved (and which may in fact not be valid JSON data).
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/09/26 03:24</em>
</p>

<p>
I like Lars&rsquo;s suggestion for a filter function parameter for <code>toJSONString</code>. A simpler alternative would be an array of keynames. 
</p>

<p>
Another useful option would be prettyprint, which would insert spaces and linebreaks. This is not necessary, but it would be friendly. How far off of minimal to we want to go?
</p>

<p>
<code>toJSONString</code> must look for cycles. The question is what it should do if it finds them. I see three reasonable alternatives: 
</p>
<pre class="code">  1. When a recurring member is seen, then skip it, effectively deleting it from the serialization.
  2. throw
  3. return undefined</pre>

<p>
 Do we want to choose one, or leave it to the implementation? The JSON standard is met by any of the three choices.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2d%3B%26%23x69%3B%26%23x6e%3B%26%23x63%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x72;&#x6f;&#x63;&#x6b;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2d;&#x69;&#x6e;&#x63;&#x2e;&#x63;&#x6f;&#x6d;">Douglas Crockford</a> 2006/09/26 15:50</em>
</p>

<p>
I took a shot at capturing this with a config object, which keeps the default function call simple (empty of parameters) but let&rsquo;s one specify more complex behaviour in a clear fashion.  Is this interface too atypical though, I wonder?
</p>

<p>
&mdash; <em><a href="mailto:%26%23x69%3B%26%23x61%3B%26%23x69%3B%26%23x6e%3B%26%23x2e%3B%26%23x6c%3B%26%23x61%3B%26%23x6d%3B%26%23x62%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x69;&#x61;&#x69;&#x6e;&#x2e;&#x6c;&#x61;&#x6d;&#x62;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2e;&#x63;&#x6f;&#x6d;">Iain Lamb</a> 2006/09/26 16:49</em>
</p>

<p>
The array-of-names filter is probably adequate in practice.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/09/27 03:04</em>
</p>

<p>
Here&rsquo;s a slightly different proposal: get rid of <code>error</code> since it may be sufficient to use <code>filter</code>, get rid of the object argument and just use optional arguments. But I&rsquo;ve also made the <code>filter</code> argument a little more complex. Here&rsquo;s a pseudo-type (since there&rsquo;s no way to specify optional arguments other than with rest-args):
</p>
<pre class="code javascript">toJSONString<span class="br0">&#40;</span><span class="coMULTI">/* optional */</span> pretty : Boolean, <span class="coMULTI">/* optional */</span> filter : <span class="br0">&#40;</span><span class="br0">&#91;</span>String<span class="br0">&#93;</span>, <span class="kw2">function</span><span class="br0">&#40;</span>String<span class="br0">&#41;</span>:Boolean, RegExp<span class="br0">&#41;</span><span class="br0">&#41;</span></pre>
<p>
 &mdash; <em><a href="mailto:%26%23x64%3B%26%23x68%3B%26%23x65%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x63%3B%26%23x63%3B%26%23x73%3B%26%23x2e%3B%26%23x6e%3B%26%23x65%3B%26%23x75%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x64;&#x68;&#x65;&#x72;&#x6d;&#x61;&#x6e;&#x40;&#x63;&#x63;&#x73;&#x2e;&#x6e;&#x65;&#x75;&#x2e;&#x65;&#x64;&#x75;">Dave Herman</a> 2006/09/27 11:11</em>
</p>

<p>
I think the array of names should be a white list, not black list. That makes it more useful in honoring prototcol contracts.
</p>
<pre class="code javascript">toJSONString<span class="br0">&#40;</span><span class="coMULTI">/* optional */</span> filter : <span class="br0">&#91;</span>String<span class="br0">&#93;</span>, <span class="coMULTI">/* optional */</span> pretty : Boolean<span class="br0">&#41;</span></pre>
<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2d%3B%26%23x69%3B%26%23x6e%3B%26%23x63%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x72;&#x6f;&#x63;&#x6b;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2d;&#x69;&#x6e;&#x63;&#x2e;&#x63;&#x6f;&#x6d;">Douglas Crockford</a> 2006/10/02 11:13</em>
</p>

<p>
In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=340987" class="urlextern" target="_blank" title="https://bugzilla.mozilla.org/show_bug.cgi?id=340987" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Mozilla bug #340987</a>, Erik Arvidsson points out that this proposal needs <code>String.prototype.toJSONString</code> too.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2006/10/06 11:02</em>
</p>

<p>
See <a href="http://svn.red-bean.com/bob/simplejson/trunk/docs/module-simplejson.html#load" class="urlextern" target="_blank" title="http://svn.red-bean.com/bob/simplejson/trunk/docs/module-simplejson.html#load" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Bob Ippolito's simplejson Python package</a>, which Robert Sayre recommended to the es4-discuss list for its <code>object_hook</code> optional parameter.  This hook, if provided, is called with the deserialized object (dict in Python terms), and whatever it returns replaces that object in its parent during deserialization.  Iain, do I have that right?  Comments?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2006/10/11 17:02</em>
</p>

<p>
I updated to reflect what is currently offered in json.js. This is the <acronym title="Application Programming Interface">API</acronym> that people are actually using. The only complaint is that the methods are not DONTENUM.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2d%3B%26%23x69%3B%26%23x6e%3B%26%23x63%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x72;&#x6f;&#x63;&#x6b;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2d;&#x69;&#x6e;&#x63;&#x2e;&#x63;&#x6f;&#x6d;">Douglas Crockford</a> 2006/11/01 08:23</em>
</p>

<p>
The <em>filter</em> option in parseJSON is just a general purpose map function. Perhaps it would be more generally useful to pull it out of parseJSON and make it a general object method. So instead of 
</p>
<pre class="code">  myObject = myString.parseJSON(f);</pre>

<p>
 you would write 
</p>
<pre class="code">  myObject = myString.parseJSON().filter(f);</pre>

<p>
 The advantage is that .filter could be used for other purposes.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2d%3B%26%23x69%3B%26%23x6e%3B%26%23x63%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x72;&#x6f;&#x63;&#x6b;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2d;&#x69;&#x6e;&#x63;&#x2e;&#x63;&#x6f;&#x6d;">Douglas Crockford</a> 2007/01/10 09:33</em>
</p>

<p>
See <a href="doku.php%3Fid=proposals:static_generics.html" class="wikilink1" title="proposals:static_generics" onclick="return svchk()" onkeypress="return svchk()">static generics</a> &ndash; <code>Array.filter</code> (available also on array instances via <code>Array.prototype.filter</code>) is proposed, after JS1.6 in Firefox, but it works only on indexed (non-negative property identifiers from 0 up to but not including the value of the instance&rsquo;s <code>length</code> property, and not including holes). It does not map over all, or all enumerable, properties of any object. Also, you can suppress elements from the instance by returning <code>false</code> from the filter function. This means that <code>Array.filter</code>, like <code>Array.map</code>, allocates a new array into which elements passing the filter are stored.
</p>

<p>
The advantage of a filter parameter <code>f</code> to <code>parseJSON</code> is that it avoids making the new array result that <code>Array.filter</code> creates. I think this is a compelling reason to keep the <code>filter</code> parameter. On the other hand, this proposal does not allow <code>f</code> to suppress a key/value pair, while <code>Array.filter</code> does. Unifying the two notions of filtering to allow suppression may be worthwhile. Do you know of real-world use cases for filtering &ldquo;out&rdquo; whole properties (key/value pairs), rather than transforming values as this proposal allows?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/01/11 15:02</em>
</p>

<p>
The advantage of the pair is that transformations can be made based on the key. For example, if there is a convention that all date fields will include &lsquo;date&rsquo; in their keys, then they can be easily identified and transformed. 
</p>
<pre class="code">  myData = text.parseJSON(function (key, value) {
      return key.indexOf('date') &gt;= 0 ? new Date(value) : value;
  });</pre>

<p>
  &mdash; <em><a href="mailto:%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2d%3B%26%23x69%3B%26%23x6e%3B%26%23x63%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x72;&#x6f;&#x63;&#x6b;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2d;&#x69;&#x6e;&#x63;&#x2e;&#x63;&#x6f;&#x6d;">Douglas Crockford</a> 2007/01/12 10:58</em>
</p>

<p>
I see the benefit of separate <code>key</code> and <code>value</code> parameters to the callback, and didn&rsquo;t mean to question it &ndash; sorry for any confusion. As you noted earlier, the callback here is a map function, and it could be abstracted. It&rsquo;s not a filter in the Lisp or proposed ES4 <code>Array.filter</code> sense. But making it an optional callback parameter to <code>parseJSON</code> avoids an extra array or object allocation that would be imposed if we separated the transformation step: <code>text.parseJSON().map(function (key, value) {...})</code> would allocate twice. Sounds like we agree on avoiding that cost by keeping the callback parameter to <code>parseJSON</code>.
</p>

<p>
The question I asked above remains: should there be a way to suppress properties? Is that something real-world JSON decoders ever do?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/01/13 09:30</em>
</p>

<p>
JSON does not encode cyclical structures, so implementations must take some action when presented with one. The json.js library simply loops until reaching stack or memory exhaustion. That is not an ideal coping strategy. It is highly recommended that implementations adopt more useful strategies, such as throwing an exception on noticing a cycle.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2d%3B%26%23x69%3B%26%23x6e%3B%26%23x63%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x72;&#x6f;&#x63;&#x6b;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2d;&#x69;&#x6e;&#x63;&#x2e;&#x63;&#x6f;&#x6d;">Douglas Crockford</a> 2007/04/24 08:15</em>
</p>

<p>
I just received a bug report: 
</p>
<pre class="code"> var x = '{&quot;__proto__&quot;: 3}'.parseJSON();</pre>
<pre class="code"> x.__proto__ === 3
 false</pre>
<pre class="code"> x.__proto__ === Object.prototype
 true</pre>

<p>
 It seems that an implementation is allowed to add readonly properties to empty objects.  We should have language in the standard to explicitly disallow this.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2d%3B%26%23x69%3B%26%23x6e%3B%26%23x63%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x72;&#x6f;&#x63;&#x6b;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2d;&#x69;&#x6e;&#x63;&#x2e;&#x63;&#x6f;&#x6d;">Douglas Crockford</a> 2007/09/23 00:21</em>
</p>

<p>
From ES3 Chapter 16: &ldquo;An implementation may provide additional types, values, objects, properties, and functions beyond those described in this specification. This may cause constructs (such as looking up a variable in the global scope) to have implementation-defined behaviour instead of throwing an error (such as ReferenceError).&rdquo;
</p>

<p>
The <code>__proto__</code> property in SpiderMonkey is not read-only &ndash; it can be written, but attempts to create cycles throw errors, and attempts to store primitive values are no-ops. <acronym title="If I remember correctly">IIRC</acronym> other implements support read-only <code>__proto__</code>.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/09/24 01:06</em>
</p>

<p>
Right. I am suggesting that that language in Chapter 16 be changed to disallow things like <u>proto</u>.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x63%3B%26%23x6b%3B%26%23x40%3B%26%23x79%3B%26%23x61%3B%26%23x68%3B%26%23x6f%3B%26%23x6f%3B%26%23x2d%3B%26%23x69%3B%26%23x6e%3B%26%23x63%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x72;&#x6f;&#x63;&#x6b;&#x40;&#x79;&#x61;&#x68;&#x6f;&#x6f;&#x2d;&#x69;&#x6e;&#x63;&#x2e;&#x63;&#x6f;&#x6d;">Douglas Crockford</a> 2007/09/24 19:13</em>
</p>

<p>
Could you make a specific proposal?
</p>

<p>
In this case I wonder who was bugged by <code>__proto__</code>. Was it a real-world bug, or a problem found by someone working on a fuzz-testcase generator or some such?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/09/24 20:42</em> 
</p>

</div>

<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/f/f77e82bde106a002380f342894df5eae.xhtml used -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        proposals/json_encoding_and_decoding.txt &middot; Last modified: 2007/09/27 00:54 by lars      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="proposals:json_encoding_and_decoding" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="proposals:json_encoding_and_decoding" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="proposals:json_encoding_and_decoding" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="proposals:json_encoding_and_decoding" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=proposals:json_encoding_and_decoding.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=proposals%253Ajson_encoding_and_decoding&amp;1454275575" width="1" height="1" alt=""  /></body>
</html>
