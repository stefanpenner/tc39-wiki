<html>
<head>
  <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="http://wiki.ecmascript.org/feed.php?mode=list&amp;ns=harmony" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="robots" content="noindex,nofollow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />
</head>
<body>
<div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#proper_tail_calls" class="toc">Proper Tail Calls</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#lost_opportunity" class="toc">Lost Opportunity</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#tail_position" class="toc">Tail position</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#attribute_grammar" class="toc">Attribute grammar</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#expressions" class="toc">Expressions</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#statements" class="toc">Statements</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#clauses" class="toc">Clauses</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#functions" class="toc">Functions</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#declarations" class="toc">Declarations</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=harmony:proper_tail_calls&amp;do=export_html.html#references" class="toc">References</a></span></li>
</ul>
</div>
</div>

<a name="proper_tail_calls"></a><h1>Proper Tail Calls</h1>
<div class="level1">

<p>
 We need to define when a call is in <em>possible tail position</em> for safety purposes, and <em>proper tail position</em> for liveness purposes. An implementation MAY implement a call in possible tail position as a proper tail call (PTC) and MUST implement a call in proper tail position as a PTC. (Loosely speaking, implementing a call as a PTC is also known as <em>tail call optimization</em>.) The old <a href="doku.php%3Fid=proposals:proper_tail_calls.html" class="wikilink1" title="proposals:proper_tail_calls" onclick="return svchk()" onkeypress="return svchk()">ES4 proposal for proper tail calls</a> should be adapted to provide these definitions for ES-Harmony.
</p>

<p>
Since ES5/strict and ES-Harmony 
</p>
<ul>
<li class="level1"><div class="li"> poisons <code>&lt;function&gt;.caller</code> and <code>&lt;function&gt;.arguments</code>,</div>
</li>
<li class="level1"><div class="li"> prohibits <code>&lt;non-strict-function&gt;.caller</code> from revealing a strict function,</div>
</li>
<li class="level1"><div class="li"> poisons <code>arguments.callee</code> and <code>arguments.caller</code>, and</div>
</li>
<li class="level1"><div class="li"> does not join <code>arguments</code> with parameters</div>
</li>
</ul>

<p>
all calls in possible tail position MAY safely be implemented as PTC by our <a href="doku.php%3Fid=strawman:gc_semantics.html" class="wikilink1" title="strawman:gc_semantics" onclick="return svchk()" onkeypress="return svchk()">gc semantics</a> safety rule. 
</p>

<p>
When calculating the asymptotic space complexity of an algorithm, we are concerned with GC liveness, in which case we may assume that all calls in proper tail position are implemented as PTC. To support such assumptions, implementers MUST implement such calls as PTC. We model the call stack as a <em>gc root</em>. All active stack frames are strongly reachable from the call stack. All active local variables within a stack frame are strongly reachable from a stack frame. Once stack frame X initiates a PTC, X is no longer active, and so X&rsquo;s stack frame is no longer reachable from the call stack. X, and any objects which were transitively reachable only from X&rsquo;s local variables are thus no longer transitively reachable from roots, and so MUST eventually be collected, if needed to avoid failure from memory exhaustion. 
</p>
<hr noshade="noshade" size="1" />

<p>
Just a note after some offline conversation with Mark: he wants a distinction between the classic notion of tail position and what he calls &ldquo;possible tail position,&rdquo; but I am skeptical that the latter concept makes sense. I also don&rsquo;t think the distinction matters.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x64%3B%26%23x68%3B%26%23x65%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x63%3B%26%23x63%3B%26%23x73%3B%26%23x2e%3B%26%23x6e%3B%26%23x65%3B%26%23x75%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x64;&#x68;&#x65;&#x72;&#x6d;&#x61;&#x6e;&#x40;&#x63;&#x63;&#x73;&#x2e;&#x6e;&#x65;&#x75;&#x2e;&#x65;&#x64;&#x75;">Dave Herman</a> 2010/05/18 23:56</em>
</p>

</div>
<!-- SECTION [1-2118] -->
<a name="lost_opportunity"></a><h2>Lost Opportunity</h2>
<div class="level2">

<p>
 ES3 had reserved the identifier <code>goto</code>. ES4 had proposed that a call in tail-call position be considered a proper tail call only if preceded by <code>goto</code>, in which case the programmer could expect the PTC implementation implied by our liveness constraint above. If the programmer used <code>goto</code> on a call that cannot be implemented as PTC, this would be a static error. As a result, the programmer&rsquo;s PTC assumptions when reasoning about the asymptotic space complexity of their programs would be maintainable. A subtle change to a function call that preserved its normal semantics but lost its assumed PTC nature would also cause a static error.
</p>

<p>
Unfortunately, ES5 unreserved <code>goto</code>. Once unreserved, it would be too costly to reclaim it. None of the remaining reserved words are a plausible substitute.
</p>

</div>
<!-- SECTION [2119-2956] -->
<a name="tail_position"></a><h1>Tail position</h1>
<div class="level1">

<p>
 Part of specifying proper tail calls requires a specification of what are the <em>proper tail positions</em> of the language. In the <a href="doku.php%3Fid=proposals:proper_tail_calls.html" class="wikilink1" title="proposals:proper_tail_calls" onclick="return svchk()" onkeypress="return svchk()">ES4 proposal</a>, Lars and I made an initial attempt, but it was pretty buggy. Here&rsquo;s an updated spec. It will still need more scrutiny, but this is a start.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x64%3B%26%23x68%3B%26%23x65%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x63%3B%26%23x63%3B%26%23x73%3B%26%23x2e%3B%26%23x6e%3B%26%23x65%3B%26%23x75%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x64;&#x68;&#x65;&#x72;&#x6d;&#x61;&#x6e;&#x40;&#x63;&#x63;&#x73;&#x2e;&#x6e;&#x65;&#x75;&#x2e;&#x65;&#x64;&#x75;">Dave Herman</a> 2010/05/18 00:03</em>
</p>

</div>
<!-- SECTION [2957-3364] -->
<a name="attribute_grammar"></a><h2>Attribute grammar</h2>
<div class="level2">

<p>
 The spec is written as an <em>attribute grammar</em>. Attributes are properties of nodes in the abstract syntax tree. In general, attributes are either <em>synthesized</em> (computed bottom-up) or <em>inherited</em> (computed top-down). In this spec, there are only inherited attributes. (This is particularly pleasant for implementations, since it can easily be computed in any pass of a compiler or interpreter, with no need for an additional pass.) 
</p>
<table class="inline">
	<tr>
		<th class="leftalign"> Attribute   </th><th> Directionality </th><th class="leftalign"> Node type   </th><th class="leftalign"> Meaning                                                                     </th>
	</tr>
	<tr>
		<td class="leftalign"><code>tail</code>    </td><td class="leftalign"> inherited      </td><td class="leftalign"> expression  </td><td class="leftalign"> if <strong>true</strong>, the node is in tail position                                   </td>
	</tr>
	<tr>
		<td><code>wrapped</code></td><td class="leftalign"> inherited      </td><td class="leftalign"> all         </td><td> if <strong>true</strong>, no child expressions in the same function are in tail position </td>
	</tr>
</table>
<br />

</div>
<!-- SECTION [3365-4209] -->
<a name="expressions"></a><h2>Expressions</h2>
<div class="level2">
<pre class="code javascript">    E -&gt; E1 , E2                             E1.<span class="me1">tail</span> = <span class="kw2">false</span>
                                             E2.<span class="me1">tail</span> = E.<span class="me1">tail</span>
                                             E1.<span class="me1">wrapped</span> = E2.<span class="me1">wrapped</span> = E.<span class="me1">wrapped</span>
    E -&gt; E1 ? E2 : E3                        E2.<span class="me1">tail</span> = E3.<span class="me1">tail</span> = E.<span class="me1">tail</span>
                                             E1.<span class="me1">wrapped</span> = E2.<span class="me1">wrapped</span> = E3.<span class="me1">wrapped</span>
&nbsp;
    <span class="coMULTI">/* from the &quot;let expressions&quot; proposal */</span>
    E -&gt; let <span class="br0">&#40;</span>V1 = E1, ..., Vn = En<span class="br0">&#41;</span> <span class="br0">&#123;</span>       E1.<span class="me1">tail</span> = ... = En.<span class="me1">tail</span> = <span class="kw2">false</span>
             S1 ... <span class="me1">Sm</span>                       E<span class="br0">&#123;</span>n+<span class="nu0">1</span><span class="br0">&#125;</span>.<span class="me1">tail</span> = E.<span class="me1">tail</span>
         <span class="br0">&#125;</span>                                   S1.<span class="me1">wrapped</span> = ... = Sn.<span class="me1">wrapped</span> = S1.<span class="me1">wrapped</span> = ... = Sm.<span class="me1">wrapped</span> = E.<span class="me1">wrapped</span>
    E -&gt; let <span class="br0">&#40;</span>V1 = E1, ..., Vn = En<span class="br0">&#41;</span> <span class="br0">&#123;</span>       E1.<span class="me1">tail</span> = ... = En.<span class="me1">tail</span> = <span class="kw2">false</span>
             S1 ... <span class="me1">Sm</span> =&gt; E<span class="br0">&#123;</span>n+<span class="nu0">1</span><span class="br0">&#125;</span>             E<span class="br0">&#123;</span>n+<span class="nu0">1</span><span class="br0">&#125;</span>.<span class="me1">tail</span> = E.<span class="me1">tail</span>
         <span class="br0">&#125;</span>                                   S1.<span class="me1">wrapped</span> = ... = Sn.<span class="me1">wrapped</span> = S1.<span class="me1">wrapped</span> = ... = Sm.<span class="me1">wrapped</span> = E<span class="br0">&#123;</span>n+<span class="nu0">1</span><span class="br0">&#125;</span>.<span class="me1">wrapped</span> = E.<span class="me1">wrapped</span></pre>
</div>
<!-- SECTION [4210-5207] -->
<a name="statements"></a><h2>Statements</h2>
<div class="level2">
<pre class="code javascript">    S -&gt; <span class="br0">&#123;</span> S1 ... <span class="me1">Sn</span> <span class="br0">&#125;</span>                       S1.<span class="me1">wrapped</span> = ... = Sn.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
    S -&gt; E;                                  E.<span class="me1">tail</span> = <span class="kw2">false</span>
    S -&gt; <span class="kw1">do</span> S1 <span class="kw1">while</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span>                     S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                             E.<span class="me1">tail</span> = <span class="kw2">false</span>
    S -&gt; <span class="kw1">while</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span> S1                        S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                             E.<span class="me1">tail</span> = <span class="kw2">false</span>
    S -&gt; <span class="kw1">for</span> <span class="br0">&#40;</span>E1; E2; E3<span class="br0">&#41;</span> S1                 E1.<span class="me1">tail</span> = E2.<span class="me1">tail</span> = E3.<span class="me1">tail</span> = <span class="kw2">false</span>
                                             S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
    S -&gt; <span class="kw1">for</span> <span class="br0">&#40;</span>E1 <span class="kw1">in</span> E2<span class="br0">&#41;</span> S1                   E1.<span class="me1">tail</span> = E2.<span class="me1">tail</span> = <span class="kw2">false</span>
                                             S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
    S -&gt; <span class="kw1">if</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span> S1 <span class="kw1">else</span> S2                   S1.<span class="me1">wrapped</span> = S2.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                             E.<span class="me1">tail</span> = <span class="kw2">false</span>
    S -&gt; L: S1                               S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
    S -&gt; <span class="kw1">with</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span> S1                         S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                             E.<span class="me1">tail</span> = <span class="kw2">false</span>
&nbsp;
    <span class="coMULTI">/* tail unless wrapped by try */</span>
    S -&gt; <span class="kw1">return</span> E;                           E.<span class="me1">tail</span> = !s.<span class="me1">wrapped</span>
&nbsp;
    <span class="coMULTI">/* no tail positions inside */</span>
    S -&gt; <span class="kw1">try</span> S1 K                            S1.<span class="me1">wrapped</span> = <span class="kw2">true</span>
                                             K1.<span class="me1">wrapped</span> = ... = Kn.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
    S -&gt; <span class="kw1">try</span> S1 K <span class="kw1">finally</span> S2                 S1.<span class="me1">wrapped</span> = <span class="kw2">true</span>
                                             K1.<span class="me1">wrapped</span> = ... = Kn.<span class="me1">wrapped</span> = <span class="kw2">true</span>
                                             S2.<span class="me1">wrapped</span> = <span class="kw2">false</span>
&nbsp;
    S -&gt; <span class="kw1">throw</span> E;                            E.<span class="me1">tail</span> = <span class="kw2">false</span>
    S -&gt; <span class="kw1">switch</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span> C1 ... <span class="me1">Cn</span>                E.<span class="me1">tail</span> = <span class="kw2">false</span>
                                             C1.<span class="me1">wrapped</span> = ... = Cn.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span></pre>
</div>
<!-- SECTION [5208-6992] -->
<a name="clauses"></a><h2>Clauses</h2>
<div class="level2">
<pre class="code javascript">    K -&gt; <span class="kw1">catch</span> <span class="br0">&#40;</span>V<span class="br0">&#41;</span> S                         S.<span class="me1">wrapped</span> = K.<span class="me1">wrapped</span>
    C -&gt; <span class="kw1">case</span> E: S1 ... <span class="me1">Sn</span>                   E.<span class="me1">tail</span> = <span class="kw2">false</span>
                                             S1.<span class="me1">wrapped</span> = ... = Sn.<span class="me1">wrapped</span> = C.<span class="me1">wrapped</span>
    C -&gt; <span class="kw2">default</span>: S1 ... <span class="me1">Sn</span>                  E.<span class="me1">tail</span> = <span class="kw2">false</span>
                                             S1.<span class="me1">wrapped</span> = ... = Sn.<span class="me1">wrapped</span> = C.<span class="me1">wrapped</span></pre>
</div>
<!-- SECTION [6993-7401] -->
<a name="functions"></a><h2>Functions</h2>
<div class="level2">
<pre class="code javascript">    F -&gt; <span class="kw2">function</span> f<span class="br0">&#40;</span>x1,...,xn<span class="br0">&#41;</span> S             S.<span class="me1">wrapped</span> = <span class="kw2">false</span></pre>
</div>
<!-- SECTION [7402-7514] -->
<a name="declarations"></a><h2>Declarations</h2>
<div class="level2">
<pre class="code javascript">    D -&gt; <span class="kw2">var</span> x1 = E1, ..., xn = En;          E1.<span class="me1">tail</span> = ... = En.<span class="me1">tail</span> = <span class="kw2">false</span>
    D -&gt; let x1 = E1, ..., xn = En;          E1.<span class="me1">tail</span> = ... = En.<span class="me1">tail</span> = <span class="kw2">false</span>
    D -&gt; <span class="kw2">const</span> x1 = E1, ..., xn = En;        E1.<span class="me1">tail</span> = ... = En.<span class="me1">tail</span> = <span class="kw2">false</span></pre>
</div>
<!-- SECTION [7515-7799] -->
<a name="references"></a><h1>References</h1>
<div class="level1">

<p>
 <a href="doku.php%3Fid=proposals:proper_tail_calls.html" class="wikilink1" title="proposals:proper_tail_calls" onclick="return svchk()" onkeypress="return svchk()">ES4 proposal for proper tail calls</a> and <a href="doku.php%3Fid=discussion:proper_tail_calls.html" class="wikilink1" title="discussion:proper_tail_calls" onclick="return svchk()" onkeypress="return svchk()">discussion of that page</a>.
</p>

<p>
<a href="http://bugs.ecmascript.org/ticket/323" class="urlextern" target="_blank" title="http://bugs.ecmascript.org/ticket/323" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Trac ticket 323</a>, on implicit vs. explicit <code>goto</code> syntax, tail position assertion, etc.
</p>

<p>
<a href="http://www.schemers.org/Documents/Standards/R5RS/HTML/r5rs-Z-H-6.html#%_idx_78" class="urlextern" target="_blank" title="http://www.schemers.org/Documents/Standards/R5RS/HTML/r5rs-Z-H-6.html#%_idx_78" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Proper tail calls in Scheme</a>.
</p>

<p>
<a href="http://calculist.blogspot.com/2006/03/proper-tail-recursion-and-space.html" class="urlextern" target="_blank" title="http://calculist.blogspot.com/2006/03/proper-tail-recursion-and-space.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Dave Herman's blog on Clinger's proper tail calls</a>.
</p>

<p>
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=445363#c20" class="urlextern" target="_blank" title="https://bugzilla.mozilla.org/show_bug.cgi?id=445363#c20" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Brendan discovers that ES5/strict enables TCO</a>.
</p>

<p>
<a href="http://projectfortress.sun.com/Projects/Community/blog/ObjectOrientedTailRecursion" class="urlextern" target="_blank" title="http://projectfortress.sun.com/Projects/Community/blog/ObjectOrientedTailRecursion" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Guy Steele says OO requires tail call optimization</a>
</p>

<p>
<a href="http://gbracha.blogspot.com/2009/12/chased-by-ones-own-tail.html" class="urlextern" target="_blank" title="http://gbracha.blogspot.com/2009/12/chased-by-ones-own-tail.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Gilad Bracha on &quot;Steele's brilliant post&quot;</a> 
</p>

</div>
<!-- SECTION [7800-] -->
<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/9/90a374397d42777cd6abec9d676230cb.xhtml used -->
</body>
</html>
