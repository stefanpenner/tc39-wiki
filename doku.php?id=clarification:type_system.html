<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>clarification:type_system [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=clarification:type_system&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=clarification" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=clarification:type_system&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=clarification:type_system&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2007-07-03T13:01:54+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=clarification:type_system&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">clarification:type_system</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="clarification:type_system" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="clarification:type_system" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=clarification:dispatch_rules.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="clarification:dispatch_rules">dispatch_rules</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=clarification:package_semantics.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="clarification:package_semantics">package_semantics</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=clarification:which_prototype.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="clarification:which_prototype">which_prototype</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=clarification:multiple_compilation_units.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="clarification:multiple_compilation_units">multiple_compilation_units</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=clarification:type_system.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="clarification:type_system">type_system</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#notes" class="toc">Notes</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#the_unparameterized_type_system" class="toc">The unparameterized type system</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#primitive_types" class="toc">Primitive types</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#type_relationships" class="toc">Type relationships</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#union_types" class="toc">Union types</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#nullable_types" class="toc">Nullable types</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#other_built-in_types" class="toc">Other built-in types</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#type_environment" class="toc">Type environment</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#class_and_interface_types" class="toc">Class and interface types</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#literals" class="toc">Literals</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#function_types" class="toc">Function types</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#object_and_array_types" class="toc">Object and array types</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#conversions" class="toc">Conversions</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#the_parameterized_type_system" class="toc">The parameterized type system</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#types_for_literals" class="toc">Types for literals</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#relax-ng_types" class="toc">RELAX-NG types</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#notes_take_2" class="toc">Notes, take 2</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#abstract_syntax_for_types" class="toc">Abstract syntax for types</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#subtyping" class="toc">Subtyping</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#conversions" class="toc">Conversions</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#runtime_type_tags" class="toc">Runtime Type Tags</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#values" class="toc">Values</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#slots" class="toc">Slots</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#runtime_checks" class="toc">Runtime Checks</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#implementing_conversions" class="toc">Implementing Conversions</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#informative_notes_on_dynamic_optimization" class="toc">Informative notes on dynamic optimization</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#type_parameters" class="toc">Type Parameters</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#type_checking" class="toc">Type Checking</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:type_system.html#miscellaneous_not_yet_organized" class="toc">Miscellaneous (not yet organized)</a></span></li>
</ul>
</div>
</div>

<p>
I&rsquo;ve started a separate <a href="doku.php%3Fid=clarification:formal_type_system.html" class="wikilink1" title="clarification:formal_type_system" onclick="return svchk()" onkeypress="return svchk()">formal type system</a> page for discussion of the formal definition of the type system.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x64%3B%26%23x68%3B%26%23x65%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x63%3B%26%23x63%3B%26%23x73%3B%26%23x2e%3B%26%23x6e%3B%26%23x65%3B%26%23x75%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x64;&#x68;&#x65;&#x72;&#x6d;&#x61;&#x6e;&#x40;&#x63;&#x63;&#x73;&#x2e;&#x6e;&#x65;&#x75;&#x2e;&#x65;&#x64;&#x75;">Dave Herman</a> 2006/05/02 09:06</em>
</p>

<p>
The conclusion on the structural type system have been broken out as <a href="doku.php%3Fid=proposals:structural_types_and_typing_of_initializers.html" class="wikilink1" title="proposals:structural_types_and_typing_of_initializers" onclick="return svchk()" onkeypress="return svchk()">structural types and typing of initializers</a>, and there are many links off that proposal to type-related pages.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/05/23 04:12</em>
</p>

<p>
I&rsquo;m archiving some older, settled discussions under the <code>discussions:</code> namespace, trying to reclaim this page for its original purpose.  I&rsquo;m leaving links from here to the archival pages.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6a%3B%26%23x6f%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x6f%3B%26%23x72%3B%26%23x66%3B%26%23x66%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6a;&#x6f;&#x72;&#x65;&#x6e;&#x64;&#x6f;&#x72;&#x66;&#x66;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Jason Orendorff</a> 2007/07/03 06:00</em>
</p>

<a name="notes"></a><h1>Notes</h1>
<div class="level1">

<p>
 My current type system notes.   &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/04/07 03:20</em>
</p>

</div>

<a name="the_unparameterized_type_system"></a><h2>The unparameterized type system</h2>
<div class="level2">

</div>

<a name="primitive_types"></a><h3>Primitive types</h3>
<div class="level3">

<p>
 These are the primitive types:  
</p>
<ul>
<li class="level1"><div class="li"> #VOID</div>
</li>
<li class="level1"><div class="li"> #NULL</div>
</li>
<li class="level1"><div class="li"> #OBJECT</div>
</li>
</ul>

</div>

<a name="type_relationships"></a><h3>Type relationships</h3>
<div class="level3">

<p>
 Any type is a subtype of itself:
</p>
<pre class="code">
     t &lt;: t
</pre>

<p>
Relationships for other types are given below.
</p>

</div>

<a name="union_types"></a><h3>Union types</h3>
<div class="level3">

<p>
 Union types have the following structure:
</p>
<pre class="code">
      (union t1 .. tn)
</pre>

<p>
where the types are distinct and the ordering of the t1 .. tn has no impact on the meaning of the type.
</p>

<p>
The built-in type #ANY, written simply &ldquo;*&rdquo;, is a union type:
</p>
<pre class="code">
      #ANY = (union #VOID #NULL #OBJECT)
</pre>

<p>
A type t is a subtype of a union type (sum t1 .. tn) if it is a subtype of any of the constituent types t1 .. tn:
</p>
<pre class="code">
      t &lt;: (union t1 .. tn) iff (t &lt;: t1) or ... or (t &lt;: tn)
</pre>

<p>
A union type s is a subtype of another type t if every member of s is a subtype of t:
</p>
<pre class="code">
      (union s1 .. sn) &lt;: t iff s1 &lt;: t and ... and sn &lt;: t
</pre>

<p>
Union types are flattened when included in a union:
</p>
<pre class="code">
      (union (union s1 ... sn) t1) =&gt; (union s1 ... sn t1)
</pre>

</div>

<a name="nullable_types"></a><h3>Nullable types</h3>
<div class="level3">

<p>
 A &ldquo;nullable type&rdquo;, written &ldquo;?typename&rdquo;, is a union type with #NULL:
</p>
<pre class="code">
      ?Object = (union #OBJECT #NULL)
</pre>

<p>
A &ldquo;non-nullable type&rdquo;, written &ldquo;typename!&rdquo;, is a type that is not a union with #NULL:
</p>
<pre class="code">
      Object! = #OBJECT
</pre>

<p>
You can&rsquo;t write &ldquo;?typename!&rdquo;, &ldquo;??typename&rdquo;, or similar nonsense; the compiler  will yell at you if you do.  See <a href="doku.php%3Fid=proposals:syntax_for_type_expressions.html" class="wikilink1" title="proposals:syntax_for_type_expressions" onclick="return svchk()" onkeypress="return svchk()">syntax for type expressions</a>.
</p>

<p>
The rules for the nullability operators are:
</p>
<pre class="code">
      ?(union #NULL x) -&gt; (union #NULL x)
      ?x               -&gt; (union #NULL x)
      (union #NULL x)! -&gt; x
      x!               -&gt; x 
</pre>

</div>

<a name="other_built-in_types"></a><h3>Other built-in types</h3>
<div class="level3">

<p>
 In addition to #VOID, #NULL, #OBJECT, and #ANY there are built-in types  #STRING, #NUMBER, #BOOLEAN, #ARRAY, #REGEXP, #DATE, #NAMESPACE, #INT,  and #UINT, all of which are direct subtypes of #OBJECT.  (Yes, even  #INT and #UINT, though it would seem more natural if these were seen  as subtypes of #NUMBER?)
</p>

</div>

<a name="type_environment"></a><h3>Type environment</h3>
<div class="level3">

<p>
 The type environment maps type names to type values.  
</p>

<p>
The initial type environment contains the following bindings:
</p>
<pre class="code">
    Object    -&gt; (sum #NULL #OBJECT)
    String    -&gt; (sum #NULL #STRING)
    Number    -&gt; #NUMBER
    Boolean   -&gt; #BOOLEAN
    Array     -&gt; (sum #NULL #ARRAY)
    RegExp    -&gt; (sum #NULL #REGEXP)
    Date      -&gt; (sum #NULL #DATE)
    int       -&gt; #INT
    uint      -&gt; #UINT
</pre>

</div>

<a name="class_and_interface_types"></a><h3>Class and interface types</h3>
<div class="level3">

<p>
 Class and interface definitions introduce bindings for nullable types named  by the class and interface names.  Thus a class name C maps to the type  (sum C.class #NULL) in the type environment.
</p>

<p>
The #NULL part of the type is stripped away when the class or interface is used in contexts where it is not meaningful, notably when the class or interface is used to define a derived class or interface.
</p>

<p>
Class types have the following structure:
</p>
<pre class="code">
      (class &lt;name&gt; (extends &lt;classtype&gt; ...) 
                    (implements &lt;interfacetype&gt; ...)
                    (methods &lt;functiontype&gt; ...)
                    (properties &lt;type&gt; ...)
                    (attributes XXX ...))
</pre>

<p>
The &ldquo;extends&rdquo; list lists all classes that this class extends, in inheritance order from most specific superclass to least specific.  The last class in the list is always #OBJECT.
</p>

<p>
The &ldquo;implements&rdquo; list lists all interfaces that this class implements, without duplicates, sorted in lexicographic order by the interface name.
</p>

<p>
 Interface types have the following structure:
</p>
<pre class="code">
      (interface &lt;name&gt; (extends &lt;interfacetype&gt; ...)
                        (methods &lt;functiontype&gt; ...)
                        (attributes XXX ...))
</pre>

<p>
The &ldquo;extends&rdquo; list lists all interfaces that this class extends, without duplicates, sorted in lexicographic order by the interface name.
</p>

<p>
Class names and interface names are fully qualified by their package names.
</p>

<p>
Class and interface names are globally unique since duplicate names aren&rsquo;t  allowed in the same package scope and the package name acts as a prefix on classes and interfaces inside the package.
</p>

<p>
A class D is a subtype of type B if B appears on D&rsquo;s extends list, ie, D=B or there exist classes D=C1 .. Cn=B in the program forming a chain of direct  superclasses from D to B.
</p>

<p>
A class D is of interface type I if I appears on D&rsquo;s implements list.
</p>

<p>
An interface I extends an interface type J if J appears on I&rsquo;s extends list.
</p>

<p>
A class D may have a class B on its extends list iff:
</p>
<ul>
<li class="level1"><div class="li"> (many rules here)</div>
</li>
</ul>

<p>
 A class D may have an interface I on its implements list iff:
</p>
<ul>
<li class="level1"><div class="li"> (many rules here)</div>
</li>
</ul>

<p>
 An interface I may have an interface J on its extends list iff:
</p>
<ul>
<li class="level1"><div class="li"> (many rules here)</div>
</li>
</ul>

</div>

<a name="literals"></a><h3>Literals</h3>
<div class="level3">
<pre class="code">
Integer in range -2^31..2^31-1            #INT
Integer in 2^31..2^32-1                   #UINT
Number outside #INT/#UINT range           #NUMBER
null                                      #NULL
true, false                               #BOOLEAN
{ field, ... }                            #OBJECT
[ value, ... ]                            #ARRAY
&quot;...&quot; or '...'                            #STRING
/.../...                                  #REGEXP
</pre>

</div>

<a name="function_types"></a><h3>Function types</h3>
<div class="level3">

<p>
 Function types have the following structure:
</p>
<pre class="code">
      (function (t1 .. tn) a? tt tr)
</pre>

<p>
where <code>t1</code> through <code>tn</code> are the types of the formal arguments; <code>a?</code> is a flag saying whether the last parameter is a rest argument; <code>tt</code> is the constrained type of <code>this</code>; and <code>tr</code> is the return type.
</p>

<p>
If <code>a?</code> is true then <code>tn</code> is always an Array type.
</p>

<p>
A function definition yields a function type for the function, but this type is unnamed and not present in the type environment.
</p>

<p>
A syntax for defining both unnamed and named function types is described in the proposal <a href="doku.php%3Fid=proposals:syntax_for_function_types.html" class="wikilink1" title="proposals:syntax_for_function_types" onclick="return svchk()" onkeypress="return svchk()">syntax for function types</a>. 
</p>

<p>
The relationship (function (f1 .. fn) fa? ft fr) &lt;: (function (g1 .. gn) ga? gt gr) if
</p>
<ul>
<li class="level1"><div class="li"> gi &lt;: fi for all i</div>
</li>
<li class="level1"><div class="li"> gt &lt;: ft</div>
</li>
<li class="level1"><div class="li"> fr &lt;: gr</div>
</li>
<li class="level1"><div class="li"> fa? = ga?</div>
</li>
</ul>

</div>

<a name="object_and_array_types"></a><h3>Object and array types</h3>
<div class="level3">

<p>
 Structural object types (sometimes called record types) provide a partial description (a view) of the structure of an object.
</p>

<p>
Record types provide useful types to the object system of the ECMAScript 3 sublanguage.  While it&rsquo;s possible to talk about this sublanguage using the type <code>Object</code> for the types of the objects constructed, stored, passed, and returned, doing so provides very little information in a language where everything&rsquo;s derived from <code>Object</code>.  Record types allow these objects to be described more carefully.
</p>

<p>
Record types are for now only described in terms of plain ECMAScript 3 objects.
</p>

<p>
At this time it is unclear what adding record types to the language will do to the language, especially in terms of the performance of dynamic type checking.  The way they are written up here, record types are like undeclared interfaces: a datum of any type may conform to a record type at run-time.  
</p>

<p>
A record type has this structure: 
</p>
<pre class="code">  (object (name1 type1) ...)</pre>

<p>
 The type states that any object conforming to the type contains the named fields with the given types (or subtypes thereof).
</p>

<p>
Array types are simply object types: 
</p>
<pre class="code">  (object (0 t1) ... (* tn) (length uint))</pre>

<p>
 where the field name * signifies all nonnegative integer names below 2^32 not mentioned elsewhere in the list of fields.
</p>

<p>
Subtyping of object types is straightforward: 
</p>
<pre class="code">  (object (x t)) &lt;: (object)</pre>

<p>
 for any x and t, and 
</p>
<pre class="code">  (object (x t1)) &lt;: (object (x t2))</pre>

<p>
 if <code>t1 &lt;: t2</code>.
</p>

<p>
The subtyping rule extends to instances of classes: consider 
</p>
<pre class="code">  class C {
      var x : int, y : int;
  }</pre>

<p>
 We have that  
</p>
<pre class="code">  C &lt;: (object (x int) (y int))</pre>

<p>
 (though not in the other direction).
</p>

</div>

<a name="conversions"></a><h3>Conversions</h3>
<div class="level3">

<p>
 A type A can be used where another type B is expected even if A is not a  subtype of B, provided a run-time conversion exists from values of type A  to values of type B.  The conversions may only apply in some contexts.
</p>

<p>
The following conversions are built-in.
</p>

<p>
Always valid:
</p>
<pre class="code">
   #INT          -&gt; #NUMBER
   #UINT         -&gt; #NUMBER
   #NUMBER       -&gt; #INT
   #NUMBER       -&gt; #UINT
   #INT          -&gt; #UINT
   #UINT         -&gt; #INT
</pre>

<p>
(At this point it should be clear that int and uint are just hints to the compiler to generate better code.)
</p>

<p>
The following conversion applies in conditional-expression contexts, ie, in  do-while, if, for, and while statements and in conditional expressions:
</p>
<pre class="code">
   #ANY          -&gt; #BOOLEAN
</pre>

<p>
(There are others.)
</p>

</div>

<a name="the_parameterized_type_system"></a><h2>The parameterized type system</h2>
<div class="level2">

<p>
 Class, interface, and function types can be parameterized.  A parameterized type is seen as a function from types to types.
</p>

<p>
Parameterized types appear in the type environment with a structure that looks like this:
</p>
<pre class="code">
    (ptype (I1 .. In) Tr)
</pre>

<p>
where the I1 .. In are just parameter names and the T is a template into which the actual (type) values of the I1 .. In are inserted to create a new type.
</p>

<p>
Thus the mapping
</p>
<pre class="code">
    Pair -&gt; (ptype (I1 I2) (class (Pair I1 I2) ... 
                                  (methods ((head (function () I1)) 
                                            (tail (function () I2))))))
</pre>

<p>
applied to #INT, #STRING becomes the class type
</p>
<pre class="code">
    (class Pair#INT#STRING
           (methods ((head (function () #INT)) 
                     (tail (function () #STRING))))))
</pre>

<p>
Parameterized types applied to the same parameters yield types that are equal, ie, <code>Pair(int,String) = Pair(int,String)</code>.
</p>

</div>

<a name="types_for_literals"></a><h1>Types for literals</h1>
<div class="level1">

<p>
 See <a href="doku.php%3Fid=discussion:object_literals_type_of.html" class="wikilink1" title="discussion:object_literals_type_of" onclick="return svchk()" onkeypress="return svchk()">object literals, type of</a>.
</p>

</div>

<a name="relax-ng_types"></a><h1>RELAX-NG types</h1>
<div class="level1">

<p>
 I mentioned this above, but it got passed over. I suspect we&rsquo;re just too late in the process for ES4 to support anything like it, but I feel I&rsquo;d be doing a disservice if I didn&rsquo;t suggest that we at least <em>leave room</em> for types which are compatible with RELAX-NG / Xduce / Cduce in the future. 
</p>

<p>
Briefly, this is a type system: 
</p>
<ul>
<li class="level1"><div class="li"> Oriented towards typing <acronym title="Extensible Markup Language">XML</acronym> documents (<acronym title="Extensible Markup Language">XML</acronym> people call types &ldquo;schemas&rdquo;)</div>
</li>
<li class="level1"><div class="li"> Supporting types which are structural combinations of named elements and attributes</div>
</li>
<li class="level1"><div class="li"> Structural combination rules are similar to regular expressions: </div>
<ul>
<li class="level2"><div class="li"> Sequence, Alternation, Kleene-star</div>
</li>
</ul>
</li>
</ul>

<p>
 Note that we are already talking about supporting structural array types with simple sequential specification (interpreted as records with integer fields), and permitting Kleene-star <em>in tail position</em> of such types. So we&rsquo;re not necessarily very far from RELAX-NG types.
</p>

<p>
Possible advantages here involve trying to improve the types in E4X; currently I think they&rsquo;ll all just wind up with <code><acronym title="Extensible Markup Language">XML</acronym></code> or <code><acronym title="Document Object Model">DOM</acronym></code> type. It might be nice to be able to say <em>which kind</em> of <acronym title="Extensible Markup Language">XML</acronym> document a function takes.
</p>

<p>
Another possible applpication is in writing typed destructuring assignments on <acronym title="Extensible Markup Language">XML</acronym> documents or regexps. I can only vaguely imagine what a syntax for that might look like.
</p>
<pre class="code">
// Bind a sequence of meta tags to m
let m : &lt;meta&gt;*;
&lt;&gt;&lt;html&gt;&lt;head&gt;&lt;{meta*: m}&gt;&lt;/head&gt;&lt;{*}&gt;&lt;/html&gt;&lt;/&gt; = xhtml_producer();
</pre>

<p>
Ugh, I sort of wish I hadn&rsquo;t written this note. But there it is. Is it worth leaving the door open? Is the parser for type expressions in a safe enough corner of the grammar that we&rsquo;ll be safe sticking <code>*</code> and <code>+</code> and whatnot in there in the future?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/05/12 17:11</em>
</p>

<p>
Graydon, see &ldquo;The <acronym title="Extensible Markup Language">XML</acronym> connection&rdquo; near the bottom of <a href="doku.php%3Fid=proposals:destructuring_assignment.html" class="wikilink1" title="proposals:destructuring_assignment" onclick="return svchk()" onkeypress="return svchk()">destructuring assignment</a> &ndash; Ed proposed something like this in a meeting (at Adobe in SF, <acronym title="If I remember correctly">IIRC</acronym>) in thinking about destructuring using object and array &ldquo;literals&rdquo;, and other &ldquo;literals&rdquo;, to which Lars replied &ldquo;provocative!&rdquo; and wrote up that paragraph.
</p>

<p>
There&rsquo;s clearly something here.  Since we are not folding E4X into Edition 4, I would like to see this pursued in the &ldquo;E4X for ES4&rdquo; update. You are quite right that E4X needs something very much like the type systems developed by Pierce et al.
</p>

<p>
In the mean time, for ES4, what should we do to future-proof?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2006/05/13 17:02</em>
</p>

<p>
I&rsquo;m not sure we know what to do to future-proof. I think at least: 
</p>
<ul>
<li class="level1"><div class="li"> The type system, formally, has to be OK supporting it. We currently have type constructors for sequences (in arrays) with trailing kleene stars. We&rsquo;d need to be sure that sequences of elements with arbitrary kleene stars and alternatives can participate in the type system without ruining the type and subtype judgments.</div>
</li>
<li class="level1"><div class="li"> The type grammar needs to have some room for extension, so we can <em>denote</em> such types.</div>
</li>
<li class="level1"><div class="li"> (Optionally) the destructuring assignment grammar needs to have some room for extension.</div>
</li>
</ul>

<p>
 It&rsquo;s good to hear that this round will not be including merger with E4X; we&rsquo;ve mentioned it so many times during discussion that I wasn&rsquo;t sure.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/05/16 12:04</em>
</p>

<p>
We started our discussion of structural types by imagining that primitive types like <code>Function</code>, <code>Array</code>, and <code>Object</code> would have type parameters, but we now have dedicated syntax for these. I propose we eliminate the type parameters from <code>Function</code>, <code>Array</code>, and <code>Object</code>, since we don&rsquo;t have a way of expressing variable-arity type parameters, which would make it impossible to implement these classes in ECMAScript a la <a href="doku.php%3Fid=proposals:builtin_classes.html" class="wikilink1" title="proposals:builtin_classes" onclick="return svchk()" onkeypress="return svchk()">builtin classes</a>. I would think it&rsquo;d be far more trouble than it&rsquo;s worth to add variable-arity type parameters just for these three special cases, especially since it&rsquo;s duplicating functionality we already get from the <code>function</code>, <code>[..]</code>, and <code>{..}</code> type constructor syntax.
</p>

<p>
So I propose that types <code>Function</code>, <code>Array</code>, and <code>Object</code> are unparameterized classes. From the standpoint of the type checker, these types are interchangeable with <code>function(this:*, ...rest:*):*</code>, <code>[*]</code>, and <code>{}</code>, respectively. If programmers want more precise structural types they should use the structural type syntax.
</p>

<p>
Does that sound reasonable?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x64%3B%26%23x68%3B%26%23x65%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x63%3B%26%23x63%3B%26%23x73%3B%26%23x2e%3B%26%23x6e%3B%26%23x65%3B%26%23x75%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x64;&#x68;&#x65;&#x72;&#x6d;&#x61;&#x6e;&#x40;&#x63;&#x63;&#x73;&#x2e;&#x6e;&#x65;&#x75;&#x2e;&#x65;&#x64;&#x75;">Dave Herman</a> 2006/08/11 17:16</em>
</p>

<p>
Yes, it sounds reasonable.  (I&rsquo;d much rather write <code>[int]</code> than <code>Array.&lt;int&gt;</code> anyway.)
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/08/23 09:28</em>
</p>

</div>

<a name="notes_take_2"></a><h1>Notes, take 2</h1>
<div class="level1">

<p>
 <strong>These were moved here from <a href="doku.php%3Fid=spec:type_system.html" class="wikilink1" title="spec:type_system" onclick="return svchk()" onkeypress="return svchk()">type_system</a> on 2007/03/11 by Dave.</strong>
</p>

<p>
Beginnings of a draft spec unifying all the aspects of the type system.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x64%3B%26%23x68%3B%26%23x65%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x63%3B%26%23x63%3B%26%23x73%3B%26%23x2e%3B%26%23x6e%3B%26%23x65%3B%26%23x75%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x64;&#x68;&#x65;&#x72;&#x6d;&#x61;&#x6e;&#x40;&#x63;&#x63;&#x73;&#x2e;&#x6e;&#x65;&#x75;&#x2e;&#x65;&#x64;&#x75;">Dave Herman</a> 2006/08/11 17:03</em>
</p>

</div>

<a name="abstract_syntax_for_types"></a><h1>Abstract syntax for types</h1>
<div class="level1">

<p>
 Types :
</p>
<pre class="code ebnf">T ::= *
   |  Identifier
   |  (FUNCTION (THIS T) (ARGS T1 .. Tn) REST? (RETURN T))  // REST is a type, or the null pointer
   |  (UNION T ..)                                // Ordered, for conversions
   |  (OBJECT (Identifier T) ..)
   |  (ARRAY T .. T) // last element is a &quot;rest&quot; type
   |  (PARAMETERIZED Identifier T ...)

// these are a subset of Identifier
P ::= intrinsic::Null
   |  intrinsic::Undefined
   |  intrinsic::Boolean
   |  intrinsic::String
   |  intrinsic::Number
   |  intrinsic::int
   |  intrinsic::uint
   |  intrinsic::double
   |  intrinsic::decimal
   |  intrinsic::Date
   |  intrinsic::RegExp
</pre>
<p>
The above are an abstract syntax for types. Parsing involves resolving various issues, including: 
</p>
<ul>
<li class="level1"><div class="li"> <code>intrinsic::Null</code> is always explicit in abstract syntax</div>
</li>
<li class="level2"><div class="li"> <code>!</code> is translated by removing <code>intrinsic::Null</code></div>
</li>
<li class="level2"><div class="li"> <code>?</code> is translated as <code>(UNION intrinsic::Null T)</code></div>
</li>
</ul>

<p>
 Type arguments are always optional; any missing required type parameters are bound to <code>*</code>. It is a semantic error for a type argument list to be longer than its corresponding type parameter list.
</p>
<pre class="code">
type pairint = [int,int]
type pair.&lt;T&gt; = [T,T];
</pre>

<p>
 In the context of the above type definitions, we consider the type name <code>pairint</code> to simply be an abbreviation for <code>[int,int]</code>, and so references to <code>pairint</code> are actually replaced by <code>[int,int]</code> at some stage during parsing. 
</p>

<p>
This approach also extends to parameterized type definitions, and so <code>pair.&lt;int&gt;</code> is also replaced by <code>[int,int]</code> during parsing. Note that an unparameterized reference to <code>pair</code> would be equivalent to <code>pair.&lt;*&gt;</code> or <code>[*,*]</code>.
</p>

<p>
Thus, in the AST, the only occurrences of (PARAMETERIZED Id ...) is for parameterized class and interface types.
</p>

</div>

<a name="subtyping"></a><h1>Subtyping</h1>
<div class="level1">

<p>
 There are two relationships between types: subtyping and conversion (described below). A type <code>T1</code> is a subtype of another type <code>T2</code> if, conceptually, anything you can do with a <code>T2</code> you can do with a <code>T1</code> (i.e., a <code>T1</code> &ldquo;is a&rdquo; <code>T2</code>).  We use the symbol &lt;: to mean subtyping. 
</p>

<p>
The subtyping relation is defined by the following (incomplete) set of rules:
</p>
<ul>
<li class="level1"><div class="li"> Subtyping is reflexively and transitively closed.</div>
</li>
<li class="level1"><div class="li"> The type * is the maximal type, that is, every type is a subtype of *.</div>
</li>
<li class="level1"><div class="li"> The <code>(ARRAY)</code> type is equivalent to <code>intrinsic::Array</code>. </div>
</li>
<li class="level1"><div class="li"> The <code>(FUNCTION (THIS ?) (ARGS) * (RETURN *))</code> type is equivalent to <code>intrinsic::Function</code>. </div>
</li>
<li class="level1"><div class="li"> The <code>(OBJECT)</code> type is equivalent to <code>intrinsic::Object</code>.</div>
</li>
<li class="level1"><div class="li"> Record subtyping is covariant, even though record fields are mutable, thus requiring a check on field writes (much like with arrays in Java). In more detail, a record type <code>(OBJECT (Id1 S1) ... (Idm Sm))</code> is a subtype of <code>(OBJECT (Id1 T1) ... (Idn Tn))</code> if</div>
<ul>
<li class="level2"><div class="li"> m ≤ n</div>
</li>
<li class="level2"><div class="li"> the identifiers Id1 .. Idm match  (ordering does not matter)</div>
</li>
<li class="level2"><div class="li"> each type Si (for 1 ≤ i ≤ m) is a subtype of Ti</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> For union types, <code>(UNION S1 .. Sm)</code> is a subtype of <code>(UNION T1 .. Tn)</code> if each Si is a subtype of some Tj.</div>
<ul>
<li class="level2"><div class="li"> We consider any type T to be equivalent to the singleton union type <code>(UNION T)</code>. </div>
</li>
<li class="level2"><div class="li"> Thus, a non-union type S is a subtype of <code>(UNION T1 .. Tn)</code> if S is a subtype of some Tj. </div>
</li>
<li class="level2"><div class="li"> Similarly, <code>(UNION S1 .. Sm)</code> is a subtype of a non-union type T  if each Si is a subtype of T.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Like records, array subtyping is convariant, and again requires a write-barrier check. Array subtyping is complicated somewhat by the presence of rest type. Specifically, <code>(ARRAY S1 .. Sm)</code> is a subtype of <code>(ARRAY T1 .. Tn)</code> if</div>
<ul>
<li class="level2"><div class="li"> Si &lt;: Ti for each 1 ≤ i ≤ min(m,n)</div>
</li>
<li class="level2"><div class="li"> Si &lt;: Tn for each n &lt; i ≤ m</div>
</li>
<li class="level2"><div class="li"> Sm &lt;: Ti for each m &lt; i ≤ n</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Function subtyping is complicated by the presence of rest arguments. Specifically, <code>(FUNCTION (THIS U)  (ARGS S1  .. Sm) V (RETURN T))</code> is a subtype of <code>(FUNCTION (THIS U&rsquo;) (ARGS S1&rsquo; .. Sn&rsquo;) V&rsquo; (RETURN T&rsquo;))</code>     provided that</div>
<ul>
<li class="level2"><div class="li"> U&rsquo; &lt;: U (contravariant subtyping on the <code>THIS</code> argument)</div>
</li>
<li class="level2"><div class="li"> Si&rsquo; &lt;: Si for 1 ≤ i ≤ min(m,n) (contravariant subtyping on arguments)</div>
</li>
<li class="level2"><div class="li"> T &lt;: T&rsquo; (covariant subtyping on the result)</div>
</li>
<li class="level2"><div class="li"> In addition, one of the following three cases must hold:</div>
<ol>
<li class="level3"><div class="li"> Neither function type has rest arguments:</div>
<ul>
<li class="level4"><div class="li"> V = V&rsquo; = null</div>
</li>
<li class="level4"><div class="li"> m = n (both argument lists are the same length).</div>
</li>
</ul>
</li>
<li class="level3"><div class="li"> Only the first function type has rest arguments:</div>
<ul>
<li class="level4"><div class="li"> V&rsquo; = null but V != null</div>
</li>
<li class="level4"><div class="li"> m ≤ n </div>
</li>
<li class="level4"><div class="li"> Si&rsquo; &lt;: V for m &lt; i ≤ n.</div>
</li>
</ul>
</li>
<li class="level3"><div class="li"> Both function types have rest arguments:</div>
<ul>
<li class="level4"><div class="li"> V != null and V&rsquo; != null</div>
</li>
<li class="level4"><div class="li"> Si&rsquo; &lt;: V for m &lt; i ≤ n </div>
</li>
<li class="level4"><div class="li"> V&rsquo; &lt;: S for n &lt; i ≤ m </div>
</li>
<li class="level4"><div class="li"> V&rsquo; &lt;: V</div>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Subtyping of classes reflects the inheritance hierarchy. That is, if class C extends D, then C is a subtype of D. </div>
</li>
<li class="level1"><div class="li"> This rule gets more complicated in the presence of parameterized class definitions, such as <code>class C.&lt;A1, .., Am&gt; extends D.&lt;T1 .. Tn&gt;</code>. In this case, the instantiated class type <code>(PARAMETERIZED C S1 .. Sm)</code> is a subtype of <code>(PARAMETERIZED D  T1&rsquo; .. Tn&rsquo;)</code>, where each Ti&rsquo; is obtained from T&rsquo; by replacing each reference to a formal type parameter Aj by the corresponding actual type parameter Sj. </div>
</li>
<li class="level1"><div class="li"> A similar rule applies to classes implementing interfaces, and interfaces extending other interfaces.</div>
</li>
<li class="level1"><div class="li"> Each class type is also a subtype of the corresponding object type. That is, given a class declaration</div>
</li>
</ul>
<pre class="code">
    class C {
        var x : int, y : int;
    }
</pre>

<p>
 we have that C is a subtype of <code>(OBJECT (x int) (y int))</code> (though not in the other direction).
</p>
<hr noshade="noshade" size="1" />

<p>
For record subtyping, don&rsquo;t you want m &gt;= n and the bounds in the next two rules to use n instead of m?  The way I read this, a record {x:T1, y:T2} cannot be a subtype of {x:T1} but that seems wrong.
</p>

<p>
I also think <code>intinsic::Function</code> is more complex than you make it, because Function is a class with several instance properties.  It&rsquo;s more like a union of a nominal type (capturing its data structure nature) and the function type you list.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/09/21 07:54</em>
</p>

</div>

<a name="conversions"></a><h1>Conversions</h1>
<div class="level1">

<p>
 Some types, such as <code>int</code> and <code>double</code>, are not subtypes of one another but are still related: it&rsquo;s possible to use an <code>int</code> as a <code>double</code> via a runtime conversion. This is the conversion relationship: the type <code>int</code> is <em>convertible</em> to <code>double</code>. There are a number of places where type conversions occur, e.g.: 
</p>
<ul>
<li class="level1"><div class="li"> interconvertible base types like <code>int</code> and <code>double</code></div>
</li>
<li class="level1"><div class="li"> using something of type * in a statically typed context</div>
</li>
<li class="level1"><div class="li"> structural types with convertible component types</div>
</li>
</ul>

<p>
 In each conversion, a value that has a given tag needs to be converted to some other type. This check for convertibility is performed statically, although the conversion itself is performed at runtime. The symbol ~&lt;: means convertible. For example, int ~&lt;: double.
</p>

<p>
The following rules clarify which types are convertible to other types. Convertibility is closely related to, but more general than subtyping, and many of the convertibility rules are quite similar to corresponding subtyping rules. 
</p>
<ul>
<li class="level1"><div class="li"> Any type is convertable to boolean.</div>
</li>
<li class="level1"><div class="li"> The type * is convertible to every type</div>
</li>
<li class="level1"><div class="li"> If S is a subtype of T, then S is (trivially) convertable to T.</div>
</li>
<li class="level1"><div class="li"> Convertibility is reflexive, but (unlike subtyping) not transitive. For example, int is convertiable to *, and * is convertable to string, but int is <u>not</u> convertable to string.</div>
</li>
<li class="level1"><div class="li"> For union types, (UNION S1 .. Sm) is convertable to (UNION T1 .. Tn) if each Si is convertable to some Tj. <strong>NOTE: What to do about ambiguity?</strong></div>
</li>
<li class="level1"><div class="li"> <code>intrinsic::Array</code> is convertable to any <code>(ARRAY ...)</code> type.</div>
</li>
<li class="level1"><div class="li"> <code>intrinsic::Function</code> is convertable to any <code>(FUNCTION...)</code> type.</div>
</li>
<li class="level1"><div class="li"> <code>intrinsic::Object</code> is convertable to any <code>(OBJECT...)</code> type.</div>
</li>
<li class="level1"><div class="li"> <code>(ARRAY S1 .. Sm)</code> is convertable to <code>(ARRAY T1 .. Tn)</code> if</div>
<ul>
<li class="level2"><div class="li"> Si ~&lt;: Ti for each 1 ≤ i ≤ min(m,n)</div>
</li>
<li class="level2"><div class="li"> Si ~&lt;: Tn for each n &lt; i ≤ m</div>
</li>
<li class="level2"><div class="li"> Sm ~&lt;: Ti for each m &lt; i ≤ n</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> A record type <code>(OBJECT (Id1 S1) ... (Idm Sm))</code> is convertable to <code>(OBJECT (Id1 T1) ... (Idn Tn))</code> if</div>
<ul>
<li class="level2"><div class="li"> m ≤ n</div>
</li>
<li class="level2"><div class="li"> the identifiers Id1 .. Idm match</div>
</li>
<li class="level2"><div class="li"> each type Si (for 1 ≤ i ≤ m) is convertable to Ti</div>
</li>
</ul>
</li>
<li class="level1"><div class="li">  <code>(FUNCTION (THIS U)  (ARGS S1  .. Sm) V (RETURN T))</code> is convertable to <code>(FUNCTION (THIS U&rsquo;) (ARGS S1&rsquo; .. Sn&rsquo;) V&rsquo; (RETURN T&rsquo;))</code>     provided that</div>
<ul>
<li class="level2"><div class="li"> U&rsquo; ~&lt;: U  </div>
</li>
<li class="level2"><div class="li"> Si&rsquo; ~&lt;: Si for 1 ≤ i ≤ min(m,n)  </div>
</li>
<li class="level2"><div class="li"> T ~&lt;: T&rsquo;  </div>
</li>
<li class="level2"><div class="li"> In addition, one of the following three cases must hold:</div>
<ol>
<li class="level3"><div class="li"> Neither function type has rest arguments:</div>
<ul>
<li class="level4"><div class="li"> V = V&rsquo; = null</div>
</li>
<li class="level4"><div class="li"> m = n (both argument lists are the same length).</div>
</li>
</ul>
</li>
<li class="level3"><div class="li"> Only the first function type has rest arguments:</div>
<ul>
<li class="level4"><div class="li"> V&rsquo; = null but V != null</div>
</li>
<li class="level4"><div class="li"> m ≤ n </div>
</li>
<li class="level4"><div class="li"> Si&rsquo; ~&lt;: V for m &lt; i ≤ n.</div>
</li>
</ul>
</li>
<li class="level3"><div class="li"> Both function types have rest arguments:</div>
<ul>
<li class="level4"><div class="li"> V != null and V&rsquo; != null</div>
</li>
<li class="level4"><div class="li"> Si&rsquo; ~&lt;: V for m &lt; i ≤ n </div>
</li>
<li class="level4"><div class="li"> V&rsquo; ~&lt;: S for n &lt; i ≤ m </div>
</li>
<li class="level4"><div class="li"> V&rsquo; ~&lt;: V</div>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ul>

</div>

<a name="runtime_type_tags"></a><h1>Runtime Type Tags</h1>
<div class="level1">

<p>
 Runtime values must carry around type information to enforce the rules of the type system. These runtime <em>tags</em> are associated with all values (such as objects and primitives) and slots (mutable properties). A tag is a runtime representation of a type.
</p>

<p>
In general, tags can represent any type, except parameterized types that are not fully instantiated. Furthermore, there are restrictions on value tags detailed below.
</p>

</div>

<a name="values"></a><h2>Values</h2>
<div class="level2">

<p>
 Every runtime value contains an internal tag indicating some information about the value&rsquo;s type. A value&rsquo;s tag is a fully instantiated type whose top-level type constructor cannot be a <code>UNION</code> type or the type <code>*</code>.
</p>

<p>
For primitive values and instances of classes, the value&rsquo;s tag is simply its associated type. For structurally typed functions and objects, the type tag contains all the static type information associated with the literal expression that constructed the value.
</p>

<p>
For example, an untyped function object might have the tag: 
</p>
<pre class="code">(FUNCTION (THIS *) (ARGS *) #t (RETURN *))</pre>

<p>
 Dynamically typed object literals have the structural type 
</p>
<pre class="code">(OBJECT)</pre>

<p>
 because it&rsquo;s known that they are objects but there are no other known constraints.
</p>

<p>
Examples:
</p>
<pre class="code javascript"><span class="co1">// tag: (FUNCTION (THIS *) (ARGS int) #f (RETURN String))</span>
<span class="kw2">function</span> f<span class="br0">&#40;</span>x : int<span class="br0">&#41;</span> : String <span class="br0">&#123;</span> ... <span class="br0">&#125;</span>
&nbsp;
<span class="co1">// tag: (OBJECT (x int) (y int))</span>
<span class="br0">&#123;</span> x: <span class="nu0">3</span>, y: <span class="nu0">4</span> <span class="br0">&#125;</span> : <span class="br0">&#123;</span> x: int, y: int <span class="br0">&#125;</span>
&nbsp;
<span class="co1">// tag: (OBJECT (x int))</span>
<span class="br0">&#123;</span> x: <span class="nu0">3</span>, y: <span class="nu0">4</span> <span class="br0">&#125;</span> : <span class="br0">&#123;</span> x: int <span class="br0">&#125;</span>
&nbsp;
<span class="co1">// tag: (OBJECT)</span>
<span class="br0">&#123;</span> x: <span class="nu0">3</span>, y: <span class="nu0">4</span> <span class="br0">&#125;</span> : *</pre>
</div>

<a name="slots"></a><h2>Slots</h2>
<div class="level2">

<p>
 Mutable entities such as object properties are known as <em>slots</em>. All slots have associated type tags. A slot tag may represent any fully instantiated type.
</p>
<pre class="code javascript"><span class="co1">// x's tag: int</span>
<span class="br0">&#123;</span> x: <span class="nu0">3</span> <span class="br0">&#125;</span> : <span class="br0">&#123;</span> x: int <span class="br0">&#125;</span>
&nbsp;
<span class="co1">// x's tag: (UNION int String)</span>
<span class="br0">&#123;</span> x: <span class="nu0">3</span> <span class="br0">&#125;</span> : <span class="br0">&#123;</span> x: <span class="br0">&#40;</span>int,String<span class="br0">&#41;</span> <span class="br0">&#125;</span></pre>
</div>

<a name="runtime_checks"></a><h2>Runtime Checks</h2>
<div class="level2">

<p>
 Runtime checks occur when setting a slot or passing a value to a function or method. The check involves testing whether the value&rsquo;s tag is compatible with the expected type (associated with the slot or function signature). Runtime checks also occur when accessing a slot value or returning from a function. The check involves testing whether the returned value or slot value is compatible with the expected type (associated with the slot or function signature).
</p>

<p>
If a runtime check succeeds but requires an implicit conversion, the conversion is performed automatically.
</p>

<p>
Compilers are free to skip a dynamic check if they can prove that the check is guaranteed to succeed without conversion.
</p>

</div>

<a name="implementing_conversions"></a><h1>Implementing Conversions</h1>
<div class="level1">

<p>
 For any pair of convertable types S and T, we must at runtime be able to convert values of type S to type T. For simple types like <code>int</code> and <code>double</code>, the runtime conversion is straight-forward. But there are two things that make conversion more subtle: functions and mutable slots.
</p>

<p>
The following example illustrates how mutable slots are problematic:
</p>
<pre class="code javascript">type Box = <span class="br0">&#123;</span> val: TCPSocket <span class="br0">&#125;</span>
&nbsp;
<span class="kw2">var</span> boxAny : * = <span class="br0">&#123;</span> val: <span class="kw2">new</span> TCPSocket <span class="br0">&#125;</span> : *
<span class="kw2">var</span> box : Box = boxAny          <span class="co1">// conversion from * ~&gt; Box</span>
boxAny.<span class="me1">val</span> = <span class="kw2">new</span> RubberChicken  <span class="co1">// no problem, boxAny is untyped</span>
box.<span class="me1">val</span>                         <span class="co1">// ERROR: no longer a TCPSocket!</span></pre>
<p>
At some point, it has to be an error for <code>o.x.val</code> to be a <code>RubberChicken</code>, because the type system promised it would always be a <code>TCPSocket</code>. It&rsquo;s not in general possible to catch this kind of error statically, because of type <code>*</code>. 
</p>

<p>
For the example above, the conversion from * to Box does not introduce a wrapper or view; box is just set to  point to the same record as boxAny. On the access to box.val (or any access to a record), since box has type Box = {val:TCPSocket} and the underlying record is not guaranteed to hold a TCPSocket, the compiler will insert a check that box.val returns a TCPSocket, and will issue a dynamic type error otherwise.
</p>

<p>
For other code like: 
</p>
<pre class="code javascript">type Box = <span class="br0">&#123;</span> val: TCPSocket <span class="br0">&#125;</span>
<span class="kw2">function</span> f<span class="br0">&#40;</span>box:Box<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">return</span> box.<span class="me1">val</span>;
<span class="br0">&#125;</span></pre>
<p>
the compiler will also insert the same dynamic check.
</p>

<p>
Of course, a sufficiently-smart compiler could prove many of these checks are redundant via static analysis. 
</p>

</div>

<a name="informative_notes_on_dynamic_optimization"></a><h2>Informative notes on dynamic optimization</h2>
<div class="level2">

<p>
 In the following, we assume that there is an object <code>OBJ</code> that has a type <code>T</code>, and <code>n</code> slots <code>S1:U1</code> .. <code>S<em>n</em>:U<em>n</em></code> <em>outside</em> <code>OBJ</code>, that <em>refer</em> to <code>OBJ</code>. Then when attempting a property read <code>S<em>i</em>.x</code>, intended to extract field <code>x</code> from <code>OBJ</code> via some referencing slot <code>S<em>i</em>:U<em>i</em></code>, we have two ways to cache type-compatibility information to make this read efficient: 
</p>
<ol>
<li class="level1"><div class="li"> <code>OBJ</code> can carry a single bit that is set when <em>any</em> slot <code>S<em>k</em>:U<em>k</em></code> exists with <code>Uk != T</code>. </div>
<ul>
<li class="level2"><div class="li"> When the bit is set, <code>S<em>i</em>.x</code> must perform a typecheck between <code>U<em>i</em></code> and <code>T</code>.</div>
</li>
<li class="level2"><div class="li"> When the bit is cleared, we know that <em>every</em> <code>S<em>k</em>:U<em>k</em></code> has <code>U<em>k</em> == T</code>, so <code>S<em>i</em>.x</code> can proceed without a typecheck.</div>
</li>
<li class="level2"><div class="li"> This bit (on <code>OBJ</code>) may be modified any time a new <code>S<em>j</em></code> is made to refer to <code>OBJ</code>.</div>
</li>
</ul>
</li>
</ol>
<ol>
<li class="level1"><div class="li"> Every slot <code>S<em>i</em>:U<em>i</em></code> <em>that currently refers to <code>OBJ:T</code></em> can carry a single bit that indicates whether <code>U<em>i</em> != T</code>.  </div>
<ul>
<li class="level2"><div class="li"> When the bit is set, as above, <code>S<em>i</em>.x</code> must perform a typecheck between <code>U<em>i</em></code> and <code>T</code>.</div>
</li>
<li class="level2"><div class="li"> When the bit is cleared, as above, no type comparison is required.</div>
</li>
<li class="level2"><div class="li"> These bits (on every <code>S<em>i</em></code>) must be set or cleared any time an <code>S<em>i</em></code> is given a referent: there&rsquo;s only one bit and it relates to the <em>current referent</em>.</div>
</li>
</ul>
</li>
</ol>

<p>
 Essentially the first case spends a bit less space (one bit per object), but is more likely to enter the slow slot-to-object type comparison. The second case spends a bit more space (one bit per slot) but is less likely to enter the slow type comparison.
</p>

</div>

<a name="type_parameters"></a><h1>Type Parameters</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> separate phase before type checking</div>
</li>
<li class="level1"><div class="li"> type variable scope</div>
<ul>
<li class="level2"><div class="li"> binding occurrences (class declarations, function declarations)</div>
</li>
<li class="level2"><div class="li"> where free type variables can(&rsquo;t) occur</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> parameterization (i.e., type substitution)</div>
</li>
</ul>

</div>

<a name="type_checking"></a><h1>Type Checking</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> <code>void</code> functions &hArr; <code>return</code> syntactic restrictions</div>
</li>
<li class="level1"><div class="li"> generator functions &hArr; return type</div>
</li>
<li class="level1"><div class="li"> generator functions &hArr; <code>yield</code> syntactic restrictions</div>
</li>
<li class="level1"><div class="li"> generally, any type is convertible to booleans </div>
</li>
<li class="level1"><div class="li"> types <code>Null</code> and <code>Undefined</code> don&rsquo;t allow object operations</div>
</li>
<li class="level1"><div class="li"> what about object operations on nullable types?</div>
</li>
<li class="level1"><div class="li"> <code>with</code> follows <a href="doku.php%3Fid=proposals:reformed_with.html" class="wikilink1" title="proposals:reformed_with" onclick="return svchk()" onkeypress="return svchk()">reformed with</a></div>
</li>
</ul>

</div>

<a name="miscellaneous_not_yet_organized"></a><h1>Miscellaneous (not yet organized)</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> libraries in initial environment &ndash; impl.-specific, but must have:</div>
<ul>
<li class="level2"><div class="li"> <code>DontDelete</code></div>
</li>
<li class="level2"><div class="li"> runtime type constraint</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> no environment needed for subtyping (inside parameterized class definitions we may have type variables, but these are always universally quantified so they do not need to be bound in the type environment) </div>
</li>
<li class="level1"><div class="li"> parsing of concrete type expressions/definitions to abstract syntax</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> explain abstract syntax and meta-syntax</div>
</li>
<li class="level1"><div class="li"> The operator <code>v is T</code> checks if the tag of the value v is a subtype of the type T.</div>
</li>
<li class="level1"><div class="li"> The operator <code>v to T</code> checks if the tag of v is <em>convertible</em> to the type T, and throws a TypeError if not. Note that this requires invoking the convertibility checking algorithm, but only looks at the value&rsquo;s tag, not its actual contents. For example:</div>
</li>
</ul>
<pre class="code javascript"><span class="kw2">var</span> o : * = <span class="br0">&#123;</span> x: <span class="nu0">3</span>, y: <span class="st0">'foo'</span> <span class="br0">&#125;</span> : <span class="br0">&#123;</span> x: int <span class="br0">&#125;</span>
o isTagCompatible <span class="br0">&#123;</span> x: int, y: int <span class="br0">&#125;</span> <span class="co1">// true</span></pre>
<p>
Notice also that for union types, the tag subtyping check involves an implicit <code>typecase</code> on the variants of the union:
</p>
<pre class="code javascript"><span class="kw2">var</span> o : * = <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x <span class="br0">&#125;</span>
o isTagCompatible <span class="br0">&#40;</span>int, <span class="kw2">function</span><span class="br0">&#40;</span>int<span class="br0">&#41;</span>:int<span class="br0">&#41;</span> <span class="co1">// true</span></pre>
<p>
 More details are in <a href="doku.php%3Fid=clarification:formal_type_system.html" class="wikilink1" title="clarification:formal_type_system" onclick="return svchk()" onkeypress="return svchk()">formal type system</a> 
</p>
<hr noshade="noshade" size="1" />

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        clarification/type_system.txt &middot; Last modified: 2007/07/03 13:01 by jorendorff      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="clarification:type_system" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="clarification:type_system" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="clarification:type_system" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="clarification:type_system" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=clarification:type_system.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=clarification%253Atype_system&amp;1454275593" width="1" height="1" alt=""  /></body>
</html>
