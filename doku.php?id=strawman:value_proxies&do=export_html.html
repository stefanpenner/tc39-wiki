<html>
<head>
  <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=strawman:value_proxies&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=strawman" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=strawman:value_proxies&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="robots" content="noindex,nofollow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />
</head>
<body>
<div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#value_proxies" class="toc">Value Proxies</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#goals" class="toc">Goals</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#use_cases" class="toc">Use cases</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#design_choices" class="toc">Design Choices</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#operator_handler" class="toc">Operator Handler</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#comparison_traps" class="toc">Comparison Traps</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#creating_value_proxies" class="toc">Creating Value Proxies</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#pending_items" class="toc">Pending Items</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#see_also" class="toc">See Also</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:value_proxies&amp;do=export_html.html#notes_from_2_dec_discussion" class="toc">Notes from 2 Dec discussion</a></span></li>
</ul>
</li>
</ul>
</div>
</div>

<a name="value_proxies"></a><h1>Value Proxies</h1>
<div class="level1">

<p>
 This page lists an extension to <a href="doku.php%3Fid=harmony:proxies.html" class="wikilink1" title="harmony:proxies" onclick="return svchk()" onkeypress="return svchk()">proxies</a> that supports operator overloading. It is a work-in-progress and likely inconsistent in some parts.
</p>

</div>
<!-- SECTION [1-184] -->
<a name="goals"></a><h2>Goals</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Enable implementing new kinds of values for which the behavior of standard operators such as &lsquo;+&rsquo; can be customized.</div>
</li>
<li class="level1"><div class="li"> Keep consistency with <a href="doku.php%3Fid=harmony:proxies.html" class="wikilink1" title="harmony:proxies" onclick="return svchk()" onkeypress="return svchk()">proxies</a> where possible.</div>
</li>
<li class="level1"><div class="li"> Performance, as far as possible.</div>
</li>
</ul>

</div>
<!-- SECTION [185-424] -->
<a name="use_cases"></a><h2>Use cases</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Decimal</div>
</li>
<li class="level1"><div class="li"> Bignum</div>
</li>
<li class="level1"><div class="li"> Rationals</div>
</li>
<li class="level1"><div class="li"> Complex numbers</div>
</li>
<li class="level1"><div class="li"> Matrices</div>
</li>
<li class="level1"><div class="li"> Taint analysis (and provenance tracking)</div>
</li>
<li class="level1"><div class="li"> <a href="http://en.wikipedia.org/wiki/Automatic_differentiation" class="urlextern" target="_blank" title="http://en.wikipedia.org/wiki/Automatic_differentiation" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Automatic differentiation</a></div>
</li>
</ul>

</div>
<!-- SECTION [425-656] -->
<a name="design_choices"></a><h2>Design Choices</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> For performance reasons, we want a complex number to be represented in a single block of memory, which we call a value proxy. This value proxy should include both the real and complex components, plus a pointer to data/methods etc that are common to all complex numbers.  The alternative of having separate proxy and handler objects (plus closure state) for each complex seems too heavyweight.</div>
</li>
<li class="level1"><div class="li"> We want the state in the value proxy to be immutable. This fits with the notion of &lsquo;immutable values&rsquo;. Also, it allows equality on value proxies, if not trapped, to default to equality on the components. Hence there is no possibility of comparing value proxies for pointer equality, and so value proxies have no notion of identity, only observable equivalence.</div>
</li>
<li class="level1"><div class="li"> The state in the value proxy needs to be accessed by the methods of the value proxy. We could use some notion of private names to make this state encapsulated or private to the value proxy, but instead choose to also allow that state to be visible externally.</div>
</li>
</ul>

</div>
<!-- SECTION [657-1716] -->
<a name="operator_handler"></a><h2>Operator Handler</h2>
<div class="level2">

<p>
 An operator handler is an object that implements the following collection of traps. In each trap (aka method), <code>this</code> is bound to an underlying value proxy:
</p>
<pre class="code javascript"><span class="br0">&#123;</span>
  <span class="co1">// unary operators</span>
  neg: <span class="kw2">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> -&gt; result    <span class="co1">// for unary -</span>
  pos: <span class="kw2">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> -&gt; result    <span class="co1">// for unary +</span>
  invert: <span class="kw2">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> -&gt; result <span class="co1">// for unary ~, invert is python's name</span>
  <span class="co1">// additional traps</span>
  test: <span class="kw2">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> -&gt; result     <span class="co1">// return a boolean for use in conditionals</span>
&nbsp;
  <span class="co1">// binary operators. </span>
  <span class="co1">// The 'add'  trap is called when the left argument to '+' is a value proxy.</span>
  <span class="co1">// The 'radd' trap is called when the left argument is not a proxy and the right argument is.</span>
  add:  <span class="kw2">function</span><span class="br0">&#40;</span>rarg<span class="br0">&#41;</span> -&gt; result    <span class="co1">// python uses __add__</span>
  radd: <span class="kw2">function</span><span class="br0">&#40;</span>larg<span class="br0">&#41;</span> -&gt; result    <span class="co1">// python uses __radd__</span>
  ...
  
  <span class="me1">ditto</span> <span class="kw1">for</span> the following binary operators:
    sub,    rsub    <span class="br0">&#40;</span>-<span class="br0">&#41;</span>
    mul,    rmul    <span class="br0">&#40;</span>*<span class="br0">&#41;</span>
    div,    rdiv    <span class="br0">&#40;</span>/<span class="br0">&#41;</span>     
    mod,    rmod    <span class="br0">&#40;</span>%<span class="br0">&#41;</span>
    lshift, rlshift <span class="br0">&#40;</span>&lt;&lt;<span class="br0">&#41;</span>
    rshift, rrshift <span class="br0">&#40;</span>&gt;&gt;<span class="br0">&#41;</span>
    bitand, rbitand <span class="br0">&#40;</span>&amp;<span class="br0">&#41;</span> 
    bitor,  rbitor  <span class="br0">&#40;</span>|<span class="br0">&#41;</span>        
    bitxor, rbitxor <span class="br0">&#40;</span>^<span class="br0">&#41;</span>
&nbsp;
  <span class="co1">// comparison operators (perhaps required to return booleans)</span>
    equal, requal <span class="br0">&#40;</span><span class="kw1">for</span> ==<span class="br0">&#41;</span>
    compare<span class="br0">&#40;</span>rarg<span class="br0">&#41;</span> - returns negative <span class="kw1">for</span> &lt;, zero <span class="kw1">for</span> ===, positive <span class="kw1">for</span> &gt;
    rcompare<span class="br0">&#40;</span>larg<span class="br0">&#41;</span>  
<span class="br0">&#125;</span></pre>
<p>
This operator handler has a large collection of traps. We refer to the above traps as <strong>derived traps</strong>. If a particular derived trap is not implemented, it is multiplexed onto the following smaller collection of <strong>fundamental traps</strong>:
</p>
<pre class="code javascript"><span class="br0">&#123;</span>
  <span class="co1">// unary operators</span>
  unary: <span class="kw2">function</span><span class="br0">&#40;</span>opstring, opfn<span class="br0">&#41;</span> -&gt; result
&nbsp;
  <span class="co1">// binary operators</span>
  left : <span class="kw2">function</span><span class="br0">&#40;</span>opstring, opfn, rarg<span class="br0">&#41;</span> -&gt; result
  right: <span class="kw2">function</span><span class="br0">&#40;</span>opstring, opfn, larg<span class="br0">&#41;</span> -&gt; result
<span class="br0">&#125;</span></pre>
<p>
Each fundamental trap is passed the operator in two forms: as a string <code>opstring</code> and as a function <code>opfn</code>, which is either a unary or binary function that performs that operation on its arguments. Thus the default implementation of the derived trap <code>mul</code> dispatches to the <code>left</code> trap as follows:
</p>
<pre class="code javascript">&nbsp;
<span class="kw2">function</span> mul <span class="br0">&#40;</span>rarg<span class="br0">&#41;</span> <span class="br0">&#123;</span>
  <span class="kw1">return</span> <span class="kw1">this</span>.<span class="me1">left</span><span class="br0">&#40;</span> <span class="st0">"*"</span>,
                    <span class="kw2">function</span> <span class="br0">&#40;</span>l,r<span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> l * r <span class="br0">&#125;</span>,
                    rarg <span class="br0">&#41;</span>
<span class="br0">&#125;</span></pre>
<p>
An error is raised (which?) an operator is applied to a proxy for which neither a fundamental or derived trap is defined.
</p>

<p>
MarkM says: a TypeError, since that&rsquo;s the error a normal method missing (<code>({}).foo()</code>) turns into.
</p>

</div>
<!-- SECTION [1717-4157] -->
<a name="comparison_traps"></a><h2>Comparison Traps</h2>
<div class="level2">

<p>
 There are eight comparison operators <code>==</code>, <code>!=</code>, <code>===</code>, <code>!==</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>. These are all required to return booleans. (This helps optimizations and understandability.)
</p>

<p>
There is no trap for !=, it is handled by the == trap <code>equal</code>. There is no <code>requal</code> trap; it is also handled by <code>equal</code>.
</p>

<p>
The remaining 6 comparison operators are all handled by <code>compare</code>. There is no need for an <code>rcompare</code> trap; it is also handled by <code>compare</code>.
</p>

<p>
Note that we could have a larger collection of traps for comparison operators that could allow more general behaviors (eg a non-symmetric <code>==</code> operator).
</p>

<p>
Note that both <code>==</code> and <code>===</code> on value proxies must be defined via traps.
</p>

<p>
In contrast, value proxies cannot override the proposed &lsquo;egal&rsquo; function.  On value proxies, &lsquo;egal&rsquo; should check for equality of the (immutable) components of the value proxy (perhaps recursively, if those components are in turn value proxies, but there is no need for an expensive cycle check). 
</p>

<p>
MarkM asks: Why is there no need for a cycle check? Is it impossible to build an infinite rational value?
</p>

</div>
<!-- SECTION [4158-5303] -->
<a name="creating_value_proxies"></a><h2>Creating Value Proxies</h2>
<div class="level2">

<p>
 A value proxy needs to combine:
</p>
<ul>
<li class="level1"><div class="li"> an operator handler that should implement the above traps. It should not implement the <a href="doku.php%3Fid=harmony:proxies.html" class="wikilink1" title="harmony:proxies" onclick="return svchk()" onkeypress="return svchk()">proxies</a> traps; if necessary, the prototype could be such an object proxy.</div>
</li>
<li class="level1"><div class="li"> a prototype to contain methods on value proxies, such as <code>complex.abs()</code> etc. (May be an object proxy).</div>
</li>
<li class="level1"><div class="li"> an answer for <code>typeof</code> queries. (It should be one of the existing <code>typeof</code> answers, excluding &ldquo;function&rdquo;.)</div>
</li>
<li class="level1"><div class="li"> information about the number and name of fields in the value proxy.  </div>
</li>
</ul>

<p>
 Since these four kinds of information is likely common to many value proxies, we pre-allocate them in a <code>ValueType</code> object, and then reference that object from multiple value proxies.    
</p>
<pre class="code javascript"><span class="kw2">var</span> proxyValueType = Proxy.<span class="me1">createValueType</span><span class="br0">&#40;</span>operatorhandler, proto, 
                      typeofString, <span class="br0">&#123;</span> x:float64, y:float64<span class="br0">&#125;</span> <span class="br0">&#41;</span>;
&nbsp;
<span class="kw2">var</span> proxy = Proxy.<span class="me1">createValue</span><span class="br0">&#40;</span>proxyValueType, <span class="nu0">2</span>.<span class="nu0">0</span>, <span class="nu0">3</span>.<span class="nu0">0</span><span class="br0">&#41;</span>;
&nbsp;
<span class="co1">// example uses</span>
assert proxy.<span class="me1">x</span> == <span class="nu0">2</span>.<span class="nu0">0</span>
&nbsp;
proxy.<span class="me1">abs</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="co1">// calls proto.abs() with this bound to proxy</span>
&nbsp;
proxy + <span class="nu0">1</span> <span class="co1">// calls operatorhandler.add(1)</span>
&nbsp;
<span class="kw1">typeof</span><span class="br0">&#40;</span>proxy<span class="br0">&#41;</span> <span class="co1">// returns typeofstring</span></pre>
<p>
 The last argument to <code>createValueType</code> uses block types from the <a href="doku.php%3Fid=strawman:binary_data.html" class="wikilink1" title="strawman:binary_data" onclick="return svchk()" onkeypress="return svchk()">binary data</a> strawman. What block type should we use for an arbitrary <acronym title="JavaScript">JS</acronym> value? 
</p>

</div>
<!-- SECTION [5304-6600] -->
<a name="pending_items"></a><h2>Pending Items</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Do we need geti and seti traps, when a (value) proxy is used as an object index?</div>
</li>
<li class="level1"><div class="li"> What should <code>typeof</code> return? Perhaps one of the following</div>
<ul>
<li class="level2"><div class="li"> Any existing typeof result, excluding <code>function</code> (proposed above)</div>
</li>
<li class="level2"><div class="li"> Always <code>object</code></div>
</li>
<li class="level2"><div class="li"> Any string</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Membrane code needs some way to distinguish real primitive values from value proxies.  The example membrane code uses a hypothetical <code>Object.isPrimitive(val)</code> method. This method (or equivalent functionality) is required as part of this proposal.</div>
</li>
<li class="level1"><div class="li"> Each value proxy has both a prototype (for methods) and a handler (for operator traps). These could be merged into a single prototype object, but then the handler traps would be exposed and could be called explicitly on the value proxy, (eg <code>proxy.left(...)</code>), which seems problematic.</div>
</li>
</ul>

</div>
<!-- SECTION [6601-7441] -->
<a name="see_also"></a><h2>See Also</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="http://docs.python.org/reference/datamodel.html#emulating-numeric-types" class="urlextern" target="_blank" title="http://docs.python.org/reference/datamodel.html#emulating-numeric-types" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Pythons API</a> for emulating numeric types.</div>
</li>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=strawman:value_types.html" class="wikilink1" title="strawman:value_types" onclick="return svchk()" onkeypress="return svchk()">value types</a> </div>
</li>
<li class="level1"><div class="li"> <a href="http://www.soe.ucsc.edu/research/report?ID=1595" class="urlextern" target="_blank" title="http://www.soe.ucsc.edu/research/report?ID=1595" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Virtual Values for Language Extension</a>: a more formal presentation of these ideas for a simpler language than Javascript.  In terms of the nine traps of this paper, <a href="doku.php%3Fid=harmony:proxies.html" class="wikilink1" title="harmony:proxies" onclick="return svchk()" onkeypress="return svchk()">proxies</a> implements (variants of) <code>call</code>, <code>getr</code>, <code>setr</code>. This proposal adds <code>unary</code>, <code>left</code>, <code>right</code>, <code>test</code> (called <code>truth</code> above) and leaves pending <code>geti</code> and <code>seti</code>.</div>
</li>
</ul>

</div>
<!-- SECTION [7442-8041] -->
<a name="notes_from_2_dec_discussion"></a><h2>Notes from 2 Dec discussion</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Likely want geti handlers, or perhaps <u>index</u> as in python</div>
</li>
</ul>

</div>
<!-- SECTION [8042-] -->
<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/9/95f3be66053ba53c52c1571e6750376d.xhtml used -->
</body>
</html>
