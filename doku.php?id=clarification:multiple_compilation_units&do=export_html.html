<html>
<head>
  <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=clarification" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="robots" content="noindex,nofollow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />
</head>
<body>
<div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#multiple_compilation_units" class="toc">Multiple compilation units</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#abstract" class="toc">Abstract</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#proposal" class="toc">Proposal</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#discussion" class="toc">Discussion</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#previous_discussion" class="toc">Previous Discussion</a></span><ul class="toc">
<li class="clear"><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#whole-program_compilation" class="toc">Whole-program compilation</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#incremental_compilation" class="toc">Incremental compilation</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#propositions" class="toc">Propositions</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#connections" class="toc">Connections</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#background_rationale" class="toc">Background &amp; rationale</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#caseweb_browsers" class="toc">Case: Web browsers</a></span><ul class="toc">
<li class="level4"><span class="li"><a href="doku.php%3Fid=clarification:multiple_compilation_units&amp;do=export_html.html#3rd_edition_semantics_for_web_browsers" class="toc">3rd Edition semantics for web browsers</a></span></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<p>
DO NOT EXPORT
</p>

<a name="multiple_compilation_units"></a><h1>Multiple compilation units</h1>
<div class="level1">

<p>
 NEEDS: 
</p>
<ul>
<li class="level1"><div class="li"> refactoring as a GlobalFrame with external &ldquo;class&rdquo; loaders</div>
</li>
</ul>

<p>
(Also see the <a href="doku.php%3Fid=discussion:multiple_compilation_units.html" class="wikilink1" title="discussion:multiple_compilation_units" onclick="return svchk()" onkeypress="return svchk()">discussion page</a> for this proposal)
</p>

</div>
<!-- SECTION [16-222] -->
<a name="abstract"></a><h2>Abstract</h2>
<div class="level2">

<p>
 The semantics of interoperation between programs evaluated in different 3rd edition <strong>Execution Contexts</strong> is defined. In order to allow for multiple separately compiled programs to share their fixed bindings in a type safe way, we extend the Execution Context by adding to the scope chain an <strong>external frame</strong> that includes zero or more bindings to external definitions. This extension is compatible with 3rd edition semantics for multiple compilation units that share a single execution environment. 
</p>

</div>
<!-- SECTION [223-749] -->
<a name="proposal"></a><h2>Proposal</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Add to the scope chain, ahead of the root global object, an <em>External Frame</em> object whose properties are proxies for external bindings</div>
</li>
</ul>
<pre class="code">
         ... -&gt; Global Block -&gt; External Frame -&gt; Global Object (root)
</pre>
<ul>
<li class="level1"><div class="li"> For each accessible external and every local global definition, add a proxy binding to the External Frame. The proxy must forward an invocation (e.g. get, set, call) to the corresponding owning global object</div>
</li>
<li class="level1"><div class="li"> Built-ins must be internal properties of the current global object. That is,</div>
</li>
</ul>
<pre class="code">
         this.parseInt === parseInt
</pre>
<ul>
<li class="level1"><div class="li"> Implementations that do not support separate compilation in distinct execution contexts can do so without the use of an External Frame. Lexical references to global definitions will be compatibly resolved through the global object at the root of the scope chain (as defined by the 3rd edition)</div>
</li>
</ul>

</div>
<!-- SECTION [750-1645] -->
<a name="discussion"></a><h2>Discussion</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Except for the part about built-ins appearing to be internal properties, what is proposed in compatible with AS3</div>
</li>
<li class="level1"><div class="li"> It might seem weird that external bindings shadow internal dynamic bindings, but this is consistent with the behavior, for example, of block scoped lets shadowing dynamic globals</div>
</li>
<li class="level1"><div class="li"> The external frame and the top level block frame are different so that top-level let bindings shadow external bindings</div>
</li>
<li class="level1"><div class="li"> Global definitions collide with incompatible external definitions of the same name</div>
</li>
</ul>
<ul>
<li class="level1"><div class="li"> Describe classloader like &ldquo;prefer the parent&rdquo; rule in AS3</div>
</li>
</ul>

</div>
<!-- SECTION [1646-2244] -->
<a name="previous_discussion"></a><h1>Previous Discussion</h1>
<div class="level1">

<p>
 We define two standard models, one for whole-program compilation and one for incremental compilation.  These are consistent in the sense that if a multi-fragment program compiles and runs with no unhandled exceptions under both models then both executions yield the same result except as described below. The incremental model is compatible with the 3rd Edition semantics for web browsers.
</p>

<p>
Suppose in the following that the program consists of a totally ordered set of fragments F1 through Fn. This set might include strings passed to <code>eval</code> and which are evaluated in the same global environent as F1..Fn. This set does not include strings passed to <code>eval</code> which are evluated in a differnt environment, or the <code>Function</code> constructor. Note: entities named by <code>include</code> are included by being textually in-lined in the referencing fragments.
</p>

<p>
In an incremental setting the set of fragments can be unbounded, and it includes fragments loaded through the use of host mechanisms (writing a <code>SCRIPT</code> tag into the document in a browser environment, for example).  
</p>

<p>
In the whole-program setting we assume that no such mechanisms for incremental script creation exists.
</p>

<p>
Each fragment Fi defines: 
</p>
<ul>
<li class="level1"><div class="li"> zero or more fragments of the unnamed package</div>
</li>
<li class="level1"><div class="li"> zero or more fragments of sundry named packages</div>
</li>
<li class="level1"><div class="li"> perhaps some global code.</div>
</li>
</ul>

<p>
 Each package fragment consists of statements and definitions of constants, variables, functions, classes, interfaces.
</p>

</div>
<!-- SECTION [2245-3732] -->
<a name="whole-program_compilation"></a><h3>Whole-program compilation</h3>
<div class="level3">

<p>
 For whole-program compilation, F1..Fn are all available at compile time. We concatenate these fragments in order into a single source fragment and then compile that fragment as a single compliation unit. Consequences include: 
</p>
<ul>
<li class="level1"><div class="li"> All top-level definitions in F1..Fn are visible to all fragments, possibly in an uninitialised state</div>
</li>
<li class="level1"><div class="li"> F1..Fn necessarily operate on the same global environment</div>
</li>
</ul>

</div>
<!-- SECTION [3733-4166] -->
<a name="incremental_compilation"></a><h3>Incremental compilation</h3>
<div class="level3">

<p>
 Consider two fragments Fi and Fj, considered in that order.  (For &ldquo;variable&rdquo; read &ldquo;var or const&rdquo;.) 
</p>
<ul>
<li class="level1"><div class="li"> If Fi defines a top-level package, class, interface, namespace, or variable then that item is visible statically in Fj just as it is in Fi</div>
</li>
<li class="level1"><div class="li"> Fj may add definitions to a package P defined in Fi by also defining P.  All classes, interfaces, namespaces, and variables defined in P in Fi are visible when P is compiled in Fj, and conflicts are resolved as if all the definitions came from the same fragment.</div>
</li>
<li class="level1"><div class="li"> Fj may not redefine (at top level) any classes, interfaces, or namespaces defined in Fi</div>
</li>
<li class="level1"><div class="li"> Fj may redefine (at top level) a variable defined in Fi provided it is type-compatible, and if it is a <code>const</code> only if it does not have an initializer in Fj</div>
</li>
<li class="level1"><div class="li"> If Fi defines a <code>const</code> then it must contain code that definitely leaves that constant initialized when Fi&rsquo;s evaluatation terminates (though see Open Issues below)</div>
</li>
<li class="level1"><div class="li"> Fi may not contain compile-time constant references to packages, classes, namespaces or interfaces defined in Fj (and in the strict language it may also not reference variables defined in Fj)</div>
</li>
<li class="level1"><div class="li"> A namespace or package opened in Fi will not be automatically opened in Fj. That is Fi and Fj introduce separate block scopes</div>
</li>
<li class="level1"><div class="li"> It is implementation defined whether separately compiled fragments are interpreted in a common or unique global environments</div>
</li>
</ul>

<p>
Open issues: 
</p>
<ul>
<li class="level1"><div class="li"> It&rsquo;s unclear whether &ldquo;default xml namespace&rdquo; is scoped inside a fragment or in the program as a whole since that&rsquo;s really some sort of assignment statement [ <em><a href="mailto:%26%23x6a%3B%26%23x6f%3B%26%23x64%3B%26%23x79%3B%26%23x65%3B%26%23x72%3B%26%23x40%3B%26%23x61%3B%26%23x64%3B%26%23x6f%3B%26%23x62%3B%26%23x65%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6a;&#x6f;&#x64;&#x79;&#x65;&#x72;&#x40;&#x61;&#x64;&#x6f;&#x62;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">Jeff Dyer</a> 2006/09/22 08:38</em> &mdash; default xml namespace is an implicit variable that gets set on the global object, so to the extent that a global object is shared, the state of the dxns will be shared.]</div>
</li>
<li class="level1"><div class="li"> The rules about <code>const</code> break down if the implementation allows one fragment to be terminated by an error and the next program to be evaluated anyway. <em>[Anyhow <code>const</code> already has some initialization issues with regard to non-nullable types.]</em> [ <em><a href="mailto:%26%23x6a%3B%26%23x6f%3B%26%23x64%3B%26%23x79%3B%26%23x65%3B%26%23x72%3B%26%23x40%3B%26%23x61%3B%26%23x64%3B%26%23x6f%3B%26%23x62%3B%26%23x65%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6a;&#x6f;&#x64;&#x79;&#x65;&#x72;&#x40;&#x61;&#x64;&#x6f;&#x62;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">Jeff Dyer</a> 2006/09/22 08:38</em> &mdash; what are the rules for handling exceptions? Is the state of its environment at the point of the exception passed to the next fragement?]</div>
</li>
</ul>

</div>
<!-- SECTION [4167-6445] -->
<a name="propositions"></a><h3>Propositions</h3>
<div class="level3">

<p>
 The following remain to be proved: 
</p>
<ul>
<li class="level1"><div class="li"> The whole-program and incremental models are consistent in the sense that they yield the same values in programs that do not throw unhandled exceptions</div>
</li>
<li class="level1"><div class="li"> The incremental compilation mechanism is compatible with 3rd Edition semantics</div>
</li>
</ul>

</div>
<!-- SECTION [6446-6745] -->
<a name="connections"></a><h2>Connections</h2>
<div class="level2">

<p>
 The <a href="doku.php%3Fid=proposals:local_packages.html" class="wikilink1" title="proposals:local_packages" onclick="return svchk()" onkeypress="return svchk()">local packages</a> proposal provides a complementary mechanism that allows names to be hidden from the global view.
</p>

</div>
<!-- SECTION [6746-6901] -->
<a name="background_rationale"></a><h2>Background &amp; rationale</h2>
<div class="level2">

<p>
 Both the 3rd Edition and the 4th Edition Draft define only the meaning of a single program fragment executing in a single global environment (where &ldquo;program fragment&rdquo; is the &ldquo;Program&rdquo; that is the initial nonterminal in the language grammar).
</p>

<p>
However, all major implementations of the language will likely need to consider interpretation of complete programs consisting of multiple, separately compiled such fragments, sometimes interacting in multiple global environments. 
</p>
<ul>
<li class="level1"><div class="li"> We need to define what it means to load and execute a program consisting of multiple fragments in a single global environment.</div>
</li>
<li class="level1"><div class="li"> We should also address any complexities that arise with multiple global environments.</div>
</li>
<li class="level1"><div class="li"> We should do this both for 3rd Edition code and for 4th Edition code.</div>
</li>
</ul>

<p>
 If the spec does not address these complexities then it is left up to each implementation to define the meaning of such programs.  Multiple implementations in the same domain (notably web browsers) will tend to develop incompatibilities.
</p>

</div>
<!-- SECTION [6902-7947] -->
<a name="caseweb_browsers"></a><h3>Case: Web browsers</h3>
<div class="level3">

<p>
 Web browsers always perform compilation and evaluation on-line, one program at a time.  The meaning of a web page can depend on the output of scripts; there is therefore a dependency between scripts.  Scripts can also be loaded and executed by extra-lingual mechanisms.  Scripts come from multiple sources, notably from the page itself and from inserted ad content.  Even discounting <code>eval</code> there is no way that a complete set of program fragments can be presented to the browser for compilation all together.
</p>

<p>
The fact that 3rd Edition does not define the meaning of loading multiple scripts in multiple global environments is mitigated by several factors: 
</p>
<ul>
<li class="level1"><div class="li"> most global variables are updateable, so redefining something in a later fragment is rarely a problem</div>
</li>
<li class="level1"><div class="li"> most standard entities are treated as constant <em>in practice</em>, so picking up the wrong global environment in a function is rarely a problem</div>
</li>
<li class="level1"><div class="li"> the language is sufficiently simple that browsers have generally managed to agree on the semantics of 3rd Edition programs (see the following section)</div>
</li>
</ul>

<p>
 The situation for 4th Edition is more difficult: 
</p>
<ul>
<li class="level1"><div class="li"> many names are constant (classes, types, constants) and will therefore not be updateable.  Redefinition will not work.</div>
</li>
<li class="level1"><div class="li"> the language is richer and getting the correct global environment will be of greater importance</div>
</li>
<li class="level1"><div class="li"> there are greater interdependencies among program phrases.</div>
</li>
</ul>

</div>
<!-- SECTION [7948-9382] -->
<a name="3rd_edition_semantics_for_web_browsers"></a><h4>3rd Edition semantics for web browsers</h4>
<div class="level4">

<p>
 A program consists of a potentially unbounded totally ordered set of program fragments F1 ..., each of which is a <code>Program</code> as per Section 14 of the 3rd Edition.  This set is evaluated in an on-line fashion in the context of a global environment that is freshly created before the evaluation of the first fragment.  
</p>

<p>
Functions in the fragment are assigned and hitherto unknown variables are created before evaluation begins.
</p>

<p>
If the evaluation of a fragment throws an exception that is not caught by the fragment or by any other mechanism, then the fragment&rsquo;s evaluation is aborted.  If one fragment&rsquo;s evaluation is aborted, the implementation goes on to evaluate the following fragments as it would have if no abort had taken place.
</p>

<p>
Functions are statically scoped with respect to their global environment.  This is true for built-in functions as well as user-defined functions.
</p>

<p>
The initial values of standard types in two global environments are separate types wrt <code>instanceof</code>; eg, <code>String</code> in two separate environment has entirely separate prototype chains.
</p>

<p>
Two programs can interact by manipulating data and functions in each others&rsquo; global environments, each of which can be considered simply an Object.  Apart from constraints in the implementation, there are no restrictions on accesses from one global environment to another.
</p>

<p>
Observe that the evaluation of any fragment requires no knowledge of any previous fragment apart from observing which names have been defined so far. 
</p>

</div>
<!-- SECTION [9383-] -->
<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/4/4c0ba584a1b015a5fd0bff447a746f83.xhtml used -->
</body>
</html>
