<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>discussion:stack_inspection [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=discussion:stack_inspection&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=discussion" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=discussion:stack_inspection&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=discussion:stack_inspection&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2007-01-19T21:47:34+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=discussion:stack_inspection&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">discussion:stack_inspection</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="discussion:stack_inspection" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="discussion:stack_inspection" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:operators.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:operators">operators</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:proper_tail_calls.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:proper_tail_calls">proper_tail_calls</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:reformed_with.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:reformed_with">reformed_with</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:resurrected_eval.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:resurrected_eval">resurrected_eval</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=discussion:stack_inspection.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:stack_inspection">stack_inspection</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#old_proposal" class="toc">Old Proposal</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#examples" class="toc">Examples</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#proposal" class="toc">Proposal</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#installing_marks" class="toc">Installing marks</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#alternatives" class="toc">Alternatives</a></span><ul class="toc">
<li class="level4"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#mark_objects" class="toc">Mark objects</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#keyvalue_pairs" class="toc">Key/value pairs</a></span></li>
</ul>
</li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#viewing_marks" class="toc">Viewing marks</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#alternatives" class="toc">Alternatives</a></span><ul class="toc">
<li class="level4"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#special_object" class="toc">Special object</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#primitive_function" class="toc">Primitive function</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#special_form" class="toc">Special form</a></span></li>
</ul>
</li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#marking_rules" class="toc">Marking rules</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#applicability" class="toc">Applicability</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#implementation" class="toc">Implementation</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:stack_inspection.html#issues" class="toc">Issues</a></span></li>
</ul>
</div>
</div>

<p>
This is the discussion page for <a href="doku.php%3Fid=proposals:stack_inspection.html" class="wikilink1" title="proposals:stack_inspection" onclick="return svchk()" onkeypress="return svchk()">stack_inspection</a>.
</p>

<a name="old_proposal"></a><h1>Old Proposal</h1>
<div class="level1">

</div>

<a name="examples"></a><h1>Examples</h1>
<div class="level1">

<p>
 The following demonstrates stack marks that build up during a computation:
</p>
<pre class="code javascript"><span class="kw2">var</span> key = <span class="st0">'length computation'</span>;
&nbsp;
<span class="kw2">function</span> length<span class="br0">&#40;</span>array, index<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span>index &gt;= array.<span class="me1">length</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="nu0">0</span>;
    mark <span class="br0">&#40;</span>key : array<span class="br0">&#91;</span>index<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw3">print</span><span class="br0">&#40;</span><span class="br0">&#40;</span>marks key<span class="br0">&#41;</span> + <span class="st0">'<span class="es0">\n</span>'</span><span class="br0">&#41;</span>;
        <span class="kw1">return</span> <span class="nu0">1</span> + length<span class="br0">&#40;</span>array, index + <span class="nu0">1</span><span class="br0">&#41;</span>;
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
length<span class="br0">&#40;</span><span class="br0">&#91;</span><span class="nu0">3</span>,<span class="nu0">8</span>,<span class="nu0">6</span>,<span class="nu0">2</span><span class="br0">&#93;</span>, <span class="nu0">0</span><span class="br0">&#41;</span>;
&nbsp;
<span class="co1">// prints:</span>
<span class="co1">// [3]</span>
<span class="co1">// [3,8]</span>
<span class="co1">// [3,8,6]</span>
<span class="co1">// [3,8,6,2] </span>
&nbsp;</pre>
<p>
The following example demonstrates stack marks that do not build up because they are in tail position:
</p>
<pre class="code javascript"><span class="kw2">var</span> key = <span class="st0">'lastval computation'</span>;
&nbsp;
<span class="kw2">function</span> lastval<span class="br0">&#40;</span>array, index<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span>index == array.<span class="me1">length</span> - <span class="nu0">1</span><span class="br0">&#41;</span> <span class="kw1">return</span> array<span class="br0">&#91;</span>index<span class="br0">&#93;</span>;
    <span class="kw3">print</span><span class="br0">&#40;</span><span class="br0">&#40;</span>marks key<span class="br0">&#41;</span> + <span class="st0">'<span class="es0">\n</span>'</span><span class="br0">&#41;</span>;
    <span class="kw1">return</span> mark<span class="br0">&#40;</span>key : array<span class="br0">&#91;</span>index<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        lastval<span class="br0">&#40;</span>array, index + <span class="nu0">1</span><span class="br0">&#41;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
lastval<span class="br0">&#40;</span><span class="br0">&#91;</span><span class="nu0">3</span>, <span class="nu0">8</span>, <span class="nu0">6</span>, <span class="nu0">2</span><span class="br0">&#93;</span>, <span class="nu0">0</span><span class="br0">&#41;</span>
&nbsp;
<span class="co1">// prints:</span>
<span class="co1">// []</span>
<span class="co1">// [3]</span>
<span class="co1">// [8]</span>
<span class="co1">// [6]</span></pre>
</div>

<a name="proposal"></a><h1>Proposal</h1>
<div class="level1">

</div>

<a name="installing_marks"></a><h2>Installing marks</h2>
<div class="level2">

<p>
 There needs to be a mechanism for installing new context marks. This mechanism should obey the marking rules detailed below. Informally, installing a stack mark should usually push the mark onto a stack of marks for its key, but in tail position it should overwrite the top mark on the stack (if there is one).
</p>

</div>

<a name="alternatives"></a><h3>Alternatives</h3>
<div class="level3">

</div>

<a name="mark_objects"></a><h4>Mark objects</h4>
<div class="level4">

<p>
 The mark form evaluates a single expression to an object, and uses all its enumerable property names as keys, adding the properties&rsquo; values to the current stack frame&rsquo;s mark set for their respective keys, according to the marking rules detailed below.
</p>
<pre class="code">WithMark ::= &quot;mark&quot; &quot;(&quot; Expression &quot;)&quot; Block</pre>
<pre class="code javascript">mark <span class="br0">&#40;</span>e<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    ...
<span class="br0">&#125;</span></pre>
<p>
<strong>Pros:</strong> 
</p>
<ul>
<li class="level1"><div class="li"> simple, concise syntax</div>
</li>
<li class="level1"><div class="li"> makes use of objects as lightweight collections of key-value pairs</div>
</li>
</ul>

<p>
 <strong>Cons:</strong> 
</p>
<ul>
<li class="level1"><div class="li"> because keys of objects must be strings, keys of stack marks must be strings</div>
</li>
<li class="level1"><div class="li"> no way to guarantee separate modules won&rsquo;t have name clashes for these strings</div>
</li>
<li class="level1"><div class="li"> I haven&rsquo;t followed the hashcode discussion closely &ndash; could that help?</div>
</li>
</ul>

</div>

<a name="keyvalue_pairs"></a><h4>Key/value pairs</h4>
<div class="level4">

<p>
 A mark expression evaluates a list of pairs of expressions, where each pair evaluates to a key and a mark value, and adds the values to the current stack frame&rsquo;s mark set for their respective keys, according to the marking rules detailed below.
</p>
<pre class="code">WithMark ::= &quot;mark&quot; &quot;(&quot; MarkPair* &quot;)&quot; Block</pre>
<pre class="code javascript">mark <span class="br0">&#40;</span>e : e, ...<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    ...
<span class="br0">&#125;</span></pre>
<p>
<strong>Pros:</strong> 
</p>
<ul>
<li class="level1"><div class="li"> makes it possible to create unique keys, because arbitrary values can be used as keys</div>
</li>
</ul>

<p>
 <strong>Cons:</strong> 
</p>
<ul>
<li class="level1"><div class="li"> slightly less simple syntax</div>
</li>
</ul>

</div>

<a name="viewing_marks"></a><h2>Viewing marks</h2>
<div class="level2">

<p>
 The mechanism for accessing marks should return an ordered collection of all the marks for a particular key. Libraries that use context marks can give others access to their marks by providing access to their key. The mark access form should return either a read-only array of the current marks, or a writeable array that is a copy of the underlying collection.
</p>

</div>

<a name="alternatives"></a><h3>Alternatives</h3>
<div class="level3">

</div>

<a name="special_object"></a><h4>Special object</h4>
<div class="level4">

<p>
 Access a list of marks for a particular key by dereferencing a read-only field of a special <code>marks</code> object.
</p>
<pre class="code">CurrentMarks ::= &quot;marks&quot;</pre>

<p>
<strong>Pros:</strong> 
</p>
<ul>
<li class="level1"><div class="li"> simple syntax</div>
</li>
<li class="level1"><div class="li"> no function call involved</div>
</li>
</ul>

<p>
 <strong>Cons:</strong> 
</p>
<ul>
<li class="level1"><div class="li"> keys have to be strings</div>
</li>
</ul>

</div>

<a name="primitive_function"></a><h4>Primitive function</h4>
<div class="level4">

<p>
 Access a list of marks for a particular key by calling a primitive <code>marks</code> function.
</p>
<pre class="code javascript">global.<span class="me1">marks</span> = <span class="coMULTI">/* native function */</span></pre>
<p>
<strong>Pros:</strong> 
</p>
<ul>
<li class="level1"><div class="li"> keys can be arbitrary values</div>
</li>
</ul>

<p>
 <strong>Cons:</strong> 
</p>
<ul>
<li class="level1"><div class="li"> it&rsquo;s a little confusing that there&rsquo;s extra context pushed on when you call the primitive function, but that should be fine as long as that function doesn&rsquo;t actually install any extra marks</div>
</li>
</ul>

</div>

<a name="special_form"></a><h4>Special form</h4>
<div class="level4">

<p>
 Unary operator that doesn&rsquo;t overload the object property access syntax, but that avoids involving a function call:
</p>
<pre class="code">CurrentMarks ::= &quot;marks&quot; Expression</pre>

<p>
This allows the use of arbitrary values for keys.
</p>

</div>

<a name="marking_rules"></a><h2>Marking rules</h2>
<div class="level2">

<p>
 The basic idea is that a mark added in tail position overwrites the last mark for that key, if there is one; otherwise, the mark is simply added to the collection of marks for that key. Marks are returned in last-in-first-out fashion, i.e., in a stack.
</p>

<p>
<em>need to describe this more</em>
</p>

</div>

<a name="applicability"></a><h1>Applicability</h1>
<div class="level1">

<p>
 Stack inspection is extremely useful for implementing all sorts of language features: 
</p>
<ul>
<li class="level1"><div class="li"> <strong>exceptions</strong>: exception handlers can be implemented as marks, with exceptions jumping upwards until they find the exception handlers</div>
</li>
<li class="level1"><div class="li"> <strong>stack traces</strong>: the compiler can mark frames with their source locations, to be retrieved by the stack trace</div>
</li>
<li class="level1"><div class="li"> <strong>AOP</strong>: features like AspectJ&rsquo;s <code>cflow</code> can be implemented by marking relevant stack frames</div>
</li>
<li class="level1"><div class="li"> <strong>security mechanisms</strong>: it&rsquo;s possible to implement security mechanisms like that of the JVM using stack inspection without losing the desired efficiency of <a href="doku.php%3Fid=discussion:proper_tail_calls.html" class="wikilink1" title="discussion:proper_tail_calls" onclick="return svchk()" onkeypress="return svchk()">proper tail calls</a> &ndash; see <a href="http://www.csc.calpoly.edu/~clements/papers/cf-toplas04.pdf" class="urlextern" target="_blank" title="http://www.csc.calpoly.edu/~clements/papers/cf-toplas04.pdf" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">A Tail-Recursive Machine with Stack Inspection</a> for more information</div>
</li>
<li class="level1"><div class="li"> etc: dynamic binding, debuggers, steppers</div>
</li>
</ul>

</div>

<a name="implementation"></a><h1>Implementation</h1>
<div class="level1">

<p>
 forthcoming...
</p>

</div>

<a name="issues"></a><h1>Issues</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> implementation strategies (need to get input from John Clements and Matthew Flatt)</div>
</li>
<li class="level1"><div class="li"> more explanation of semantics</div>
</li>
<li class="level1"><div class="li"> syntax</div>
<ul>
<li class="level2"><div class="li"> <code>mark</code> should really be an expression form, needs to mix with <code>return</code> and tail position nicer</div>
</li>
<li class="level2"><div class="li"> if we make its body a block like the <code>let</code> proposal, tail positions inside the block are fragile (e.g., what about extra semicolons at end?)</div>
</li>
</ul>
</li>
</ul>
<hr noshade="noshade" size="1" />

<p>
One reaction, not knee-jerk I hope!  Is new syntax called for, or would functions, objects, methods, and other properties do the trick?  That was the idea for <a href="doku.php%3Fid=proposals:meta_objects.html" class="wikilink1" title="proposals:meta_objects" onclick="return svchk()" onkeypress="return svchk()">meta objects</a>, although <code>null.__type__</code> and <code>undefined.__type__</code> don&rsquo;t work in general (global <code>__type__</code> function, or a wholesale revision to <code>typeof</code>, does).  I don&rsquo;t fully understand the Issues above, but some suggest that using functional forms would help.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2006/02/28 22:32</em>
</p>

<p>
I&rsquo;ve thought about that, too, and I think it might be possible. One danger of functions, though, is that functions affect the call stack, so that&rsquo;s a little confusing when you&rsquo;re implementing something that&rsquo;s inspecting the call stack. But this whole proposal is a brand new idea so I need to work more on fleshing it out.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x64%3B%26%23x68%3B%26%23x65%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x63%3B%26%23x63%3B%26%23x73%3B%26%23x2e%3B%26%23x6e%3B%26%23x65%3B%26%23x75%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x64;&#x68;&#x65;&#x72;&#x6d;&#x61;&#x6e;&#x40;&#x63;&#x63;&#x73;&#x2e;&#x6e;&#x65;&#x75;&#x2e;&#x65;&#x64;&#x75;">Dave Herman</a> 2006/03/01 18:12</em>
</p>

<p>
I dislike the concept of having to install marks on frames. I think this mostly defeats the purposes I had in mind, which involve capturing or inspecting frames you don&rsquo;t know you want to capture when you&rsquo;re writing the code: debuggers, exceptions, continuation capture, etc. 
</p>

<p>
If this set of purposes is uninteresting, or insuffiently compelling to make it into this round of language work, I do not think we need to bring in an explicit-marker-based system. That can mostly be done (or simulated nearly enough) in a library, by the community, if it&rsquo;s important.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/05/25 13:20</em>
</p>

<p>
I want to understand this some more before accepting this.
</p>

<p>
The CLR does not does not grant programs full access to their stacks. Programs can work around this by managing their own stack on the heap (i.e. manage a stack-away-from-the-VM stack). However, the JIT is less efficient on code that manage their own stack. Furthermore, allocating the stack on the heap effectively disguises the stack, hiding it from programming tools such as debuggers and profilers, as well as security managers, which expect to find run-time information on the stack.
</p>

<p>
I want to ascertain if this is indeed implementable on the CLR.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x70%3B%26%23x72%3B%26%23x61%3B%26%23x74%3B%26%23x61%3B%26%23x70%3B%26%23x6c%3B%26%23x40%3B%26%23x6d%3B%26%23x69%3B%26%23x63%3B%26%23x72%3B%26%23x6f%3B%26%23x73%3B%26%23x6f%3B%26%23x66%3B%26%23x74%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x70;&#x72;&#x61;&#x74;&#x61;&#x70;&#x6c;&#x40;&#x6d;&#x69;&#x63;&#x72;&#x6f;&#x73;&#x6f;&#x66;&#x74;&#x2e;&#x63;&#x6f;&#x6d;">Pratap Lakshman</a> 2007/01/13 11:20</em>
</p>

<p>
The stack inspection library is optional (see the bottom of the proposal page).  The thought was that lightweight implementations &ndash; such as Opera&rsquo;s &ndash; would not provide it, but there&rsquo;s no requirement that your implementation <em>has</em> to be lightweight in order not to provide it <img src="lib/images/smileys/icon_smile.gif" align="middle" alt=":-)" />  So I think you&rsquo;re on safe ground here, whether it&rsquo;s implementable on the CLR or not.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/01/16 08:02</em>
</p>

<p>
Ah, but it is implementable on the CLR! <img src="lib/images/smileys/icon_smile.gif" align="middle" alt=":-)" /> You can use the CLR&rsquo;s native stack and your debuggers will work just fine. The trick is to keep the annotations in a separate, heap-allocated stack. Each frame on this stack represents the annotation <em>above</em> the current stack frame.
</p>

<p>
Here&rsquo;s the rough approach: 
</p>
<ul>
<li class="level1"><div class="li"> ES stack frames are just CLR stack frames.</div>
</li>
<li class="level1"><div class="li"> Annotations are stored in a separate, heap-allocated stack.</div>
</li>
<li class="level1"><div class="li"> Every stack frame has an internal local variable that points to its annotation-stack frame.</div>
</li>
<li class="level1"><div class="li"> The procedure calling convention includes a protocol involving a single global cell used to communicate between caller and callee without having to pass an extra parameter (actually, it&rsquo;s a thread-local cell; one per thread).</div>
</li>
<li class="level1"><div class="li"> To perform a non-tail call:</div>
<ul>
<li class="level2"><div class="li"> the caller allocates and pushes a new frame on the annotation stack</div>
</li>
<li class="level2"><div class="li"> the caller then sets the global cell with the pointer to the new frame</div>
</li>
<li class="level2"><div class="li"> the caller calls the callee</div>
</li>
<li class="level2"><div class="li"> the callee reads the cell and sets its internal local pointer to the pointer stored in the cell</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> To perform a tail call:</div>
<ul>
<li class="level2"><div class="li"> the caller does <em>not</em> push a new frame on the annotation stack</div>
</li>
<li class="level2"><div class="li"> the caller sets the global cell with the value of its internal local pointer</div>
</li>
<li class="level2"><div class="li"> the caller tail-calls the callee</div>
</li>
<li class="level2"><div class="li"> the callee reads the cell and sets its internal local pointer to the pointer stored in the cell</div>
</li>
</ul>
</li>
</ul>

<p>
 This gives you equivalent behavior to the proposal. Specifically, by not pushing a frame on the annotation stack when performing a tail call, you&rsquo;re doing the same thing as keeping the current annotation above the stack frame but replacing the stack frame.
</p>

<p>
There&rsquo;s also a simple optimization you can do: if you know statically that no non-tail call is made from a procedure before making a tail call, then you don&rsquo;t have to set the global cell before performing the tail call, because it will already have the right pointer in it (i.e., it won&rsquo;t have been trashed).
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x64%3B%26%23x68%3B%26%23x65%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x63%3B%26%23x63%3B%26%23x73%3B%26%23x2e%3B%26%23x6e%3B%26%23x65%3B%26%23x75%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x64;&#x68;&#x65;&#x72;&#x6d;&#x61;&#x6e;&#x40;&#x63;&#x63;&#x73;&#x2e;&#x6e;&#x65;&#x75;&#x2e;&#x65;&#x64;&#x75;">Dave Herman</a> 2007/01/19 13:25</em>
</p>

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        discussion/stack_inspection.txt &middot; Last modified: 2007/01/19 21:47 by dherman      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="discussion:stack_inspection" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="discussion:stack_inspection" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="discussion:stack_inspection" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="discussion:stack_inspection" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=discussion:stack_inspection.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=discussion%253Astack_inspection&amp;1454275587" width="1" height="1" alt=""  /></body>
</html>
