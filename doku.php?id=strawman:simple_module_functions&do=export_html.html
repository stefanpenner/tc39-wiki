<html>
<head>
  <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=strawman:simple_module_functions&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=strawman" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=strawman:simple_module_functions&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=strawman:simple_module_functions&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="robots" content="noindex,nofollow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />
</head>
<body>
<div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:simple_module_functions&amp;do=export_html.html#simple_module_functions" class="toc">Simple Module Functions</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:simple_module_functions&amp;do=export_html.html#the_problem" class="toc">The problem</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:simple_module_functions&amp;do=export_html.html#the_proposal" class="toc">The proposal</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:simple_module_functions&amp;do=export_html.html#module_parameters" class="toc">Module parameters</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:simple_module_functions&amp;do=export_html.html#see" class="toc">See</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:simple_module_functions&amp;do=export_html.html#reasons_to_avoid_mutable_static_state" class="toc">Reasons to avoid mutable static state</a></span></li>
</ul>
</li>
</ul>
</div>
</div>

<a name="simple_module_functions"></a><h1>Simple Module Functions</h1>
<div class="level1">

</div>
<!-- SECTION [1-41] -->
<a name="the_problem"></a><h2>The problem</h2>
<div class="level2">

<p>
 Here we propose an enhancement to <a href="doku.php%3Fid=strawman:simple_modules.html" class="wikilink1" title="strawman:simple_modules" onclick="return svchk()" onkeypress="return svchk()">simple modules</a> to cope with the problems created by its combination of mutable static state and the second-classness of its modules. To understand the problem, consider its example of  <a href="doku.php%3Fid=strawman:simple_modules_examples.html#shared_state" class="wikilink1" title="strawman:simple_modules_examples" onclick="return svchk()" onkeypress="return svchk()">shared state</a>:
</p>
<pre class="code javascript">module Counter <span class="br0">&#123;</span>
    <span class="kw2">var</span> counter = <span class="nu0">0</span>;
    <span class="kw2">export</span> <span class="kw2">function</span> increment<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> counter++ <span class="br0">&#125;</span>
    <span class="kw2">export</span> <span class="kw2">function</span> current<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> counter <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
<p>
This could be imported by
</p>
<pre class="code javascript">    <span class="kw2">import</span> Counter.<span class="br0">&#123;</span>increment,current<span class="br0">&#125;</span>;</pre>
<p>
or loaded by
</p>
<pre class="code javascript">    module Counter = <span class="coMULTI">/*MRL or Counter.js*/</span>;</pre>
<p>
(Note that the simple modules strawman may change the concrete syntactic details shown above, but this does not affect the points made here.)
</p>

<p>
This is similar to the following pre-module code, intended to be &ldquo;imported&rdquo; by evaling it and using its completion value as the module instance:
</p>
<pre class="code javascript"><span class="co1">// Counter.js</span>
<span class="br0">&#40;</span><span class="kw2">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
    <span class="kw2">var</span> counter = <span class="nu0">0</span>;
    <span class="kw1">return</span> Object.<span class="me1">freeze</span><span class="br0">&#40;</span><span class="br0">&#123;</span>
        increment: <span class="kw2">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> counter++ <span class="br0">&#125;</span>,
        current: <span class="kw2">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> counter <span class="br0">&#125;</span>
    <span class="br0">&#125;</span><span class="br0">&#41;</span>;
<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;</pre>
<p>
Say this text has already been fetched by XHR and stored in the variable <code>CounterSrc</code>. The corresponding load operation would then be
</p>
<pre class="code javascript">    <span class="kw2">var</span> Counter = <span class="kw1">eval</span><span class="br0">&#40;</span>CounterSrc<span class="br0">&#41;</span>;</pre>
<p>
In almost all ways, the new module-based way of doing this is better than the old eval-based way. (Both are better than present practice of linkage via global variables.) However, the new module-based way does have one comparative problem. In both cases, the original Counter module has made a choice that <span class="curid"><a href="doku.php%3Fid=strawman:simple_module_functions.html#reasons_to_avoid_mutable_static_state" class="wikilink1" title="strawman:simple_module_functions" onclick="return svchk()" onkeypress="return svchk()">many consider bad practice</a></span>: the use of top level static mutable state. The customer of the Counter module may wish to avoid this choice in the system into which they import the Counter module, by nesting the load within a multiply instantiable context, such as a function body:
</p>
<pre class="code javascript">    <span class="kw2">function</span> Something<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1">//...</span>
        module Counter = <span class="coMULTI">/*MRL or Counter.js*/</span>;
        <span class="co1">//...</span>
    <span class="br0">&#125;</span></pre>
<p>
or
</p>
<pre class="code javascript">    <span class="kw2">function</span> Something<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1">//...</span>
        <span class="kw2">var</span> Counter = <span class="kw1">eval</span><span class="br0">&#40;</span>CounterSrc<span class="br0">&#41;</span>;
        <span class="co1">//...</span>
    <span class="br0">&#125;</span></pre>
<p>
However, the first module-based nested load is illegal, in order to preserve the second-class nature of modules and be able to report early errors, as explained in the modules strawman.
</p>

<p>
The design of <a href="doku.php%3Fid=strawman:simple_modules.html" class="wikilink1" title="strawman:simple_modules" onclick="return svchk()" onkeypress="return svchk()">simple modules</a> makes it possible to multiply instantiate a module by using <a href="doku.php%3Fid=strawman:module_loaders.html#dynamic_evaluation" class="wikilink1" title="strawman:module_loaders" onclick="return svchk()" onkeypress="return svchk()">dynamic evaluation</a>: 
</p>
<pre class="code javascript">    <span class="kw2">function</span> Something<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        CurrentModuleLoader.<span class="me1">evalSrc</span><span class="br0">&#40;</span>
            <span class="st0">"//..."</span> +
            <span class="st0">"module Counter = /*MRL or Counter.js*/;"</span> +
            <span class="st0">"//..."</span><span class="br0">&#41;</span>;
    <span class="br0">&#125;</span></pre>
<p>
The normal early errors here are postponed until the evalSrc happens. The problem is that the above synchronous evalSrc is not actually possible (without further mechanism) under the normal event-loop concurrency constraints, because the module can no longer static tell that the importing &ldquo;Something&rdquo; module synchronously depends on the contents of /*MRL or Counter.js*/, and therefore cannot know that it needs to prefetch it before execution begins.
</p>

</div>
<!-- SECTION [42-3323] -->
<a name="the_proposal"></a><h2>The proposal</h2>
<div class="level2">

<p>
 We enhance the grammar at <a href="doku.php%3Fid=strawman:simple_modules.html#syntax" class="wikilink1" title="strawman:simple_modules" onclick="return svchk()" onkeypress="return svchk()">syntax</a> with the following additional productions. In all cases, &ldquo;...&rdquo; means the present right hand side of an existing production.
</p>
<pre class="code">
    ModuleDeclaration ::= ... |   'module' ModuleFunctionDefinition

    ModuleFunctionDefinition ::= Identifier '(' (ModuleParameter (',' ModuleParameter)*)? ')' '{' ModuleElement* '}'

    ModuleParameter ::= FormalParameter | 'module' FormalParameter

    QualifiedPath ::= ... | ModuleFunctionCall

    ModuleFunctionCall ::= QualifiedPath Arguments
</pre>

<p>
A module function is a parameterized module definition. A module function call to a module function results in a module instance. By analogy with parameterized types, we can see that this need not violate the second class nature of modules. Regarding the time of error reporting, the body of a module function is still like the previous <code>evalSrc</code> call &ndash; a &ldquo;static&rdquo; module error within the module function body is thrown on entry to the module function.
</p>

<p>
We can now express our previous example as
</p>
<pre class="code javascript">    module Something<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="co1">//...</span>
        module Counter = <span class="coMULTI">/*MRL or Counter.js*/</span>;
        <span class="co1">//...</span>
    <span class="br0">&#125;</span></pre>
<p>
Using an explicit abstraction form is notationally more pleasant that combining an eval form and an inline literal string. We also see a more fundamental advantage: It is now statically apparent that the importing &ldquo;Something&rdquo; module synchronously depends on /*MRL or Counter.js*/, and so the module system can know to fetch the code for the latter before starting execution of the former.
</p>

<p>
Note that the fundamental advantage above may well get fixed by simple modules by other means, in which case simple module functions provides only notational advantages over the <code>evalSrc</code> pattern.
</p>

</div>
<!-- SECTION [3324-5130] -->
<a name="module_parameters"></a><h2>Module parameters</h2>
<div class="level2">

<p>
 (Rough &ndash; to be rewritten) Module loaders also explains <a href="doku.php%3Fid=strawman:module_loaders.html#module_registration" class="wikilink1" title="strawman:module_loaders" onclick="return svchk()" onkeypress="return svchk()">module registration</a>, how to dynamically demote a first class value to a second class module instance, by use of <code>attachModule</code>. In our grammar above, a module parameter annotated with <code>module</code> serves the same purpose. To a module function&rsquo;s caller, this is just a normal parameter, for which the caller should provide a first class frozen object as argument. The module function does the equivalent of <code>attachModule</code> of these arguments around the equivalent of <code>evalSrc</code>ing the module function body. This has the effect of binding the parameter name as a module name to this object as module instance.
</p>

</div>
<!-- SECTION [5131-5857] -->
<a name="see"></a><h1>See</h1>
<div class="level1">

<p>
 <a href="doku.php%3Fid=strawman:simple_modules.html" class="wikilink1" title="strawman:simple_modules" onclick="return svchk()" onkeypress="return svchk()">simple modules</a>
</p>

<p>
<a href="doku.php%3Fid=strawman:simple_modules_examples.html" class="wikilink1" title="strawman:simple_modules_examples" onclick="return svchk()" onkeypress="return svchk()">simple modules examples</a>
</p>

<p>
<a href="doku.php%3Fid=strawman:module_loaders.html" class="wikilink1" title="strawman:module_loaders" onclick="return svchk()" onkeypress="return svchk()">module loaders</a>
</p>

</div>
<!-- SECTION [5858-5973] -->
<a name="reasons_to_avoid_mutable_static_state"></a><h2>Reasons to avoid mutable static state</h2>
<div class="level2">

<p>
<a href="http://www.object-oriented-security.org/lets-argue/singletons" class="urlextern" target="_blank" title="http://www.object-oriented-security.org/lets-argue/singletons" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Singletons Considered Harmful</a> by Kenton Varda.
</p>

<p>
<a href="http://gbracha.blogspot.com/2008/02/cutting-out-static.html" class="urlextern" target="_blank" title="http://gbracha.blogspot.com/2008/02/cutting-out-static.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Cutting Out Static</a> by Gilad Bracha. <a href="http://lambda-the-ultimate.org/node/2678" class="urlextern" target="_blank" title="http://lambda-the-ultimate.org/node/2678" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Discussion</a> on Lambda the Ultimate.
</p>

<p>
<a href="http://www.erights.org/talks/asian03/paradigm-revised.pdf" class="urlextern" target="_blank" title="http://www.erights.org/talks/asian03/paradigm-revised.pdf" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Paradigm Regained: Abstraction Mechanisms for Access Control</a> by Mark Miller.
</p>

<p>
<a href="http://www.cs.berkeley.edu/~daw/papers/joe-e-ndss10.pdf" class="urlextern" target="_blank" title="http://www.cs.berkeley.edu/~daw/papers/joe-e-ndss10.pdf" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Joe-E: A Security-Oriented Subset of Java</a> by Adrian Mettler, David Wagner, and Tyler Close.
</p>

<p>
<a href="http://googletesting.blogspot.com/2008/08/root-cause-of-singletons.html" class="urlextern" target="_blank" title="http://googletesting.blogspot.com/2008/08/root-cause-of-singletons.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Root Cause of Singletons</a> by Miško Hevery.
</p>

<p>
<a href="http://code.google.com/p/google-singleton-detector/wiki/WhySingletonsAreControversial" class="urlextern" target="_blank" title="http://code.google.com/p/google-singleton-detector/wiki/WhySingletonsAreControversial" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Why Singletons Are Controversial</a> at the <a href="http://code.google.com/p/google-singleton-detector/" class="urlextern" target="_blank" title="http://code.google.com/p/google-singleton-detector/" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Google Singleton Detector project</a>.
</p>

<p>
<a href="http://c2.com/cgi/wiki?GlobalVariablesAreBad" class="urlextern" target="_blank" title="http://c2.com/cgi/wiki?GlobalVariablesAreBad" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Global Variables Are Bad</a> and <a href="http://c2.com/cgi/wiki?SingletonsAreEvil" class="urlextern" target="_blank" title="http://c2.com/cgi/wiki?SingletonsAreEvil" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Singletons Are Evil</a> on the c2 wiki.
</p>

<p>
<a href="http://blogs.msdn.com/b/scottdensmore/archive/2004/05/25/140827.aspx" class="urlextern" target="_blank" title="http://blogs.msdn.com/b/scottdensmore/archive/2004/05/25/140827.aspx" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Why Singletons are Evil</a> perhaps by Scott Densmore.
</p>

<p>
<a href="http://portal.acm.org/citation.cfm?doid=1032297.1032303" class="urlextern" target="_blank" title="http://portal.acm.org/citation.cfm?doid=1032297.1032303" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Re-engineering global variables in Ada</a> by Sward and Chamillard.
</p>

<p>
<a href="http://corfield.org/entry/Static_is_Evil" class="urlextern" target="_blank" title="http://corfield.org/entry/Static_is_Evil" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Static is Evil</a> in ColdFusion.
</p>

</div>
<!-- SECTION [5974-] -->
<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/5/50dfaf4b9debf6f359bf1cc2ad94d3cd.xhtml used -->
</body>
</html>
