<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>spec:type_system [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=spec:type_system&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="http://wiki.ecmascript.org/feed.php?mode=list&amp;ns=spec" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=spec:type_system&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=spec:type_system&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2007-07-12T17:46:06+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=spec:type_system&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">spec:type_system</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="spec:type_system" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="spec:type_system" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:self_type.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:self_type">self_type</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:oopkoolaid.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:oopkoolaid">oopkoolaid</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:operators.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:operators">operators</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=spec:wikiexportscript.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="spec:wikiexportscript">wikiexportscript</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=spec:type_system.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="spec:type_system">type_system</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#type_language" class="toc">Type Language</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#well-formed_types" class="toc">Well-Formed Types</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#type_relationships" class="toc">Type Relationships</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#resolved" class="toc">Resolved</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#questions" class="toc">Questions</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#still_missing" class="toc">Still missing...</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#runtime_type_checking" class="toc">Runtime type checking</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#playgroundmicro.sml" class="toc">playground/micro.sml</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#miscellaneous_notes" class="toc">Miscellaneous Notes</a></span><ul class="toc">
<li class="clear"><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#a_note_on_interfaces" class="toc">A note on interfaces</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=spec:type_system.html#travel_guide" class="toc">Travel guide</a></span></li>
</ul>
</li>
</ul>
</div>
</div>

<a name="type_language"></a><h1>Type Language</h1>
<div class="level1">
<pre class="code">
T ::=
   (T,..,T)       union type
   [T,..,T]       array type (last type can be repeated 0 or more times)
   {l:T,..,l:T}   structural object type, each l is a label
   function(U,S1,..,Sn, Sn+1=,..,Sm=)       function type, no rest args
   function(U,S1,..,Sn, Sn+1=,..,Sm=,...T)  function type with rest arguments
   ...
</pre>

</div>

<a name="well-formed_types"></a><h1>Well-Formed Types</h1>
<div class="level1">
<table class="inline">
	<tr>
		<th>Notation</th><th>Meaning</th>
	</tr>
	<tr>
		<td><code>|- T </code></td><td><em>type <code>T</code> is well-formed</em></td>
	</tr>
</table>
<br />

<p>
 Note that we do not make the typing environment explicit here. Most of the rules about well-formed types are standard and fairly straightforward. 
</p>

<p>
One exception is that, in function types, the rest args <strong>must</strong> be an array that supports zero-or-more elements.
</p>

</div>

<a name="type_relationships"></a><h1>Type Relationships</h1>
<div class="level1">

<p>
 There are four different relations between types: <em>equality</em> (<code>T = U</code>), <em>subtyping</em> (<code>T &lt;: U</code>), <em>compatibility</em> (<code>T ~: U</code>), and <em>convertibility</em> (<code>T ~~&gt; U</code>). These are defined in <a href="doku.php%3Fid=spec:type_relations.html" class="wikilink1" title="spec:type_relations" onclick="return svchk()" onkeypress="return svchk()">type_relations</a>.
</p>

<p>
For clarity, these rules are presented more in a declarative style than algorithmic, and this presentation is focused more on being expository than complete, since we always have the reference implementation for completeness.
</p>

</div>

<a name="resolved"></a><h1>Resolved</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> We have separate notions of program variables and type variables, but type variables exist at runtime and can be used where program variables are expected. The converse does not hold - program variables may not appear in a type context.</div>
</li>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=meetings:minutes_feb_21_2007.html#alpha-renaming" class="wikilink1" title="meetings:minutes_feb_21_2007" onclick="return svchk()" onkeypress="return svchk()">alpha-renaming</a> (renaming bound variable to avoid collision). This is required in the language, we just need to say somewhere in the English spec that alpha-renaming is implicitly performed where needed, and then everywhere else we can ignore the problem. This is the standard approach in the PL literature.</div>
</li>
</ul>

</div>

<a name="questions"></a><h1>Questions</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> Trac 122: <code>Set.&lt;*&gt; ~: Set.&lt;int&gt;</code></div>
</li>
<li class="level1"><div class="li"> Trac 127: Is <code>*</code> a top type? micro.sml argues yes for performance.</div>
</li>
<li class="level1"><div class="li"> Relationship between nominal and structural types, for subtyping and compatibility.</div>
</li>
<li class="level1"><div class="li"> E4X types and expression forms</div>
</li>
<li class="level1"><div class="li"> translation of non-nullable types? (treat nullable built-ins <code>T</code> as sugar for <code>T?</code> and treat <code>T!</code> as the &ldquo;real&rdquo; type?)</div>
</li>
<li class="level1"><div class="li"> combined optional args and rest args? - blocked on bounds proposal</div>
</li>
<li class="level1"><div class="li"> bug? every class is a subtype of the structural type containing its fixtures; but we also have <code>Object = {}</code> even though <code>Object</code> has some fixtures. Perhaps these fixtures are implicit in <code>{}</code>, and in other structural object types.</div>
</li>
</ul>

</div>

<a name="still_missing"></a><h1>Still missing...</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> typing of prototypes</div>
</li>
<li class="level1"><div class="li"> parameterized types (these are still crystallizing)</div>
<ul>
<li class="level2"><div class="li"> typedefs</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> scope of type parameters</div>
<ul>
<li class="level2"><div class="li"> limited in class initialization (initializers, settings)</div>
</li>
<li class="level2"><div class="li"> limited in inheritance specifiers (see <a href="doku.php%3Fid=discussion:type_parameters.html" class="wikilink1" title="discussion:type_parameters" onclick="return svchk()" onkeypress="return svchk()">type_parameters</a>)</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> types <code>null</code> and <code>undefined</code> don&rsquo;t allow object operations (formalize this via compatibility rules?)</div>
</li>
<li class="level1"><div class="li"> nominal subtyping details</div>
</li>
<li class="level1"><div class="li"> runtime types and conversions</div>
</li>
</ul>

<p>
 Type checking: 
</p>
<ul>
<li class="level1"><div class="li"> this should all be specified with <strong>fixtures</strong> &ndash; I&rsquo;m not sure - CF</div>
</li>
<li class="level1"><div class="li"> is the <code>Reference</code> type constructor the right thing?</div>
</li>
<li class="level1"><div class="li"> restricted uses of name <code>eval</code></div>
</li>
<li class="level1"><div class="li"> optional arguments for function types (see <a href="doku.php%3Fid=meetings:minutes_feb_21_2007.html#function_types_with_initializers" class="wikilink1" title="meetings:minutes_feb_21_2007" onclick="return svchk()" onkeypress="return svchk()">function types with initializers</a>)</div>
</li>
<li class="level1"><div class="li"> definition of âŠ“</div>
</li>
<li class="level1"><div class="li"> adding fields</div>
</li>
<li class="level1"><div class="li"> lookup(D,Ident,I) = T</div>
</li>
<li class="level1"><div class="li"> method decls</div>
</li>
<li class="level1"><div class="li"> namespaces, statically vs. dynamically bound identifiers</div>
</li>
<li class="level1"><div class="li"> <code>mustReturn</code>, a predicate on statements and blocks</div>
</li>
<li class="level1"><div class="li"> numbers and other built-ins</div>
</li>
<li class="level1"><div class="li"> overloaded <code>+</code></div>
</li>
<li class="level1"><div class="li"> other operator overloading</div>
</li>
<li class="level1"><div class="li"> many forms of &ldquo;callable&rdquo;</div>
<ul>
<li class="level2"><div class="li"> classes</div>
</li>
<li class="level2"><div class="li"> objects with special call method</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <code>new e</code> where <code>e</code> has type <code>Class</code>, vs. <code>new I</code> where <code>I</code> is a statically known class name</div>
</li>
<li class="level1"><div class="li"> conversion between class types and object types? (<code>public</code> properties only)</div>
</li>
<li class="level1"><div class="li"> generator functions &hArr; return type</div>
</li>
<li class="level1"><div class="li"> generator functions &hArr; <code>yield</code> syntactic restrictions</div>
</li>
<li class="level1"><div class="li"> need to formalize the notion of &ldquo;statically known name&rdquo; and compile-time name resolution</div>
</li>
<li class="level1"><div class="li"> more sophisticated representation of class information to deal with</div>
<ul>
<li class="level2"><div class="li"> constructor settings</div>
</li>
<li class="level2"><div class="li"> rest args</div>
</li>
<li class="level2"><div class="li"> etc.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> no partially instantiated parameterized types (only either uninstantiated or totally instantiated)</div>
</li>
<li class="level1"><div class="li"> nullables as unions? what about union ordering?</div>
</li>
</ul>

</div>

<a name="runtime_type_checking"></a><h1>Runtime type checking</h1>
<div class="level1">

<p>
 Our overall approach to gradual typing, the type <code>*</code>, the <code>strict</code> and <code>standard</code> modes, etc is summarized for a small language in the file <code>playground/micro.sml</code> under monotone, and included below.
</p>

<p>
We summarize some key issues here. We have two modes, <code>strict</code> (which may report type errors at type-checking time), and <code>standard</code> (which doesn&rsquo;t).
</p>

<p>
In both modes, we feed the input program through a verifier (aka type checker) that possibly reports type errors (though not in <code>standard</code> mode), and which outputs a verified program. The verified program is well-typed in that it only relies on subtyping: for an assignment <code>x = e</code>, the type of <code>e</code> is guaranteed to be a subtype of the slot <code>x</code>.
</p>

<p>
The verification process may insert casts to achieve this guarantee. If a value <code>v</code> of dynamic type <code>S</code> is being casted to type <code>T</code>, then the behavior of the cast depends on the relationship between <code>S</code> and <code>T</code>.
</p>
<ul>
<li class="level1"><div class="li"> If <code>S</code> is a subtype of <code>T</code>, then <code>v&rsquo; is returned as the result of the cast.
  * If </code>S<code> is compatible with </code>T<code>, then </code>v&rsquo; is returned as the result of the cast but its safety bit is set, meaning that the relationship between the dynamic type <code>S</code> of <code>v</code> and its static view may now be just compatibility, instead of subtyping.</div>
</li>
<li class="level1"><div class="li"> If <code>S</code> is *not* compatible with <code>T</code>, then a run-time error is signaled.</div>
</li>
</ul>

<p>
 Various operations on values (function invocation, array dereference, etc) need to inspect this bit and handle it appropriately.
</p>

</div>

<a name="playgroundmicro.sml"></a><h2>playground/micro.sml</h2>
<div class="level2">
<pre class="code">
(* -*- mode: sml; mode: font-lock; tab-width: 60; insert-tabs-mode: nil; indent-tabs-mode: nil -*- *)
(* vim: set ts=4 sw=4 et: *)

(* This is an implementation of a toy language to express and clarify
 * a number of issues relating to the ES4 type system in a simpler
 * context, and may also help to shake out bugs in the type system earlier. 
 * - Cormac
 *)

(*********** environments ***********)
(* variable names are just strings,
 * environments are polymorphic to support both value and type environments
 *)

exception UnboundVariable of string

type 'a ENV = (string * 'a) list

fun extend (env:'a ENV) (x:string) (v:'a) : 'a ENV =
    (x,v)::env

fun lookup (env:'a ENV) (x:string) : 'a =
    case env of
        [] =&gt; raise UnboundVariable x
      | (y,v)::r =&gt; if (x=y) then v else lookup r x

(*********** Types, subtyping, and compatibility ***********)

datatype TYPE =
         AnyType  (* the type &quot;*&quot; *)
       | IntType
       | FunType of TYPE * TYPE
       | RefType of TYPE

(* Q: Is AnyType the top type? *)

fun subtype (t1:TYPE) (t2:TYPE) : bool =
    case (t1,t2) of
        (AnyType,AnyType) =&gt; true
      | (IntType,IntType) =&gt; true
      | (FunType(s1,t1), FunType(s2,t2)) =&gt;
        (subtype s2 s1) andalso (subtype t1 t2)
      | (RefType s, RefType t) =&gt; (subtype s t) andalso (subtype t s)
      | _ =&gt; false

fun compatible (t1:TYPE) (t2:TYPE) : bool =
    case (t1,t2) of
        (_,AnyType) =&gt; true
      | (AnyType,_) =&gt; true
      | (IntType,IntType) =&gt; true
      | (FunType(s1,t1), FunType(s2,t2)) =&gt;
        (compatible s2 s1) andalso (compatible t1 t2)
      | (RefType s, RefType t) =&gt;
        (compatible s t) andalso (compatible t s)
      | _ =&gt; false

(*********** The expression language **********)

datatype EXPR =
         IntExpr of int
       | VarExpr of string
       | LetExpr of string * TYPE * EXPR * EXPR
       | FunExpr of string * TYPE * TYPE * EXPR  (* arg and result types *)
       | CastExpr of TYPE * EXPR
       | AppExpr of EXPR * EXPR
       | RefExpr of TYPE * EXPR     (* allocate, dereference, and update ref cells *)
       | GetExpr of EXPR
       | SetExpr of EXPR * EXPR
       | ExpectedType of TYPE * EXPR

(*********** Verify routines ***********)

(* some type errors *)

exception BadFunExpr of EXPR * TYPE
exception BadRefExpr of EXPR * TYPE
exception StaticTypeError of (EXPR * TYPE * TYPE)

datatype MODE =
         Standard
       | Strict

(* The expression &quot;e&quot; of type &quot;s&quot; is being converted to type &quot;t&quot; in mode &quot;mode&quot;.
 * This function either returns &quot;e&quot; itself, raises a type error,
 * or wraps &quot;e&quot; in a cast to &quot;t&quot;, as appropriate.
 *)

fun check (mode:MODE) (e:EXPR) (s:TYPE) (t:TYPE) : EXPR =
    if (subtype s t)
    then e
    else if (compatible s t) orelse mode=Standard
    then CastExpr (t,e)
    else raise StaticTypeError (e,s,t)

(* Type checks expression &quot;e&quot; in type environment &quot;n&quot; and mode &quot;mode&quot;,
 * and returns a pair of 
 * an expression (which is &quot;e&quot; with extra casts where necessary)
 * and the inferred type of &quot;e&quot;.
 *
 * The resulting expression satisfies the invariant that if an expression of type &quot;s&quot;
 * is bound to a variable of type &quot;t&quot;, then &quot;s&quot; is a subtype of &quot;t&quot; - this invariant
 * is ensured via dynamic casts if necessary, both in Strict and Standard mode.
 *)
       
fun verify (mode:MODE) (n:TYPE ENV) (e:EXPR) : (EXPR * TYPE) =
    case e of
        IntExpr n =&gt; (e,IntType)
      | VarExpr x =&gt; (e, lookup n x)
      | LetExpr (x,t,e,body) =&gt; 
        let val e' = verifyAndCheck mode n e t
            val n' = extend n x t
            val (body',bodyTy) = verify mode n' body
        in
            (LetExpr (x, t, e', body'), bodyTy)
        end
      | FunExpr (x,t1,t2,e) =&gt; 
        let val e' = verifyAndCheck mode (extend n x t1) e t2
        in
            (FunExpr(x,t1,t2,e'), FunType(t1,t2))
        end
      | CastExpr (ty,e) =&gt;
        let val (e',ty) = verify mode n e 
        in
            (CastExpr(ty,e'), ty)
        end
      | AppExpr (e1,e2) =&gt;
        let val (e1',ty1) = verify mode n e1
        in
        case ty1 of
            FunType (argty,resty) =&gt;
            (ExpectedType (resty, 
                           AppExpr(e1', 
                                   verifyAndCheck mode n e2 argty)), 
             resty)
          | AnyType =&gt;
            (ExpectedType (AnyType, 
                           AppExpr( CastExpr( FunType(AnyType,AnyType), e1'),
                                    verifyAndCheck mode n e2 AnyType)),
             AnyType)
          | _ =&gt; raise BadFunExpr (e1',ty1)
        end
      | RefExpr (t,e) =&gt;
        (RefExpr (t, verifyAndCheck mode n e t), RefType t)
      | GetExpr e =&gt;
        let val (e',t) = verify mode n e in
            (ExpectedType (t, GetExpr e'), t)
        end
      | SetExpr (e1, e2) =&gt;
        let val (e1',t1) = verify mode n e1
        in
            case t1 of
                RefType s =&gt;
                (SetExpr (e1', 
                          verifyAndCheck mode n e2 s),
                 s)
              | AnyType =&gt;
                (SetExpr (CastExpr(RefType AnyType, e1'), 
                          verifyAndCheck mode n e2 AnyType),
                 AnyType)
              | _ =&gt; raise BadRefExpr (e1',t1)
        end

and verifyAndCheck (mode:MODE) (n:TYPE ENV) (e:EXPR) (t:TYPE) =
    let val (e',t') = verify mode n e in
        check mode e' t' t
    end


(*********** Evaluation, run-time values, and conversion ***********)

(* Every closure has a &quot;safe&quot; bit. 
 * This Safe bit, together with the Strict/Standard mode, constrain the relationship between
 * the dynamic type of the closure  and the static type of the reference to the closure,
 * as follows:
 * 
 * SAFEBIT     MODE                    typing relation
 * Safe        Strict or Standard      subtyping
 * Unsafe      Strict                  compatibility
 * Unsafe      Standard                no constraint
 *)

datatype SAFEBIT =
         Safe
       | Unsafe

datatype VAL =
         IntVal of int
       | ClosureVal of string * TYPE * TYPE * EXPR * VAL ENV * SAFEBIT
       | RefVal of TYPE * VAL ref * SAFEBIT

exception NotAClosure of VAL
exception NotARef of VAL
exception ConversionError of (VAL * TYPE)

fun typeOfVal (v:VAL) : TYPE =
    case v of
        IntVal _ =&gt; IntType
      | ClosureVal (_,t1,t2,_,_,_) =&gt; FunType (t1,t2)      
      | RefVal (t,_,_) =&gt; RefType t

fun markUnsafe (v:VAL) : VAL =
    case v of
        IntVal _ =&gt; v
      | ClosureVal (x,t1,t2,body,env,_) =&gt; ClosureVal(x,t1,t2,body,env,Unsafe)
      | RefVal (t,v,_) =&gt; RefVal(t,v,Unsafe)

(* Converts a value &quot;v&quot; to type &quot;t&quot;, 
 * raising an error if the type of &quot;v&quot; is not compatible with &quot;t&quot;,
 * and setting the unsafe bit if the type of &quot;v&quot; is not a subtype of &quot;t&quot;.
 *)

fun convert (v:VAL) (t:TYPE) : VAL =
    let val s = typeOfVal v in
        if subtype s t
        then v
        else if compatible s t
        then markUnsafe v
        else raise ConversionError (v,t)
    end

fun eval (n:VAL ENV) (e:EXPR) : VAL =
    case e of
        IntExpr n =&gt; IntVal n
      | VarExpr x =&gt; lookup n x
      | LetExpr (x,t,e,body) =&gt; eval (extend n x (eval n e)) body
      | FunExpr (x,t1,t2,e) =&gt; ClosureVal (x,t1,t2,e,n,Safe)
      | CastExpr (ty,e) =&gt; convert (eval n e) ty        
      | ExpectedType (retTy, AppExpr (e1,e2)) =&gt;
        let in
            case (eval n e1) of
                ClosureVal (x,argTy,_,body,n2,safebit) =&gt;
                let val argVal  = (eval n e2)
                    val argVal' = case safebit of Safe =&gt; argVal | Unsafe =&gt; convert argVal argTy
                    val resVal  = eval (extend n2 x argVal') body
                    (* tail call issues here *)
                    val resVal' = case safebit of Safe =&gt; resVal | Unsafe =&gt; convert resVal retTy
                in
                    resVal'
                end
              | v =&gt; raise NotAClosure v
        end
      | RefExpr (t,e) =&gt; RefVal(t, ref (eval n e), Safe)
      | ExpectedType (t, GetExpr e) =&gt;
        let in
            case eval n e of
                RefVal (_,r,Safe) =&gt; !r
              | RefVal (s,r,Unsafe) =&gt; convert (!r) t
        end
      | SetExpr (e1,e2) =&gt;
        let in
            case eval n e1 of
                RefVal (t,r,safebit) =&gt;
                let val v = eval n e2 in
                    case safebit of 
                        Safe =&gt; r := v 
                      | Unsafe =&gt; r := convert v t;
                    v
                end
              | v =&gt; raise NotARef v
        end
        
(*********** Tests **********)

fun go (mode:MODE) (e:EXPR) : (EXPR*VAL) =
    let val (e',ty) = verify mode [] e 
        val v = eval [] e'
    in 
        (e',v)
    end

fun go2 (e:EXPR) =
    (go Standard e, go Strict e)

val idint : EXPR = FunExpr(&quot;x&quot;,IntType,IntType,VarExpr &quot;x&quot;)
val idany : EXPR = FunExpr(&quot;x&quot;,AnyType,AnyType,VarExpr &quot;x&quot;)
val idbad : EXPR = FunExpr(&quot;x&quot;,AnyType,IntType,VarExpr &quot;x&quot;);

(*
(go2 idint);
(go2 idany);
(go2 idbad);
*)

(go2
     (LetExpr (&quot;f&quot; ,AnyType, idint,
               (AppExpr (VarExpr &quot;f&quot;, 
                         IntExpr 4 
)))))
</pre>

<p>
 Function applications may require stacking to checks on the stack, leading to problems with tail recursion - see <a href="doku.php%3Fid=clarification:runtime_types_and_conversions.html" class="wikilink1" title="clarification:runtime_types_and_conversions" onclick="return svchk()" onkeypress="return svchk()">runtime_types_and_conversions</a>.
</p>

<p>
Some additional notes are at:
</p>
<ul>
<li class="level1"><div class="li"> Type conversions and tail calls </div>
</li>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=meetings:minutes_jul_27_2006.html" class="wikilink1" title="meetings:minutes_jul_27_2006" onclick="return svchk()" onkeypress="return svchk()">minutes_jul_27_2006</a></div>
</li>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=meetings:minutes_dec_13_2006.html" class="wikilink1" title="meetings:minutes_dec_13_2006" onclick="return svchk()" onkeypress="return svchk()">minutes_dec_13_2006</a></div>
</li>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=meetings:minutes_jan_24_2007.html" class="wikilink1" title="meetings:minutes_jan_24_2007" onclick="return svchk()" onkeypress="return svchk()">minutes_jan_24_2007</a></div>
</li>
</ul>

</div>

<a name="miscellaneous_notes"></a><h1>Miscellaneous Notes</h1>
<div class="level1">
<ul>
<li class="level1"><div class="li"> <code>const</code> does not affect typing</div>
</li>
<li class="level1"><div class="li"> patterns are desugared before type checking</div>
</li>
<li class="level1"><div class="li"> hoisting is performed before type checking</div>
</li>
<li class="level1"><div class="li"> <code>v is T</code> is defined to perform the subtyping algorithm</div>
</li>
<li class="level1"><div class="li"> <code>v to T</code> performs the <code>to</code>-method corresponding to the convertibility rules, or is a no-op if <code>v</code> is trivially convertible to <code>T</code> (i.e., it&rsquo;s already compatible with <code>T</code>); the operation throws a <code>TypeError</code> if <code>v</code> is not convertible to <code>T</code></div>
</li>
<li class="level1"><div class="li"> any global bindings in the host environment&rsquo;s library that the type checker knows about must be <code>DontDelete</code> and have a runtime type constraint</div>
</li>
<li class="level1"><div class="li"> runtime restrictions for <a href="doku.php%3Fid=proposals:reformed_with.html" class="wikilink1" title="proposals:reformed_with" onclick="return svchk()" onkeypress="return svchk()">reformed_with</a>, <a href="doku.php%3Fid=proposals:resurrected_eval.html" class="wikilink1" title="proposals:resurrected_eval" onclick="return svchk()" onkeypress="return svchk()">resurrected_eval</a>, and reformed eval (see <a href="doku.php%3Fid=meetings:minutes_jan_24_2007.html" class="wikilink1" title="meetings:minutes_jan_24_2007" onclick="return svchk()" onkeypress="return svchk()">minutes_jan_24_2007</a> and <a href="doku.php%3Fid=meetings:minutes_feb_06_2007.html" class="wikilink1" title="meetings:minutes_feb_06_2007" onclick="return svchk()" onkeypress="return svchk()">minutes_feb_06_2007</a>)</div>
</li>
<li class="level1"><div class="li"> for now, <code>()</code> is illegal syntax, empty unions are verboten (see the relevant <a href="https://members.ecma-international.org/archives/tc39-tg1-545900/frm00829.html" class="urlextern" target="_blank" title="https://members.ecma-international.org/archives/tc39-tg1-545900/frm00829.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">TG1 mailing list thread</a>)</div>
<ul>
<li class="level2"><div class="li"> perhaps useful in future to restrict function bodies to forbid termination</div>
</li>
</ul>
</li>
</ul>

</div>

<a name="a_note_on_interfaces"></a><h3>A note on interfaces</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> interfaces allow method redeclaration with appropriate subtyping (covariant return, contravariant arg)</div>
</li>
<li class="level1"><div class="li"> this might result in unimplementable interfaces, e.g. if two superinterfaces have versions of a method with unrelated return types; but this is legal, only on implementing will you see an error</div>
</li>
</ul>

</div>

<a name="travel_guide"></a><h2>Travel guide</h2>
<div class="level2">

<p>
 Other pages of interest to the type system include: 
</p>
<table class="inline">
	<tr>
		<th>Section</th><th>Page</th>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=discussion:discussions.html" class="wikilink1" title="discussion:discussions" onclick="return svchk()" onkeypress="return svchk()">discussions</a></td><td><a href="doku.php%3Fid=discussion:is_as_to.html" class="wikilink1" title="discussion:is_as_to" onclick="return svchk()" onkeypress="return svchk()">is_as_to</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=discussion:discussions.html" class="wikilink1" title="discussion:discussions" onclick="return svchk()" onkeypress="return svchk()">discussions</a></td><td><a href="doku.php%3Fid=discussion:type_parameters.html" class="wikilink1" title="discussion:type_parameters" onclick="return svchk()" onkeypress="return svchk()">type_parameters</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=discussion:discussions.html" class="wikilink1" title="discussion:discussions" onclick="return svchk()" onkeypress="return svchk()">discussions</a></td><td><a href="doku.php%3Fid=discussion:nullability.html" class="wikilink1" title="discussion:nullability" onclick="return svchk()" onkeypress="return svchk()">nullability</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=discussion:discussions.html" class="wikilink1" title="discussion:discussions" onclick="return svchk()" onkeypress="return svchk()">discussions</a></td><td><a href="doku.php%3Fid=discussion:strict_and_standard_modes.html" class="wikilink1" title="discussion:strict_and_standard_modes" onclick="return svchk()" onkeypress="return svchk()">strict_and_standard_modes</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=spec:spec.html" class="wikilink1" title="spec:spec" onclick="return svchk()" onkeypress="return svchk()">spec</a></td><td><a href="doku.php%3Fid=spec:chapter_6_types.html" class="wikilink1" title="spec:chapter_6_types" onclick="return svchk()" onkeypress="return svchk()">chapter_6_types</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=spec:spec.html" class="wikilink1" title="spec:spec" onclick="return svchk()" onkeypress="return svchk()">spec</a></td><td><span class="curid"><a href="doku.php%3Fid=spec:type_system.html" class="wikilink1" title="spec:type_system" onclick="return svchk()" onkeypress="return svchk()">type_system</a></span><code> </code>&larr; you are here</td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=proposals:proposals.html" class="wikilink1" title="proposals:proposals" onclick="return svchk()" onkeypress="return svchk()">proposals</a></td><td><a href="doku.php%3Fid=proposals:type_parameters.html" class="wikilink1" title="proposals:type_parameters" onclick="return svchk()" onkeypress="return svchk()">type_parameters</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=proposals:proposals.html" class="wikilink1" title="proposals:proposals" onclick="return svchk()" onkeypress="return svchk()">proposals</a></td><td><a href="doku.php%3Fid=proposals:structural_types_and_typing_of_initializers.html" class="wikilink1" title="proposals:structural_types_and_typing_of_initializers" onclick="return svchk()" onkeypress="return svchk()">structural_types_and_typing_of_initializers</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=proposals:proposals.html" class="wikilink1" title="proposals:proposals" onclick="return svchk()" onkeypress="return svchk()">proposals</a></td><td><a href="doku.php%3Fid=proposals:is_as_to.html" class="wikilink1" title="proposals:is_as_to" onclick="return svchk()" onkeypress="return svchk()">is_as_to</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=proposals:proposals.html" class="wikilink1" title="proposals:proposals" onclick="return svchk()" onkeypress="return svchk()">proposals</a></td><td><a href="doku.php%3Fid=proposals:nullability.html" class="wikilink1" title="proposals:nullability" onclick="return svchk()" onkeypress="return svchk()">nullability</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=proposals:proposals.html" class="wikilink1" title="proposals:proposals" onclick="return svchk()" onkeypress="return svchk()">proposals</a></td><td><a href="doku.php%3Fid=proposals:strict_and_standard_modes.html" class="wikilink1" title="proposals:strict_and_standard_modes" onclick="return svchk()" onkeypress="return svchk()">strict_and_standard_modes</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=proposals:proposals.html" class="wikilink1" title="proposals:proposals" onclick="return svchk()" onkeypress="return svchk()">proposals</a></td><td><a href="doku.php%3Fid=proposals:switch_class.html" class="wikilink1" title="proposals:switch_class" onclick="return svchk()" onkeypress="return svchk()">switch_class</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=proposals:proposals.html" class="wikilink1" title="proposals:proposals" onclick="return svchk()" onkeypress="return svchk()">proposals</a></td><td><a href="doku.php%3Fid=proposals:type_definitions.html" class="wikilink1" title="proposals:type_definitions" onclick="return svchk()" onkeypress="return svchk()">type_definitions</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=proposals:proposals.html" class="wikilink1" title="proposals:proposals" onclick="return svchk()" onkeypress="return svchk()">proposals</a></td><td><a href="doku.php%3Fid=proposals:syntax_for_type_expressions.html" class="wikilink1" title="proposals:syntax_for_type_expressions" onclick="return svchk()" onkeypress="return svchk()">syntax_for_type_expressions</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=clarification:clarifications.html" class="wikilink1" title="clarification:clarifications" onclick="return svchk()" onkeypress="return svchk()">clarifications</a></td><td><a href="doku.php%3Fid=clarification:type_system.html" class="wikilink1" title="clarification:type_system" onclick="return svchk()" onkeypress="return svchk()">type_system</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=clarification:clarifications.html" class="wikilink1" title="clarification:clarifications" onclick="return svchk()" onkeypress="return svchk()">clarifications</a></td><td><a href="doku.php%3Fid=clarification:formal_type_system.html" class="wikilink1" title="clarification:formal_type_system" onclick="return svchk()" onkeypress="return svchk()">formal_type_system</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=clarification:clarifications.html" class="wikilink1" title="clarification:clarifications" onclick="return svchk()" onkeypress="return svchk()">clarifications</a></td><td><a href="doku.php%3Fid=clarification:drop_traits.html" class="wikilink1" title="clarification:drop_traits" onclick="return svchk()" onkeypress="return svchk()">drop_traits</a></td>
	</tr>
	<tr>
		<td><a href="doku.php%3Fid=clarification:clarifications.html" class="wikilink1" title="clarification:clarifications" onclick="return svchk()" onkeypress="return svchk()">clarifications</a></td><td><a href="doku.php%3Fid=clarification:runtime_types_and_conversions.html" class="wikilink1" title="clarification:runtime_types_and_conversions" onclick="return svchk()" onkeypress="return svchk()">runtime_types_and_conversions</a></td>
	</tr>
</table>
<br />

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        spec/type_system.txt &middot; Last modified: 2007/07/12 17:46 by cormac      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="spec:type_system" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="spec:type_system" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="spec:type_system" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="spec:type_system" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=spec:type_system.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=spec%253Atype_system&amp;1454276568" width="1" height="1" alt=""  /></body>
</html>
