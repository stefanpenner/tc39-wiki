<html>
<head>
  <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=discussion:update_unicode&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=discussion" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=discussion:update_unicode&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=discussion:update_unicode&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="robots" content="noindex,nofollow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />
</head>
<body>
<div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:update_unicode&amp;do=export_html.html#updated_unicode_functionality" class="toc">Updated Unicode functionality</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:update_unicode&amp;do=export_html.html#extended_unicode_character_constants" class="toc">Extended Unicode character constants</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:update_unicode&amp;do=export_html.html#changes_to_the_string_class" class="toc">Changes to the String class</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:update_unicode&amp;do=export_html.html#comments" class="toc">Comments</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:update_unicode&amp;do=export_html.html#counterproposal" class="toc">Counterproposal</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:update_unicode&amp;do=export_html.html#proposal" class="toc">Proposal</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:update_unicode&amp;do=export_html.html#discussion" class="toc">Discussion</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:update_unicode&amp;do=export_html.html#format_control_proposal" class="toc">Format Control Proposal</a></span></li>
</ul>
</div>
</div>

<a name="updated_unicode_functionality"></a><h1>Updated Unicode functionality</h1>
<div class="level1">

<p>
 (This is the discussion page for <a href="doku.php%3Fid=proposals:update_unicode.html" class="wikilink1" title="proposals:update_unicode" onclick="return svchk()" onkeypress="return svchk()">proposals:update unicode</a>.)
</p>

<p>
We need to add better handling for non-BMP characters. Currently, the String class supports surrogate pairs for extended characters.
</p>

</div>
<!-- SECTION [1-269] -->
<a name="extended_unicode_character_constants"></a><h2>Extended Unicode character constants</h2>
<div class="level2">

<p>
 I propose to add a bracket notation to all numeric escapes in string literals: 
</p>
<pre class="code">
\u{1AFFE}
\x{1AFFE}
</pre>

<p>
 This notation would make \u equivalent to \x, and programmers could use any numeric escape to speficy any Unicode character. Octals should not be supported in this way.
</p>

</div>
<!-- SECTION [270-603] -->
<a name="changes_to_the_string_class"></a><h2>Changes to the String class</h2>
<div class="level2">

<p>
 The internal implementation of the String class uses code points instead of characters. The length property reflects the number of code points, and the index operator returns the value of code points. All functions treat surrogate pairs as one code point. For small systems, implementers can choose to throw a runtime error when detecting surrogate pairs.
</p>

<p>
Alternative: Define a new class <code>WideString</code> that has the same elements as <code>String</code>, but works with code points. Add <code>String.codePointAt (n)</code> that returns the code point at the given index. If the index points to the second character of a surrogate pair, throw an error.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6d%3B%26%23x64%3B%26%23x61%3B%26%23x65%3B%26%23x75%3B%26%23x6d%3B%26%23x6c%3B%26%23x69%3B%26%23x40%3B%26%23x61%3B%26%23x64%3B%26%23x6f%3B%26%23x62%3B%26%23x65%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6d;&#x64;&#x61;&#x65;&#x75;&#x6d;&#x6c;&#x69;&#x40;&#x61;&#x64;&#x6f;&#x62;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">Michael Daumling</a> 2006/04/21 16:04</em>
</p>

<p>
I don&rsquo;t see the point in <code>WideString.prototype.codePointAt</code>, since the UTF-16 forms have been erased in wide strings.  <code>charCodeAt</code> and <code>charAt</code> should suffice, and both can throw if any surrogate pair half is seen.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2006/04/21 18:27</em>
</p>

</div>
<!-- SECTION [604-1633] -->
<a name="comments"></a><h2>Comments</h2>
<div class="level2">

<p>
 The Unicode people at Opera do not believe that this proposal places a huge burden on our implementation (targeted to very small systems), ie, we can live with the larger tables, probably.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/03/31 04:11</em>
</p>

</div>
<!-- SECTION [1634-1905] -->
<a name="counterproposal"></a><h1>Counterproposal</h1>
<div class="level1">

<p>
 The original proposal tries to attack several problems with Unicode in ECMAScript: 
</p>
<ul>
<li class="level1"><div class="li"> ECMAScript 3 implementations are locked into a 16-bit Unicode representation by the spec.  Implementations that provide 21-bit character representations are nonconforming.</div>
</li>
<li class="level1"><div class="li"> There is no way to write down with a single lexeme Unicode characters outside the 16-bit range, you have to use two \u literals.  Doing so is senseless unless the character is represented internally as a surrogate pair, so it would break if the language did support wider characters.</div>
</li>
<li class="level1"><div class="li"> In some cases the surrounding host system uses full Unicode, but host characters must be represented using surrogate pairs in ECMAScript strings.  This is error prone for some applications, but not for all.</div>
</li>
</ul>

<p>
 All of these problems are worth solving.
</p>

<p>
Today the major application of ECMAScript is in browsers, and at least MSIE, Firefox, and Opera all use UTF16 internally.  <acronym title="Microsoft">MS</acronym> Windows has native 16-bit APIs (and other operating systems probably do as well).  Demanding that these implementations move to wider representations now will be met with resistance.  They will in any case not all do so at the same time.
</p>

<p>
However, operating systems and browsers will move to wider strings eventually, and we should at the very least future-proof the language.
</p>

</div>
<!-- SECTION [1906-3243] -->
<a name="proposal"></a><h2>Proposal</h2>
<div class="level2">

<p>
 ECMAScript implementations are allowed to, but not required to, support full Unicode (21-bit) characters.  
</p>

<p>
An ECMAScript implementation that uses full Unicode but interacting with a host system that uses UTF16 shall never see surrogate pairs in strings; all characters shall be resolved as full Unicode characters.
</p>

<p>
The proposed new syntax is added to the language and shall be used to write down all character values outside the 16-bit range.  In systems with 16-bit strings such a character value shall turn into a surrogate pair of two indexable characters in the resulting string, with the high part of the pair at the lower index.
</p>

<p>
Two code points written down as \unnnn\unnnn shall be represented as individually indexable characters in all implementations, even if they form a valid UTF16 surrogate pair.
</p>

<p>
(Open question: character classification, case folding in 16-bit implementations.)
</p>

</div>
<!-- SECTION [3244-4164] -->
<a name="discussion"></a><h2>Discussion</h2>
<div class="level2">

<p>
 On the one hand, this looks like a return to the bad old days of unknown representations (eg, C, C++).  
</p>

<p>
On the other hand, it does allow implementations to move to full Unicode at their leisure (including immediately), it allows implementers and programmers to understand the meaning of programs in both kinds of implementations, and it allows programmers to future-proof their programs by pretending to use full Unicode in strings and only worrying about surrogate pairs in some circumstances.
</p>

<p>
A future update to the language may then require full Unicode characters everywhere; this will not change the meaning of any portable program written for ECMAScript 4.  (Non-portable programs written for 16-bit implementations may have slight behavioral changes, though.)
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/04/22 07:23</em>
</p>

</div>
<!-- SECTION [4165-5021] -->
<a name="format_control_proposal"></a><h1>Format Control Proposal</h1>
<div class="level1">

<p>
 The problem was reported by <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=274152" class="urlextern" target="_blank" title="https://bugzilla.mozilla.org/show_bug.cgi?id=274152" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">https://bugzilla.mozilla.org/show_bug.cgi?id=274152</a>, with some hot-headed comments about &ldquo;brain-dead ECMA&rdquo; <img src="lib/images/smileys/icon_wink.gif" align="middle" alt=";-)" />.  For a cooler summary of the problem, start <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=274152#c14" class="urlextern" target="_blank" title="https://bugzilla.mozilla.org/show_bug.cgi?id=274152#c14" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">here</a>.  It seems that <acronym title="Internet Explorer">IE</acronym>&lsquo;s JScript implementation does not follow ECMA-262 by stripping format-control characters blindly: it does not strip <em>any</em> format-control characters in string literals.
</p>

<p>
This means lexer context feeds back on input character stripping, which is easy enough to implement, if a bit clunky.
</p>

<p>
Does the same thing happen in <code>RegExp</code> literals?
</p>

<p>
Whatever the case, I propose that we do as <acronym title="Internet Explorer">IE</acronym> JScript has done.  <acronym title="Internet Explorer">IE</acronym> has flouted ECMA-262, and established the de-facto standard here.  And from the user feedback we&rsquo;ve received, it does more-or-less &ldquo;the right thing&rdquo;.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2006/04/26 23:33</em> 
</p>

<p>
Opera does not strip format control characters anywhere, either.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/04/27 00:38</em>
</p>

<p>
Those at the <a href="doku.php%3Fid=meetings:minutes_jan_24_2007.html" class="wikilink1" title="meetings:minutes_jan_24_2007" onclick="return svchk()" onkeypress="return svchk()">January face-to-face</a> may recall my committing the patch to make SpiderMonkey leave format control characters alone. That seems to have regressed Yahoo! mail &ndash; see <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=368516" class="urlextern" target="_blank" title="https://bugzilla.mozilla.org/show_bug.cgi?id=368516" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Mozilla bug 368516</a>. Why does that Ajax app work in <acronym title="Internet Explorer">IE</acronym> and Opera, if they too do not strip format control chars?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/02/03 18:38</em>
</p>

<p>
It does <em>not</em> work in Opera.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x68%3B%26%23x72%3B%26%23x69%3B%26%23x73%3B%26%23x70%3B%26%23x69%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x63;&#x68;&#x72;&#x69;&#x73;&#x70;&#x69;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Chris Pine</a> 2007/02/05 01:23</em>
</p>

<p>
Aha!  How about <acronym title="Internet Explorer">IE</acronym>?  I can&rsquo;t test at the moment.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/02/05 21:41</em> 
</p>

</div>
<!-- SECTION [5022-] -->
<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/d/de0164b02a12f69e020823a79c4e31bd.xhtml used -->
</body>
</html>
