<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>strawman:fixed_properties [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=strawman:fixed_properties&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=strawman" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=strawman:fixed_properties&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=strawman:fixed_properties&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2011-07-13T10:50:07+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=strawman:fixed_properties&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">strawman:fixed_properties</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="strawman:fixed_properties" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:fixed_properties" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:proxy_derived_traps.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:proxy_derived_traps">proxy_derived_traps</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:iterators.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:iterators">iterators</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:handler_access_to_proxy.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:handler_access_to_proxy">handler_access_to_proxy</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:catchalls.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:catchalls">catchalls</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=strawman:fixed_properties.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:fixed_properties">fixed_properties</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:fixed_properties.html#fixed_properties_for_proxies" class="toc">Fixed Properties for Proxies</a></span><ul class="toc">
<li class="clear"><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:fixed_properties.html#enforcing_the_invariants" class="toc">Enforcing the invariants</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:fixed_properties.html#required_checks" class="toc">Required checks</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:fixed_properties.html#specification" class="toc">Specification</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:fixed_properties.html#open_issues" class="toc">Open issues</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:fixed_properties.html#references" class="toc">References</a></span></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<a name="fixed_properties_for_proxies"></a><h1>Fixed Properties for Proxies</h1>
<div class="level1">

<p>
 Goal: allow proxies to emulate non-configurable properties, without breaking the invariants implied by <code>configurable:false</code>.
</p>

<p>
In what follows, a <u>fixed property</u> is a non-configurable property that is observed as the return value from the <code>get{Own}PropertyDescriptor</code> traps, or as an input argument to a successful <code>defineProperty</code> trap invocation. In other words, fixed properties are exposed non-configurable properties of Proxy objects.
</p>

<p>
This strawman proposes to allow proxies to expose non-configurable properties, provided that the following invariants are upheld: 
</p>
<ul>
<li class="level1"><div class="li"> get{Own}PropertyDescriptor cannot report fixed properties as non-existent</div>
</li>
<li class="level1"><div class="li"> get{Own}PropertyDescriptor cannot report incompatible changes to a fixed property (e.g. reporting a non-configurable property as configurable, or reporting a non-configurable, non-writable property as writable)</div>
</li>
<li class="level1"><div class="li"> defineProperty cannot complete successfully when incompatible changes are made to the attributes of fixed properties</div>
</li>
<li class="level1"><div class="li"> when a proxy is fixed, no incompatible changes to fixed properties can be made (i.e. properties returned by the fix() trap are combined with fixed properties before fixing the proxy)</div>
</li>
<li class="level1"><div class="li"> delete cannot report a successful deletion of a fixed property</div>
</li>
<li class="level1"><div class="li"> hasOwn cannot report a fixed property as non-existent</div>
</li>
<li class="level1"><div class="li"> has cannot report a fixed property as non-existent</div>
</li>
<li class="level1"><div class="li"> get cannot report inconsistent values for non-writable fixed data properties</div>
</li>
<li class="level1"><div class="li"> set cannot report a successful assignment for non-writable fixed data properties</div>
</li>
</ul>

<p>
 These invariants are derived from the <a href="doku.php%3Fid=es3.1:attribute_states.html" class="wikilink1" title="es3.1:attribute_states" onclick="return svchk()" onkeypress="return svchk()">allowable state transitions</a> of ES5 property descriptors, and from ES5 Section 8.6.2, &ldquo;Object Internal Properties and Methods&rdquo;.
</p>

</div>

<a name="enforcing_the_invariants"></a><h3>Enforcing the invariants</h3>
<div class="level3">

<p>
 Two approaches were identified:
</p>
<ol>
<li class="level1"><div class="li"> <strong>Trap-and-enforce</strong>: The proxy stores a copy of all fixed properties. Traps whose name corresponds to a fixed property are still triggered, but the result of the trap is checked for conformance against the copy. <code>defineProperty</code> updates the copy if the trap completes successfully. A failed check causes a <code>TypeError</code> to be thrown.</div>
</li>
<li class="level1"><div class="li"> <strong>Short-circuiting</strong>: The proxy stores a copy of all fixed properties. Traps whose name corresponds to a fixed property are no longer triggered, the proxy instead applies the default behavior on its copy of the property.</div>
</li>
</ol>

<p>
 This strawman proposes the trap-and-enforce model. An earlier version proposed the short-circuiting approach, but was retracted because of the following:
</p>
<ul>
<li class="level1"><div class="li"> Operating on the copy of a property without trapping could cause the copy to diverge from the &ldquo;virtual&rdquo; property. The strawman could be patched up to the point where e.g. Array&rsquo;s non-configurable <code>length</code> could be emulated, but it was ad hoc.</div>
</li>
<li class="level1"><div class="li"> The short-circuiting approach required changes to the Proxy <acronym title="Application Programming Interface">API</acronym> and had implications on the default forwarding handler. The trap-and-enforce approach requires no such changes.</div>
</li>
<li class="level1"><div class="li"> Inherited fixed properties exposed through <code>getPropertyDescriptor</code> would be wrongfully exposed as own properties.</div>
</li>
<li class="level1"><div class="li"> Short-circuited proxies caused a surprising information leak when used as membrane wrappers: a revoked membrane wrapper would continue to expose fixed properties.</div>
</li>
</ul>

</div>

<a name="required_checks"></a><h3>Required checks</h3>
<div class="level3">

<p>
 To check whether a descriptor for <code>name</code> is &ldquo;compatible&rdquo;, is equivalent to testing whether the built-in [[DefineOwnProperty]] method on a regular <code>Object</code> that contains an own <code>name</code> property completes successfully. 
</p>
<ul>
<li class="level1"><div class="li"> <code>get{Own}PropertyDescriptor(name)</code>: check whether <code>name</code> was fixed. If so, check whether the returned descriptor is compatible. If the returned descriptor is non-configurable, mark it as fixed.</div>
</li>
<li class="level1"><div class="li"> <code>defineProperty(name,desc)</code>: check whether <code>name</code> was fixed. If so, and if <code>defineProperty</code> completes successfully, check whether the changes made are compatible, and record the changes. If <code>desc</code> is non-configurable, mark it as fixed.</div>
</li>
<li class="level1"><div class="li"> <code>fix()</code>: for each fixed property returned by the trap, check whether its descriptor is compatible.</div>
</li>
<li class="level1"><div class="li"> <code>delete(name)</code>: check whether <code>name</code> is fixed. If so, check whether the trap returns <code>false</code>.</div>
</li>
<li class="level1"><div class="li"> <code>hasOwn(name)</code>: check whether <code>name</code> is fixed. If so, check whether the trap returns <code>true</code>.</div>
</li>
<li class="level1"><div class="li"> <code>has(name)</code>: check whether <code>name</code> is fixed. If so, check whether the trap returns <code>true</code>.</div>
</li>
<li class="level1"><div class="li"> <code>get(name)</code>: check whether <code>name</code> is fixed. If so, and if it is a non-writable data property, check whether the returned value is consistent (using <code>SameValue</code>).</div>
</li>
<li class="level1"><div class="li"> <code>set(name,val)</code>: check whether <code>name</code> is fixed. If so, and if it is a non-writable data property, check whether the trap returns <code>false</code>.</div>
</li>
</ul>

<p>
 The following traps require no checks. In principle, these traps could check whether all fixed properties are included, but that check is costly (cost of the check proportional to number of fixed properties):
</p>
<ul>
<li class="level1"><div class="li"> <code>get{Own}PropertyNames()</code></div>
</li>
<li class="level1"><div class="li"> <code>keys()</code></div>
</li>
<li class="level1"><div class="li"> <code>enumerate()</code></div>
</li>
</ul>

</div>

<a name="specification"></a><h3>Specification</h3>
<div class="level3">

<p>
 The built-in [[DefineOwnProperty]] and [[GetOwnProperty]] methods of proxies in the trap-and-enforce approach could be defined as follows:
</p>

<p>
<strong>[[DefineOwnProperty]] (P, Desc, Throw)</strong>
</p>

<p>
When [[DefineOwnProperty]] is called on a trapping proxy <code>O</code>, the following steps are taken: 
</p>
<ol>
<li class="level1"><div class="li"> Let handler be the value of the [[Handler]] internal property of O.</div>
</li>
<li class="level1"><div class="li"> Let defineProperty be the result of calling the [[Get]] internal method of handler with argument “defineProperty”.</div>
</li>
<li class="level1"><div class="li"> If defineProperty is undefined, throw a TypeError exception.</div>
</li>
<li class="level1"><div class="li"> If IsCallable(defineProperty) is false, throw a TypeError exception.</div>
</li>
<li class="level1"><div class="li"> Call the [[Call]] internal method of defineProperty providing handler as the this value, P as the first argument and Desc as the second argument.</div>
</li>
<li class="level1"><div class="li"> Let fixedProperty be the result of calling Object.[[GetOwnProperty]] ( P ) on O.</div>
</li>
<li class="level1"><div class="li"> If fixedProperty is not undefined, or Desc.[[Configurable]] is false</div>
<ul>
<li class="level2"><div class="li"> a. Return the result of calling Object.[[DefineOwnProperty]](P, Desc, Throw) on O.</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Return true.</div>
</li>
</ol>

<p>
 Here, Object.[[GetOwnProperty]] and Object.[[DefineOwnProperty]] refer to the algorithms for Object values from ES5 sections 8.12.1 and 8.12.9 respectively, but applied to a trapping proxy instead.
</p>

<p>
<strong>[[GetOwnProperty]] (P)</strong>
</p>

<p>
When [[GetOwnProperty]] is called on a trapping proxy <code>O</code>, the following steps are taken: 
</p>
<ol>
<li class="level1"><div class="li"> Let handler be the value of the [[Handler]] internal property of O.</div>
</li>
<li class="level1"><div class="li"> Let getOwnProperty be the result of calling the [[Get]] internal method of handler with argument “getOwnPropertyDescriptor”.</div>
</li>
<li class="level1"><div class="li"> If getOwnProperty is undefined, throw a TypeError exception.</div>
</li>
<li class="level1"><div class="li"> If IsCallable(getOwnProperty) is false, throw a TypeError exception.</div>
</li>
<li class="level1"><div class="li"> Let trapResult be the result of calling the [[Call]] internal method of getOwnProperty providing handler as the this value and P as the first argument.</div>
</li>
<li class="level1"><div class="li"> Let fixedProperty be the result of calling Object.[[GetOwnProperty]]( P ) on O</div>
</li>
<li class="level1"><div class="li"> If trapResult is undefined</div>
<ul>
<li class="level2"><div class="li"> a. If fixedProperty is undefined, return undefined</div>
</li>
<li class="level2"><div class="li"> b. Otherwise, fixedProperty is defined, so throw a TypeError</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Let desc be ToCompletePropertyDescriptor(trapResult)</div>
</li>
<li class="level1"><div class="li"> If fixedProperty is not undefined, or desc.[[Configurable]] is false</div>
<ul>
<li class="level2"><div class="li"> a. call Object.[[DefineOwnProperty]](P, desc, true) on O</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Return desc</div>
</li>
</ol>

</div>

<a name="open_issues"></a><h3>Open issues</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"> A straightforward implementation of the trap-and-enforce model requires the proxy to store copies of fixed properties. This cost is proportional to the number of fixed properties. This may be an issue for virtual objects exposing a large or infinite number of non-configurable properties. One way out is to model such abstractions only in terms of configurable properties. Even if a proxy exposes a property as being configurable, it can still choose to ignore any changes requested via <code>defineProperty</code>.</div>
</li>
<li class="level1"><div class="li"> Even if the handler no longer retains a reference to the value of a fixed property, the proxy must retain a live reference to its exposed value, to check whether the value returned from <code>get</code> is unchanged. Only when the proxy becomes fixed can these references be cleared.</div>
</li>
</ul>

</div>

<a name="references"></a><h3>References</h3>
<div class="level3">
<ol>
<li class="level1"><div class="li"> A <a href="http://code.google.com/p/es-lab/source/browse/trunk/src/proxies/FixedHandler.js" class="urlextern" target="_blank" title="http://code.google.com/p/es-lab/source/browse/trunk/src/proxies/FixedHandler.js" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">prototype implementation</a> of this strawman as a wrapper around regular Proxy handlers.</div>
</li>
</ol>

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        strawman/fixed_properties.txt &middot; Last modified: 2011/07/13 10:50 by tomvc      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="strawman:fixed_properties" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:fixed_properties" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="strawman:fixed_properties" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="strawman:fixed_properties" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=strawman:fixed_properties.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=strawman%253Afixed_properties&amp;1454275711" width="1" height="1" alt=""  /></body>
</html>
