<html>
<head>
  <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=proposals:proper_tail_calls&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=proposals" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=proposals:proper_tail_calls&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=proposals:proper_tail_calls&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="robots" content="noindex,nofollow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />
</head>
<body>
<div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=proposals:proper_tail_calls&amp;do=export_html.html#proper_tail_calls" class="toc">Proper tail calls</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:proper_tail_calls&amp;do=export_html.html#motivation" class="toc">Motivation</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:proper_tail_calls&amp;do=export_html.html#specification" class="toc">Specification</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:proper_tail_calls&amp;do=export_html.html#syntactic_characterization" class="toc">Syntactic characterization</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=proposals:proper_tail_calls&amp;do=export_html.html#expressions" class="toc">Expressions</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=proposals:proper_tail_calls&amp;do=export_html.html#statements" class="toc">Statements</a></span></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<a name="proper_tail_calls"></a><h1>Proper tail calls</h1>
<div class="level1">

<p>
 (Also see the <a href="doku.php%3Fid=discussion:proper_tail_calls.html" class="wikilink1" title="discussion:proper_tail_calls" onclick="return svchk()" onkeypress="return svchk()">discussion page</a> for this proposal)
</p>

<p>
Also see <a href="http://bugs.ecmascript.org/ticket/215" class="urlextern" target="_blank" title="http://bugs.ecmascript.org/ticket/215" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Ticket #215</a>.
</p>

</div>
<!-- SECTION [1-181] -->
<a name="motivation"></a><h2>Motivation</h2>
<div class="level2">

<p>
 Proper tail calls allow programmers to write recursive or mutually recursive functions to implement iterative control behavior.  This is useful for many data structures that are common in functional, object-oriented, and procedural styles of programming.  Common use cases are: 
</p>
<ul>
<li class="level1"><div class="li"> state machines, eg finite automata</div>
</li>
<li class="level1"><div class="li"> interpreters (be it direct style or CPS)</div>
</li>
<li class="level1"><div class="li"> delegation-style programming</div>
</li>
<li class="level1"><div class="li"> macro systems</div>
</li>
</ul>

<p>
 Languages with proper tail calls allow the use of procedural abstraction to a much larger extent than languages without.  Without proper tail calls, programmers must resort to loops, gotos, or other kinds of unabstract control structures to prune the control stack (eg &ldquo;Cheney on the MTA&rdquo; <a href="http://home.pipeline.com/~hbaker1/CheneyMTA.html" class="urlextern" target="_blank" title="http://home.pipeline.com/~hbaker1/CheneyMTA.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">http://home.pipeline.com/~hbaker1/CheneyMTA.html</a>), and must also maintain explicit control stack data structures for the non-iterative parts of the computation.
</p>

<p>
Proper tail calls are not an optimization, but an aspect of the semantics of the space usage of the language.
</p>

</div>
<!-- SECTION [182-1187] -->
<a name="specification"></a><h2>Specification</h2>
<div class="level2">

<p>
 ECMAScript 4 shall require all implementations to be properly tail recursive in the sense defined here, so as to allow the procedural abstraction facilities of the language to be used to their full potential.
</p>

<p>
A function or method call is said to be in <em>tail position</em> if the only thing the caller can do when the call terminates (normally or abnormally) is either: 
</p>
<ul>
<li class="level1"><div class="li"> return the value of the call to its own caller; or</div>
</li>
<li class="level1"><div class="li"> fall off the end of the current function and thereby return an undefined value.</div>
</li>
</ul>

<p>
 A call that is in tail position shall be executed without accumulating control stack, asymptotically.
</p>
<hr noshade="noshade" size="1" />

<p>
In fact, return type annotations add further restrictions on when tail calls are possible, because of mixed typed/untyped code and conversions among primitive types. 
</p>

<p>
Assume <code>f1</code> and <code>f2</code> are arbitrary functions with return type annotations (may be <code>*</code>) <code>t1</code> and <code>t2</code>.  A tail call from <code>f1</code> to <code>f2</code> shall be executed without accumulating control stack, asymptotically, in at least the following cases. 
</p>
<ul>
<li class="level1"><div class="li"> <code>t1</code> is <code>*</code></div>
</li>
<li class="level1"><div class="li"> <code>f1</code> and <code>f2</code> are in the same top-level <a href="doku.php%3Fid=proposals:program_units.html" class="wikilink1" title="proposals:program_units" onclick="return svchk()" onkeypress="return svchk()">unit</a>, and:</div>
<ul>
<li class="level2"><div class="li"> <code>t1</code> is the same type as <code>t2</code></div>
</li>
<li class="level2"><div class="li"> <code>t1</code> is a nominal supertype of <code>t2</code></div>
</li>
<li class="level2"><div class="li"> <code>t1</code> is a record or array supertype of <code>t2</code></div>
</li>
<li class="level2"><div class="li"> <code>t1</code> is a &ldquo;like&rdquo; or &ldquo;wrap&rdquo; supertype of <code>t2</code></div>
</li>
</ul>
</li>
</ul>

<p>
 In none of these cases are type checking or type conversion required when <code>f2</code> returns to <code>f1</code> (or to the caller of <code>f1</code>).
</p>

<p>
Implementations are allowed to do better than this, but all implementations are required to implement tail calls at least this much.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/09/26 22:25</em>
</p>

<p>
 I think we can simplify the above cases to: 
</p>
<ul>
<li class="level1"><div class="li"> <code>t1</code> is a (non-strict) supertype of <code>t2</code></div>
</li>
</ul>

<p>
  &mdash; <em><a href="mailto:%26%23x63%3B%26%23x6f%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x63%3B%26%23x40%3B%26%23x73%3B%26%23x6f%3B%26%23x65%3B%26%23x2e%3B%26%23x75%3B%26%23x63%3B%26%23x73%3B%26%23x63%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x63;&#x6f;&#x72;&#x6d;&#x61;&#x63;&#x40;&#x73;&#x6f;&#x65;&#x2e;&#x75;&#x63;&#x73;&#x63;&#x2e;&#x65;&#x64;&#x75;">Cormac Flanagan</a> 2007/09

28 23:14</em>
</p>

</div>
<!-- SECTION [1188-3030] -->
<a name="syntactic_characterization"></a><h2>Syntactic characterization</h2>
<div class="level2">

<p>
 (Second draft &ndash; there may still be bugs here.)
</p>

<p>
Tail positions can be characterized precisely in terms of propagation of the following attributes on the abstract syntax structure of the language: 
</p>
<ul>
<li class="level1"><div class="li"> <code>S.wrapped</code> &ndash; <code>S</code> appears within the syntactic context of a form that wraps its dynamic execution with extra operations (effectively precluding tail positions from occurring within <code>S</code>);</div>
</li>
<li class="level1"><div class="li"> <code>S.tail</code> &ndash; <code>S</code> is a statement in tail position (meaning that in the absence of a <code>return</code>, control would fall off the end of the procedure after executing <code>S</code>);</div>
</li>
<li class="level1"><div class="li"> <code>E.tail</code> &ndash; <code>E</code> is an expression in tail position.</div>
</li>
</ul>

<p>
 Analogous attributes exist for <code>case</code> and <code>catch</code> clauses as well.
</p>

<p>
Following attribute computation as defined below, any method or function call expression whose <code>tail</code> attribute is <code>true</code> shall be performed as a tail call.
</p>

<p>
In some circumstances the implementation may be able to prove that certain other calls can be executed as tail calls.  The implementation shall be free to execute these calls as tail calls.
</p>

</div>
<!-- SECTION [3031-4125] -->
<a name="expressions"></a><h3>Expressions</h3>
<div class="level3">

<p>
 For any expression <code>E</code>, all its subexpressions <code>E1 ...</code> have <code>Ei.tail = false</code>, except in the following cases:
</p>
<pre class="code javascript">   E -&gt; E1 , E2                             E2.<span class="me1">tail</span> = E.<span class="me1">tail</span>
   E -&gt; E1 ? E2 : E3                        E2.<span class="me1">tail</span> = E3.<span class="me1">tail</span> = E.<span class="me1">tail</span>
   E -&gt; let <span class="br0">&#40;</span>V1 = E1, ..., Vn = En<span class="br0">&#41;</span> E<span class="br0">&#123;</span>n+<span class="nu0">1</span><span class="br0">&#125;</span>  E<span class="br0">&#123;</span>n+<span class="nu0">1</span><span class="br0">&#125;</span>.<span class="me1">tail</span> = E.<span class="me1">tail</span></pre>
</div>
<!-- SECTION [4126-4495] -->
<a name="statements"></a><h3>Statements</h3>
<div class="level3">

<p>
 Only statements that lead to expression evaluation are relevant:
</p>
<pre class="code javascript">   S -&gt; <span class="br0">&#123;</span> S1 ... <span class="me1">Sn</span> <span class="br0">&#125;</span>                S1.<span class="me1">wrapped</span> = ... = Sn.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                     S1.<span class="me1">tail</span> = ... = S<span class="br0">&#123;</span>n-<span class="nu0">1</span><span class="br0">&#125;</span>.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     Sn.<span class="me1">tail</span> = S.<span class="me1">tail</span>                 <span class="coMULTI">/* only the last statement is in tail position */</span>
   S -&gt; <span class="kw1">do</span> S1 <span class="kw1">while</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span>              S1.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                     E.<span class="me1">tail</span> = <span class="kw2">false</span>
   S -&gt; E;                           E.<span class="me1">tail</span> = S.<span class="me1">tail</span>                  <span class="coMULTI">/* falls off the end */</span>
   S -&gt; <span class="kw1">for</span> <span class="br0">&#40;</span>E1; E2; E3<span class="br0">&#41;</span> S1          E1.<span class="me1">tail</span> = E2.<span class="me1">tail</span> = E3.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     S1.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
   S -&gt; <span class="kw1">for</span> <span class="br0">&#40;</span>E1 <span class="kw1">in</span> E2<span class="br0">&#41;</span> S1            E1.<span class="me1">tail</span> = E2.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     S1.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
   S -&gt; <span class="kw1">if</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span> S1 <span class="kw1">else</span> S2            S1.<span class="me1">wrapped</span> = S2.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                     S1.<span class="me1">tail</span> = S2.<span class="me1">tail</span> = S.<span class="me1">tail</span>       <span class="coMULTI">/* branches are in tail position */</span>
                                     E.<span class="me1">tail</span> = <span class="kw2">false</span>
   S -&gt; L: S1                        S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                     S1.<span class="me1">tail</span> = S.<span class="me1">tail</span>
   S -&gt; <span class="kw1">return</span> E;                    E.<span class="me1">tail</span> = !s.<span class="me1">wrapped</span>              <span class="coMULTI">/* tail unless inside of try etc. */</span>
   S -&gt; <span class="kw1">with</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span> S1                  S1.<span class="me1">wrapped</span> = <span class="kw2">true</span>
                                     S1.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     E.<span class="me1">tail</span> = <span class="kw2">false</span>
   S -&gt; <span class="kw1">try</span> S1 K1 ... <span class="me1">Kn</span>             S1.<span class="me1">wrapped</span> = <span class="kw2">true</span>                <span class="coMULTI">/* no tail positions inside */</span>
                                     K1.<span class="me1">wrapped</span> = ... = Kn.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                     S1.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     K1.<span class="me1">tail</span> = ... = Kn.<span class="me1">tail</span> = S.<span class="me1">tail</span>
   S -&gt; <span class="kw1">try</span> S1 K1 ... <span class="me1">Kn</span> <span class="kw1">finally</span> S2  S1.<span class="me1">wrapped</span> = <span class="kw2">true</span>                <span class="coMULTI">/* no tail positions inside */</span>
                                     K1.<span class="me1">wrapped</span> = ... = Kn.<span class="me1">wrapped</span> = <span class="kw2">true</span>
                                     S2.<span class="me1">wrapped</span> = <span class="kw2">false</span>
                                     S1.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     K1.<span class="me1">tail</span> = ... = Kn.<span class="me1">tail</span> = <span class="kw2">false</span>  <span class="coMULTI">/* followed by a finally */</span>
                                     S2.<span class="me1">tail</span> = S.<span class="me1">tail</span>
   S -&gt; <span class="kw1">throw</span> E;                     E.<span class="me1">tail</span> = <span class="kw2">false</span>
   S -&gt; <span class="kw1">switch</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span> C1 ... <span class="me1">Cn</span>         E.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     C1.<span class="me1">wrapped</span> = ... = Cn.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                     C1.<span class="me1">tail</span> = ... = Cn.<span class="me1">tail</span> = S.<span class="me1">tail</span>
   S -&gt; <span class="kw1">while</span> <span class="br0">&#40;</span>E<span class="br0">&#41;</span> S1                 S1.<span class="me1">wrapped</span> = S.<span class="me1">wrapped</span>
                                     S1.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     E.<span class="me1">tail</span> = <span class="kw2">false</span>
   K -&gt; <span class="kw1">catch</span> <span class="br0">&#40;</span>V<span class="br0">&#41;</span> S                  S.<span class="me1">wrapped</span> = K.<span class="me1">wrapped</span>
                                     S.<span class="me1">tail</span> = K.<span class="me1">tail</span>
   C -&gt; <span class="kw1">case</span> E: S1 ... <span class="me1">Sn</span>            E.<span class="me1">tail</span> = <span class="kw2">false</span>
                                     S1.<span class="me1">wrapped</span> = ... = Sn.<span class="me1">wrapped</span> = C.<span class="me1">wrapped</span>
                                     S1.<span class="me1">tail</span> = ... = Sn.<span class="me1">tail</span> = <span class="kw2">false</span>  <span class="coMULTI">/* might fall through */</span>
   C -&gt; <span class="kw2">default</span>: S1 ... <span class="me1">Sn</span>           <span class="coMULTI">/* ditto */</span></pre><hr noshade="noshade" size="1" />

<p>
Just noting that the Scheme report requires tail call behavior for <code>apply</code> as well, so we should probably consider doing the same for <code>Function.prototype.call</code> and <code>Function.prototype.apply</code>.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/04/20 11:07</em> 
</p>

</div>
<!-- SECTION [4496-] -->
<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/e/ebafe332ed11f2e1b66c429498109e04.xhtml used -->
</body>
</html>
