<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>strawman:revokable_proxies [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=strawman:revokable_proxies&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=strawman" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=strawman:revokable_proxies&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=strawman:revokable_proxies&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2012-09-24T11:47:15+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=strawman:revokable_proxies&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">strawman:revokable_proxies</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="strawman:revokable_proxies" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:revokable_proxies" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:simultaneous_iteration.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:simultaneous_iteration">simultaneous_iteration</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:syntactic_support_for_private_names.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:syntactic_support_for_private_names">syntactic_support_for_private_names</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:proxies_names.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:proxies_names">proxies_names</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:proxy_symbol_decoupled.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:proxy_symbol_decoupled">proxy_symbol_decoupled</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=strawman:revokable_proxies.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:revokable_proxies">revokable_proxies</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:revokable_proxies.html#revocable_proxies" class="toc">Revocable Proxies</a></span><ul class="toc">
<li class="clear"><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:revokable_proxies.html#the_problem" class="toc">The Problem</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:revokable_proxies.html#proposed_solution" class="toc">Proposed Solution</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:revokable_proxies.html#revoking_while_trapping" class="toc">Revoking while trapping</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:revokable_proxies.html#spec" class="toc">Spec</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:revokable_proxies.html#open_issues" class="toc">Open issues</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:revokable_proxies.html#references" class="toc">References</a></span></li>
</ul>
</li>
</ul>
</div>
</div>

<a name="revocable_proxies"></a><h1>Revocable Proxies</h1>
<div class="level1">

</div>

<a name="the_problem"></a><h3>The Problem</h3>
<div class="level3">

<p>
 In a nutshell: with direct proxies, one can no longer write a caretaker proxy that nulls out a pointer to its target once revoked. This means that the target can no longer be garbage-collected separately from its proxy.
</p>

<p>
As pointed out by David Bruant, caretakers are often useful precisely for memory management, where one uses revocation of the caretaker to release the underlying resources, as described <a href="http://blog.kylehuey.com/post/21892343371/fixing-the-memory-leak" class="urlextern" target="_blank" title="http://blog.kylehuey.com/post/21892343371/fixing-the-memory-leak" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">here</a>.
</p>

<p>
Such caretakers were easy to define in the old Proxy design, since the link between a proxy and its target was fully under the control of the handler (i.e. fully virtual). However, with direct proxies, the proxy has a built-in, immutable reference directly to its target. This reference can&rsquo;t be modified or nulled out.
</p>

</div>

<a name="proposed_solution"></a><h3>Proposed Solution</h3>
<div class="level3">

<p>
 Provide an extension to the Proxy <acronym title="Application Programming Interface">API</acronym> that allows scripts to null out the proxy-target reference. Of course, the <acronym title="Application Programming Interface">API</acronym> must be designed with care so that this link can&rsquo;t be nulled out by any old client of the proxy. Only the creator of the proxy should have the right to revoke it.
</p>

<p>
Because revocable proxies appear to be a niche abstraction, we propose to introduce a separate Proxy constructor dedicated to creating revocable proxies. Proxies created with the regular <code>Proxy</code> constructor would remain unrevocable.
</p>

<p>
Proposal: 
</p>
<ul>
<li class="level1"><div class="li"> Introduce a new factory method <code>Proxy.revocable</code>.</div>
</li>
<li class="level1"><div class="li"> <code>Proxy.revocable(target, handler)</code> returns an object <code>{proxy: proxy, revoke: revoke}</code>.</div>
</li>
<li class="level1"><div class="li"> <code>revoke</code> is a zero-argument function that, when called, revokes its associated proxy.</div>
</li>
<li class="level1"><div class="li"> A revoked proxy becomes unusable in the sense that any operation that would trap to the handler instead throws a <code>TypeError</code>.</div>
</li>
<li class="level1"><div class="li"> Revoking an already revoked proxy has no effect.</div>
</li>
<li class="level1"><div class="li"> Once a proxy is revoked, it remains forever revoked.</div>
</li>
<li class="level1"><div class="li"> A revoked proxy drops its target and handler, making both available for garbage collection.</div>
</li>
</ul>

<p>
 Revoking a proxy is observably equivalent to replacing the handler such that all handler traps throw a <code>TypeError</code> unconditionally.
</p>

<p>
Example:
</p>
<pre class="code javascript">let <span class="br0">&#123;</span> proxy, revoke <span class="br0">&#125;</span> = Proxy.<span class="me1">revocable</span><span class="br0">&#40;</span>target, handler<span class="br0">&#41;</span>;
proxy.<span class="me1">foo</span> <span class="co1">// traps</span>
revoke<span class="br0">&#40;</span><span class="br0">&#41;</span>  <span class="co1">// always returns undefined</span>
proxy.<span class="me1">foo</span> <span class="co1">// throws TypeError: &quot;proxy is revoked&quot;</span></pre>
</div>

<a name="revoking_while_trapping"></a><h3>Revoking while trapping</h3>
<div class="level3">

<p>
 Revocable proxies reintroduce a subtle issue from the old design that had to do with fixing a proxy while it still has pending trap activations on the runtime stack: an unrevoked proxy may call one of its traps and be revoked by the time the trap returns:
</p>
<pre class="code javascript">let <span class="br0">&#123;</span> proxy, revoke <span class="br0">&#125;</span> = Proxy.<span class="me1">revocable</span><span class="br0">&#40;</span><span class="br0">&#123;</span>foo:<span class="nu0">42</span><span class="br0">&#125;</span>, <span class="br0">&#123;</span>
  get: <span class="kw2">function</span><span class="br0">&#40;</span>target, <span class="kw3">name</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> revoke<span class="br0">&#40;</span><span class="br0">&#41;</span>; <span class="kw1">return</span> target<span class="br0">&#91;</span><span class="kw3">name</span><span class="br0">&#93;</span>; <span class="br0">&#125;</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span>;
proxy.<span class="me1">foo</span> <span class="co1">// traps and revokes the proxy</span></pre>
<p>
A first question to answer is whether the above <code>proxy.foo</code> call should return <code>42</code> or should instead throw <code>TypeError: proxy is revoked</code>. We propose to have the trap still return its result since the proxy was still unrevoked at the time the operation was performed.
</p>

<p>
For invariant enforcement to work correctly, the trap&rsquo;s result must be verified against the original target. So, the proxy must ensure that it holds on to the original target <em>before</em> calling the trap, and use that stored pointer after the trap returns.
</p>

</div>

<a name="spec"></a><h2>Spec</h2>
<div class="level2">

<p>
 <strong>Proxy.revocable(target, handler)</strong> 
</p>
<ol>
<li class="level1"><div class="li"> If Type(T) is not Object, throw a TypeError exception</div>
</li>
<li class="level1"><div class="li"> If Type(H) is not Object, throw a TypeError exception</div>
</li>
<li class="level1"><div class="li"> Let p be a new Proxy Object with custom internal Object methods as <a href="doku.php%3Fid=harmony:proxies_spec.html" class="urlextern" target="_blank" title="http://wiki.ecmascript.org/doku.php?id=harmony:proxies_spec" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">specified</a></div>
</li>
<li class="level1"><div class="li"> If IsCallable(T), set the [[Call]], [[Construct]] and [[HasInstance]] internal methods as <a href="doku.php%3Fid=harmony:proxies_spec.html" class="urlextern" target="_blank" title="http://wiki.ecmascript.org/doku.php?id=harmony:proxies_spec" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">specified</a></div>
</li>
<li class="level1"><div class="li"> Set the [[Handler]] internal property of p to H</div>
</li>
<li class="level1"><div class="li"> Set the [[Target]] internal property of p to T</div>
</li>
<li class="level1"><div class="li"> Let r be a new Function with the below [[Call]] behavior</div>
</li>
<li class="level1"><div class="li"> Set the [[Proxy]] internal property of r to p</div>
</li>
<li class="level1"><div class="li"> Let pair be a new ECMAScript Object</div>
</li>
<li class="level1"><div class="li"> Call pair.[[DefineOwnProperty]](&rdquo;proxy&rdquo;,{value:p,writable:true,enumerable:true,configurable:true},true)</div>
</li>
<li class="level1"><div class="li"> Call pair.[[DefineOwnProperty]](&rdquo;revoke&rdquo;,{value:r,writable:true,enumerable:true,configurable:true},true)</div>
</li>
<li class="level1"><div class="li"> Return pair</div>
</li>
</ol>

<p>
 <strong>[[Call]]</strong>
</p>

<p>
When the [[Call]] method of a revoke function F is called: 
</p>
<ol>
<li class="level1"><div class="li"> Let proxy be the value of the [[Proxy]] internal property of F</div>
</li>
<li class="level1"><div class="li"> Set the [[Target]] internal property of proxy to null</div>
</li>
<li class="level1"><div class="li"> Set the [[Handler]] internal property of proxy to null</div>
</li>
<li class="level1"><div class="li"> Return undefined</div>
</li>
</ol>

<p>
 The specification of operations that trap on a proxy P would follow the following template: 
</p>
<ol>
<li class="level1"><div class="li"> Let handler be the value of the [[Handler]] internal property of P.</div>
</li>
<li class="level1"><div class="li"> If handler is null, throw a TypeError</div>
</li>
<li class="level1"><div class="li"> Let target be the value of the [[Target]] internal property of P.</div>
</li>
<li class="level1"><div class="li"> Let trap be the result of calling GetTrap(handler, &ldquo;trapName&rdquo;).</div>
</li>
<li class="level1"><div class="li"> If trap is undefined,</div>
<ul>
<li class="level2"><div class="li"> a. Return the result of calling the built-in function Reflect.trapName(target).</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> Let trapResult be the result of calling the [[Call]] internal method of trap providing handler as the this value, with target as the first argument.</div>
</li>
<li class="level1"><div class="li"> <em>at this point, [[Target]] may have been nulled out, be we still have a reference to target to do invariant checks</em></div>
</li>
</ol>

<p>
 Checking for a null [[Handler]] works because a valid handler must always be of type <code>Object</code> (it can&rsquo;t normally be set to <code>null</code>).
</p>

<p>
An <strong>IsCallable</strong> test on a revoked proxy should return false.
</p>

<p>
The <code>typeof</code> operator, applied on a revoked proxy, should continue to return the same result it returned for the unrevoked proxy (ensuring <code>typeof</code> remains a stable operator).
</p>

<p>
Since the <code>instanceof</code> operator tries to access the [[Prototype]] of its LHS and [[Get]]s the &ldquo;prototype&rdquo; of its RHS, if either LHS or RHS is a revoked proxy, a <code>TypeError</code> will be thrown.
</p>

</div>

<a name="open_issues"></a><h2>Open issues</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Object.prototype.valueOf: this method is currently specified to auto-forward to a proxy&rsquo;s target. If the proxy is revoked, we could throw, but this would be observably different from changing all handler traps to throw (since valueOf currently doesn&rsquo;t trap).</div>
</li>
<li class="level1"><div class="li"> Function.prototype.toString: on a proxy wrapping a function, this method auto-forwards to the target. If the proxy is revoked, we could throw, but this would be observably different from changing all handler traps to throw (since this method currently doesn&rsquo;t trap).</div>
</li>
<li class="level1"><div class="li"> Consider a more developer-friendly alternative to &ldquo;revocable&rdquo;: nullable?</div>
</li>
<li class="level1"><div class="li"> September 2012 TC39 meeting: some concern was expressed about the ability to throw (either via revocable proxies or via explicit throws in traps) from isFrozen tests. One alternative could be to only trap isFrozen (and isSealed, isExtensible) until it returns true (false for isExtensible). After a stable result is observed, the operation would no longer trap (requires some extra bookkeeping state in the proxy to store the outcome of these operations).</div>
</li>
</ul>

</div>

<a name="references"></a><h2>References</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Initial post on <a href="https://mail.mozilla.org/pipermail/es-discuss/2012-August/024344.html" class="urlextern" target="_blank" title="https://mail.mozilla.org/pipermail/es-discuss/2012-August/024344.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">es-discuss</a>, and a <a href="https://mail.mozilla.org/pipermail/es-discuss/2012-August/024666.html" class="urlextern" target="_blank" title="https://mail.mozilla.org/pipermail/es-discuss/2012-August/024666.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">proposed solution</a>.</div>
</li>
<li class="level1"><div class="li"> How caretaker proxies help with <a href="http://blog.kylehuey.com/post/21892343371/fixing-the-memory-leak" class="urlextern" target="_blank" title="http://blog.kylehuey.com/post/21892343371/fixing-the-memory-leak" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">memory leaks</a>.</div>
</li>
</ul>

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        strawman/revokable_proxies.txt &middot; Last modified: 2012/09/24 11:47 by tomvc      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="strawman:revokable_proxies" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:revokable_proxies" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="strawman:revokable_proxies" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="strawman:revokable_proxies" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=strawman:revokable_proxies.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=strawman%253Arevokable_proxies&amp;1454275645" width="1" height="1" alt=""  /></body>
</html>
