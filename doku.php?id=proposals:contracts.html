<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>proposals:contracts [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=proposals:contracts&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=proposals" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=proposals:contracts&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=proposals:contracts&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2006-06-02T19:05:15+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=proposals:contracts&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">proposals:contracts</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="proposals:contracts" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="proposals:contracts" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:bytearray.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:bytearray">bytearray</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:type_refinements.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:type_refinements">type_refinements</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:security_wrappers.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:security_wrappers">security_wrappers</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:date_literal_syntax.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:date_literal_syntax">date_literal_syntax</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=proposals:contracts.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:contracts">contracts</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#motivation" class="toc">Motivation</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#proposal" class="toc">Proposal</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#bound_contracts" class="toc">Bound contracts</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#unbound_contracts" class="toc">Unbound contracts</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#arguments_to_contracts" class="toc">Arguments to contracts</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#arbitrary_expressions_for_contracts" class="toc">Arbitrary expressions for contracts</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#subtyping_and_conversion" class="toc">Subtyping and Conversion</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#contract_erasure" class="toc">Contract erasure</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#contract_combinators" class="toc">Contract combinators</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#blame" class="toc">Blame</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#granularity_of_blame" class="toc">Granularity of blame</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#modes" class="toc">Modes</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=proposals:contracts.html#dave_s_original_discussion" class="toc">Dave's original discussion</a></span></li>
</ul>
</div>
</div>

<p>
This proposal has been deferred. For now, <a href="doku.php%3Fid=proposals:type_refinements.html" class="wikilink1" title="proposals:type_refinements" onclick="return svchk()" onkeypress="return svchk()">type refinements</a> is a less ambitious proposal that could ultimately lead to the development of a more sophisticated, post-ES4 contract system.
</p>

<a name="motivation"></a><h1>Motivation</h1>
<div class="level1">

<p>
 Types are a great tool for programmers to specify invariants about their programs, but they are limited in their expressive power. There are plenty of invariants programmers would like to specify that cannot easily be expressed as types, either due to limitations of the type system or actual computability limitations.
</p>

<p>
In those cases, allowing the programmer to express the invariants as dynamic checks that produce runtime errors allows them to program with contracts and still catch the errors relatively early.
</p>

<p>
Furthermore, research on dynamic contract systems has shown that it&rsquo;s possible to detect specific information about which component is to blame for a contract violation, beyond merely indicating that something went wrong. For programming in the large, this ability to narrow down the source of a bug to a particular component can be indispensible.
</p>

</div>

<a name="proposal"></a><h1>Proposal</h1>
<div class="level1">

<p>
 In the strict mode (see <a href="doku.php%3Fid=proposals:strict_and_standard_modes.html" class="wikilink1" title="proposals:strict_and_standard_modes" onclick="return svchk()" onkeypress="return svchk()">strict and standard modes</a>), contracts are expressed as refinements of types. These can take one of two forms: <em>bound contracts</em> and <em>unbound contracts</em>.
</p>

</div>

<a name="bound_contracts"></a><h2>Bound contracts</h2>
<div class="level2">

<p>
 In the case where a contract is a bound method (with the return type <code>Boolean</code>) defined in the class of the object in question, a contract can simply be specified with the name of the method. When the value is received at runtime, the system implicitly invokes the method on the object; if the result is <code>false</code>, a contract violation is signalled.
</p>

<p>
For example, imagine that the <code>Int</code> class has a method called <code>isNatural</code> which checks whether the integer is non-negative:
</p>
<pre class="code javascript"><span class="kw2">class</span> Int <span class="br0">&#123;</span>
    ...
    <span class="kw2">function</span> isNatural<span class="br0">&#40;</span><span class="br0">&#41;</span> : Boolean <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="kw1">this</span> &gt;= <span class="nu0">0</span> <span class="br0">&#125;</span>
    ...
<span class="br0">&#125;</span></pre>
<p>
Then an expression typed as <code>Int</code> may refine the type with the bound contract <code>isNatural</code> via some special operator (<code>&ldquo;@&rdquo;</code>? <code>&ldquo;#&rdquo;</code>? <code>&ldquo;|&rdquo;</code>? <code>&ldquo;.&rdquo;</code> would be nice but I believe introduces ambiguities with package qualifiers):
</p>
<pre class="code javascript"><span class="kw2">function</span> factorial<span class="br0">&#40;</span>n : Int#isNatural<span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span></pre>
</div>

<a name="unbound_contracts"></a><h2>Unbound contracts</h2>
<div class="level2">

<p>
 Unbound functions may be used as contracts as well. In this case, the type of the function used for the contract must have as its <code>this</code> type a compatible type with the type being refined.
</p>
<pre class="code javascript"><span class="kw2">function</span> trimmedString<span class="br0">&#40;</span><span class="kw1">this</span>:String<span class="br0">&#41;</span> : Boolean <span class="br0">&#123;</span>
    <span class="kw1">return</span> <span class="br0">&#40;</span><span class="kw1">this</span>.<span class="me1">length</span> == <span class="nu0">0</span><span class="br0">&#41;</span> || <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> != <span class="st0">' '</span><span class="br0">&#41;</span> &amp;&amp; <span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#91;</span><span class="kw1">this</span>.<span class="me1">length</span> - <span class="nu0">1</span><span class="br0">&#93;</span> != <span class="st0">' '</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">function</span> trim<span class="br0">&#40;</span>s : String<span class="br0">&#41;</span> : String#trimmedString <span class="br0">&#123;</span> ... <span class="br0">&#125;</span></pre>
</div>

<a name="arguments_to_contracts"></a><h2>Arguments to contracts</h2>
<div class="level2">

<p>
 It should also be possible to pass extra arguments to contracts. For example:
</p>
<pre class="code javascript"><span class="kw2">function</span> hasLength<span class="br0">&#40;</span><span class="kw1">this</span>:String, n:Int#isNatural<span class="br0">&#41;</span> : Boolean <span class="br0">&#123;</span> <span class="kw1">return</span> s.<span class="me1">length</span> == n <span class="br0">&#125;</span>
&nbsp;
<span class="kw2">function</span> repeat<span class="br0">&#40;</span>n : Int#isNatural, s : String<span class="br0">&#41;</span> : String#hasLength<span class="br0">&#40;</span>n * s.<span class="me1">length</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span></pre>
<p>
Here the unbound method <code>hasLength</code> receives as its argument the value <code>n * s.length</code>. Notice that the arguments to <code>repeat</code> are in scope for the contract expression.
</p>

</div>

<a name="arbitrary_expressions_for_contracts"></a><h2>Arbitrary expressions for contracts</h2>
<div class="level2">

<p>
 The syntax used above may not be conducive to using complex expressions for contracts. We may also want a syntax that allows any expression to be used (for unbound contracts), such as:
</p>
<pre class="code javascript"><span class="kw2">function</span> foo<span class="br0">&#40;</span><span class="br0">&#41;</span> : <span class="br0">&#91;</span> String | <span class="coMULTI">/* complicated expression */</span><span class="br0">&#40;</span>args, ...<span class="br0">&#41;</span> <span class="br0">&#93;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span></pre>
<p>
This reads something like &ldquo;<code>foo</code> has return type <code>String</code>, where the string must pass the predicate specified by calling the unbound method returned by the <em>complicated expression</em> on arguments <em>args</em>.&rdquo;
</p>

</div>

<a name="subtyping_and_conversion"></a><h2>Subtyping and Conversion</h2>
<div class="level2">

<p>
 Int#isNatural is a subtype of Int. 
</p>

<p>
Int#isNatural and  Int#isPositive  are not subtypes of each other, but they are convertible.
</p>

<p>
Similarly, Int is convertible to  Int#isNatural.
</p>

</div>

<a name="contract_erasure"></a><h2>Contract erasure</h2>
<div class="level2">

<p>
 In order for the static type checker to work, it must be able to erase contract annotations and just look at the static type portions of the annotations. This is an obvious algorithm for the system described so far. Function types and class refinements can easily be erased.
</p>

</div>

<a name="contract_combinators"></a><h2>Contract combinators</h2>
<div class="level2">

<p>
 It&rsquo;s also useful to use contract combinators like <code>and</code> and <code>or</code>. In this case, though, it&rsquo;s not as obvious how to do contract erasure. For this case, it might be useful only to allow <code>and</code> and <code>or</code> of non-function types, and to force the contract combinators to go within the refinement. I need a little more time to flesh this out.
</p>

</div>

<a name="blame"></a><h2>Blame</h2>
<div class="level2">

<p>
 The distinction between contracts and vanilla assertions is that contracts indicate an agreement between parties, particularly for functions and methods: argument contracts are preconditions, i.e., requirements on the client, and return contracts are postconditions, i.e., requirements on the function/method implementation. A well-designed contract system can actually keep track of these responsibilities as the values flow through the program, and assign blame to the guilty party whenever a contract is violated.
</p>

<p>
Our system should require these blame annotations. I&rsquo;ll work on ways of specifying this as precisely (hopefully formally) as possible.
</p>

</div>

<a name="granularity_of_blame"></a><h2>Granularity of blame</h2>
<div class="level2">

<p>
 An important decision is the granularity of the parties involved in the blame assignment. Blame can be as specific as individual source expressions and as wide as modules. Contracts are most important for programming in the large, where you want to pinpoint individual modules in a large system. And contract checking incurs a serious performance hit. Therefore it usually behooves the designer to pick a level of granularity narrow enough to be helpful in narrowing down bugs, but wide enough not to degrade performance too badly.
</p>

<p>
Furthermore, it&rsquo;s important to keep in mind that return type contracts prevent tail calls from exhibiting iterative control behavior, because they introduce an extra operation to perform on return. Thus, disabling contract checking at the intra-module level allows tail-recursive and mutually tail-recursive functions even when they are wrapped in return-type contracts, while possibly preventing inter-module tail calls.
</p>

<p>
This also means that programmers who truly want iterative behavior even across module boundaries have to know not to put contracts on the return types of their exported functions and methods.
</p>

<p>
We will need to decide whether we want blame assignment to be at the level of granularity of individual classes, or namespaces, or packages.
</p>

</div>

<a name="modes"></a><h2>Modes</h2>
<div class="level2">

<p>
 Contracts should be available both in the strict mode and the standard mode (see <a href="doku.php%3Fid=proposals:strict_and_standard_modes.html" class="wikilink1" title="proposals:strict_and_standard_modes" onclick="return svchk()" onkeypress="return svchk()">strict and standard modes</a>). Perhaps the two modes can remain syntactically identical, with the type portion of the annotation translating to nothing more than an additional dynamic contract in the standard mode. This is worth discussing more.
</p>

</div>

<a name="dave_s_original_discussion"></a><h1>Dave's original discussion</h1>
<div class="level1">

<p>
 Moved to <a href="doku.php%3Fid=proposals:discussion_about_contracts.html" class="wikilink1" title="proposals:discussion_about_contracts" onclick="return svchk()" onkeypress="return svchk()">discussion about contracts</a> 
</p>

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        proposals/contracts.txt &middot; Last modified: 2006/06/02 19:05 by graydon      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="proposals:contracts" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="proposals:contracts" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="proposals:contracts" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="proposals:contracts" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=proposals:contracts.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=proposals%253Acontracts&amp;1454276655" width="1" height="1" alt=""  /></body>
</html>
