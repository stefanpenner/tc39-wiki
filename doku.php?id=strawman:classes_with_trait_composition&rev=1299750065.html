<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>strawman:classes_with_trait_composition [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=strawman" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2011-05-09T20:50:26+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">strawman:classes_with_trait_composition</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1299750065" /><input type="hidden" name="id" value="strawman:classes_with_trait_composition" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:classes_with_trait_composition" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=harmony:concise_object_literal_extensions.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="harmony:concise_object_literal_extensions">concise_object_literal_extensions</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=harmony:object_extension_literal_class_pattern.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="harmony:object_extension_literal_class_pattern">object_extension_literal_class_pattern</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:object_initialiser_extensions.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:object_initialiser_extensions">object_initialiser_extensions</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:private_name_objects.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:private_name_objects">private_name_objects</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=strawman:classes_with_trait_composition.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:classes_with_trait_composition">classes_with_trait_composition</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    
<p>
<strong>This is an old revision of the document!</strong>
</p>
<hr noshade="noshade" size="1" />

<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/6/67d2e00dcdffee79b180253e830ab050.xhtml used -->
<div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#classes_with_trait_composition" class="toc">Classes with Trait Composition</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#class_declarations_and_expressions" class="toc">Class Declarations and Expressions</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#class_elements" class="toc">Class Elements</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#inheritance" class="toc">Inheritance</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#graduated_examples" class="toc">Graduated Examples</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#adding_public_declaration_shorthands" class="toc">Adding public declaration shorthands</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#adding_class-private_instance_variables" class="toc">Adding class-private instance variables</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#helpersoftfield" class="toc">Helper: SoftField___</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#adding_single_inheritance" class="toc">Adding single inheritance</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#helperstoverride_makeclass_and_makefixedpoint" class="toc">Helpers: TOverride___, MakeClass___, and MakeFixedPoint___</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#semi-static_rejection_rulessimple_inheritance" class="toc">Semi-Static Rejection Rules: Simple Inheritance</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#adding_prototype_inheritance_instead" class="toc">Adding prototype inheritance instead</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#semi-static_rejection_rulesprototype_inheritance" class="toc">Semi-static Rejection Rules: prototype inheritance</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#adding_abstract_classes_and_required_members" class="toc">Adding abstract classes and required members</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#helperstrequired_makeabstractclass" class="toc">Helpers: TRequired___, MakeAbstractClass___</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#semi-static_rejection_rulesunresolved_required_members" class="toc">Semi-Static Rejection Rules: Unresolved required members</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#adding_soft-bound_methods" class="toc">Adding soft-bound methods</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#semi-static_rejection_rulessoft-bound_method" class="toc">Semi-static Rejection Rules: soft-bound method</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#adding_multiple_inheritance" class="toc">Adding multiple inheritance</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#helpertcompose" class="toc">Helper: TCompose___</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#semi-static_rejection_rulesunresolved_conflicts" class="toc">Semi-static Rejection Rules: Unresolved conflicts</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#adding_trait_renaming_operations" class="toc">Adding trait renaming operations</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#adding_extension_methods" class="toc">Adding extension methods</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#semi-static_rejection_rulesextension_methods" class="toc">Semi-static Rejection Rules: extension methods</a></span></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#see" class="toc">See</a></span></li>
</ul>
</div>
</div>

<a name="classes_with_trait_composition"></a><h1>Classes with Trait Composition</h1>
<div class="level1">

<p>
 Those who learn best by example may wish to first skip to <span class="curid"><a href="doku.php%3Fid=strawman:classes_with_trait_composition.html#graduated_examples" class="wikilink1" title="strawman:classes_with_trait_composition" onclick="return svchk()" onkeypress="return svchk()">graduated_examples</a></span> and then return here afterwards. There are plenty of forward references either way, so be prepared to make two passes before everything fits together.
</p>

<p>
 This strawman merges the best of <a href="doku.php%3Fid=strawman:syntax_for_efficient_traits.html" class="wikilink1" title="strawman:syntax_for_efficient_traits" onclick="return svchk()" onkeypress="return svchk()">syntax for efficient traits</a> and <a href="doku.php%3Fid=strawman:classes_as_sugar.html" class="wikilink1" title="strawman:classes_as_sugar" onclick="return svchk()" onkeypress="return svchk()">classes as sugar</a>. However, the explanation presented here does not depend on those earlier strawmen. It is essentially the <a href="doku.php%3Fid=strawman:classes_as_sugar.html" class="wikilink1" title="strawman:classes_as_sugar" onclick="return svchk()" onkeypress="return svchk()">classes as sugar</a> strawman enhanced with <code>extends</code> and <code>abstract</code> classes, for inheritance. When a class inherits from multiple base classes, those multiple bases are combined according to trait composition rules. The derived class is combined with the composed base classes by trait override rules. 
</p>

<p>
This strawman should not be considered all or nothing. As with Allen&rsquo;s <a href="doku.php%3Fid=strawman:object_initialiser_extensions.html" class="wikilink1" title="strawman:object_initialiser_extensions" onclick="return svchk()" onkeypress="return svchk()">object initialiser extensions</a>, we can treat this as an ala carte menu, where some subsets can be accepted without accepting the whole package. Specifically, the following subsettings are sensible.
</p>
<ul>
<li class="level1"><div class="li"> By allowing only a single <code>extends</code> clause in a class body and no Proto clause, this strawman becomes equivalent to conventional single inheritance.</div>
</li>
<li class="level1"><div class="li"> By allowing only a Proto clause in a class declaration and no <code>extends</code> clauses in the body, this strawman again becomes equivalent to conventional single inheritance. But now the inheritance chain is also mapped onto JavaScript&rsquo;s prototype inheritance chain.</div>
</li>
<li class="level1"><div class="li"> By not allowing any <code>extends</code> or Proto clauses at all, this strawman is similar to <a href="doku.php%3Fid=strawman:classes_as_sugar.html" class="wikilink1" title="strawman:classes_as_sugar" onclick="return svchk()" onkeypress="return svchk()">classes as sugar</a> and to <a href="doku.php%3Fid=strawman:obj_initialiser_constructors.html" class="wikilink1" title="strawman:obj_initialiser_constructors" onclick="return svchk()" onkeypress="return svchk()">obj initialiser constructors</a>.</div>
</li>
<li class="level1"><div class="li"> The support for class-private instance variables could be omitted without any effect on the rest of the strawman.</div>
</li>
<li class="level1"><div class="li"> The support for <code>super</code> could be omitted, or could be provided only in the single inheritance case.</div>
</li>
<li class="level1"><div class="li"> The support for <code>self</code> as a bound variable distinct from <code>this</code> could be omitted. We enumerate several more options for self-reference <span class="curid"><a href="doku.php%3Fid=strawman:classes_with_trait_composition.html#helperstoverride_makeclass_makefixedpoint_and_tcreate" class="wikilink1" title="strawman:classes_with_trait_composition" onclick="return svchk()" onkeypress="return svchk()">below</a></span>.</div>
</li>
<li class="level1"><div class="li"> If <code>self</code> is omitted in favor of <code>this</code>, we could <a href="doku.php%3Fid=strawman:soft_bind.html" class="wikilink1" title="strawman:soft_bind" onclick="return svchk()" onkeypress="return svchk()">soft bind</a> methods to their instance or not.</div>
</li>
<li class="level1"><div class="li"> If <code>super</code> is omitted, the Renamings production could be enhanced to provide similar functionality.</div>
</li>
<li class="level1"><div class="li"> The Renamings productions could be omitted or altered without much effect on the rest of this strawman. Since this issue has subtle interactions with possible future type or <a href="doku.php%3Fid=strawman:guards.html" class="wikilink1" title="strawman:guards" onclick="return svchk()" onkeypress="return svchk()">guards</a> strawmen, we leave this issue open for those strawman to pin down.</div>
</li>
<li class="level1"><div class="li"> <a href="http://msdn.microsoft.com/en-us/library/bb311042.aspx" class="urlextern" target="_blank" title="http://msdn.microsoft.com/en-us/library/bb311042.aspx" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Extension methods</a> could be omitted without effect on the rest of this strawman. </div>
</li>
</ul>

<p>
 Even though we encourage such ala carte consideration, we present the full package below, to make clear that if we accept a subset now, this subset would not be a dead end &ndash; it could grow to regain some of the options initially omitted. We then present graduated examples, starting with the minimal proposal and then showing the impact of each successive ala carte extension.
</p>

</div>

<a name="class_declarations_and_expressions"></a><h2>Class Declarations and Expressions</h2>
<div class="level2">

<p>
 We extend the Declaration production from <a href="doku.php%3Fid=harmony:block_scoped_bindings.html" class="wikilink1" title="harmony:block_scoped_bindings" onclick="return svchk()" onkeypress="return svchk()">block scoped bindings</a> to accept a ClassDeclaration. We also extend MemberExpression to accept a ClassExpression. These expand into a FunctionDeclaration and FunctionExpression, respectively. 
</p>
<pre class="code">
  Declaration :
      LetDeclaration
      ConstDeclaration
      FunctionDeclaration
      ClassDeclaration
  ClassDeclaration :     // by analogy to FunctionDeclaration
      ClassAdjective? class Identifier ( FormalParameterList? ) Proto? { ClassBody }
  ExpressionStatement : 
      [lookahead not-in { &quot;{&quot;, &quot;function&quot;, &quot;const&quot;, &quot;class&quot; }] Expression &quot;;&quot;
  MemberExpression : ... // &quot;...&quot; means members defined elsewhere
      ClassExpression
  ClassExpression :      // by analogy to FunctionExpression
      ClassAdjective? class Identifier? ( FormalParameterList? ) Proto? { ClassBody }
  ClassAdjective :
      abstract
  ClassBody :           // by analogy to FunctionBody
      ClassElement*
</pre>

<p>
A class serves two purposes: to make the instances it describes, and to contribute descriptions to be composed by other derived classes. Abstract classes cannot make instances, and the descriptions they provide can be partial and conflicted. Concrete (non-abstract) classes must describe complete non-conflicted instances. 
</p>

<p>
Since a class is just sugar for a function, its syntax and scoping are analogous to that for functions. Just as an ExpressionStatement cannot begin with <code>function</code> or <code>const</code>, it would also not be able to begin with <code>class</code>. The identifiers &ldquo;<code>abstract</code>&rdquo; is not reserved by ES5/strict, and so we are not proposing it be a keyword. Rather, we propose class adjectives be contextually reserved words, recognized as special only when juxtaposed with &ldquo;<code>class</code>&ldquo;. Someone please advise whether the lookahead not-in rule above should be adjusted somehow to reflect this. 
</p>

</div>

<a name="class_elements"></a><h2>Class Elements</h2>
<div class="level2">

<p>
 The remainder of the body of a class consists of statements, declarations, annotated declarations, and <code>extends</code> clauses. Declarations annotated by <code>public</code> are gathered together into a (potentially partial) description of same-named properties contributed towards composing the public <acronym title="Application Programming Interface">API</acronym> of the object to be created. (This is purposely analogous to the mechanics of <code>export</code> in so-called <a href="doku.php%3Fid=strawman:simple_modules.html" class="wikilink1" title="strawman:simple_modules" onclick="return svchk()" onkeypress="return svchk()">simple_modules</a>.)
</p>
<pre class="code">
  ClassElement : // by analogy to SourceElement
      Statement // but not ReturnStatement
      Declaration
      PrivateDeclaration
      PublicDeclaration
      SuperElement
  PrivateDeclaration :
      private Declaration
      private Identifier = Expression ;
      private Identifier ( FormalParameterList? ) { FunctionBody }
  PublicDeclaration :
      public Declaration
      public Identifier = Expression ;
      public Identifier ( FormalParameterList? ) { FunctionBody }
      require public Identifier ; // required data
      public require Identifier ;
      require public Identifier ( FormalParameterList? ) ; // required method
      public require Identifier ( FormalParameterList? ) ;
  MemberExpression : ... // &quot;...&quot; means members defined elsewhere
      private ( AssignmentExpression )
</pre>

<p>
The body of a class resembles a function body except
</p>
<ul>
<li class="level1"><div class="li"> It also lists those classes, if any, that this class extends. See SuperElement below.</div>
</li>
<li class="level1"><div class="li"> It must not contain a <code>return</code> statement. Rather, it contains <code>public</code> declarations to populate the instance it makes and returns (or the description of an instance it provides to derived classes).</div>
</li>
<li class="level1"><div class="li"> It contains <code>private</code> declarations, in order to declare class-private instance variables.</div>
</li>
<li class="level1"><div class="li"> Within the ClassElements, the keyword <code>super</code> can be used on the left of a dot as if it is an expression, to access members from the composition of the classes that this class extends.</div>
</li>
<li class="level1"><div class="li"> <em>Optional</em>: The variable name <code>self</code> is in scope, bound to the identity of the object to be instantiated, but guarded by an <em>initialization barrier</em> that rejects operations on the object until it is initialized. We mark this feature <em>optional</em> since the co-existence of <code>self</code> and <code>this</code> in one language will be confusing and hard to explain. Alternatives:</div>
<ul>
<li class="level2"><div class="li"> Simply do not bring any reliable self-reference in scope, leaving the programmer only with the current <code>this</code> with all its problems.</div>
</li>
<li class="level2"><div class="li"> Bind <code>this</code> to the value that would have been bound to <code>self</code>. </div>
</li>
<li class="level2"><div class="li"> Soft-bind <code>this</code> in methods only.</div>
</li>
</ul>
</li>
</ul>

<p>
 The MemberExpression production above using <code>private</code> is used to access the class-private instance variables of other objects allegedly of the same class. The <code>private</code> keyword can also be used to form an expression for obtaining the private facet of another instance of the same class. 
</p>

</div>

<a name="inheritance"></a><h2>Inheritance</h2>
<div class="level2">

<p>
 If a class extends no other classes, then this strawman is equivalent to <a href="doku.php%3Fid=strawman:classes_as_sugar.html" class="wikilink1" title="strawman:classes_as_sugar" onclick="return svchk()" onkeypress="return svchk()">classes as sugar</a>. If a class extends just one base class, whether with an <code>extends</code> or a Proto clause, then this strawman is equivalent to conventional single inheritance, including the bindings of <code>self</code> and <code>super</code>. If a class extends multiple base classes, then this strawman uses trait composition among these sibling base classes, and it uses trait override between the composition of these siblings and the Proto base class.
</p>
<pre class="code">
  Proto :
      : ClassName Arguments
  SuperElement :
      extends ClassName Arguments Renamings? ;
  ClassName :
      Identifier
  Renamings :
      Renaming
      Renamings , Renaming
  Renaming
      with Identifier as Identifier
      without Identifier
  MemberExpression : ... // &quot;...&quot; means members defined elsewhere
      super . IdentifierName
</pre>

<p>
The above <code>extends</code> syntax serves two purposes: It both declares the direct inheritance relationship among classes, and it provides the <em>constructor chaining</em> needed for all the contributing classes to be able to initialize their respective instance states. <em>Optional</em>: The Renamings are used to resolve conflicts or suppress members when inheriting from multiple base classes.
</p>

<p>
The meaning of the optional Proto clause is similar to that of the <code>extends</code> clause, except that it maps inheritance directly onto JavaScript&rsquo;s prototype chain, smoothing co-existence with legacy code. For new programmers working with new code that never say &ldquo;.prototype&rdquo; and are blissfully ignorant of the existence of prototype objects &ndash; thinking only in classes &ndash; the two have an almost identical meaning. The only salient differences are:
</p>
<ul>
<li class="level1"><div class="li"> A class can have a most one Proto clause.</div>
</li>
<li class="level1"><div class="li"> A Proto clause cannot be modified with Renamings</div>
</li>
<li class="level1"><div class="li"> When A class has both a Proto clause and <code>extends</code> clauses, then the ingredients contributed by the Proto clause have lower priority that the ingredients contributed by the <code>extends</code> clauses.</div>
</li>
</ul>

<p>
 For those familiar with systems which mix single inheritance classes with multiple inheritance traits or mixins, the Proto chain is like the class inheritance chain and the <code>extends</code> tree is like trait or mixin inheritance &ndash; except that there are fewer semantic differences between the two.
</p>

</div>

<a name="graduated_examples"></a><h1>Graduated Examples</h1>
<div class="level1">

<p>
 The minimal coherent subset of this strawman leaves out everything listed as optional in the introduction above. What&rsquo;s left is
</p>
<pre class="code">
  Declaration :
      LetDeclaration
      ConstDeclaration
      FunctionDeclaration
      ClassDeclaration
  ClassDeclaration :     // by analogy to FunctionDeclaration
      class Identifier ( FormalParameterList? ) { ClassBody }
  ExpressionStatement : 
      [lookahead not-in { &quot;{&quot;, &quot;function&quot;, &quot;const&quot;, &quot;class&quot; }] Expression &quot;;&quot;
  MemberExpression : ... // &quot;...&quot; means members defined elsewhere
      ClassExpression
  ClassExpression :      // by analogy to FunctionExpression
      class Identifier? ( FormalParameterList? ) { ClassBody }
  ClassBody :           // by analogy to FunctionBody
      ClassElement*

  ClassElement : // by analogy to SourceElement
      Statement // but not ReturnStatement
      Declaration
      PublicDeclaration
  PublicDeclaration :
      public Declaration
</pre>

<p>
In this minimal subset, code such as
</p>
<pre class="code javascript">  <span class="kw2">class</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> yy = y+y;
    <span class="kw2">public</span> <span class="kw2">const</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x; <span class="br0">&#125;</span>
    <span class="kw2">public</span> <span class="kw2">const</span> y = y;
    <span class="kw2">public</span> let size = x+yy; <span class="co1">// don't worry about nonsense math</span>
  <span class="br0">&#125;</span></pre>
<p>
is observably equivalent to (but expected to be more efficient than) the following code.
</p>

<p>
In such explanatory expansions, lower case variable names ending in triple underbar (<code>___</code>) merely represent some variable name guaranteed not to conflict with any user-written variable name. Upper case names ending in triple underbar (<code>___</code>) represent internal helper functions or methods. <code>OFreeze___</code> is the original value of <code>Object.freeze</code>. <code>OCreate___</code> is the original value of <code>Object.create</code>.
</p>
<pre class="code javascript">  <span class="kw2">const</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> yy = y+y;
    <span class="kw2">const</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x; <span class="br0">&#125;</span>
    <span class="kw2">const</span> y = y; <span class="co1">// See below</span>
    let size = x+yy;
    <span class="kw1">return</span> OFreeze___<span class="br0">&#40;</span>OCreate___<span class="br0">&#40;</span>Point.<span class="me1">prototype</span>, <span class="br0">&#123;</span>
      getX: <span class="br0">&#123;</span>value: getX<span class="br0">&#125;</span>,
      y: <span class="br0">&#123;</span>value: y, enumerable: <span class="kw2">true</span><span class="br0">&#125;</span>,
      size: <span class="br0">&#123;</span>get: <span class="kw2">const</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="kw1">return</span> size;<span class="br0">&#125;</span>, 
             set: <span class="kw2">const</span><span class="br0">&#40;</span>newSize<span class="br0">&#41;</span><span class="br0">&#123;</span>size = newSize;<span class="br0">&#125;</span>, 
             enumerable: <span class="kw2">true</span><span class="br0">&#125;</span>
    <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
  <span class="br0">&#125;</span></pre>
<p>
A class declaration is essentially the constructor function for initializing instances of that class. Everytime the constructor function is called, with or without <code>new</code>, it will run the code within its body as a regular function would, ignoring the <code>public</code> keyword. Then, after executing the last statement within its body, it gathers all the publicly declared variables into like-named properties of the instance it will create and return. 
</p>
<ul>
<li class="level1"><div class="li"> Public <code>const</code> or <code>let</code> variable declarations are taken to define data fields, and are therefore enumerable. </div>
</li>
<li class="level1"><div class="li"> Public <code>function</code> or <code>const</code> function declarations are taken to define methods, and are therefore not enumerable. </div>
</li>
<li class="level1"><div class="li"> <code>const</code> declarations define an unassignable variable, whose value can therefore not change after initialization. Thus, the corresponding property is simply a frozen data property holding the same value.</div>
</li>
<li class="level1"><div class="li"> <code>let</code> variable declarations and <code>function</code> function declarations define assignable variables, whose value can change at runtime. The corresponding property tracks the state of this lexical variable, and is therefore an accessor property. If either is assigned, both now present the new value.</div>
</li>
</ul>

<p>
 By prohibiting <code>return</code> within a class body, we can associate hidden state within a class accurately describing the shape of the instances it makes. For each instance of a given class, we know what public properties it will have. For each public property of the instance, we know whether it is
</p>
<ul>
<li class="level1"><div class="li"> an enumerable data property,</div>
</li>
<li class="level1"><div class="li"> an enumerable acccessor property &ndash; in which case we also know what variable it captures from its scope,</div>
</li>
<li class="level1"><div class="li"> a non-enumerable method property &ndash; in which case we know the code of the method and what variables it captures from its scope,</div>
</li>
<li class="level1"><div class="li"> (on an abstract class as defined below) a required property,</div>
</li>
<li class="level1"><div class="li"> (on a multiply inheriting abstract class) a conflicted property,</div>
</li>
</ul>

<p>
We also know, per class, the shape of the hidden state of its instance &ndash; each contains precisely the variables captured by the accessors and methods above. These accessors and methods can therefore be stored in a per-class vtable and obtain their scope, when invoked, from their instance. This per-class shape knowledge is also used in the early rejection rules below.
</p>

<p>
Note the funny looking <code>const y = y;</code>. This depends on a new &ldquo;let*&rdquo;-flavored proposal (from a recent TC39 meeting, written down where?), independent of this strawman, for the scoping of <code>const</code> and <code>let</code> declarations. Like C++ and Java local variable declarations, their scope begin at the point of declaration and covers the remainder of the enclosing block excluding their own initialization expression. If this does not become the agreed meaning of <code>const</code> and <code>let</code>, the above example becomes invalid, but the remainder of this strawman is not much affected.
</p>

</div>

<a name="adding_public_declaration_shorthands"></a><h2>Adding public declaration shorthands</h2>
<div class="level2">
<pre class="code">
  PublicDeclaration : ...
      public Identifier = Expression ;
      public Identifier ( FormalParameterList? ) { FunctionBody }
</pre>

<p>
Using our public declaration shorthand productions, our example could have been written more compactly as:
</p>
<pre class="code javascript">  <span class="kw2">class</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> yy = y+y;
    <span class="kw2">public</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x; <span class="br0">&#125;</span>
    <span class="kw2">public</span> y = y;
    <span class="kw2">public</span> let size = x+yy;
  <span class="br0">&#125;</span></pre>
<p>
For methods, a <code>const</code> function is clearly the desired meaning for the shorthand. For variables, it is not so clear. Other possibilities are
</p>
<ul>
<li class="level1"><div class="li"> an implicit <code>let</code> rather than <code>const</code>, or</div>
</li>
<li class="level1"><div class="li"> an implicit <code>let</code> on the variable declaration, but define the corresponding accessor property with a getter but no setter. This makes the lexical variable read-write within the encapsulation boundary of the object but read-only to clients of the object.</div>
</li>
</ul>

</div>

<a name="adding_class-private_instance_variables"></a><h2>Adding class-private instance variables</h2>
<div class="level2">
<pre class="code">
  ClassElement : ...
      PrivateDeclaration
  PrivateDeclaration :
      private Declaration
      private Identifier = Expression ;
      private Identifier ( FormalParameterList? ) { FunctionBody }
  MemberExpression : ... // &quot;...&quot; means members defined elsewhere
      private ( AssignmentExpression )
</pre>

<p>
A nonsensical example using class-private instance variables:
</p>
<pre class="code javascript">  <span class="kw2">class</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">private</span> size = x + y;
    <span class="kw2">public</span> sum<span class="br0">&#40;</span>otherPt<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> size + <span class="kw2">private</span><span class="br0">&#40;</span>otherPt<span class="br0">&#41;</span>.<span class="me1">size</span>;
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span></pre>
<p>
Without a <code>public</code> or <code>private</code> annotation, the <code>size</code> variable would be encapsulated within each individual instance, as in Smalltalk, E, or the Crockford objects-as-closures pattern. With the <code>private</code> annotation, <code>size</code> is instead encapsulated within the Point class, as in Java or C++. Any instance of this Point class can see the <code>size</code> of any other instance of the same Point class. 
</p>

<p>
The precise semantics of this can be understood as equivalent to (but expected to be faster than) the following code. 
</p>
<pre class="code javascript">  <span class="kw2">const</span> Point = <span class="br0">&#40;</span><span class="kw2">const</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span>
    <span class="kw2">const</span> private___ = SoftField___<span class="br0">&#40;</span><span class="br0">&#41;</span>;
    <span class="kw1">return</span> <span class="kw2">const</span><span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw2">const</span> size = x + y;
      <span class="kw2">const</span> sum<span class="br0">&#40;</span>otherPt<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> size + private___.<span class="me1">get</span><span class="br0">&#40;</span>otherPt<span class="br0">&#41;</span>.<span class="me1">size</span>;
      <span class="br0">&#125;</span>
      <span class="kw2">const</span> self___ = OFreeze___<span class="br0">&#40;</span>OCreate___<span class="br0">&#40;</span>Point.<span class="me1">prototype</span>, <span class="br0">&#123;</span>
        sum: <span class="br0">&#123;</span>value: sum<span class="br0">&#125;</span>
      <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
      private___.<span class="me1">set</span><span class="br0">&#40;</span>self___, OFreeze___<span class="br0">&#40;</span>OCreate___<span class="br0">&#40;</span>Object.<span class="me1">prototype</span>, <span class="br0">&#123;</span>
        size: <span class="br0">&#123;</span>value: size, enumerable: <span class="kw2">true</span><span class="br0">&#125;</span>
      <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
      <span class="kw1">return</span> self___;
    <span class="br0">&#125;</span>;
  <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;</pre>
<p>
If we decide that <code>self</code> or <code>this</code> is bound to the instantiated object, then it could be rewritten to the <code>self___</code> introduced above. If so, then expansions without <code>private</code> would still need <code>self___</code> but not <code>private___</code>, and thus not need the anonymous outer function definition and call.
</p>

</div>

<a name="helpersoftfield"></a><h3>Helper: SoftField___</h3>
<div class="level3">

<p>
 <code>SoftField___</code> is the original value of <code>SoftField </code> from <a href="doku.php%3Fid=strawman:inherited_explicit_soft_fields.html" class="wikilink1" title="strawman:inherited_explicit_soft_fields" onclick="return svchk()" onkeypress="return svchk()">inherited_explicit_soft_fields</a>. Note that an actual implementation should add the shape of the private record to its description of the shape of its instances, and then store this private record in hidden state within its instances.
</p>

</div>

<a name="adding_single_inheritance"></a><h2>Adding single inheritance</h2>
<div class="level2">
<pre class="code">
  ClassElement : ... // &quot;...&quot; means members defined elsewhere
      SuperElement
  SuperElement :
      extends ClassName Arguments ;
  ClassName :
      Identifier
  MemberExpression : ... 
      super . IdentifierName
</pre>

<p>
Brings us to our first slightly sensible example. From here on, we assume that <code>self</code> is used for reliable self-reference and that <code>this</code> is undisturbed.
</p>
<pre class="code javascript">  <span class="kw2">class</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">public</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x; <span class="br0">&#125;</span>
    <span class="kw2">public</span> getY<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> y; <span class="br0">&#125;</span>
    <span class="kw2">public</span> toString<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="st0">'&lt;'</span> + self.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">','</span> + self.<span class="me1">getY</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">'&gt;'</span>;
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
  <span class="kw2">class</span> WobblyPoint<span class="br0">&#40;</span>x, y, wobble<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">extends</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span>;
    <span class="kw2">public</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="kw2">super</span>.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + wobble * Math.<span class="me1">random</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span></pre>
<p>
This example demonstrates how we reconstruct the traditional single inheritance meanings of <code>self</code> and <code>super</code> as it exists in other languages from Smalltalk to Java.
</p>
<pre class="code javascript">  <span class="kw2">const</span> Point = MakeClass___<span class="br0">&#40;</span>Object, <span class="co1">// at this stage, always Object</span>
                             <span class="kw2">const</span><span class="br0">&#40;</span>self, x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x; <span class="br0">&#125;</span>
    <span class="kw2">const</span> getY<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> y; <span class="br0">&#125;</span>
    <span class="kw2">const</span> toString<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="st0">'&lt;'</span> + self.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">','</span> + self.<span class="me1">getY</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">'&gt;'</span>;
    <span class="br0">&#125;</span>
    <span class="kw1">return</span> <span class="br0">&#123;</span>
      getX: <span class="br0">&#123;</span>value: x<span class="br0">&#125;</span>,
      getY: <span class="br0">&#123;</span>value: y<span class="br0">&#125;</span>,
      toString: <span class="br0">&#123;</span>value: toString<span class="br0">&#125;</span>
    <span class="br0">&#125;</span>;
  <span class="br0">&#125;</span><span class="br0">&#41;</span>;
  <span class="kw2">const</span> WobblyPoint = MakeClass___<span class="br0">&#40;</span>Object, <span class="co1">// at this stage, always Object</span>
                                   <span class="kw2">const</span><span class="br0">&#40;</span>self, x, y, wobble<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> superIngredients___ = Point.<span class="me1">makeIngredients</span><span class="br0">&#40;</span>self, x, y<span class="br0">&#41;</span>;
    <span class="kw2">const</span> super___ = OFreeze___<span class="br0">&#40;</span>OCreate___<span class="br0">&#40;</span>Point.<span class="me1">prototype</span>, superIngredients___<span class="br0">&#41;</span><span class="br0">&#41;</span>;
    <span class="kw2">const</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> super___.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + wobble * Math.<span class="me1">random</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
    <span class="br0">&#125;</span>
    <span class="kw1">return</span> TOverride___<span class="br0">&#40;</span><span class="br0">&#123;</span>
      getX: <span class="br0">&#123;</span>value: getX<span class="br0">&#125;</span>
    <span class="br0">&#125;</span>, superIngredients___<span class="br0">&#41;</span>;
  <span class="br0">&#125;</span><span class="br0">&#41;</span>;</pre>
<p>
Our class expansion relies most of all on the helper function <code>MakeClass___</code>, explained in detail below. <code>MakeClass___</code> takes two arguments:
</p>
<ul>
<li class="level1"><div class="li"> <code>protoClass</code> which is always <code>Object</code> until we introduce prototype inheritance below, and</div>
</li>
<li class="level1"><div class="li"> a <code>makeIngredients</code> function, which is a transform of the function-like aspects of the class definition.</div>
</li>
</ul>

<p>
 <code>MakeClass___</code> installs the <code>makeIngredients</code> function it is given as the static <code>makeIngredients</code> method of the class it creates and returns. Thus, the call in <code>WobblyPoint</code>&lsquo;s expansion to <code>Point.makeIngredients</code> calls the function passed in as the second argument of the <code>MakeClass___</code> call in <code>Point</code>&lsquo;s expansion.
</p>

<p>
The two most important differences between the class-as-function as originally written and the <code>makeIngredients</code> function it is transformed into are
</p>
<ul>
<li class="level1"><div class="li"> An extra <code>self</code> first parameter is added in addition to the class&rsquo; explicit construction parameters. Likewise, the expansion of our <code>extends</code> clause inserts an additional <code>self</code> argument as part of the constructor chaining. (By analogy with the conventional <code>Point.call(this, x, y)</code> which would have appeared in a conventional <code>WobblyPoint</code> constructor.))</div>
</li>
<li class="level1"><div class="li"> Whereas calling a class returns an instance, calling a <code>makeIngredients</code> function returns a stateful trait, i.e., an enhanced property descriptor map, enabling stateful trait composition.</div>
</li>
</ul>

<p>
 Given a <code>protoClass</code> and a <code>makeIngredients</code> function, <code>MakeClass___</code> provides all the remaining logic needed to create a class, which is therefore generic and reusable. <code>MakeClass___</code> creates the class constructor function which will 
</p>
<ul>
<li class="level1"><div class="li"> create the new <code>self</code> instance, </div>
</li>
<li class="level1"><div class="li"> call its own <code>makeIngredients</code> method with this self and the constructor arguments to get the ingredients needed to initialize this self,</div>
</li>
<li class="level1"><div class="li"> use these ingredients to initialize this <code>self</code>, and</div>
</li>
<li class="level1"><div class="li"> return this <code>self</code>.</div>
</li>
</ul>

<p>
 <code>MakeClass___</code> itself then 
</p>
<ul>
<li class="level1"><div class="li"> sets this constructor&rsquo;s <code>makeIngredients</code> property to be this <code>makeIngredients</code> function, </div>
</li>
<li class="level1"><div class="li"> sets this constructor&rsquo;s <code>prototype</code> property to inherit from <code>protoClass.prototype</code>,</div>
</li>
<li class="level1"><div class="li"> freezes extraneously mutable things as needed, and</div>
</li>
<li class="level1"><div class="li"> return this constructor as the class.</div>
</li>
</ul>

<p>
Even though Point does not itself extend anything, once we introduce inheritance, Point must still be defined in terms of <code>MakeClass___</code> so that other classes can inherit from it by calling its static <code>makeIngredients</code> method.
</p>

</div>

<a name="helperstoverride_makeclass_and_makefixedpoint"></a><h3>Helpers: TOverride___, MakeClass___, and MakeFixedPoint___</h3>
<div class="level3">

<p>
 <code>TOverride___</code> is defined by <a href="doku.php%3Fid=strawman:traits_semantics.html#toverride" class="wikilink1" title="strawman:traits_semantics" onclick="return svchk()" onkeypress="return svchk()">toverride</a> and corresponds to <code>Trait.override</code> from <a href="http://howtonode.org/traitsjs" class="urlextern" target="_blank" title="http://howtonode.org/traitsjs" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">traits.js</a>.
</p>

<p>
The above explanatory expansion depends on our internal helper functions <code>MakeClass___</code>:
</p>
<pre class="code javascript">  <span class="kw2">const</span> MakeClass___<span class="br0">&#40;</span>protoClass, makeIngredients<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">function</span> constructor___<span class="br0">&#40;</span>...<span class="me1">args</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw2">const</span> <span class="br0">&#123;</span>self, initialize<span class="br0">&#125;</span> = MakeFixedPoint___<span class="br0">&#40;</span>constructor___.<span class="me1">prototype</span><span class="br0">&#41;</span>;
      initialize<span class="br0">&#40;</span>makeIngredients<span class="br0">&#40;</span>self, ...<span class="me1">args</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
      <span class="kw1">return</span> self;
    <span class="br0">&#125;</span>
    constructor___.<span class="me1">makeIngredients</span> = makeIngredients;
    constructor___.<span class="me1">prototype</span> = OCreate___<span class="br0">&#40;</span>protoClass.<span class="me1">prototype</span><span class="br0">&#41;</span>;
    OFreeze___<span class="br0">&#40;</span>constructor___.<span class="me1">prototype</span><span class="br0">&#41;</span>;
    <span class="kw1">return</span> OFreeze___<span class="br0">&#40;</span>constructor___<span class="br0">&#41;</span>;
  <span class="br0">&#125;</span></pre>
<p>
which in turn depends on <code>MakeFixedPoint___</code>:
</p>
<pre class="code javascript">  <span class="kw2">const</span> MakeFixedPoint___<span class="br0">&#40;</span>parent<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> h0 = OFreeze___<span class="br0">&#40;</span><span class="br0">&#123;</span>
      get: <span class="kw2">const</span><span class="br0">&#40;</span>rcvr, <span class="kw3">name</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">throw</span> <span class="kw2">new</span> ReferenceError<span class="br0">&#40;</span>...<span class="br0">&#41;</span>; <span class="br0">&#125;</span>,
      has: <span class="kw2">const</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="kw2">true</span>; <span class="br0">&#125;</span>
    <span class="br0">&#125;</span><span class="br0">&#41;</span>;
    <span class="kw2">const</span> h1 = Proxy.<span class="me1">create</span><span class="br0">&#40;</span>h0, <span class="kw2">null</span><span class="br0">&#41;</span>;
    <span class="kw2">const</span> h2 = OCreate___<span class="br0">&#40;</span>h1<span class="br0">&#41;</span>;
    <span class="kw2">const</span> self = Proxy.<span class="me1">create</span><span class="br0">&#40;</span>h2, parent<span class="br0">&#41;</span>;
    <span class="kw1">return</span> OFreeze___<span class="br0">&#40;</span><span class="br0">&#123;</span>
      self: self,
      initialize: <span class="kw2">const</span><span class="br0">&#40;</span>pdmap<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        Object.<span class="me1">defineProperty</span><span class="br0">&#40;</span>h2, <span class="st0">'fix'</span>, <span class="br0">&#123;</span>
          value: <span class="kw2">const</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> pdmap; <span class="br0">&#125;</span>
        <span class="br0">&#125;</span><span class="br0">&#41;</span>;
        Object.<span class="me1">preventExtensions</span><span class="br0">&#40;</span>self<span class="br0">&#41;</span>;
      <span class="br0">&#125;</span>
    <span class="br0">&#125;</span><span class="br0">&#41;</span>;
  <span class="br0">&#125;</span></pre>
<p>
<code>MakeFixedPoint___</code> solves a long standing tension in the design of class inheritance mechanisms between:
</p>
<ul>
<li class="level1"><div class="li"> <code>self</code> isn&rsquo;t ready for use until it is fully initialized.</div>
</li>
<li class="level1"><div class="li"> Internal methods within the class are useful to help initialize an fresh instance during construction.</div>
</li>
<li class="level1"><div class="li"> <code>self</code> (unlike <code>super</code>) holds a first class value that can be shared with others during construction.</div>
</li>
</ul>

<p>
 The three common non-solutions to this problem are:
</p>
<ul>
<li class="level1"><div class="li"> In C++, constructors are executed top down (from base to derived). During the execution of each constructor, the object has the vtable of the current class.</div>
</li>
<li class="level1"><div class="li"> In Java and Smalltalk, constructors are also executed top down (from base to derived), but the object immediately has its final vtable &ndash; the vtable of the concrete class being directly instantiated.</div>
</li>
<li class="level1"><div class="li"> In C# apparently constructors are executed bottom up (from derived to base), and the object immediately has its final vtable. (Is this true?)</div>
</li>
</ul>

<p>
 In our semantics, although <code>self</code> is still a first class value during construction, during that time it acts as a trapping proxy that reacts to all traps by throwing a ReferenceError. During construction, it is therefore only useful for non-trapping operations like
</p>
<ul>
<li class="level1"><div class="li"> lexically capturing the value as <code>self</code> in methods that will run post-construction, and</div>
</li>
<li class="level1"><div class="li"> using its identity, as our previous class-private explanatory expansion does, by using <code>self</code> as a key in a weak map.</div>
</li>
</ul>

<p>
This is an initialization barrier analogous to the dynamic dead zone for <code>const</code> variables, but associated with an object rather than a variable.
</p>

<p>
Despite the enforced uselessness of <code>self</code> during initialization, all the variables and methods that this class itself would directly contribute to self are still accessible as lexical variables within the class body. These local methods can be used to manipulate these local state variables to the extent that they access them as lexical variables. Direct lexical access <em>always</em> bypasses the vtable of the instance, going directly to the lexically captured definition irrepective of derived class overrides.
</p>

<p>
Once we have all the ingredients needed to initialize the <code>self</code>, we then turn <code>self</code> into a non-extensible regular object whose properties are those described by the accumulated ingredients. In support of high integrity, <code>self</code> only goes live after all its invariants should be in place.
</p>

</div>

<a name="semi-static_rejection_rulessimple_inheritance"></a><h3>Semi-Static Rejection Rules: Simple Inheritance</h3>
<div class="level3">

<p>
 Class definitions can have semi-static errors, and these are not accounted for by our explanatory expansions. When a class with a semi-static error is evaluated, it throws a TypeError without further effect. Like a FunctionDeclaration, a ClassDeclaration is evaluated on entry to its immediately containing Block or Program. Thus, a semi-static error in a top-level ClassDeclaration happens as early as early errors &ndash; before any code within the Program is executed. A ClassExpression is evaluated according to where the expression appears, as with any other expression, and therefore the semi-static error would be reported then.
</p>

<p>
When no class definitions anywhere have semi-static errors, then our explanatory expansions do accurately describe their semantics. Thus, these explanatory expansions are sound conservative models of the possible behaviors of the program if we add only the proviso that any class definition, when evaluated, might or might not throw a TypeError without further effect.
</p>

<p>
The ClassName within an <code>extends</code> clause must be free within the class definition it appears in, and must evaluate to a class value, i.e., a value created by some other class definitions. Only class definitions can create class values, i.e., values which can be named in extends clauses. The extension relationship among class values may not contain cycles. The error must be reported by the class definition that would otherwise have created a cycle when evaluated. 
</p>

<p>
Note that we do not require the ClassName to be <em>statically</em> resolvable to a class. Rather, it simply names a value to be looked up at runtime. Combined with the free variable rule above, this allows errors to be reported as early as they would under a static restriction without prohibiting the dynamic and generative patterns one should expect from a dynamic language. For example:
</p>
<pre class="code javascript">  <span class="kw2">const</span> makeWobblyPointClass<span class="br0">&#40;</span>Point<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">class</span> WobblyPoint<span class="br0">&#40;</span>x, y, wobble<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw2">extends</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span>;
      <span class="kw2">public</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">return</span> <span class="kw2">super</span>.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + wobble * Math.<span class="me1">random</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
      <span class="br0">&#125;</span>
    <span class="br0">&#125;</span>
    <span class="kw1">return</span> WobblyPoint;
  <span class="br0">&#125;</span></pre>
<p>
is valid code. Whether it results in a semi-static error simply cannot be determined statically without static types. However, if <code>makeWobblyPointClass</code> is called with a non-class argument, then it throws a TypeError on entry, when it evaluates the <code>WobblyPoint</code> definition. Gilad Bracha&rsquo;s <em>newspeak</em> language makes much use of this ability to parameterize which class a given class inherits from (citation needed).
</p>

<p>
From the implementation perspective, this free variable rule makes the hidden shape information of the superclasses available when a derived class&rsquo; definition is evaluated, which can thereby be accumulated into the hidden shape information stored in the derived class.
</p>

</div>

<a name="adding_prototype_inheritance_instead"></a><h2>Adding prototype inheritance instead</h2>
<div class="level2">

<p>
 Here, we first explore reusing JavaScript&rsquo;s prototype inheritance as the sole (and therefore single) inheritance mechanism, as an alternative to the single <code>extends</code> clause explained above. We deal with their co-existence below when we consider multiple inheritance. So the productions below are in addition to the above productions in the absence of the previous single inheritance additions.
</p>
<pre class="code">
  ClassDeclaration :
      ClassAdjective? class Identifier ( FormalParameterList? ) Proto? { ClassBody }
  ClassExpression :
      ClassAdjective? class Identifier? ( FormalParameterList? ) Proto? { ClassBody }
  Proto :
      : ClassName Arguments
  ClassName :
      Identifier
  MemberExpression : ... 
      super . IdentifierName
</pre>
<pre class="code javascript">  <span class="kw2">class</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">public</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x; <span class="br0">&#125;</span>
    <span class="kw2">public</span> getY<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> y; <span class="br0">&#125;</span>
    <span class="kw2">public</span> toString<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="st0">'&lt;'</span> + self.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">','</span> + self.<span class="me1">getY</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">'&gt;'</span>;
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
  <span class="kw2">class</span> WobblyPoint<span class="br0">&#40;</span>x, y, wobble<span class="br0">&#41;</span> : Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">public</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="kw2">super</span>.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + wobble * Math.<span class="me1">random</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span></pre><pre class="code javascript">  <span class="kw2">const</span> Point = MakeClass___<span class="br0">&#40;</span>Object, 
                             <span class="kw2">const</span><span class="br0">&#40;</span>self, x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x; <span class="br0">&#125;</span>
    <span class="kw2">const</span> getY<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> y; <span class="br0">&#125;</span>
    <span class="kw2">const</span> toString<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="st0">'&lt;'</span> + self.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">','</span> + self.<span class="me1">getY</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">'&gt;'</span>;
    <span class="br0">&#125;</span>
    <span class="kw1">return</span> <span class="br0">&#123;</span>
      getX: <span class="br0">&#123;</span>value: x<span class="br0">&#125;</span>,
      getY: <span class="br0">&#123;</span>value: y<span class="br0">&#125;</span>,
      toString: <span class="br0">&#123;</span>value: toString<span class="br0">&#125;</span>
    <span class="br0">&#125;</span>;
  <span class="br0">&#125;</span><span class="br0">&#41;</span>;
  <span class="kw2">const</span> WobblyPoint = MakeClass___<span class="br0">&#40;</span>Point, <span class="co1">// only difference</span>
                                   <span class="kw2">const</span><span class="br0">&#40;</span>self, x, y, wobble<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> superIngredients___ = Point.<span class="me1">makeIngredients</span><span class="br0">&#40;</span>self, x, y<span class="br0">&#41;</span>;
    <span class="kw2">const</span> super___ = OFreeze___<span class="br0">&#40;</span>OCreate___<span class="br0">&#40;</span>Point.<span class="me1">prototype</span>, superIngredients___<span class="br0">&#41;</span><span class="br0">&#41;</span>;
    <span class="kw2">const</span> getX<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> super___.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + wobble * Math.<span class="me1">random</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
    <span class="br0">&#125;</span>
    <span class="kw1">return</span> TOverride___<span class="br0">&#40;</span><span class="br0">&#123;</span>
      getX: <span class="br0">&#123;</span>value: getX<span class="br0">&#125;</span>
    <span class="br0">&#125;</span>, superIngredients___<span class="br0">&#41;</span>;
  <span class="br0">&#125;</span><span class="br0">&#41;</span>;</pre>
<p>
The only difference above is that <code>Point</code> is also passes as the <code>protoClass</code> argument to <code>MakeClass___</code>. The only resulting difference of behavior at this stage is that <code>MakeClass___</code> initializes <code>WobblyPoint.prototype</code> to inherit from <code>Point.prototype</code> rather than <code>Object.prototype</code>.
</p>

</div>

<a name="semi-static_rejection_rulesprototype_inheritance"></a><h3>Semi-static Rejection Rules: prototype inheritance</h3>
<div class="level3">

<p>
 Same as for single inheritance.
</p>

</div>

<a name="adding_abstract_classes_and_required_members"></a><h2>Adding abstract classes and required members</h2>
<div class="level2">
<pre class="code">
  ClassDeclaration :     // by analogy to FunctionDeclaration
      ClassAdjective? class Identifier ( FormalParameterList? ) { ClassBody }
  ClassExpression :      // by analogy to FunctionExpression
      ClassAdjective? class Identifier? ( FormalParameterList? ) { ClassBody }
  ClassAdjective : ...
      abstract

  PublicDeclaration : ...
      require public Identifier ; // required data
      public require Identifier ;
      require public Identifier ( FormalParameterList? ) ; // required method
      public require Identifier ( FormalParameterList? ) ;
</pre>

<p>
 Say our Point class were instead:
</p>
<pre class="code javascript">  abstract <span class="kw2">class</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">public</span> require getX<span class="br0">&#40;</span><span class="br0">&#41;</span>;
    <span class="kw2">public</span> getY<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> y; <span class="br0">&#125;</span>
    <span class="kw2">public</span> toString<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="st0">'&lt;'</span> + self.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">','</span> + self.<span class="me1">getY</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">'&gt;'</span>;
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span></pre>
<p>
it would then expand into
</p>
<pre class="code javascript">  <span class="kw2">const</span> Point = MakeAbstractClass___<span class="br0">&#40;</span>Object, 
                                     <span class="kw2">const</span><span class="br0">&#40;</span>self, x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> getY<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> y; <span class="br0">&#125;</span>
    <span class="kw2">const</span> toString<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> <span class="st0">'&lt;'</span> + self.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">','</span> + self.<span class="me1">getY</span><span class="br0">&#40;</span><span class="br0">&#41;</span> + <span class="st0">'&gt;'</span>;
    <span class="br0">&#125;</span>
    <span class="kw1">return</span> <span class="br0">&#123;</span>
      getX: TRequired___,
      getY: <span class="br0">&#123;</span>value: y<span class="br0">&#125;</span>,
      toString: <span class="br0">&#123;</span>value: toString<span class="br0">&#125;</span>
    <span class="br0">&#125;</span>;
  <span class="br0">&#125;</span><span class="br0">&#41;</span>;</pre>
<p>
An required member does not declare a local variable, but rather only creates and marks that public property as needing to be provided downstream. At this stage the difference between a public required data member and a public required method is purely documentary. Other strawmen may well leverage this syntactic distinction for other purposes.
</p>

</div>

<a name="helperstrequired_makeabstractclass"></a><h3>Helpers: TRequired___, MakeAbstractClass___</h3>
<div class="level3">

<p>
 <code>TRequired___</code> is defined as <code>{required: true}</code>, in order to play nice with our <a href="doku.php%3Fid=strawman:traits_semantics.html" class="wikilink1" title="strawman:traits_semantics" onclick="return svchk()" onkeypress="return svchk()">traits_semantics</a> operations.
</p>

<p>
<code>MakeAbstractClass___</code> is just like <code>MakeClass___</code> except that the direct constructor behavior is only to throw a TypeError. An abstract class can contribute ingredients towards the initialization of an object, but only a concrete class can use the gathered ingredients to make and initialize an object.
</p>
<pre class="code javascript">  <span class="kw2">const</span> MakeAbstractClass___<span class="br0">&#40;</span>protoClass, makeIngredients<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">function</span> constructor___<span class="br0">&#40;</span>...<span class="me1">args</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">throw</span> <span class="kw2">new</span> TypeError<span class="br0">&#40;</span>...<span class="br0">&#41;</span>;
    <span class="br0">&#125;</span>
    constructor___.<span class="me1">makeIngredients</span> = makeIngredients;
    constructor___.<span class="me1">prototype</span> = OCreate___<span class="br0">&#40;</span>protoClass.<span class="me1">prototype</span><span class="br0">&#41;</span>;
    OFreeze___<span class="br0">&#40;</span>constructor___.<span class="me1">prototype</span><span class="br0">&#41;</span>;
    <span class="kw1">return</span> OFreeze___<span class="br0">&#40;</span>constructor___<span class="br0">&#41;</span>;
  <span class="br0">&#125;</span></pre>
</div>

<a name="semi-static_rejection_rulesunresolved_required_members"></a><h3>Semi-Static Rejection Rules: Unresolved required members</h3>
<div class="level3">

<p>
 In a class in which any member is required, whether because of a direct <code>require</code> declaration or because of an unresolved inherited required member, then the class itself must be declared <code>abstract</code>. If it is not, then a TypeError is thrown when the class definition is evaluated. <code>Point</code> above does not exhibit such an error.
</p>

<p>
If <code>super.identifier</code> names an inherited required member, as WobblyPoint&rsquo;s <code>super.getX</code> now does, then a TypeError is thrown when WobblyPoint&rsquo;s definition is evaluated.
</p>

</div>

<a name="adding_soft-bound_methods"></a><h2>Adding soft-bound methods</h2>
<div class="level2">

<p>
 If classes use only <code>self</code> and do not traffic in <code>this</code>, then soft binding should not be relevant. If classes do make use of <code>this</code> to designate the instance of the class, then could adopt the method binding of semantics of <a href="doku.php%3Fid=strawman:traits_semantics.html#tcreate" class="wikilink1" title="strawman:traits_semantics" onclick="return svchk()" onkeypress="return svchk()">tcreate</a> (which corresponds to <code>Trait.create</code> from traits.js). Alternatively, we might want to adopt a tcreate modified to <a href="doku.php%3Fid=strawman:soft_bind.html" class="wikilink1" title="strawman:soft_bind" onclick="return svchk()" onkeypress="return svchk()">soft bind</a> <code>this</code> to its methods instead. The semantics of <code>this</code> would then resemble the following objects-as-closure pattern, ignoring for the moment the impossibility of using <code>self___</code> before it&rsquo;s defined. (Repairing this is easy but verbose.)
</p>
<pre class="code javascript">  <span class="kw2">const</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> self___ = OFreeze___<span class="br0">&#40;</span>OCreate___<span class="br0">&#40;</span>Point.<span class="me1">prototype</span>, <span class="br0">&#123;</span>
      getX: <span class="br0">&#123;</span>value: <span class="br0">&#40;</span><span class="kw2">const</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x; <span class="br0">&#125;</span><span class="br0">&#41;</span>.<span class="me1">softBind</span><span class="br0">&#40;</span>self___<span class="br0">&#41;</span><span class="br0">&#125;</span>,
      getY: <span class="br0">&#123;</span>value: <span class="br0">&#40;</span><span class="kw2">const</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> y; <span class="br0">&#125;</span><span class="br0">&#41;</span>.<span class="me1">softBind</span><span class="br0">&#40;</span>self___<span class="br0">&#41;</span><span class="br0">&#125;</span>
    <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
    <span class="kw1">return</span> self___;
  <span class="br0">&#125;</span></pre>
<p>
However, this way of using soft binding only works for inheritance within the class system, not for non-class objects that happen to inherit from an individual point. To accommodate this case as well, we can use a getter to do the soft binding at extraction time. We first define a helper function for define such getters.
</p>
<pre class="code javascript">  <span class="kw2">function</span> makeSoftBindingDescriptor<span class="br0">&#40;</span>f<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">return</span> <span class="br0">&#123;</span> get: <span class="kw2">const</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> f.<span class="me1">softBind</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span>; <span class="br0">&#125;</span><span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
  <span class="co1">//...</span>
  <span class="kw2">const</span> Point<span class="br0">&#40;</span>x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">return</span> OFreeze___<span class="br0">&#40;</span>OCreate___<span class="br0">&#40;</span>Point.<span class="me1">prototype</span>, <span class="br0">&#123;</span>
      getX: makeSoftBindingDescriptor<span class="br0">&#40;</span><span class="kw2">const</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x; <span class="br0">&#125;</span><span class="br0">&#41;</span>,
      getY: makeSoftBindingDescriptor<span class="br0">&#40;</span><span class="kw2">const</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> y; <span class="br0">&#125;</span><span class="br0">&#41;</span>
    <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
  <span class="br0">&#125;</span></pre>
<p>
This also has the minor benefit that, by postponing the soft binding until extraction time, we no longer need to solve the circular definition puzzle above.
</p>
<pre class="code">    </pre>

</div>

<a name="semi-static_rejection_rulessoft-bound_method"></a><h3>Semi-static Rejection Rules: soft-bound method</h3>
<div class="level3">

<p>
 TODO: I suspect there aren&rsquo;t any, in which case delete this subsection
</p>

</div>

<a name="adding_multiple_inheritance"></a><h2>Adding multiple inheritance</h2>
<div class="level2">

<p>
 No new productions. Syntactically, we just lift the restriction that only one <code>extends</code> or Proto clause can appear in each class. The <code>superIngredients___</code> are now made from a <code>TCompose___</code> of the ingredients defined by each of the superclasses, and a <code>TOverride___</code> of this composition with the ingredients defined by Proto. The result of composing these extensions is a set of properties, where each is either
</p>
<ul>
<li class="level1"><div class="li"> a description of concrete member (data, accessor, or method),</div>
</li>
<li class="level1"><div class="li"> a required member,</div>
</li>
<li class="level1"><div class="li"> a conflicted member.</div>
</li>
</ul>

<p>
 If two sibling superclasses both define non-required (i.e., concrete or conflicted) members of the same name, then the composition of these superclasses has that member in conflict. If exactly one superclass contributes a non-required member of a given name, then the composition has this non-requires member. 
</p>

<p>
If a derived class itself directly defines a member for a given name, whether concrete or required, then this definition overrides whatever was inherited from the composition of superclasses.
</p>

<p>
If the composition of superclasses defines a member of a given name, then this definition overrides whatever was inherited from Proto.
</p>
<pre class="code javascript">    <span class="kw2">class</span> D<span class="br0">&#40;</span>x,y<span class="br0">&#41;</span> : A<span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw2">extends</span> B<span class="br0">&#40;</span>y<span class="br0">&#41;</span>;
        <span class="kw2">extends</span> C<span class="br0">&#40;</span>x+y<span class="br0">&#41;</span>;
        <span class="kw2">public</span> foo<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> x-y; <span class="br0">&#125;</span>
    <span class="br0">&#125;</span></pre>
<p>
would expand to
</p>
<pre class="code javascript">  <span class="kw2">const</span> D = MakeClass___<span class="br0">&#40;</span>A, 
                         <span class="kw2">const</span><span class="br0">&#40;</span>self, x, y<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">const</span> superIngredients___ = 
        TOverride___<span class="br0">&#40;</span>TCompose___<span class="br0">&#40;</span>B.<span class="me1">makeIngredients</span><span class="br0">&#40;</span>self, y<span class="br0">&#41;</span>,
                                 C.<span class="me1">makeIngredients</span><span class="br0">&#40;</span>self, x+y<span class="br0">&#41;</span><span class="br0">&#41;</span>,
                     A.<span class="me1">makeIngredients</span><span class="br0">&#40;</span>self, x<span class="br0">&#41;</span><span class="br0">&#41;</span>;
    <span class="kw2">const</span> super___ = OFreeze___<span class="br0">&#40;</span>OCreate___<span class="br0">&#40;</span>A.<span class="me1">prototype</span>, superIngredients___<span class="br0">&#41;</span><span class="br0">&#41;</span>;
    <span class="kw2">const</span> foo<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> x-y;
    <span class="br0">&#125;</span>
    <span class="kw1">return</span> TOverride___<span class="br0">&#40;</span><span class="br0">&#123;</span>
      foo: <span class="br0">&#123;</span>value: foo<span class="br0">&#125;</span>
    <span class="br0">&#125;</span>, superIngredients___<span class="br0">&#41;</span>;
  <span class="br0">&#125;</span><span class="br0">&#41;</span>;</pre>
<p>
More intuitively, if we ignore <code>super</code> issues and the distinction between instances and ingredients, the above class defines approximately:
</p>
<pre class="code javascript">    TOverride___<span class="br0">&#40;</span><span class="br0">&#123;</span>value: foo<span class="br0">&#125;</span>,              <span class="co1">// local members first</span>
                 TCompose___<span class="br0">&#40;</span>B<span class="br0">&#40;</span>y<span class="br0">&#41;</span>, C<span class="br0">&#40;</span>x+y<span class="br0">&#41;</span><span class="br0">&#41;</span>, <span class="co1">// ''extends'' next, symmetrically</span>
                 A<span class="br0">&#40;</span>x<span class="br0">&#41;</span><span class="br0">&#41;</span>                      <span class="co1">// Proto last</span></pre>
</div>

<a name="helpertcompose"></a><h3>Helper: TCompose___</h3>
<div class="level3">

<p>
 <code>TCompose___</code> is defined by <a href="doku.php%3Fid=strawman:traits_semantics.html#tcompose" class="wikilink1" title="strawman:traits_semantics" onclick="return svchk()" onkeypress="return svchk()">tcompose</a>, corresponding to <code>Trait.compose</code> of traits.js. The most important feature of <code>TCompose___</code> is that it is associative and commutative. Commutativity ensures that the order of <code>extends</code> clauses within a class don&rsquo;t affect the result of composition. In a pattern where each class either defines local members or extends other classes but no class does both, then associativity ensures that any <code>extends</code> tree that composes together the same members yields the same composition, easing refactoring.
</p>

<p>
TODO: Revise <code>MakeClass___</code> and <code>MakeAbstractClass___</code> so that classes are defined using <a href="doku.php%3Fid=strawman:proxy_instanceof.html" class="wikilink1" title="strawman:proxy_instanceof" onclick="return svchk()" onkeypress="return svchk()">proxy instanceof</a> as equivalent to function proxies that trap <code>hasInstance</code>, so that an instance is <code>instanceof</code> all of its ancestor classes, even under multiple inheritance. Although <code>instanceof</code> is still not a valid type or trademark check, we should nevertheless ensure that <code>instanceof</code> remains unsurprising in the face of multiple inheritance. Of course, we are powerless to make the prototype chain reflect multiple inheritance as well, so we live with the symmetry-breaking rule that the prototype chain follows the first <code>extends</code> clause of each class.
</p>

</div>

<a name="semi-static_rejection_rulesunresolved_conflicts"></a><h3>Semi-static Rejection Rules: Unresolved conflicts</h3>
<div class="level3">

<p>
 An abstract class may have unresolved required or conflicted members. A concrete class cannot; instead a TypeError is thrown. 
</p>

<p>
A <code>super.identifier</code> expression causes a semi-static error if that named member of the composition of superclasses is required or conflicted. When a class definition containing such a <code>super</code> expression is evaluated, a TypeError is thrown.
</p>

</div>

<a name="adding_trait_renaming_operations"></a><h2>Adding trait renaming operations</h2>
<div class="level2">
<pre class="code">
  SuperElement :
      extends ClassName Arguments Renamings? ;
  Renamings :
      Renaming
      Renamings , Renaming
  Renaming
      with Identifier as Identifier
      without Identifier
</pre>

<p>
TODO based on <a href="doku.php%3Fid=strawman:traits_semantics.html#tresolve" class="wikilink1" title="strawman:traits_semantics" onclick="return svchk()" onkeypress="return svchk()">tresolve</a> which corresponds to <code>Trait.resolve</code> from traits.js.
</p>

<p>
By itself, the above production and the corresponding <a href="doku.php%3Fid=strawman:traits_semantics.html#tresolve" class="wikilink1" title="strawman:traits_semantics" onclick="return svchk()" onkeypress="return svchk()">tresolve</a> semantics is not yet adequate to replace the need for <code>super</code>, since the result of renaming is still accessible as a public property on the instance. By contrast, <code>super</code> accesses the overridden functionality without thereby making it accessible outside the abstraction. Overriding becomes a form of encapsulation. Alternatively, we could omit <code>super</code> and enhance the above production so that the right hand side of a <code>with/as</code> could be a local variable declaration, making the overridden member accessible without exporting it. This would be more expressive than <code>super</code> and more naturally part of a traits system. 
</p>

</div>

<a name="adding_extension_methods"></a><h2>Adding extension methods</h2>
<div class="level2">

<p>
 <a href="doku.php%3Fid=strawman:names_vs_soft_fields.html#conflict-free_object_extension_using_soft_fields" class="wikilink1" title="strawman:names_vs_soft_fields" onclick="return svchk()" onkeypress="return svchk()">conflict-free object extension using soft fields</a> Shows how to use soft fields to express the semantics of <a href="http://msdn.microsoft.com/en-us/library/bb311042.aspx" class="urlextern" target="_blank" title="http://msdn.microsoft.com/en-us/library/bb311042.aspx" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">extension methods</a> using soft fields. Using our running example, we might say:
</p>
<pre class="code javascript">  <span class="kw2">private</span> getSlope; <span class="co1">// soft field for slope method</span>
  Point.<span class="me1">prototype</span>.<span class="me1">getSlope</span> = <span class="kw2">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="kw1">this</span>.<span class="me1">getY</span><span class="br0">&#40;</span><span class="br0">&#41;</span> / <span class="kw1">this</span>.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span>; <span class="br0">&#125;</span>;
  <span class="co1">//...</span>
  <span class="kw3">print</span><span class="br0">&#40;</span>wobblyPoint.<span class="me1">getSlope</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>; <span class="co1">// looks up and applies getSlope extension above</span>
&nbsp;
  <span class="kw2">export</span> #.<span class="me1">getSlope</span>; <span class="co1">// if you wish</span></pre>
<p>
This would expand to
</p>
<pre class="code javascript">  <span class="kw2">const</span> getSlope___ = SoftField<span class="br0">&#40;</span><span class="br0">&#41;</span>;
  getSlope.<span class="me1">set</span><span class="br0">&#40;</span>Point.<span class="me1">prototype</span>, <span class="kw2">function</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="kw1">this</span>.<span class="me1">getY</span><span class="br0">&#40;</span><span class="br0">&#41;</span> / <span class="kw1">this</span>.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span>; <span class="br0">&#125;</span><span class="br0">&#41;</span>;
  <span class="co1">//...</span>
  <span class="kw3">print</span><span class="br0">&#40;</span>getSlope___.<span class="me1">get</span><span class="br0">&#40;</span>wobblyPoint<span class="br0">&#41;</span>.<span class="me1">call</span><span class="br0">&#40;</span>wobblyPoint<span class="br0">&#41;</span><span class="br0">&#41;</span>;
&nbsp;
  <span class="kw2">export</span> getSlope___;</pre>
<p>
In the context of a class system, the use of <code>private</code> in this syntax is unpleasant, as it doesn&rsquo;t have an intuitive (non-implementation oriented) relationship to other meanings of <code>private</code>. Worse, the above expresses the extension by explicitly mentioning prototypes, requiring the new class-based programmer to still understand the mapping of classes to prototype inheritance. A more class-oriented sugar based on <a href="http://www.w3.org/TR/WebIDL/#idl-implements-statements" class="urlextern" target="_blank" title="http://www.w3.org/TR/WebIDL/#idl-implements-statements" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">WebIDL implements statements</a> might be:
</p>
<pre class="code javascript">  interface SlopyThing <span class="br0">&#123;</span>
    getSlope<span class="br0">&#40;</span><span class="br0">&#41;</span>; <span class="co1">// In an interface, &quot;public&quot; and &quot;required&quot; are implicit</span>
    <span class="co1">// other slopy method declarations</span>
  <span class="br0">&#125;</span>;
&nbsp;
  Point implements SlopyThing <span class="br0">&#123;</span>
    <span class="kw2">public</span> getSlope<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">return</span> self.<span class="me1">getY</span><span class="br0">&#40;</span><span class="br0">&#41;</span> / self.<span class="me1">getX</span><span class="br0">&#40;</span><span class="br0">&#41;</span>; 
    <span class="br0">&#125;</span>
    <span class="co1">// other slopy method implementations</span>
  <span class="br0">&#125;</span></pre>
<p>
Importing <code>SlopyThing</code> could then bring its members into scope. This is hazardous, since these members would then not be enumerated at the importing site. 
</p>

<p>
Whether extension methods are packaged into extension interfaces or not, the important point is that the above <code>implements</code> clause is subjective. Code not importing <code>SlopyThing</code> would not see any changes, even reflectively, to the semantics of points.
</p>

<p>
Restating the example from <a href="doku.php%3Fid=strawman:names_vs_soft_fields.html#conflict-free_object_extension_using_soft_fields" class="wikilink1" title="strawman:names_vs_soft_fields" onclick="return svchk()" onkeypress="return svchk()">conflict-free object extension using soft fields</a> in these terms, we get
</p>
<pre class="code javascript">  interface Cloneable <span class="br0">&#123;</span>
    clone<span class="br0">&#40;</span><span class="br0">&#41;</span>;
  <span class="br0">&#125;</span>
&nbsp;
  Object implements Cloneable <span class="br0">&#123;</span>
    <span class="kw2">public</span> clone<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
  Array implements Cloneable <span class="br0">&#123;</span>
    <span class="kw2">public</span> clone<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      ...
      <span class="me1">target</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span> = <span class="kw1">this</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span>.<span class="me1">clone</span><span class="br0">&#40;</span><span class="br0">&#41;</span>; <span class="co1">// recur on clone method</span>
      ...
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
  String implements Cloneable <span class="br0">&#123;</span>
    <span class="kw2">public</span> clone<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
  ...
  <span class="kw2">export</span> Cloneable;</pre>
</div>

<a name="semi-static_rejection_rulesextension_methods"></a><h3>Semi-static Rejection Rules: extension methods</h3>
<div class="level3">

<p>
 TODO: if none, which seems plausible, remove this section.
</p>

</div>

<a name="see"></a><h1>See</h1>
<div class="level1">

<p>
 <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.17.1949" class="urlextern" target="_blank" title="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.17.1949" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow"> Encapsulation and Inheritance in Object-Oriented Programming Languages</a> &ndash; classic 1986 paper by Alan Snyder 
</p>

<p>
<a href="doku.php%3Fid=strawman:const_functions.html" class="wikilink1" title="strawman:const_functions" onclick="return svchk()" onkeypress="return svchk()">const_functions</a>
</p>

<p>
<a href="doku.php%3Fid=strawman:guards.html" class="wikilink1" title="strawman:guards" onclick="return svchk()" onkeypress="return svchk()">guards</a>
</p>

<p>
<a href="doku.php%3Fid=strawman:trademarks.html" class="wikilink1" title="strawman:trademarks" onclick="return svchk()" onkeypress="return svchk()">trademarks</a>
</p>

<p>
<a href="doku.php%3Fid=strawman:inherited_explicit_soft_fields.html" class="wikilink1" title="strawman:inherited_explicit_soft_fields" onclick="return svchk()" onkeypress="return svchk()">inherited explicit soft fields</a>
</p>

<p>
<a href="doku.php%3Fid=strawman:classes_as_sugar.html" class="wikilink1" title="strawman:classes_as_sugar" onclick="return svchk()" onkeypress="return svchk()">classes as sugar</a>
</p>

<p>
<a href="http://howtonode.org/traitsjs" class="urlextern" target="_blank" title="http://howtonode.org/traitsjs" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">How To Node article on Traits.js</a>
</p>

<p>
<a href="https://jetpack.mozillalabs.com/sdk/1.0b3/docs/packages/api-utils/docs/traits.html" class="urlextern" target="_blank" title="https://jetpack.mozillalabs.com/sdk/1.0b3/docs/packages/api-utils/docs/traits.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Jetpack Traits</a>
</p>

<p>
<a href="doku.php%3Fid=strawman:syntax_for_efficient_traits.html" class="wikilink1" title="strawman:syntax_for_efficient_traits" onclick="return svchk()" onkeypress="return svchk()">syntax for efficient traits</a>
</p>

<p>
<a href="doku.php%3Fid=strawman:object_initialiser_extensions.html" class="wikilink1" title="strawman:object_initialiser_extensions" onclick="return svchk()" onkeypress="return svchk()">object initialiser extensions</a>
</p>

<p>
<a href="https://mail.mozilla.org/pipermail/es-discuss/2009-March/009115.html" class="urlextern" target="_blank" title="https://mail.mozilla.org/pipermail/es-discuss/2009-March/009115.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Classes as Sugar thread</a> which starts with pointers to earlier threads.
</p>

<p>
<a href="doku.php%3Fid=strawman:classes_as_inheritance_sugar.html" class="wikilink1" title="strawman:classes_as_inheritance_sugar" onclick="return svchk()" onkeypress="return svchk()">classes as inheritance sugar</a> (not yet ready)
</p>

<p>
<a href="http://msdn.microsoft.com/en-us/library/bb311042.aspx" class="urlextern" target="_blank" title="http://msdn.microsoft.com/en-us/library/bb311042.aspx" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">extension methods</a> 
</p>

</div>
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        strawman/classes_with_trait_composition.1299750065.txt &middot; Last modified: 2011/05/09 20:50 by markm      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="1299750065" /><input type="hidden" name="id" value="strawman:classes_with_trait_composition" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:classes_with_trait_composition" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="strawman:classes_with_trait_composition" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="strawman:classes_with_trait_composition" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=strawman:classes_with_trait_composition&amp;rev=1299750065.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=strawman%253Aclasses_with_trait_composition&amp;1454275748" width="1" height="1" alt=""  /></body>
</html>
