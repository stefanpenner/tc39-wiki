<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>proposals:program_units [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=proposals:program_units&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=proposals" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=proposals:program_units&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=proposals:program_units&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2007-12-03T18:42:29+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=proposals:program_units&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">proposals:program_units</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="proposals:program_units" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="proposals:program_units" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:expression_closures.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:expression_closures">expression_closures</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:remove_the_arguments_object.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:remove_the_arguments_object">remove_the_arguments_object</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:resurrected_eval.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:resurrected_eval">resurrected_eval</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=proposals:arrays.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:arrays">arrays</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=proposals:program_units.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="proposals:program_units">program_units</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#program_units" class="toc">Program Units</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#design_goals_constraints" class="toc">Design Goals &amp; Constraints</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#syntax" class="toc">Syntax</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#semantics" class="toc">Semantics</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#requirements" class="toc">Requirements</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#interpretation" class="toc">Interpretation</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#interaction_with_type_system" class="toc">Interaction with type system</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#tbd" class="toc">TBD</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#discussion" class="toc">Discussion</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#rationale" class="toc">Rationale</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=proposals:program_units.html#implementation_notes" class="toc">Implementation notes</a></span></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<a name="program_units"></a><h1>Program Units</h1>
<div class="level1">

<p>
 A proposed pragma for managing compilation units.
</p>

</div>

<a name="design_goals_constraints"></a><h2>Design Goals &amp; Constraints</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Provide standard way of declaring dependencies between compilation units, to encourage a library ecosystem.</div>
</li>
<li class="level1"><div class="li"> Provide standard way of &ldquo;loading a file once&rdquo;, both to speed loading and permit unique &ldquo;one-time evaluation&rdquo; of programs within a host environment</div>
</li>
<li class="level1"><div class="li"> Permit bundling of multiple compilation units into a single source file, such as by pre-combining source files on a busy web server</div>
</li>
</ul>

</div>

<a name="syntax"></a><h2>Syntax</h2>
<div class="level2">

<p>
 The pragma has two forms: <strong>unresolved</strong> and <strong>resolved</strong>. 
</p>

<p>
An unresolved unit pragma looks like this:
</p>
<pre class="code">
use unit UnitName &quot;locator&quot;;
</pre>

<p>
A resolved unit pragma looks like this: 
</p>
<pre class="code">
unit UnitName { ... fragment* ... }
</pre>

<p>
Where a fragment can be either of: 
</p>
<ol>
<li class="level1"><div class="li"> A package block</div>
</li>
<li class="level1"><div class="li"> A directive (including, possibly, further unit pragmas)</div>
</li>
</ol>

</div>

<a name="semantics"></a><h2>Semantics</h2>
<div class="level2">

</div>

<a name="requirements"></a><h3>Requirements</h3>
<div class="level3">

<p>
 The proposal requires 3 additions to each execution context:
</p>
<ol>
<li class="level1"><div class="li"> A set of <strong>resolved unit names</strong> . This set is initially empty. </div>
</li>
<li class="level1"><div class="li"> A <strong>current top-level unit</strong> name. This is initially a sentinel or <code>null</code> value.</div>
</li>
<li class="level1"><div class="li"> A table or mapping from unit names to saved snapshots of the top-level lexical environment, called the <strong>saved top-ribs</strong> table. This table is initially empty.</div>
</li>
</ol>

</div>

<a name="interpretation"></a><h3>Interpretation</h3>
<div class="level3">

<p>
 Like all pragmas, <code>use unit</code> is interpreted during the definition phase. 
</p>

<p>
The semantics of an <strong>unresolved</strong> unit pragma is:
</p>
<ol>
<li class="level1"><div class="li"> If the <em>unit name</em> is present in the <strong>resolved unit names</strong> set, ignore the pragma.</div>
</li>
<li class="level1"><div class="li"> Attempt to open the <em>unit name</em> for input using implementation-specific interpretation of the <em>locator</em> (and the meaning of &ldquo;input&rdquo;). </div>
</li>
<li class="level1"><div class="li"> If the unit cannot be opened using <em>locator</em> fail with a definition error.</div>
</li>
<li class="level1"><div class="li"> Read the the referenced unit as text.</div>
</li>
<li class="level1"><div class="li"> Proceed as though interpreting a <strong>resolved</strong> unit pragma, with the same <em>unit name</em>, containing the text of the referenced unit between the resolved pragma&rsquo;s braces.</div>
</li>
</ol>

<p>
 The semantics of a <strong>resolved</strong> unit pragma is:
</p>
<ol>
<li class="level1"><div class="li"> If the <em>unit name</em> is present in the <strong>resolved unit names</strong> set, ignore the pragma.</div>
</li>
<li class="level1"><div class="li"> Add the <em>unit name</em> into the <strong>resolved unit names</strong> set.</div>
</li>
<li class="level1"><div class="li"> Save the current value of the <strong>current top-level unit</strong>.</div>
</li>
<li class="level1"><div class="li"> If the <strong>current top-level unit</strong> is <code>null</code>, set it to the <em>unit name</em>.</div>
</li>
<li class="level1"><div class="li"> Parse and define the text between the begin and end braces as a program fragment.</div>
</li>
<li class="level1"><div class="li"> Restore the <strong>current top-level unit</strong> to the saved value from step #3.</div>
</li>
<li class="level1"><div class="li"> Save a snapshot of the top level rib into the <strong>saved top-rib table</strong> under <em>unit name</em>.</div>
</li>
</ol>

</div>

<a name="interaction_with_type_system"></a><h3>Interaction with type system</h3>
<div class="level3">

<p>
 While the definition phase is defining a type term, the <strong>current top-level unit name</strong> is captured in the defined type term, along with the non-top-level ribs. Thus for each type term there is a <strong>captured top-level unit name</strong>, as well as a chain of captured non-top-level ribs.
</p>

<p>
While the verification phase is verifying a type term, type names are looked up in a type environment called the <strong>completed environment</strong> of the type. The <strong>completed environment</strong> of a type is formed by appending the captured non-top-level ribs of the type term to a term-specific top-level rib. The top-level rib used depends on the <strong>captured top-level unit name</strong>. If it is <code>null</code>, the top-level rib used in the <strong>completed environment</strong> is the &ldquo;current&rdquo; top-level rib present at the start of the verification phase. If the <strong>captured top-level unit name</strong> is not <code>null</code>, it is used as a key into the <strong>saved top-level ribs</strong> table to look up a top-level rib, and this saved rib is used instead.
</p>

<p>
If normalization of a type term fails to resolve a type name within a <strong>completed environment</strong> formed from a saved top-level rib, the normalization failure is treated as a verification error. Otherwise the normalization failure is considered a temporary failure due to types that may not presently be defined, but may become defined in the future, after further code is loaded.
</p>

<p>
The purpose of these rules is to give definite scope to forward references of type names in type terms, and permit the use of definite points in each unit at which unknown type names should be reported as verification errors. A mnemonic for the rules is: by the closing brace of a top-level unit, all the type names used inside it must be defined.
</p>

<p>
For type terms without captured top-level unit names, type name resolution failures are delayed (possibly indefinitely) until the latest possible moment of the type term&rsquo;s requirements for use, during evaluation.
</p>

</div>

<a name="tbd"></a><h3>TBD</h3>
<div class="level3">

<p>
 Reconcile any conflicts with <a href="doku.php%3Fid=clarification:multiple_compilation_units.html" class="wikilink1" title="clarification:multiple_compilation_units" onclick="return svchk()" onkeypress="return svchk()">multiple_compilation_units</a>.
</p>

<p>
Decide if &ldquo;open&rdquo; and &ldquo;read&rdquo; have sufficiently concrete meanings, and/or whether we need language about encoding rules or similar business.
</p>

<p>
The anonymous unit syntax <code>unit { ... }</code> may be sufficiently useful to support as well (for saying &ldquo;this chunk of code should verify without undefined type names&rdquo;).
</p>

</div>

<a name="discussion"></a><h2>Discussion</h2>
<div class="level2">

</div>

<a name="rationale"></a><h3>Rationale</h3>
<div class="level3">

<p>
 It may be valid for a pre-processor to transform a source file by replacing all unresolved units with resolved units, as described by these rules. The validity of this transformation depends on whether the pre-processor resolves locators to units the same way a later execution context does. Part of the rationale for this proposal rests in formulating and  encouraging a standard strategy for such pre-processors.
</p>

<p>
Earlier there was some thought that a unit name might imply the existence of a similarly-named package (perhaps a shortened version of a full unit path). This thinking unfortunately leads to an odd situation in which, upon resolving a unit, the definer is looking at such code:
</p>
<pre class="code">
unit Foo { 
 unit Foo { ... }
}
</pre>

<p>
The modifications to the proposal required to support this are more complex than necessary. Rather than support such situations, this proposal is simpler and more orthogonal: packages and units are formally unrelated. The <em>defining</em> unit places &ldquo;package Foo { ... }&rdquo; around its code, and the unit <em>using</em> the defining unit employs a unit pragma, resulting in code for the definer that looks like this:
</p>
<pre class="code">
unit Foo {
  package Foo {...}
  package Bar { ... }
  package AnythingElse { ... }
  ...
}
</pre>

</div>

<a name="implementation_notes"></a><h3>Implementation notes</h3>
<div class="level3">

<p>
 Implementations should support, but are not required to support, resolving locators that appear to be URLs.
</p>

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        proposals/program_units.txt &middot; Last modified: 2007/12/03 18:42 by graydon      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="proposals:program_units" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="proposals:program_units" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="proposals:program_units" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="proposals:program_units" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=proposals:program_units.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=proposals%253Aprogram_units&amp;1454275570" width="1" height="1" alt=""  /></body>
</html>
