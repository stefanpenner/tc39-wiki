<html>
<head>
  <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=proposals:name_objects&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=proposals" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=proposals:name_objects&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=proposals:name_objects&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="robots" content="noindex,nofollow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />
</head>
<body>

<a name="name_objects_and_others"></a><h1>Name objects (and others)</h1>
<div class="level1">

<p>
 (Also see the <a href="doku.php%3Fid=discussion:name_objects.html" class="wikilink1" title="discussion:name_objects" onclick="return svchk()" onkeypress="return svchk()">discussion page</a>.)
</p>

</div>
<!-- SECTION [1-102] -->
<a name="problem_statement"></a><h2>Problem Statement</h2>
<div class="level2">

<p>
 The <code>for-in</code> loop combined with namespace-qualified names means we need a <code>Name</code> class reflecting namespace-qualified identifiers of enumerable properties:
</p>
<pre class="code javascript">let o = <span class="br0">&#123;</span>x:<span class="nu0">1</span>, <span class="nu0">2</span>:<span class="st0">"two"</span>, <span class="st0">'@funny'</span>:<span class="nu0">3</span><span class="br0">&#125;</span>;
<span class="kw1">for</span> <span class="br0">&#40;</span>let i <span class="kw1">in</span> o<span class="br0">&#41;</span>
  <span class="kw3">print</span><span class="br0">&#40;</span>i, <span class="kw1">typeof</span> i<span class="br0">&#41;</span>;</pre>
<p>
Per ES1-3, and required for backward compatibility, this script should print
</p>
<pre class="code">
x string
2 string
@funny string
</pre>

<p>
Consider this code:
</p>
<pre class="code javascript"><span class="kw2">namespace</span> n;
let p = <span class="br0">&#123;</span>n::m: <span class="nu0">42</span><span class="br0">&#125;</span>;
<span class="kw1">for</span> <span class="br0">&#40;</span>let i <span class="kw1">in</span> p<span class="br0">&#41;</span>
  <span class="kw3">print</span><span class="br0">&#40;</span>i, <span class="kw1">typeof</span> i<span class="br0">&#41;</span>;</pre>
<p>
It would be impossible to index <code>p.n::m</code> by <code>p[i]</code> if <code>i</code> were <code>&ldquo;m&rdquo;</code> (if the output of this loop were <code>m string</code>). We need something like the <code>QName</code> class from E4X (ECMA-357). Jeff proposes we call it <code>Name</code>. It should have a conversion method such that you can write:
</p>
<pre class="code javascript"><span class="kw2">namespace</span> q;
let o = <span class="br0">&#123;</span>x:<span class="nu0">1</span>, <span class="nu0">2</span>:<span class="st0">"two"</span>, <span class="st0">'@funny'</span>:<span class="nu0">3</span>, q::m: <span class="nu0">42</span><span class="br0">&#125;</span>;
<span class="kw1">for</span> <span class="br0">&#40;</span>let n : <span class="kw3">Name</span> <span class="kw1">in</span> o<span class="br0">&#41;</span>
  <span class="kw3">print</span><span class="br0">&#40;</span>n, <span class="kw1">typeof</span> n<span class="br0">&#41;</span>;</pre>
<p>
This script should print:
</p>
<pre class="code">
x object
2 object
@funny object
q::m object
</pre>

</div>
<!-- SECTION [103-1146] -->
<a name="proposed_solution"></a><h2>Proposed Solution</h2>
<div class="level2">

<p>
 The Name class is defined as follows:
</p>
<pre class="code javascript">intrinsic final <span class="kw2">class</span> <span class="kw3">Name</span> <span class="kw2">extends</span> String <span class="br0">&#123;</span>
  type NS = <span class="br0">&#40;</span><span class="kw3">Name</span>, <span class="kw2">Namespace</span>, string<span class="br0">&#41;</span>;
  type ID = <span class="br0">&#40;</span>undefined, string<span class="br0">&#41;</span>;
&nbsp;
  <span class="kw2">function</span> <span class="kw3">Name</span><span class="br0">&#40;</span>ns : NS, id : ID = undefined<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span>id <span class="kw1">is</span> undefined<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw1">if</span> <span class="br0">&#40;</span>ns <span class="kw1">is</span> <span class="kw3">Name</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        let n : <span class="kw3">Name</span> = ns;
        identifier = n.<span class="me1">identifier</span>;
        qualifier = n.<span class="me1">qualifier</span>;
      <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
        identifier = ns;
      <span class="br0">&#125;</span>
    <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span>
      qualifier = ns;
      identifier = id;
    <span class="br0">&#125;</span>
  <span class="br0">&#125;</span>
&nbsp;
  meta static <span class="kw2">function</span> invoke<span class="br0">&#40;</span>ns : NS, id : ID = undefined<span class="br0">&#41;</span> : <span class="kw3">Name</span>
    <span class="kw2">new</span> <span class="kw3">Name</span><span class="br0">&#40;</span>ns, id<span class="br0">&#41;</span>;
&nbsp;
  meta static <span class="kw2">function</span> convert<span class="br0">&#40;</span>v : <span class="br0">&#40;</span><span class="kw2">Namespace</span>, string<span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="kw2">new</span> <span class="kw3">Name</span><span class="br0">&#40;</span>v<span class="br0">&#41;</span>;
&nbsp;
  prototype <span class="kw2">function</span> toString<span class="br0">&#40;</span><span class="kw1">this</span> : <span class="kw3">Name</span><span class="br0">&#41;</span>
    <span class="kw1">this</span>.<span class="me1">intrinsic</span>::toString<span class="br0">&#40;</span><span class="br0">&#41;</span>;
&nbsp;
  intrinsic override <span class="kw2">function</span> toString<span class="br0">&#40;</span><span class="br0">&#41;</span> : string <span class="br0">&#123;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span>qualifier === <span class="kw2">null</span><span class="br0">&#41;</span>
      <span class="kw1">return</span> identifier;
    <span class="kw1">return</span> qualifier + <span class="st0">"::"</span> + identifier;
  <span class="br0">&#125;</span>
&nbsp;
  prototype <span class="kw2">function</span> valueOf<span class="br0">&#40;</span><span class="kw1">this</span> : <span class="kw3">Name</span><span class="br0">&#41;</span>
    <span class="kw1">this</span>.<span class="me1">intrinsic</span>::valueOf<span class="br0">&#40;</span><span class="br0">&#41;</span>;
&nbsp;
  intrinsic override <span class="kw2">function</span> valueOf<span class="br0">&#40;</span><span class="br0">&#41;</span> : string
    intrinsic::toString<span class="br0">&#40;</span><span class="br0">&#41;</span>;
&nbsp;
  <span class="kw2">public</span> <span class="kw2">const</span> qualifier  : <span class="kw2">Namespace</span>,
               identifier : string;
<span class="br0">&#125;</span></pre>
<p>
Note that <code>class Name</code> is <code>final</code> to allow optimization including inlining of construction, conversion (<code>meta::from</code>), and <code>toString</code>.
</p>

<p>
An <a href="doku.php%3Fid=proposals:iterators_and_generators.html#enumeration" class="wikilink1" title="proposals:iterators_and_generators" onclick="return svchk()" onkeypress="return svchk()">enumerating</a> <code>for-in</code> loop or comprehension must reflect an enumerable property name as a <code>Name</code> instance if the property was defined with an explicit or default namespace. Otherwise, with no namespace, an enumerating <code>for-in</code> reflects the name as a <code>string</code> per ES1-3 and existing <acronym title="JavaScript">JS</acronym> implementations.
</p>

<p>
A property access of the form <code>o[n]</code> where <code>n</code> is of type <code>Name</code> looks for a binding in the namespace <code>n.qualifier</code> if non-null or in no namespace if null, whose unqualified name is <code>n.identifier</code>. This implies that for any object <code>obj</code>:
</p>
<pre class="code javascript"><span class="st0">'foo'</span> <span class="kw1">in</span> obj === <span class="kw3">Name</span><span class="br0">&#40;</span><span class="st0">'foo'</span><span class="br0">&#41;</span> <span class="kw1">in</span> obj</pre>
<p>
As with E4X&rsquo;s <code>QName</code>, <code>Name</code> can be called with one parameter to create an instance with a null <code>qualifier</code>, or with two parameters where the first initializes <code>qualifier</code> and the second initializes <code>identifier</code>. When called with one parameter that is a <code>Name</code>, the constructor clones its argument.
</p>

<p>
<code>Name</code> derives from <code>String</code> so that existing <code>for-in</code> loops that call <code>String.prototype</code> methods on the enumerated identifier continue to work. Therefore it must override <code>toString</code> and <code>valueOf</code>, which are not generic.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/03/01 12:53</em>
</p>

</div>
<!-- SECTION [1147-3717] -->
<a name="namespace_sets_namespace_set_lists_security"></a><h2>Namespace sets, namespace set lists, security</h2>
<div class="level2">

<p>
 Discussion on 2007-09-26 revealed a number of interesting things.  <a href="http://bugs.ecmascript.org/ticket/90" class="urlextern" target="_blank" title="http://bugs.ecmascript.org/ticket/90" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Ticket #90</a> is useful background material here.
</p>

<p>
Consider the following snippet:
</p>
<pre class="code">
    let t = {}
    t.private::x = 37
    for (let n in t)
        if (n is Name &amp;&amp; n.identifier == &quot;x&quot;)
            private_ns = n.qualifier
</pre>

<p>
What the snippet reveals is that it&rsquo;s possible to obtain one&rsquo;s private, protected, and internal namespace (because expandos are not <code>DontEnum</code> and there&rsquo;s no restriction on using namespaces when setting them, unlike in AS3 &ndash; and the AS people generally consider the AS behavior an oversimplification).
</p>

<p>
Ergo system-internal supposedly-private namespaces can&rsquo;t be hidden.  Ergo the security problem outlined in ticket #90 is real.
</p>

<p>
After some discussion it became clear that the real bug is that enumeration, or generally iteration, does not respect the set of open or accessible namespaces, thus enumeration subverts the idea of namespaces-as-keys.
</p>

<p>
The real fix for this, as the reflection proposal has also discovered, is to make <a href="doku.php%3Fid=proposals:iterators_and_generators.html" class="wikilink1" title="proposals:iterators_and_generators" onclick="return svchk()" onkeypress="return svchk()">enumeration and iteration</a> respect a namespace set.  If this set can be constructed it can be leaked, but the leaking is less accidental than leaking through enumeration.
</p>

<p>
Thus we propose the following: 
</p>
<ol>
<li class="level1"><div class="li"> Iterators/enumerators take an optional argument which is an instance of <code>NamespaceSetList</code>, defined below.</div>
</li>
<li class="level1"><div class="li"> By default this argument is null, which means &ldquo;only the public (nons) namespace&rdquo;</div>
</li>
<li class="level1"><div class="li"> The for-in syntax supplies a value which is the result of the special form <code>namespaces</code> (see below)</div>
</li>
<li class="level1"><div class="li"> The types <code>NamespaceSet</code> and <code>NamespaceSetList</code> are available to construct new sets, and new lists of sets, and to extend lists of sets.  Instances of these types are immutable.</div>
</li>
<li class="level1"><div class="li"> The special form <code>namespaces</code> results in a <code>NamespaceSetList</code> which contains the ordered list of sets of lexically open namespaces</div>
</li>
<li class="level1"><div class="li"> The special form <code>namespace N</code>, where <code>n</code> is some reserved namespace name (public, private, protected, internal), returns a standard <code>Namespace</code> object for that reserved namespace name.</div>
</li>
</ol>

<p>
  &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/09/26 21:50</em> 
</p>

</div>
<!-- SECTION [3718-] -->
<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/4/4f392c64e29860dc83474a9ea7aaf502.xhtml used -->
</body>
</html>
