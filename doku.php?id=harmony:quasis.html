<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>harmony:quasis [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=harmony:quasis&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="http://wiki.ecmascript.org/feed.php?mode=list&amp;ns=harmony" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=harmony:quasis&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=harmony:quasis&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2013-07-11T23:58:25+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=harmony:quasis&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">harmony:quasis</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="harmony:quasis" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="harmony:quasis" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=harmony:object_literals.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="harmony:object_literals">object_literals</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:maximally_minimal_classes.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:maximally_minimal_classes">maximally_minimal_classes</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=harmony:classes.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="harmony:classes">classes</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=harmony:private_name_objects.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="harmony:private_name_objects">private_name_objects</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=harmony:quasis.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="harmony:quasis">quasis</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#ecmascript_quasi-literals" class="toc">EcmaScript Quasi-Literals</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#motivation" class="toc">Motivation</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#overview" class="toc">Overview</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#syntax" class="toc">Syntax</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#semantics" class="toc">Semantics</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#use_cases" class="toc">Use Cases</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#secure_content_generation" class="toc">Secure Content Generation</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#text_l10n" class="toc">Text L10N</a></span><ul class="toc">
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#message_extraction" class="toc">Message Extraction</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#message_meta-data" class="toc">Message Meta-data</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#substitution_meta-data" class="toc">Substitution Meta-data</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#message_replacement_and_substitution_re-ordering" class="toc">Message replacement and substitution re-ordering</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#specifying_a_locale" class="toc">Specifying a locale</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#security" class="toc">Security</a></span></li>
</ul>
</li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#query_languages" class="toc">Query Languages</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#message_sends" class="toc">Message Sends</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#flexible_literal_syntax" class="toc">Flexible Literal Syntax</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#raw_strings" class="toc">Raw Strings</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#decomposition_patterns" class="toc">Decomposition Patterns</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#logging" class="toc">Logging</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#syntax_normative" class="toc">Syntax (normative)</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#literal_portion_syntax" class="toc">Literal Portion Syntax</a></span><ul class="toc">
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#quasiliteral" class="toc">QuasiLiteral ::</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#literalportion" class="toc">LiteralPortion ::</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#literalcharacter" class="toc">LiteralCharacter ::</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" class="toc">QuasiLiteralTail ::</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#substitution" class="toc">Substitution ::</a></span></li>
</ul>
</li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#literal_portion_array" class="toc">Literal Portion Array</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#quasitag" class="toc">QuasiTag</a></span><ul class="toc">
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#quasitag" class="toc">QuasiTag ::</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#qt" class="toc">QT</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#default_quasi_tag" class="toc">Default Quasi Tag</a></span></li>
</ul>
</li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#substitution_body_syntax" class="toc">Substitution Body Syntax</a></span><ul class="toc">
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#identifierpathtail" class="toc">//IdentifierPathTail// ::</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#substitutionbody" class="toc">//SubstitutionBody// ::</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#substitutionmodifier" class="toc">//SubstitutionModifier// ::</a></span></li>
<li class="level4"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#sve" class="toc">SVE</a></span></li>
</ul>
</li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#tokenizing" class="toc">Tokenizing</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#semantics_normative" class="toc">Semantics (normative)</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#callsiteid" class="toc">CallSiteId</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#desugaring" class="toc">Desugaring</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#security_considerations" class="toc">Security Considerations</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#defensive_code" class="toc">Defensive Code</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#offensive_code" class="toc">Offensive Code</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#possible_problems" class="toc">Possible Problems</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#reasons_and_open_issues" class="toc">Reasons and Open Issues</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#quoting_character" class="toc">Quoting Character</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#nesting" class="toc">Nesting</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#substitutions" class="toc">Substitutions</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#raw_escapes_in_literal_sections" class="toc">Raw Escapes in Literal Sections</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#line_continuation_and_line_terminators" class="toc">Line Continuation and Line Terminators</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#references" class="toc">References</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#quasis_in_e" class="toc">Quasis in E</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#secure_string_interp" class="toc">Secure String Interp</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#php_string_vars" class="toc">PHP String Vars</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#plt_scheme_scribble" class="toc">PLT Scheme Scribble</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#sml_of_new_jersey" class="toc">SML of New Jersey</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#secure_code_generation" class="toc">Secure Code Generation</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#scheme_hygienic_macros" class="toc">Scheme Hygienic Macros</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#paradigm_regained" class="toc">Paradigm Regained</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=harmony:quasis.html#safe_templates" class="toc">Safe Templates</a></span></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<p>
<strong>This proposal has progressed to the Draft ECMAScript 6 Specification, which is available for review here: <a href="doku.php%3Fid=harmony:specification_drafts.html" class="wikilink1" title="harmony:specification_drafts" onclick="return svchk()" onkeypress="return svchk()">specification_drafts</a>. Any new issues relating to them should be filed as bugs at <a href="http://bugs.ecmascript.org" class="urlextern" target="_blank" title="http://bugs.ecmascript.org" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">http://bugs.ecmascript.org</a>. The content on this page is for historic record only and may no longer reflect the current state of the feature described within.</strong>
</p>

<a name="ecmascript_quasi-literals"></a><h1>EcmaScript Quasi-Literals</h1>
<div class="level1">

</div>

<a name="motivation"></a><h2>Motivation</h2>
<div class="level2">

<p>
 EcmaScript is frequently used as a glue language for dealing with content specified in other languages : <acronym title="HyperText Markup Language">HTML</acronym>, <acronym title="Cascading Style Sheets">CSS</acronym>, JSON, <acronym title="Extensible Markup Language">XML</acronym>, etc. Libraries have implemented query languages and content generation schemes for most of these : <acronym title="Cascading Style Sheets">CSS</acronym> selectors, XPath, various templating schemes.  These tend to suffer from interpretation overhead, or from injection vulnerabilities, or both.
</p>

<p>
This scheme extends EcmaScript syntax with syntactic sugar to allow libraries to provide DSLs that easily produce, query, and manipulate content from other languages that are immune or resistant to injection attacks such as XSS, <acronym title="Structured Query Language">SQL</acronym> Injection, etc.
</p>

<p>
This scheme aims to preserve ES5 strict mode&rsquo;s static analyzability while allowing details of the DSL implementation to be dynamic.
</p>

<p>
Try out the <a href="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/index.html" class="urlextern" target="_blank" title="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/index.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">quasi-literal demo testbed</a>.
</p>

</div>

<a name="overview"></a><h2>Overview</h2>
<div class="level2">

</div>

<a name="syntax"></a><h3>Syntax</h3>
<div class="level3">
<pre class="code">x`foo${bar}baz`</pre>

<p>
Syntactically, a quasi-literal is a <strong>function name</strong> (<code>x</code>) followed by zero or more characters enclosed in back quotes. The contents of the back quotes are grouped into <strong>literal sections</strong> (<code>foo</code> and <code>baz</code>) and <strong>substitutions</strong> (<code>bar</code>).
</p>

<p>
A substitution is an unescaped substitution start character (<code>$</code>) followed by either a valid <em>Identifier</em> or a curly bracket block. E.g., <code>$foo</code> or <code>${foo + bar}</code>.
</p>

<p>
The literal sections are the runs of characters not contained in substitutions.  They may be blank so the number of literal sections is always one greater than the number of substitutions.
</p>

</div>

<a name="semantics"></a><h3>Semantics</h3>
<div class="level3">

<p>
 The semantics of quasi-literals are specified in terms of a desugaring which has the property that the free variables of the desugaring are the same as the union of the free variables of the substitutions and the function name.
</p>

</div>

<a name="use_cases"></a><h2>Use Cases</h2>
<div class="level2">

<p>
 This syntactic sugar will let library developers experiment with a wide range of language features.
</p>

<p>
Quasi-literals desugar a back quoted string to a function call that operates on the literal portions and substitution results.
</p>

<p>
E.g. <code>quasiHandlerName`quasiLiteralPart1 ${quasiSubstitution} quasiLiteralPart2`</code> desugars to something like
</p>
<pre class="code">
// hoisted declaration.
const callSiteId1234 = {
    raw: ['quasiLiteralPart1 ', ' quasiLiteralPart2'],
    cooked: ['quasiLiteralPart1 ', ' quasiLiteralPart2']
};

// in-situ
quasiHandlerName(callSiteId1234, quasiSubstitution)
</pre>

<p>
The hoisted declaration at the top records the literal portions both before and after each <em>EscapeSequence</em> has been decoded and can be used as a key into a WeakMap. The in-situ function call applies the quasi handler to produce the result and receives the call site ID and the values of substiution.s
</p>

<p>
See the <a href="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/index.html" class="urlextern" target="_blank" title="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/index.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">demo REPL</a> for some runnable examples.  Especially the drop-down at the top-right.
</p>

</div>

<a name="secure_content_generation"></a><h3>Secure Content Generation</h3>
<div class="level3">
<pre class="code">safehtml`&lt;a href=&quot;${url}?q=${query}&quot; onclick=alert(${message}) style=&quot;color: ${color}&quot;&gt;${message}&lt;/a&gt;`</pre>

<p>
uses <a href="doku.php%3Fid=harmony:quasis.html#safe_templates" title="harmony:quasis &crarr;" class="wikilink1">contextual auto-escaping</a> to figure out that <code>url</code> and <code>color</code> should be filtered, <code>query</code> should be percent-encoded, and <code>message</code> <acronym title="HyperText Markup Language">HTML</acronym> entity encoded to prevent XSS.
</p>

<p>
The syntax provides a clear distinction between trusted content such as <code>&lt;a href=&rdquo;</code> and substituted values that might be controlled by an attacker such as <code>url</code>.  This prevents the problem that arise in other languages when <a href="http://en.wikipedia.org/wiki/Uncontrolled_format_string" class="urlextern" target="_blank" title="http://en.wikipedia.org/wiki/Uncontrolled_format_string" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">format strings</a> can be controlled by an attacker.  Although EcmaScript&rsquo;s memory abstractions are not vulnerable, it is very vulnerable to quoting confusion attacks and developers have trouble distinguishing content from an untrusted format string from that produced from a trusted one.
</p>

<p>
E.g. 
</p>
<pre class="code">
url = &quot;http://example.com/&quot;,
message = query = &quot;Hello &amp; Goodbye&quot;,
color = &quot;red&quot;,
safehtml`&lt;a href=&quot;${url}?q=${query}&quot; onclick=alert(${message}) style=&quot;color: ${color}&quot;&gt;${message}&lt;/a&gt;`
</pre>

<p>
 produces 
</p>
<pre class="code">
&lt;a href=&quot;http://example.com/?q=Hello%20%26%20Goodbye&quot;
 onclick=alert(&amp;#39;Hello&amp;#32;\x26&amp;#32;Goodbye&amp;#39;) style=&quot;color: red&quot;&gt;Hello &amp;amp; Goodbye&lt;/a&gt;
</pre>

<p>
 but values are filtered so that if instead 
</p>
<pre class="code">
url = &quot;javascript:alert(1337)&quot;
color = &quot;expression(alert(1337))&quot;
</pre>

<p>
 then the substitution holes are filled with innocuous values instead to produce: 
</p>
<pre class="code">
&lt;a href=&quot;#innocuous?q=Hello%20%26%20Goodbye&quot;
 onclick=alert(&amp;#39;Hello&amp;#32;\x26&amp;#32;Goodbye&amp;#39;) style=&quot;color: innocuous&quot;&gt;Hello &amp;amp; Goodbye&lt;/a&gt;
</pre>

<p>
Similar schemes can work for securely composing URLs, JSON and <acronym title="Extensible Markup Language">XML</acronym> data bundles, and for allowing composable <acronym title="Structured Query Language">SQL</acronym> prepared statements.
</p>

</div>

<a name="text_l10n"></a><h3>Text L10N</h3>
<div class="level3">
<pre class="code">msg`Welcome to ${siteName}, you are visitor number ${visitorNumber}!`</pre>

<p>
where <code>visitorNumber</code> should be formatted using locale-specific conventions, e.g. &ldquo;1,000,000&rdquo; in some parts of the world, and &ldquo;1.000.000&rdquo; in some others.
</p>

</div>

<a name="message_extraction"></a><h4>Message Extraction</h4>
<div class="level4">

<p>
Since there is a convenient simple format for human-readable messages, a static analyzer can easily find them (to substitute locale-specific versions) than if messages were simply the first argument to a function call.
</p>

<p>
For example, a static analyzer could find uses of <code>msg`...`</code> in source files to produce a message bundle like 
</p>
<pre class="code xml"><span class="sc3"><span class="re1">&lt;messagebundle<span class="re2">&gt;</span></span>
  <span class="sc3"><span class="re1">&lt;message</span> <span class="re0">id</span>=<span class="st0">"..."</span><span class="re2">&gt;</span>Welcome to {0}, you are visitor number {1}!<span class="sc3"><span class="re1">&lt;/message<span class="re2">&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/messagebundle<span class="re2">&gt;</span></span></pre>
<p>
Translators can then produce a message bundle with the translations.
</p>

</div>

<a name="message_meta-data"></a><h4>Message Meta-data</h4>
<div class="level4">

<p>
Translators often need some context to help them translate human readable message strings.
</p>

<p>
Meta-data can be attached to comments the way <a href="http://code.google.com/closure/compiler/docs/js-for-compiler.html#tags" class="urlextern" target="_blank" title="http://code.google.com/closure/compiler/docs/js-for-compiler.html#tags" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">other systems</a> put type declarations and structured documentation in comments.
</p>
<pre class="code javascript"><span class="coMULTI">/**
 * @description Label text for a button that opens a window.
 */</span>
myButton.<span class="me1">innerText</span> = msg`<span class="kw3">Open</span>`;</pre>
<p>
but if the English word &ldquo;Open&rdquo; is used in two different forms (adjectival vs imperative), it may need to have two translations, so some L10N approaches would benefit from having disambiguation meta-data available at runtime.
</p>

<p>
There are two common ways of disambiguating:
</p>
<ol>
<li class="level1"><div class="li"> Associating the message with an identifier which is used as a message ID : <code>#MSG_OPEN_BUTTON_TEXT { msg`Open` }</code></div>
</li>
<li class="level1"><div class="li"> Adding &ldquo;meaning&rdquo; meta-data to the message.  <code>myButton.innerText = msg`Open ; meaning=&rdquo;Button text&rdquo;`;</code></div>
</li>
</ol>

<p>
 The latter convention makes the meta-data available not just to static analyzers, but also at runtime.
</p>

</div>

<a name="substitution_meta-data"></a><h4>Substitution Meta-data</h4>
<div class="level4">

<p>
Meta-data can also be associated with substitutions in the same way.
</p>
<pre class="code javascript"><span class="coMULTI">/**
 * @param siteName The name of the site.  @example foo.ru
 * @param visitorNumber an integer. @example 1000000
 */</span>
<span class="kw2">var</span> message = msg`Welcome to $<span class="br0">&#123;</span>siteName<span class="br0">&#125;</span>, you are visitor number $<span class="br0">&#123;</span>visitorNumber<span class="br0">&#125;</span>:d!`;</pre>
<p>
The description of <code>siteName</code> and the <code>@example</code> meta-data can extracted along with the message and made available to translators but is not needed at runtime.
</p>

<p>
The <code>:d</code> meta-data is available at runtime to specify that the number should be presented as an integer.  Never in scientific notation no matter how many billions of visitors foo.com receives.
</p>

</div>

<a name="message_replacement_and_substitution_re-ordering"></a><h4>Message replacement and substitution re-ordering</h4>
<div class="level4">

<p>
Once translators have delivered their translations, there are a number of ways to incorporate those.
</p>

<p>
If the locale is known statically, then <code>msg`...`</code> elements can be <strong>fully rewritten</strong> 
</p>
<pre class="code javascript"><span class="co1">// Before</span>
<span class="kw3">alert</span><span class="br0">&#40;</span>msg`Hello, $<span class="br0">&#123;</span>world<span class="br0">&#125;</span>!`<span class="br0">&#41;</span>;
&nbsp;
<span class="co1">// After</span>
<span class="kw3">alert</span><span class="br0">&#40;</span>msg`Bonjour $<span class="br0">&#123;</span>world<span class="br0">&#125;</span>!`<span class="br0">&#41;</span>;</pre>
<p>
If the locale is not known statically, then a source code rewriter can <strong>partially rewrite</strong> the message to a lookup into a side-table by message id.
</p>
<pre class="code javascript"><span class="co1">// Before</span>
<span class="kw3">alert</span><span class="br0">&#40;</span>msg`Hello, $<span class="br0">&#123;</span>world<span class="br0">&#125;</span>!`<span class="br0">&#41;</span>;
&nbsp;
<span class="co1">// After</span>
<span class="kw2">var</span> messageBundle_fr = <span class="br0">&#123;</span>
  MSG_<span class="nu0">1234</span>: <span class="br0">&#91;</span><span class="st0">'Bonjour '</span>, <span class="nu0">0</span> <span class="coMULTI">/* An index into substitutions */</span>, <span class="st0">'!'</span><span class="br0">&#93;</span>
<span class="br0">&#125;</span>;
&nbsp;
<span class="kw3">alert</span><span class="br0">&#40;</span>getMessage<span class="br0">&#40;</span><span class="st0">'MSG_1234'</span>, <span class="br0">&#91;</span>world<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;</pre>
<p>
The most natural order in which elements of a thought are expressed may differ between languages.  <code>msg`Welcome to ${siteName}, you are visitor number ${visitorNumber}:d!`</code> might be translated into pig-latin as <code>msg`Elcome-way isitor-vay umber-nay ${visitorNumber}:d to ${siteName}!`</code>.
</p>

<p>
The index in the mesage bundle side-table above serve to identify the index of the substitution that fills that hole.  For the pig-latin message above, the side-table would look like
</p>
<pre class="code javascript"><span class="kw2">var</span> messageBundle_piglatin = <span class="br0">&#123;</span>
  MSG_<span class="nu0">5678</span>: <span class="br0">&#91;</span><span class="st0">'Elcome-way isitor-vay umber-nay '</span>, <span class="nu0">1</span>, <span class="st0">' oo-tay '</span>, <span class="nu0">0</span>, <span class="st0">'!'</span><span class="br0">&#93;</span>
<span class="br0">&#125;</span>;</pre>
<p>
Small projects that are not willing to introduce a source-code rewriting step just to get translation can do <strong>purely dynamic</strong> message replacement.
</p>
<pre class="code javascript"><span class="co1">// Before</span>
<span class="kw3">alert</span><span class="br0">&#40;</span>msg`Hello, $<span class="br0">&#123;</span>world<span class="br0">&#125;</span>!`<span class="br0">&#41;</span>;
&nbsp;
<span class="co1">// After</span>
<span class="kw2">var</span> messageBundle_fr = <span class="br0">&#123;</span>  <span class="co1">// Maps message text and disambiguation meta-data to replacement.</span>
  <span class="st0">'Hello, {0}!'</span>: <span class="st0">'Bonjour {0}!'</span>
<span class="br0">&#125;</span>;
&nbsp;
<span class="kw3">alert</span><span class="br0">&#40;</span>msg`Hello, $<span class="br0">&#123;</span>world<span class="br0">&#125;</span>!`<span class="br0">&#41;</span>;</pre>
<p>
where <code>msg</code> checks the side-table:
</p>
<pre class="code javascript"><span class="kw2">function</span> msg<span class="br0">&#40;</span>parts<span class="br0">&#41;</span> <span class="br0">&#123;</span>
  <span class="kw2">var</span> key = ...;  <span class="co1">// 'Hello, {0}!' given ['Hello, ', world, '!']</span>
&nbsp;
  <span class="kw2">var</span> translation = myMessageBundle<span class="br0">&#91;</span>key<span class="br0">&#93;</span>;
&nbsp;
  <span class="kw1">return</span> <span class="br0">&#40;</span>translation || key<span class="br0">&#41;</span>.<span class="me1">replace</span><span class="br0">&#40;</span><span class="re0">/\<span class="br0">&#123;</span><span class="br0">&#40;</span>\d+<span class="br0">&#41;</span>\<span class="br0">&#125;</span>/g</span>, <span class="kw2">function</span> <span class="br0">&#40;</span>_, index<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="co1">// not shown: proper formatting of substitutions</span>
      <span class="kw1">return</span> parts<span class="br0">&#91;</span><span class="br0">&#40;</span>index &lt;&lt; <span class="nu0">1</span><span class="br0">&#41;</span> | <span class="nu0">1</span><span class="br0">&#93;</span>;
    <span class="br0">&#125;</span><span class="br0">&#41;</span>;
<span class="br0">&#125;</span></pre>
</div>

<a name="specifying_a_locale"></a><h4>Specifying a locale</h4>
<div class="level4">

<p>
EcmaScript applications running in the browser typically deal with only one user, hence operate in only one locale.  But EcmaScript on the server does not, and there are exceptions in browser-based EcmaScript apps.
</p>

<p>
It is possible to specify a locale for a scope so that a particular message bundle is used for message replacement, and so that locale is used for formatting numbers and dates.
</p>
<pre class="code">
let lmsg = msg.withLocale(messageRecipientLocale);
sendRecommendation(msg`Your friend ${friendName} thinks you would like to read &quot;${articleTitle}&quot;.`);
</pre>

</div>

<a name="security"></a><h4>Security</h4>
<div class="level4">

<p>
Generating human readable strings often requires combining data from other users to produce human readable strings of <acronym title="HyperText Markup Language">HTML</acronym>.  As such, it is a prime vector for XSS attacks.
</p>

<p>
It is possible to compose the L10N use case described in this with the <a href="doku.php%3Fid=harmony:quasis.html#secure_content_generation" title="harmony:quasis &crarr;" class="wikilink1">secure content generation scheme</a> so there is no need to choose between localizability and security.
</p>
<pre class="code javascript"><span class="kw2">function</span> msg<span class="br0">&#40;</span>callSiteId <span class="coMULTI">/* ...substitution values */</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
  <span class="kw2">var</span> metaData = extractMetaDataFromLiteralParts<span class="br0">&#40;</span>callSiteId.<span class="me1">raw</span><span class="br0">&#41;</span>;
  replaceLiteralPartsWithLocaleSpecificLiteralParts<span class="br0">&#40;</span>metadata<span class="br0">&#41;</span>;
  reorderAndFormatSubstitutions<span class="br0">&#40;</span>arguments, metaData<span class="br0">&#41;</span>;
  <span class="kw1">return</span> interleaveAndJoin<span class="br0">&#40;</span>metadata.<span class="me1">literalPortions</span>, arguments<span class="br0">&#41;</span>;
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">function</span> safehtml<span class="br0">&#40;</span>callSiteId <span class="coMULTI">/* ...substitution values */</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
  <span class="kw2">var</span> sanitizers = chooseEscapingFunctionsBasedOnLiteralParts<span class="br0">&#40;</span>callSiteId.<span class="me1">raw</span><span class="br0">&#41;</span>;
  applySanitizersToSubstitutions<span class="br0">&#40;</span>sanitizers, arguments<span class="br0">&#41;</span>;
  <span class="kw1">return</span> interleaveAndJoin<span class="br0">&#40;</span>metadata.<span class="me1">literalPortions</span>, arguments<span class="br0">&#41;</span>;
<span class="br0">&#125;</span>
&nbsp;
<span class="co1">// The composition</span>
<span class="kw2">function</span> safehtml_msg<span class="br0">&#40;</span>parts<span class="br0">&#41;</span> <span class="br0">&#123;</span>
  <span class="kw2">var</span> metaData = extractMetaDataFromLiteralParts<span class="br0">&#40;</span>callSiteId.<span class="me1">raw</span><span class="br0">&#41;</span>;
  replaceLiteralPartsWithLocaleSpecificLiteralParts<span class="br0">&#40;</span>metaData<span class="br0">&#41;</span>;
  reorderAndFormatSubstitutions<span class="br0">&#40;</span>arguments, metaData<span class="br0">&#41;</span>;
  <span class="kw2">var</span> sanitizers = chooseEscapingFunctionsBasedOnLiteralParts<span class="br0">&#40;</span>metadata.<span class="me1">literalPortions</span><span class="br0">&#41;</span>;
  applySanitizersToSubstitutions<span class="br0">&#40;</span>sanitizers, arguments<span class="br0">&#41;</span>;
  <span class="kw1">return</span> interleaveAndJoin<span class="br0">&#40;</span>metadata.<span class="me1">literalPortions</span>, arguments<span class="br0">&#41;</span>;
<span class="br0">&#125;</span></pre>
</div>

<a name="query_languages"></a><h3>Query Languages</h3>
<div class="level3">
<pre class="code">$`a.${className}[href=~'//${domain}/']`</pre>

<p>
might specify a <acronym title="Document Object Model">DOM</acronym> query for all <code>&lt;a&gt;</code> elements with the given class name and that link to URLs with the given domain.
</p>

<p>
The <code>className</code> and <code>domain</code> do not need to be encoded then decoded by a query-engine so mis-encodings can be eliminated as a class of bugs and source of inefficiency.
</p>

</div>

<a name="message_sends"></a><h3>Message Sends</h3>
<div class="level3">

<p>
Message sends can be specified using a syntax that looks like an <acronym title="Hyper Text Transfer Protocol">HTTP</acronym> request.
</p>
<pre class="code">
GET`http://example.org/service?a=${a}&amp;b=${b}
    Content-Type: application/json
    X-Credentials: ${credentials}

    { &quot;foo&quot;: ${foo}, &quot;bar&quot;: ${bar} }`(myOnReadyStateChangeHandler);
</pre>

<p>
might configure an <code>XMLHttpRequest</code> object to the specified (securely composed) <acronym title="Uniform Resource Locator">URL</acronym> with the given (securely composed) headers, and after the end of the headers could switch to context-sensitive composition based on the content-type header : JSON in this case, or an <acronym title="Extensible Markup Language">XML</acronym> message in another case.
</p>

</div>

<a name="flexible_literal_syntax"></a><h3>Flexible Literal Syntax</h3>
<div class="level3">

<p>
Often, developers use the <code>new RegExp(...)</code> constructor because they want a tiny part of their regular expression to be dynamic, and fail to properly escape character classes such as <code>&ldquo;\s&rdquo;</code>, and regular expression special characters such as <code>.</code>.
</p>

<p>
A quasi syntax for regular expression construction
</p>
<pre class="code">
re`\d+(${localeSpecificDecimalPoint}\d+)?`
</pre>

<p>
gets the benefit of the literal syntax with dynamism where needed.
</p>

</div>

<a name="raw_strings"></a><h3>Raw Strings</h3>
<div class="level3">

<p>
Python raw strings are trivial since quasi handler functions receive the raw text of literal portions.
</p>
<pre class="code">
raw`In JavaScript '\n' is a line-feed.`
</pre>

</div>

<a name="decomposition_patterns"></a><h3>Decomposition Patterns</h3>
<div class="level3">

<p>
If the alternative quasis-substitutions-slot desugaring is used (see <em><a href="doku.php%3Fid=harmony:quasis.html#substitutionbody" title="harmony:quasis &crarr;" class="wikilink1">SubstitutionBody</a></em>) then a pattern decomposition handler <code>re_match</code> invoked thus
</p>
<pre class="code">
if (re_match`foo (${=x}\d+) bar`(myString)) {
  ...
}
</pre>

<p>
could use assignable substitutions to achieve the same effect as
</p>
<pre class="code">
{
  let match = myString.match(/foo (\d+) bar/);
  if (match) {
    x = match[1];
    ...
  }
}
</pre>

</div>

<a name="logging"></a><h3>Logging</h3>
<div class="level3">
<pre class="code">
warn`Bad result $result from $source`
</pre>

<p>
can provide  <code>console.log(&rdquo;o=%s&rdquo;, o)</code> style logging of structured data without the need for positional parameters.
</p>

</div>

<a name="syntax_normative"></a><h2>Syntax (normative)</h2>
<div class="level2">

</div>

<a name="literal_portion_syntax"></a><h3>Literal Portion Syntax</h3>
<div class="level3">

<p>
 This defines the top quasi literal production and explains how the boundaries between literal portions and substitutions are determined.
</p>

</div>

<a name="quasiliteral"></a><h4>QuasiLiteral ::</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <em><a href="doku.php%3Fid=harmony:quasis.html#quasitag" title="harmony:quasis &crarr;" class="wikilink1">QuasiTag</a></em> <sub>[no <em>LineTerminator</em> here]</sub> <code>`</code> <em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em> <em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em></div>
</li>
</ul>

</div>

<a name="literalportion"></a><h4>LiteralPortion ::</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <em><a href="doku.php%3Fid=harmony:quasis.html#literalcharacter" title="harmony:quasis &crarr;" class="wikilink1">LiteralCharacter</a></em> <em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em></div>
</li>
<li class="level1"><div class="li"> ε</div>
</li>
</ul>

</div>

<a name="literalcharacter"></a><h4>LiteralCharacter ::</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <em>SourceCharacter</em> <strong>but</strong> <strong>not</strong> back quote <code>`</code> <strong>or</strong> <em>LineTerminator</em> <strong>or</strong> back slash <code>\</code> <strong>or</strong> dollar-sign <code>$</code></div>
</li>
<li class="level1"><div class="li"> <em>LineTerminatorSequence</em></div>
</li>
<li class="level1"><div class="li"> <em>LineContinuation</em></div>
</li>
<li class="level1"><div class="li"> <code>\</code> <em>EscapeSequence</em></div>
</li>
<li class="level1"><div class="li"> <code>$</code> lookahead ∉ <code>{</code>, <em>IdentifierStart</em></div>
</li>
</ul>

</div>

<a name="quasiliteraltail"></a><h4>QuasiLiteralTail ::</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <code>`</code></div>
</li>
<li class="level1"><div class="li"> <em><a href="doku.php%3Fid=harmony:quasis.html#substitution" title="harmony:quasis &crarr;" class="wikilink1">Substitution</a></em> <em>LiteralPortion</em> <em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em></div>
</li>
</ul>

</div>

<a name="substitution"></a><h4>Substitution ::</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <code>${</code> <em><a href="doku.php%3Fid=harmony:quasis.html#substitutionmodifier" title="harmony:quasis &crarr;" class="wikilink1">SubstitutionModifier</a></em> <em><a href="doku.php%3Fid=harmony:quasis.html#substitutionbody" title="harmony:quasis &crarr;" class="wikilink1">SubstitutionBody</a></em> <code>}</code></div>
</li>
<li class="level1"><div class="li"> <code>$</code> <em>Identifier</em></div>
</li>
</ul>

</div>

<a name="literal_portion_array"></a><h3>Literal Portion Array</h3>
<div class="level3">

<p>
 The LPA operator defines an array of strings derived from the raw text of the literal portions of the quasi.
</p>

<p>
E.g. the LPA for the quasi <code>q`foo${bar}baz`</code> is <code>[&rsquo;foo&rsquo;, &lsquo;baz&rsquo;]</code>. 
</p>
<table class="inline">
	<tr>
		<th> Production </th><th> Result </th>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteral" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteral</a></em> :: <em><a href="doku.php%3Fid=harmony:quasis.html#quasitag" title="harmony:quasis &crarr;" class="wikilink1">QuasiTag</a></em><code>`</code><em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em>  <em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em></td><td> array-concat(single-element-array(LPA(<em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em>)), LPA(<em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em>)) </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em> :: <em><a href="doku.php%3Fid=harmony:quasis.html#substitution" title="harmony:quasis &crarr;" class="wikilink1">Substitution</a></em>  <em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em>  <em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em></td><td> array-concat(single-element-array(LPA(<em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em>)), LPA(<em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em>)) </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em> :: <code>`</code></td><td> an empty array </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em> :: <em><a href="doku.php%3Fid=harmony:quasis.html#literalcharacter" title="harmony:quasis &crarr;" class="wikilink1">LiteralCharacter</a></em>  <em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em></td><td> string-concat(LPA(<em><a href="doku.php%3Fid=harmony:quasis.html#literalcharacter" title="harmony:quasis &crarr;" class="wikilink1">LiteralCharacter</a></em>), LPA(<em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em>)) </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em> :: ε </td><td> the empty string </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#literalcharacter" title="harmony:quasis &crarr;" class="wikilink1">LiteralCharacter</a></em> :: <em>SourceCharacter</em></td><td> single character string containing that character. </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#literalcharacter" title="harmony:quasis &crarr;" class="wikilink1">LiteralCharacter</a></em> :: <em>LineTerminatorSequence</em></td><td> the literal text </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#literalcharacter" title="harmony:quasis &crarr;" class="wikilink1">LiteralCharacter</a></em> :: <em>LineContinuation</em></td><td> str-concat(<code>&ldquo;\\&rdquo;</code>, LPE(<em>LineTerminatorSequence</em>)) </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#literalcharacter" title="harmony:quasis &crarr;" class="wikilink1">LiteralCharacter</a></em> :: <code>\</code><em>EscapeSequence</em></td><td> str-concat(<code>&ldquo;\\&rdquo;</code>, <em>EscapeSequence</em>) </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#literalcharacter" title="harmony:quasis &crarr;" class="wikilink1">LiteralCharacter</a></em> :: <code>$</code></td><td><code>&ldquo;$&rdquo;</code></td>
	</tr>
</table>
<br />

</div>

<a name="quasitag"></a><h3>QuasiTag</h3>
<div class="level3">

<p>
Before the open backquote (<code>`</code>) there is an optional expression that specifies a function that receives the literal portions and substitutions.
</p>

<p>
<a href="doku.php%3Fid=strawman:quasis-quasitag-memberexpr.html" class="wikilink1" title="strawman:quasis-quasitag-memberexpr" onclick="return svchk()" onkeypress="return svchk()">quasis-quasitag-memberexpr</a> is another way to define the <em><a href="doku.php%3Fid=harmony:quasis.html#quasitag" title="harmony:quasis &crarr;" class="wikilink1">QuasiTag</a></em> production that allows for arbitrary member expressions.  If worthwhile, it should be adopted <em>instead of</em> this section.
</p>

</div>

<a name="quasitag"></a><h4>QuasiTag ::</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <em>Identifier</em></div>
</li>
<li class="level1"><div class="li"> ε</div>
</li>
</ul>

</div>

<a name="qt"></a><h4>QT</h4>
<div class="level4">
<table class="inline">
	<tr>
		<th> Production </th><th> Result </th>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#quasitag" title="harmony:quasis &crarr;" class="wikilink1">QuasiTag</a></em> :: <em>Identifier</em></td><td> an expression of the form <em>PrimaryExpression</em> : <em>Identifier</em> with the given <em>Identifier</em></td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#quasitag" title="harmony:quasis &crarr;" class="wikilink1">QuasiTag</a></em> :: ε </td><td> the Default Quasi Tag function below </td>
	</tr>
</table>
<br />

</div>

<a name="default_quasi_tag"></a><h4>Default Quasi Tag</h4>
<div class="level4">

<p>
 The default quasi tag is a frozen function defined as 
</p>
<pre class="code javascript">  <span class="co1">// callSiteId : ignored</span>
  <span class="co1">// mixedLiteralPortionsAndSubstitutions :</span>
  <span class="co1">//   An odd-length array where even elements (0-indexed) are</span>
  <span class="kw2">function</span> <span class="br0">&#40;</span>callSiteId <span class="coMULTI">/* , ...substitutions */</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">var</span> rawStrs = callSiteId.<span class="me1">expandedLP</span>;
    <span class="kw2">var</span> out = <span class="br0">&#91;</span><span class="br0">&#93;</span>;
    <span class="kw2">var</span> i = <span class="nu0">0</span>, k = -<span class="nu0">1</span>, n = rawStrs.<span class="me1">length</span> - <span class="nu0">1</span>;
    <span class="kw1">while</span> <span class="br0">&#40;</span>i &lt; n<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      out<span class="br0">&#91;</span>++k<span class="br0">&#93;</span> = rawStrs<span class="br0">&#91;</span>i<span class="br0">&#93;</span>;
      out<span class="br0">&#91;</span>++k<span class="br0">&#93;</span> = arguments<span class="br0">&#91;</span>++i<span class="br0">&#93;</span>;
    <span class="br0">&#125;</span>
    out<span class="br0">&#91;</span>++k<span class="br0">&#93;</span> = rawStrs<span class="br0">&#91;</span>n<span class="br0">&#93;</span>;
    <span class="co1">// As per the original Array.prototype.slice and Array.prototype.join.</span>
    <span class="kw1">return</span> out.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">""</span><span class="br0">&#41;</span>;
  <span class="br0">&#125;</span></pre>
</div>

<a name="substitution_body_syntax"></a><h3>Substitution Body Syntax</h3>
<div class="level3">

<p>
Between literal portions there are substitutions of the form <code>${...}</code> or <code>$ident</code>.  The substitution body specifies an expression, e.g. the substitution bodies in <code>quasitag`literal0 ${x.y} literal1 $bar literal2`</code> are <code>(x.y)</code>, and <code>(bar)</code>.
</p>

<p>
E.g. the SVE of <code>quasitag`literalPortion0 $x literalPortion1 ${y.z} literalPortion2`</code> is <code>[x, (y.z)]</code>.
</p>

<p>
Below are other ways of defining the <em><a href="doku.php%3Fid=harmony:quasis.html#substitutionbody" title="harmony:quasis &crarr;" class="wikilink1">SubstitutionBody</a></em> production and the SVE spec function.  If preferred, they should be used <em>instead of</em> this section. 
</p>
<ul>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=strawman:quasis-substitutions-simple-members.html" class="wikilink1" title="strawman:quasis-substitutions-simple-members" onclick="return svchk()" onkeypress="return svchk()">quasis-substitutions-simple-members</a> - more complex expressions, but easily lexically boundable.</div>
</li>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=strawman:quasis-substitutions-primaryexpr.html" class="wikilink1" title="strawman:quasis-substitutions-primaryexpr" onclick="return svchk()" onkeypress="return svchk()">quasis-substitutions-primaryexpr</a> - arbitrary expressions are allowed.</div>
</li>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=strawman:quasis-substitutions-thunk.html" class="wikilink1" title="strawman:quasis-substitutions-thunk" onclick="return svchk()" onkeypress="return svchk()">quasis-substitutions-thunk</a> - arbitrary expressions are allowed, and the expressions are thunkified so that a quasi handler (QT) may evaluate them zero or multiple time to support branching or looping.</div>
</li>
<li class="level1"><div class="li"> <a href="doku.php%3Fid=strawman:quasis-substitutions-slot.html" class="wikilink1" title="strawman:quasis-substitutions-slot" onclick="return svchk()" onkeypress="return svchk()">quasis-substitutions-slot</a> - arbitrary expressions are allowed, and expressions that are preceded by the modifier <code>=</code> may be used as left hand sides, assigned to by the quasi handler.  This enables use cases like the destructuring regular expression match.</div>
</li>
</ul>

</div>

<a name="identifierpathtail"></a><h4>//IdentifierPathTail// ::</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <code>.</code> <em>IdentifierName</em> <em>IdentifierPathTail</em></div>
</li>
<li class="level1"><div class="li"> ε</div>
</li>
</ul>

</div>

<a name="substitutionbody"></a><h4>//SubstitutionBody// ::</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <em>Identifier</em> <em>IdentifierPathTail</em></div>
</li>
</ul>

</div>

<a name="substitutionmodifier"></a><h4>//SubstitutionModifier// ::</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> ε</div>
</li>
</ul>

</div>

<a name="sve"></a><h4>SVE</h4>
<div class="level4">
<table class="inline">
	<tr>
		<th> Production </th><th> Result </th>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteral" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteral</a></em> :: <em>QuasiTag</em><code>`</code><em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em>  <em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em></td><td> SVE(<em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em>) </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em> :: <em><a href="doku.php%3Fid=harmony:quasis.html#substitution" title="harmony:quasis &crarr;" class="wikilink1">Substitution</a></em>  <em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em>  <em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em></td><td> array-concat(single-element-array(SVE(<em>Substitution</em>)), SVE(<em>QuasiLiteralTail</em>)) </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteraltail" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteralTail</a></em> :: <code>`</code></td><td> an empty array </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#substitution" title="harmony:quasis &crarr;" class="wikilink1">Substitution</a></em> :: <code>$</code><em>Identifier</em></td><td><em>PrimaryExpression</em> : <em>Identifier</em></td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#substitution" title="harmony:quasis &crarr;" class="wikilink1">Substitution</a></em> :: <code>${</code><em><a href="doku.php%3Fid=harmony:quasis.html#substitutionmodifier" title="harmony:quasis &crarr;" class="wikilink1">SubstitutionModifier</a></em>  <em>Identifier</em><code>}</code></td><td><em>PrimaryExpression</em></td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#substitutionbody" title="harmony:quasis &crarr;" class="wikilink1">SubstitutionBody</a></em> :: <em>Identifier</em>  <em><a href="doku.php%3Fid=harmony:quasis.html#identifierpathtail" title="harmony:quasis &crarr;" class="wikilink1">IdentifierPathTail</a></em></td><td><em>MemberExpression</em> : str-concat(SV(<em>Identifier</em>), SV(<em><a href="doku.php%3Fid=harmony:quasis.html#identifierpathtail" title="harmony:quasis &crarr;" class="wikilink1">IdentifierPathTail</a></em>)) </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#identifierpathtail" title="harmony:quasis &crarr;" class="wikilink1">IdentifierPathTail</a></em> :: <code>.</code><em>IdentifierName</em>  <em><a href="doku.php%3Fid=harmony:quasis.html#identifierpathtail" title="harmony:quasis &crarr;" class="wikilink1">IdentifierPathTail</a></em></td><td> str-concat(<code>&ldquo;.&rdquo;</code>, SV(<em>IdentifierName</em>), SV(<em><a href="doku.php%3Fid=harmony:quasis.html#identifierpathtail" title="harmony:quasis &crarr;" class="wikilink1">IdentifierPathTail</a></em>)) </td>
	</tr>
	<tr>
		<td><em><a href="doku.php%3Fid=harmony:quasis.html#identifierpathtail" title="harmony:quasis &crarr;" class="wikilink1">IdentifierPathTail</a></em> :: ε </td><td> the empty string, <code>&ldquo;&ldquo;</code></td>
	</tr>
</table>
<br />

<p>
 The SVE of a substitution is an expression that is evaluated in the scope in which the quasiliteral appears. The SVE of the quasi literal is the array of the SVE for each substitution.
</p>

<p>
E.g. the SVE of <code>quasitag`literalPortion0 $x literalPortion1 $y.z literalPortion2`</code> is <code>[x, y.z]</code>.
</p>

</div>

<a name="tokenizing"></a><h3>Tokenizing</h3>
<div class="level3">

<p>
 The grammar defined above is lexically simple. There are a number of alternate schemes for specifying the <em>SubstitutionBody</em> production.  Allowing it to be an arbitrary expression raises a few wrinkles &ndash; quasiliterals can nest, and expressions containing curly brackets can nest inside <code>${...}</code> sections, so finding out where a quasiliteral substitution body ends requires changes to the way EcmaScript is tokenized.
</p>

<p>
The <em><a href="doku.php%3Fid=harmony:quasis.html#substitutionbody" title="harmony:quasis &crarr;" class="wikilink1">SubstitutionBody</a></em> production is most simply defined in terms of <em>PrimaryExpression</em> which is not a lexical production.  The <em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteral" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteral</a></em> grammar defined below can be described in terms of lexical productions without more trickery than that needed to treat tokenize lexical productions.
</p>

<p>
When lexing, a stack of bits is needed to determine whether a curly bracket ends a substitution, and a single bit is needed to tell whether the parser is currently inside a <em><a href="doku.php%3Fid=harmony:quasis.html#literalportion" title="harmony:quasis &crarr;" class="wikilink1">LiteralPortion</a></em>.
</p>

<p>
See the <a href="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/tokenize.html" class="urlextern" target="_blank" title="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/tokenize.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">interactive demo</a> of the tokenization scheme described below for more detailed discussion. 
</p>
<table class="inline">
	<tr>
		<th> Curly Bracket Stack </th><th> In Literal Portion </th><th class="leftalign"> Character Seen         </th><th> Effect </th>
	</tr>
	<tr>
		<td class="leftalign"> any                 </td><td class="leftalign"> true               </td><td class="leftalign"><code>$</code><code>{</code>            </td><td> emit the LP, inLP := false, push true </td>
	</tr>
	<tr>
		<td class="leftalign"> any                 </td><td class="leftalign"> true               </td><td class="leftalign"><code>`</code>                  </td><td> emit the LP, inLP := false </td>
	</tr>
	<tr>
		<td class="leftalign"> any                 </td><td class="leftalign"> true               </td><td class="leftalign"><code>\</code>                  </td><td> consume next character, append both to LP </td>
	</tr>
	<tr>
		<td class="leftalign"> any                 </td><td class="leftalign"> true               </td><td class="leftalign"> other                  </td><td> append to LP </td>
	</tr>
	<tr>
		<td class="leftalign"> any                 </td><td class="leftalign"> false              </td><td class="leftalign"><code>`</code>                  </td><td> inLP := true </td>
	</tr>
	<tr>
		<td class="leftalign"> any                 </td><td class="leftalign"> false              </td><td class="leftalign"><code>{</code>                  </td><td> push false, emit <code>{</code></td>
	</tr>
	<tr>
		<td class="leftalign"> top is false        </td><td class="leftalign"> false              </td><td class="leftalign"><code>}</code>                  </td><td> pop, emit <code>}</code></td>
	</tr>
	<tr>
		<td class="leftalign"> top is true         </td><td class="leftalign"> false              </td><td class="leftalign"><code>}</code>                  </td><td> pop, inLP := true </td>
	</tr>
	<tr>
		<td class="leftalign"> empty               </td><td class="leftalign"> false              </td><td class="leftalign"><code>}</code>                  </td><td> no effect </td>
	</tr>
	<tr>
		<td class="leftalign"> any                 </td><td class="leftalign"> false              </td><td> neither <code>{</code> or <code>}</code></td><td> tokenize as if quasis not in grammar </td>
	</tr>
</table>
<br />

<p>
 This requires a lookahead of 1 because <code>${</code> has to be treated as a unit for purposes of determining whether a <code>$</code> starts a substitution.
</p>

</div>

<a name="semantics_normative"></a><h2>Semantics (normative)</h2>
<div class="level2">

<p>
Given the QT, LPA, and SVE defined above, this specifies the desugaring of the <em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteral" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteral</a></em> production.
</p>

<p>
This version passes all the parts to the function specified by the quasi tag in one argument list instead of passing the literal portions first.
</p>

</div>

<a name="callsiteid"></a><h3>CallSiteId</h3>
<div class="level3">

<p>
The desugaring below uses a hoisted declaration instead of interleaving the LPA with the SVE.  This is done for a variety of reasons. 
</p>
<ol>
<li class="level1"><div class="li"> Many quasi handlers want to deal with literal portions as if they were chunks of a <em>StringLiteral</em> where each <em>EscapeSequence</em> is replaced with its corresponding character value.  This is typical for quasi handlers that produce a string like result.</div>
</li>
<li class="level1"><div class="li"> Some use-cases benefit from having access to the raw text of the literal portion.  E.g. <code>\b</code> has a different meaning in a regular expression than in a <em>StringLiteral</em>, and knowing whether a meta-character is escaped can be beneficial.</div>
</li>
<li class="level1"><div class="li"> Many quasi handler functions benefit from being able to memoize their results.  Having an object that identifiers a call site and which can serve as a key into a WeakMap allows easy memoization.</div>
</li>
</ol>

</div>

<a name="desugaring"></a><h3>Desugaring</h3>
<div class="level3">

<p>
A <em><a href="doku.php%3Fid=harmony:quasis.html#quasiliteral" title="harmony:quasis &crarr;" class="wikilink1">QuasiLiteral</a></em> in an EcmaScript parse tree is desugared to two subtrees.  It is replaced in-situ with a function call that produces the value of the quasiliteral, and a declaration is hoisted into the top module scope that allows a quasi-tag easy access to the raw literal portions and allows a convenient handle by which a quasi handler can memoize state derived from the literal portions (extracted meta-data and the like).  This desugaring is specified in terms of a hoisted declaration for the convenience of tool authors who want to back-port this desugaring, but in interpreters, there is no need to create a record in a lexical environment or assign an actual name &ndash; the interpreter need only ensure that when a particular quasiliteral is evaluated, the same call site object is passed to the quasi handler. 
</p>

<p>
The declaration has a name, <em>CallSiteID</em>, that is an unguessable <em>Identifier</em>.  It has the form (<em>ConstDeclaration</em>, <em>CallSiteID</em>, (<em>CallExpression</em>, (<em>MemberExpression</em>, (<em>Identifier</em>, &ldquo;Object&rdquo;), &ldquo;.&rdquo;, (<em>Identifier</em>, &ldquo;freeze&rdquo;)), (<em>ParameterList</em>, (<em>ObjectLiteral</em>, (<em>ObjectProperty</em>, (<em>StringLiteral</em>, &ldquo;raw&rdquo;), (<em>CallExpression</em>, (<em>MemberExpression</em>, (<em>Identifier</em>, &ldquo;Object&rdquo;), &ldquo;.&rdquo;, (<em>Identifier</em>, &ldquo;freeze&rdquo;)), (<em>ParameterList</em>, (<em>ArrayLiteral</em>, ...LPA)))), (<em>ObjectProperty</em>, (<em>StringLiteral</em>, &ldquo;cooked&rdquo;), (<em>CallExpression</em>, (<em>MemberExpression</em>, (<em>Identifier</em>, &ldquo;Object&rdquo;), &ldquo;.&rdquo;, (<em>Identifier</em>, &ldquo;freeze&rdquo;)), (<em>ParameterList</em>, (<em>ArrayLiteral</em>, ...cookedLPA)))))))).
</p>

<p>
The cookedLPA used in the declaration by mapping the <em>StringLiteral</em> SV function over the LPA.  This has the effect of decoding each <em>EscapeSequence</em>.
</p>

<p>
In-situ, the <em>QuasiLiteral</em> is replaced with a function call: (<em>CallExpression</em>, (QT, (<em>ParameterList</em>, (array-concat([<em>CallSiteID</em>], SVE)))).
</p>

<p>
Since for <code>quasiTag`literalPortion\0 $x literalPortion1`</code> the QT is <code>quasiTag</code>, LPA is <code>[&rdquo;literalPortion\\0 &ldquo;, &quot; literalPortion1&rdquo;]</code> and SVE is <code>[x]</code>, if the assigned CallSiteId is <code>unguessableCallSiteId1234</code> then it desugars to
</p>
<pre class="code javascript"><span class="co1">// Declaration hoisted to top of module.</span>
<span class="co1">// Escape sequences in the hoisted declaration are not decoded according to CV(EscapeSequence).</span>
<span class="co1">// The calls to Object.freeze use the original definition of that method.</span>
<span class="kw2">const</span> unguessableCallSiteId1234 = Object.<span class="me1">freeze</span><span class="br0">&#40;</span><span class="br0">&#123;</span>
  raw: Object.<span class="me1">freeze</span><span class="br0">&#40;</span><span class="br0">&#91;</span><span class="st0">"literalPortion<span class="es0">\\</span>0 "</span>, <span class="st0">"literalPortion1"</span><span class="br0">&#93;</span><span class="br0">&#41;</span>,
  cooked: Object.<span class="me1">freeze</span><span class="br0">&#40;</span><span class="br0">&#91;</span><span class="st0">"literalPortion<span class="es0">\u</span>0000 "</span>, <span class="st0">"literalPortion1"</span><span class="br0">&#93;</span><span class="br0">&#41;</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span>;
&nbsp;
...
&nbsp;
  <span class="co1">// In-situ</span>
  <span class="co1">// Escape sequences in the arguments are decoded.</span>
  <span class="co1">// unguessableCallSiteId1234 is ideal as a key into a weak map used to memoize</span>
  <span class="co1">// extraction of meta-data, custom escaping conventions, and other state</span>
  <span class="co1">// that can be derived from the literal portions, so does not vary from</span>
  <span class="co1">// call to call from the same call-site.</span>
  quasiTag<span class="br0">&#40;</span>unguessableCallSiteId1234, x<span class="br0">&#41;</span></pre>
</div>

<a name="security_considerations"></a><h2>Security Considerations</h2>
<div class="level2">

<p>
 This strawman should also fall in the language subset defined by SES (Secure EcmaScript). As such, neither its presence in the language nor its use in a program should make it substantially more difficult to reason about the security properties of that program.
</p>

<p>
Developers expect that object references only escape a scope by being explicitly passed or assigned. This strawman needs to preserve both the scope invariants of EcmaScript 5 functions and catch blocks, and those introduced by the modules and <code>let</code> proposals.
</p>

<p>
 The below discusses the interaction between a quasi function defined in one scope/module and the code it produces to be executed in another scope/module.  The actors include
</p>
<ul>
<li class="level1"><div class="li"> library author &ndash; the author of the module / scope in which the quasi function is defined</div>
</li>
<li class="level1"><div class="li"> quasi author &ndash; the author of the quasi-literal and any symbols defined in the module / scope containing it.</div>
</li>
</ul>

</div>

<a name="defensive_code"></a><h3>Defensive Code</h3>
<div class="level3">

<p>
A module needs to be able to defend its invariants against bugs or deliberate malice by another module. SES does not attempt to guarantee availability since trivial programs can loop infinitely, but a module must be able to guarantee that its invariants hold when control leaves it.
</p>

<p>
This proposal does not complicate defensive code reasoning because:
</p>
<ul>
<li class="level1"><div class="li"> only symbols mentioned in a substitution are observable by the library author</div>
</li>
<li class="level1"><div class="li"> only symbols marked as writable can be written by the library author</div>
</li>
</ul>

<p>
 The quasi author has to be aware that the order of evaluation is unclear. For quasis to specify new control constructs, substitutions need to be evaluable out of order, repeatedly, or not at all.
</p>

<p>
Under the thunking and slot alternative <em>SubstitutionBody</em> desugarings, by writing a substitution, the quasi author is conveying the authority to evaluate an expression in the quasi scope any number of times from that point on. (Assuming the quasi module has the authority to cause delayed evaluation as by <code>setTimeout</code>). A substitution conveys the same authority as a zero argument function.
</p>

</div>

<a name="offensive_code"></a><h3>Offensive Code</h3>
<div class="level3">

<p>
The library author&rsquo;s quasi function may be used by multiple mutually suspicious or intentionally isolated modules.  It can ensure that bugs or malice in one module do not affect its ability to serve another module by freezing the symbols it exports and by coding defensively.
</p>

<p>
This proposal does not complicate its ability to do that, since it imposes no mutable data requirements on quasi functions.
</p>

</div>

<a name="possible_problems"></a><h3>Possible Problems</h3>
<div class="level3">

<p>
 This syntax is, by design, similar to that of string interpolation in other languages. Users may assume the result of the quasi-literal is a string as occurs in languages like <acronym title="Practical Extraction and Report Language">Perl</acronym> and <acronym title="Hypertext Preprocessor">PHP</acronym> (<a href="doku.php%3Fid=harmony:quasis.html#php_string_vars" title="harmony:quasis &crarr;" class="wikilink1">3</a>), and that subsequent mutations to values substituted in do not affect the result of the interpolation. It is the responsibility of QT implementers to match these expectations or to educate users.  Specifically, developer surprise might result from the below if <code>q</code> kept a reference to the mutable fib array which is modified by subsequent iterations of the loop.
</p>
<pre class="code javascript"><span class="kw2">var</span> quasis = <span class="br0">&#91;</span><span class="br0">&#93;</span>;
<span class="kw2">var</span> fib = <span class="br0">&#91;</span><span class="nu0">1</span>, <span class="nu0">1</span><span class="br0">&#93;</span>;  <span class="co1">// State shared across loop bodies</span>
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw2">var</span> i = <span class="nu0">1</span>; i &lt; <span class="nu0">10</span>; ++i<span class="br0">&#41;</span> <span class="br0">&#123;</span>
  fib<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> += fib<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>;
  fib<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span> = fib<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> - fib<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>;
  quasis.<span class="me1">push</span><span class="br0">&#40;</span>q`Fib$<span class="br0">&#123;</span>i-<span class="nu0">1</span><span class="br0">&#125;</span> and fib$<span class="br0">&#123;</span>i<span class="br0">&#125;</span> are $fib`<span class="br0">&#41;</span>;
<span class="br0">&#125;</span></pre>
<p>
String interpolation in other languages is often a vector for quoting confusion attacks : <acronym title="Extensible Stylesheet Language">XSL</acronym>, <acronym title="Structured Query Language">SQL</acronym> Injection, Script Injection, etc.. It is the responsibility of QT implementers to properly escape substituted values, and a lazy escaping scheme (<a href="doku.php%3Fid=harmony:quasis.html#secure_string_interp" title="harmony:quasis &crarr;" class="wikilink1">2</a>) can provide an intelligent default. It is a goal of the proposed scheme to reduce the overall vulnerability of EcmaScript applications to quoting confusion by making it easy for developers to generate properly escaped strings in other languages.
</p>

<p>
Quasi-literals contain embedded expressions, but the set of lexical bindings accessible to the quasi handler is restricted to the union of the below so they do not complicate static analysis 
</p>
<ol>
<li class="level1"><div class="li"> the set of identifiers mentioned by the author in the lexical environment in which the quasi-literal appears,</div>
</li>
<li class="level1"><div class="li"> the lexical environment of the QT in the environment in which it is defined,</div>
</li>
<li class="level1"><div class="li"> for QTs defined in non-strict mode, the global object as bound to <code>this</code>.</div>
</li>
</ol>

</div>

<a name="reasons_and_open_issues"></a><h2>Reasons and Open Issues</h2>
<div class="level2">

</div>

<a name="quoting_character"></a><h3>Quoting Character</h3>
<div class="level3">

<p>
 The meaning of existing programs should not change, so this proposal must extend the grammar without introducing ambiguity.  It is meant to enable secure string interpolation and DSLs, so using a syntax reminiscent of strings seems reasonable, and many widely used languages have string interpolation schemes which will reduce the learning curve associated with the proposed feature.
</p>

<p>
Backquote (<code>`</code>) was chosen as the quoting character for string interpolations because it is unused outside string and comment bodies; and is obviously a quoting character.
</p>

<p>
It is already used in other languages that many EcmaScript authors use &ndash; perl, <acronym title="Hypertext Preprocessor">PHP</acronym>, and ruby where it allows interpolation though with a more specific meaning than macro expansion. It is used as a macro construct in Scheme where it is called a &ldquo;quasiquote.&rdquo;  In Python 2.x and earlier, it is a shorthand for the <code>repr</code> function, so contained an expression and applied a specific transformation to it.
</p>

<p>
As such, many syntax highlighters deal with it reasonably well, and programmers are used to seeing it as a quote character instead of as a grave accent.
</p>

<p>
Alternatives include: 
</p>
<ul>
<li class="level1"><div class="li"> <pre class="code">q&quot;&quot;&quot;Interpolate ${this}!&quot;&quot;&quot;</pre>

<p>
.
</p>
</div>
</li>
<li class="level1"><div class="li"> <pre class="code">q&quot;Interpolate ${this}!&quot;</pre>

<p>
 which simply uses an existing quoting character but which constrains the default quasi handler definition.
</p>
</div>
</li>
<li class="level1"><div class="li"> <pre class="code">q{{&quot;Interpolate ${this}!&quot;}}</pre>

<p>
 which simplifies nesting.
</p>
</div>
</li>
<li class="level1"><div class="li"> <pre class="code">q(:&quot;Interpolate ${this}!&quot;:)</pre>

<p>
 which is friendly even if not RSI friendly.
</p>
</div>
</li>
<li class="level1"><div class="li"> <pre class="code">q@&quot;Interpolate ${this}!&quot;</pre>

<p>
 is similar to C# literal strings but different semantically.
</p>
</div>
</li>
</ul>

</div>

<a name="nesting"></a><h3>Nesting</h3>
<div class="level3">

<p>
There are a number of advantages to allowing quasis to nest.  Substitutions are easy to understand if they are just expressions, and quasis are just another kind of expression.
</p>

<p>
There are concrete use cases as well.  We could integrate control flow into the <code>safehtml</code> quasi handler available at the <a href="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/index.html" class="urlextern" target="_blank" title="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/index.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">REPL</a>, but substitutions with nested quasis can serve just as well.
</p>
<pre class="code">
rows = [['Unicorns', 'Sunbeams', 'Puppies'], ['&lt;3', '&lt;3', '&lt;3']],
safehtml`&lt;table&gt;${
  rows.map(function(row) {
    return safehtml`&lt;tr&gt;${
      row.map(function(cell) {
        return safehtml`&lt;td&gt;${cell}&lt;/td&gt;`
      })
    }&lt;/tr&gt;`
  })
}&lt;/table&gt;`
</pre>

<p>
produces something like
</p>
<pre class="code">
&lt;table&gt;
  &lt;tr&gt;&lt;td&gt;Unicorns&lt;/td&gt;&lt;td&gt;Sunbeams&lt;/td&gt;&lt;td&gt;Puppies&lt;/td&gt;&lt;/tr&gt;
  &lt;tr&gt;&lt;td&gt;&amp;lt;3&lt;/td&gt;&lt;td&gt;&amp;lt;3&lt;/td&gt;&lt;td&gt;&amp;lt;3&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
</pre>

</div>

<a name="substitutions"></a><h3>Substitutions</h3>
<div class="level3">

<p>
 Since we&rsquo;re choosing syntax to reduce the learning curve, we chose <code>${...}</code> since it is used to allow arbitrary embedded expressions in <acronym title="Hypertext Preprocessor">PHP</acronym> and JQuery templates. We also include the abbreviated form (<code>$ident</code>) to be compatible with Bash, <acronym title="Practical Extraction and Report Language">Perl</acronym>, <acronym title="Hypertext Preprocessor">PHP</acronym>, Ruby, etc.
</p>

<p>
We decided against <code>sprintf</code> style formatting, since, although widely understood, it does not allow many DSL applications, and imposes an O(n) cognitive load (<a href="doku.php%3Fid=harmony:quasis.html#secure_string_interp" title="harmony:quasis &crarr;" class="wikilink1">2</a>).
</p>

<p>
Alternatives include: 
</p>
<ul>
<li class="level1"><div class="li"> Bash: <code>$(...)</code></div>
</li>
<li class="level1"><div class="li"> Ruby: <code>#{...}</code></div>
</li>
</ul>

</div>

<a name="raw_escapes_in_literal_sections"></a><h3>Raw Escapes in Literal Sections</h3>
<div class="level3">

<p>
The per-call-site object passed as the first argument to the quasi handler function contains both the raw text of each literal portion and contains the text of literal portion after escape sequences have been converted into the characters they would specify inside a <em>StringLiteral</em>.
</p>

<p>
We lose no generality by providing raw escapes and there are use cases where raw escapes are useful, as in regular expression composition:
</p>
<pre class="code javascript"><span class="kw2">var</span> my regexp = re`<span class="br0">&#40;</span>?i:\w+$foo\w+<span class="br0">&#41;</span>`;
&nbsp;
<span class="kw2">function</span> re<span class="br0">&#40;</span>literalPortions<span class="br0">&#41;</span> <span class="br0">&#123;</span>
  <span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw2">var</span> i = arguments.<span class="me1">length</span>; --i &gt;= <span class="nu0">0</span>;<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    literalPortions<span class="br0">&#91;</span>i * <span class="nu0">2</span><span class="br0">&#93;</span> = arguments<span class="br0">&#91;</span>i<span class="br0">&#93;</span>;
  <span class="br0">&#125;</span>
  <span class="kw1">return</span> <span class="kw2">function</span> <span class="br0">&#40;</span>substitutions<span class="br0">&#41;</span> <span class="br0">&#123;</span>
    <span class="kw2">var</span> regexBody = literalPortions.<span class="me1">slice</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span>;
    <span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw2">var</span> i = <span class="nu0">0</span>, n = substitutions.<span class="me1">length</span>; i &lt; n; ++i<span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw2">var</span> sub = substitutions<span class="br0">&#91;</span>i<span class="br0">&#93;</span>
      regexBody<span class="br0">&#91;</span>i * <span class="nu0">2</span> + <span class="nu0">1</span><span class="br0">&#93;</span> = sub<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">replace</span><span class="br0">&#40;</span>
          <span class="re0">/<span class="br0">&#91;</span>\\<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span><span class="br0">&#125;</span>\<span class="br0">&#91;</span>\<span class="br0">&#93;</span>^$.+*?|\-<span class="br0">&#93;</span>/g</span>, <span class="st0">'<span class="es0">\\</span>$&amp;'</span><span class="br0">&#41;</span>;
    <span class="br0">&#125;</span>
    <span class="kw1">return</span> <span class="kw2">new</span> RegExp<span class="br0">&#40;</span>regexBody.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">''</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
  <span class="br0">&#125;</span>;
<span class="br0">&#125;</span></pre>
</div>

<a name="line_continuation_and_line_terminators"></a><h3>Line Continuation and Line Terminators</h3>
<div class="level3">

<p>
 Some revision control systems rewrite newlines on checkout.  These systems might change the meaning of EcmaScript programs that contain multi-line quasis.
</p>

<p>
<acronym title="Hypertext Preprocessor">PHP</acronym>, Python, <acronym title="Practical Extraction and Report Language">Perl</acronym> and other languages are already sensitive to white-space characters at the end of lines so developers are already familiar with these problems.
</p>

<p>
Newlines and trailing spaces inside quasi-literals are significant.
</p>

</div>

<a name="references"></a><h2>References</h2>
<div class="level2">

</div>

<a name="quasis_in_e"></a><h3>Quasis in E</h3>
<div class="level3">

<p>
<a href="http://www.erights.org/elang/grammar/quasi-overview.html" class="urlextern" target="_blank" title="http://www.erights.org/elang/grammar/quasi-overview.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Quasiliterals in E</a>
</p>

</div>

<a name="secure_string_interp"></a><h3>Secure String Interp</h3>
<div class="level3">

<p>
<a href="http://google-caja.googlecode.com/svn/changes/mikesamuel/string-interpolation-29-Jan-2008/trunk/src/js/com/google/caja/interp/index.html" class="urlextern" target="_blank" title="http://google-caja.googlecode.com/svn/changes/mikesamuel/string-interpolation-29-Jan-2008/trunk/src/js/com/google/caja/interp/index.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Secure String Interpolation</a>
</p>

</div>

<a name="php_string_vars"></a><h3>PHP String Vars</h3>
<div class="level3">

<p>
<a href="http://www.php.net/manual/en/language.types.string.php#languages.types.string.parsing" class="urlextern" target="_blank" title="http://www.php.net/manual/en/language.types.string.php#languages.types.string.parsing" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">PHP String variable parsing</a>
</p>

</div>

<a name="plt_scheme_scribble"></a><h3>PLT Scheme Scribble</h3>
<div class="level3">

<p>
<a href="http://docs.plt-scheme.org/scribble/reader.html" class="urlextern" target="_blank" title="http://docs.plt-scheme.org/scribble/reader.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">PLT Scheme Scribble Syntax</a>
</p>

</div>

<a name="sml_of_new_jersey"></a><h3>SML of New Jersey</h3>
<div class="level3">

<p>
<a href="http://smlnj.org" class="urlextern" target="_blank" title="http://smlnj.org" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">SML/NJ</a> has a similar <a href="http://smlnj.org/doc/quote.html" class="urlextern" target="_blank" title="http://smlnj.org/doc/quote.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Quote/Antiquote</a> feature (whose documentation, ironically enough, has an <acronym title="HyperText Markup Language">HTML</acronym> bug in a quoted code snippet, resulting in the bottom third or so of the page being in monospaced font).
</p>

</div>

<a name="secure_code_generation"></a><h3>Secure Code Generation</h3>
<div class="level3">

<p>
<a href="http://web.sec.uni-passau.de/members/martin/talks/081215_MSR.pdf" class="urlextern" target="_blank" title="http://web.sec.uni-passau.de/members/martin/talks/081215_MSR.pdf" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">&quot;Secure Code Generation for Web Applications&quot;</a> by Martin Johns.
</p>

</div>

<a name="scheme_hygienic_macros"></a><h3>Scheme Hygienic Macros</h3>
<div class="level3">

<p>
<a href="http://community.schemewiki.org/?scheme-faq-macros" class="urlextern" target="_blank" title="http://community.schemewiki.org/?scheme-faq-macros" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Scheme Macros FAQ</a>
</p>

</div>

<a name="paradigm_regained"></a><h3>Paradigm Regained</h3>
<div class="level3">

<p>
<a href="http://www.erights.org/talks/asian03/" class="urlextern" target="_blank" title="http://www.erights.org/talks/asian03/" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Paradigm Regained : Abstraction Mechanisms for Access Control</a>
</p>

</div>

<a name="safe_templates"></a><h3>Safe Templates</h3>
<div class="level3">

<p>
<a href="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/safetemplate.html" class="urlextern" target="_blank" title="http://js-quasis-libraries-and-repl.googlecode.com/svn/trunk/safetemplate.html" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Using Type Qualifiers to Make Web Templates Robust Against XSS</a> 
</p>

</div>

<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/1/1ff020591119f003a8be9d5edb7be373.xhtml used -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        harmony/quasis.txt &middot; Last modified: 2013/07/11 23:58 by rwaldron      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="harmony:quasis" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="harmony:quasis" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="harmony:quasis" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="harmony:quasis" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=harmony:quasis.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=harmony%253Aquasis&amp;1454275466" width="1" height="1" alt=""  /></body>
</html>
