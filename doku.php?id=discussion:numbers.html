<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>discussion:numbers [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=discussion:numbers&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=discussion" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=discussion:numbers&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=discussion:numbers&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2007-07-20T04:42:13+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=discussion:numbers&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">discussion:numbers</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="discussion:numbers" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="discussion:numbers" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:local_packages.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:local_packages">local_packages</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:meta_objects.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:meta_objects">meta_objects</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:name_objects.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:name_objects">name_objects</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=discussion:nullability.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:nullability">nullability</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=discussion:numbers.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="discussion:numbers">numbers</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#open_issues_july_2007" class="toc">Open issues, July 2007</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#class_hierarchy_ticket_3" class="toc">Class hierarchy (ticket 3)</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#overflow_handling_ticket_4" class="toc">Overflow handling (ticket 4)</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#pragmas_ticket_138" class="toc">Pragmas (ticket 138)</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#exposing_primitives" class="toc">Exposing primitives</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#integer_division" class="toc">Integer division</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#future-proofing_no_ticket" class="toc">Future-proofing (no ticket)</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#math_operations_ticket_83" class="toc">Math operations (ticket 83)</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#misc" class="toc">Misc</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#decimal_comparisons" class="toc">Decimal Comparisons</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#odds_and_ends" class="toc">Odds and ends</a></span></li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#discussion_of_type_hierarchy" class="toc">Discussion of type hierarchy</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#flat_solution" class="toc">Flat solution</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#hierarchical_solution" class="toc">Hierarchical solution</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#parameterized_types" class="toc">Parameterized types</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#conclusion" class="toc">Conclusion</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#understanding_use_numbertype_in_terms_of_namespaces" class="toc">Understanding &quot;use &lt;numbertype&gt;&quot; in terms of namespaces</a></span><ul class="toc">
<li class="clear"><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#number" class="toc">''Number''</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#operators" class="toc">Operators</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#literals" class="toc">Literals</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#shadowing" class="toc">Shadowing</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#initial_namespace" class="toc">Initial namespace</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#number_tokens" class="toc">Number tokens</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#arithmetic_promotion_rules" class="toc">Arithmetic promotion rules</a></span></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=discussion:numbers.html#int_and_uint_types" class="toc">int and uint types</a></span></li>
</ul>
</div>
</div>

<p>
(this is the discussion page for <a href="doku.php%3Fid=proposals:numbers.html" class="wikilink1" title="proposals:numbers" onclick="return svchk()" onkeypress="return svchk()">numbers</a>)
</p>

<a name="open_issues_july_2007"></a><h1>Open issues, July 2007</h1>
<div class="level1">

</div>

<a name="class_hierarchy_ticket_3"></a><h2>Class hierarchy (ticket 3)</h2>
<div class="level2">

<p>
 An older discussion item further down concludes that <code>Number</code> isn&rsquo;t a natural base class for <code>int</code>, <code>uint</code>, and <code>decimal</code>, but I think this understanding predates the introduction of the type <code>double</code> and also the full implications of the type <code>Numeric</code>.  So let&rsquo;s revisit the decision in full detail.
</p>

<p>
(Observe that at most <code>Number</code> is an unfortunate shorthand for its true nature, &ldquo;Real number&rdquo;.)
</p>

<p>
If <code>Number</code> is a nonfinal class and the other types subclass it, then <code>Number</code> will be used as the base class for new numeric types (bignum, complex, quaternions) even when these are not real numbers, and this is true whether the user adds them or the committee does &ndash; we&rsquo;re talking future-proofing here, and we need a consistent story.  Now this function: 
</p>
<pre class="code">
    function negative(x:Number) x &lt; 0;
</pre>

<p>
 must fail at run-time if passed a complex; no static type checking can fix that.  That&rsquo;s unfortunate.  The signature on that function has to do with traits of its argument, not subclass relationships.
</p>

<p>
On the opposite side, <code>Numeric</code> captures the traits of the built-in numbers by being defined as <code>(Number,int,uint,double,decimal)</code> but suffers from not being expandable, so the benefit of not being able to pass a complex to <code>negative()</code> is cancelled by the problem of not being able to pass a bignum either.  In addition, <code>Numeric</code> is a too-broad name, &ldquo;built-in real numbers&rdquo; would be more like it.
</p>

<p>
Perhaps we should use interfaces and go whole hog?
</p>
<pre class="code">
    interface Quaternion {}
    interface Complex {}
    interface Real {}

    class Number implements Real { ... }
    class int implements Real { ... }
</pre>

<p>
(where the language does not at present contain anything around Quaternions or Complexes).  The function interface becomes
</p>
<pre class="code">
    function negative(x: Real) x &lt; 0;
</pre>

<p>
and numeric types implement the desired interface. 
</p>
<hr noshade="noshade" size="1" />

<p>
Interfaces are not quite right, since they can&rsquo;t have static <a href="doku.php%3Fid=proposals:operators.html" class="wikilink1" title="proposals:operators" onclick="return svchk()" onkeypress="return svchk()">operator</a> functions. I&rsquo;m presuming <code>x &lt; 0</code> as the body of <code>negative</code> would use a <code>&lt;</code> operator appropriate to <code>Real</code>, but not by hardcoding that operator into the language &ndash; in other words, we would support bootstrapping and extensions at the same time, by self-hosting on top of the <a href="doku.php%3Fid=proposals:operators.html" class="wikilink1" title="proposals:operators" onclick="return svchk()" onkeypress="return svchk()">operators</a> proposal.
</p>

<p>
So far, we&rsquo;ve also avoided allowing interfaces to have generic method bodies. I think we would want those here, so both the current (evolving across Editions) set of number-like types and user extensions could share code maximally and not need to copy/paste or delegate to common helper classes or functions.
</p>

<p>
I will refrain from Scheme tower jokes <img src="lib/images/smileys/icon_razz.gif" align="middle" alt=":-P" />. But I would prefer to future-proof minimally. Not sure what that means, but I don&rsquo;t think it includes <code>Complex</code> as a base interface-like type. Sorry this comment is not that helpful; I&rsquo;ll keep noodling.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/07/18 14:37</em>
</p>

<p>
No operators are implied.  I&rsquo;m not convinced we want self-hosting here.  That said, I agree minimal future proofing is better than maximal.
</p>

<p>
I&rsquo;ve split the interfaces so that they do not form a hierarchy, because I don&rsquo;t think that hierarchy is all that useful.  As a consequence, the interfaces Complex and Quaternion would go away, we would not have to anticipate what the users might want.  But we might want to provide an interface <code>Numeric</code> (darn that word) that <code>Real</code> extends, and that <code>Complex</code> could extend too.  Don&rsquo;t know for sure.
</p>

<p>
Anyhow, we&rsquo;re not out of the woods, complexes done by the user aren&rsquo;t so easy:
</p>
<pre class="code">
    interface Complex extends Numeric {}

    class complex implements Complex {
        public static operator +(a, b): Numeric {
          // a could be real if b is complex...
          if (a is Real) {
            assert( b is Complex );
            return new complex( a + b.real, b.imag );
          }
          else {
            assert( a is Complex );
            if (b is Real)
              return new complex( a.real + b, b.imag );
            else if (b is Complex)
              return new complex( a.real + b.real, a.imag + b.imag );
            else  {
              // ouch!  Quaternions?  Vectors?  Matrices?  Probably we want to
              // convert a to the type of b and retry, but how to obtain the
              // class of b, and is that right anyway?
            }
          }
        }
        ...
    }
</pre>

<p>
Interestingly the problem is not really that extensions don&rsquo;t compose because our operators don&rsquo;t have type-based dispatch.  The problem is that for all the number types to play together they must &ldquo;know&rdquo; about each other in the sense that the rules for interconversions are clear.  Thus picking up two third-party numeric packages (complexes and matrices, say) the program must add code to both to allow interoperation and also to the base system to allow dispatch.  We provide for the latter with our operators; for the former, source code editing is required, or some sort of independent type-based dispatch (like generic functions).
</p>

<p>
All of this is just a way of getting to the point that it&rsquo;s not quite clear that the user can do something sensible with new number types unless we add a fair bit of machinery, so perhaps we should stop trying and choose something that has as little functionality as possible: a single interface type <code>Real</code> and built-in types that implement it.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/07/18 14:49</em>
</p>

</div>

<a name="overflow_handling_ticket_4"></a><h2>Overflow handling (ticket 4)</h2>
<div class="level2">

<p>
 Mike Cowlishaw argues (further down) that wrapping int (and uint?) arithmetic should signal an error.  Normally, of course, adding two ints will overflow to a double, so this does not apply, and ES3 has clear rules for how that double is truncated when it is used as the input to certain operations, and these rules probably can&rsquo;t be changed for backwards compatibility reason.  So any error signalling would only apply in &ldquo;use int&rdquo; or &ldquo;use uint&rdquo; mode, where the result type is always known.
</p>

<p>
(Discuss.)
</p>

</div>

<a name="pragmas_ticket_138"></a><h2>Pragmas (ticket 138)</h2>
<div class="level2">

<p>
 The pragmas are a blunt tool.  Too blunt?  Consider that we want to add two numbers <code>a</code> and <code>b</code> as integers yielding an integer in all cases (avoiding the question of wraparound for now).  We have several options:
</p>
<pre class="code">
    let t : int;
    { use int; t = a + b }
</pre>
<pre class="code">
    function intadd(x,y) { use int; return x+y }
    intadd(x,y)
</pre>

<p>
Or, assuming we have <code>int.intrinsic::+</code>,
</p>
<pre class="code">
    int.intrinsic::+(a,b)
</pre>

<p>
A better solution may be to be able to scope pragmas over expressions, not just blocks:
</p>
<pre class="code">
    let (use int) a+b
</pre>

<p>
What are the use cases for this?  Consider vector summing:
</p>
<pre class="code">
  function vadd(xs:[double]) {
    use uint;
    let sum:double = 0.0;
    for ( let i:uint=0 ; i &lt; xs.length ; i++ ) {
      use double;
      sum += xs[i];
    }
  }
</pre>

<p>
Without the outer pragma the increment of <code>i</code> needs an overflow check.  Without the inner pragma the elements would be converted to <code>uint</code>, clearly wrong.  So a cleaner solution would be:
</p>
<pre class="code">
  function vadd(xs:[double]) {
    use uint;
    let sum:double = 0.0;
    for ( let i:uint=0 ; i &lt; xs.length ; i++ ) 
      let (use double) sum += xs[i]
  }
</pre>

<p>
or even
</p>
<pre class="code">
  function vadd(xs:[double]) {
    let sum:double = 0.0;
    for ( let i:uint = 0 ; i &lt; xs.length ; let (use uint) i++ )
      sum += xs[i];
  }
</pre>

<p>
Now, in the latter case, this is almost as good:
</p>
<pre class="code">
  function vadd(xs:[double]) {
    let sum:double = 0.0;
    for ( let i:uint = 0 ; i &lt; xs.length ; i=uint.intrinsic::+(i,1) )
      sum += xs[i];
  }
</pre>

<p>
though the compiler will have to work a little harder to figure that out (it needs to inline the call).  It&rsquo;s slightly less clear.
</p>

</div>

<a name="exposing_primitives"></a><h2>Exposing primitives</h2>
<div class="level2">

<p>
 Should we provide access to eg <code>int.intrinsic::+</code> just like we provide access to the global <code>intrinsic::+</code>?
</p>

<p>
The function <code>int.intrinsic::+</code> is the operator that takes two ints and produces an int; it is exactly what is invoked in this code:
</p>
<pre class="code">
   {  use int;  x + y  }
</pre>

<p>
The argument in favor would be that the operation exists, and is useful; the argument against would be that it just adds complexity and that the functionality is available anyway (using the code just outlined).
</p>

<p>
Do not confuse these functions with user-defined operators; they are not.  They are just functions with operator-like names.  We&rsquo;d define them like this:
</p>
<pre class="code">
    intrinsic static function +(a, b) {
       use int;
       return a + b;
    }
</pre>

</div>

<a name="integer_division"></a><h2>Integer division</h2>
<div class="level2">

<p>
 Do we need an integer division (quotient) operator?  Or are we happy saying <code>let (use int) a / b</code> or even <code>int.intrinsic::/(a,b)</code>?  Neither of those two workarounds work for doubles or decimal, and they are not generic.
</p>

<p>
I propose that we add an operator which I will write <code>\\</code> which denotes integer division with: the operands are converted to a common representation by the normal algorithm, then rounded to integer, then divided, and the result is the integer quotient in the common representation.
</p>

</div>

<a name="future-proofing_no_ticket"></a><h2>Future-proofing (no ticket)</h2>
<div class="level2">

<p>
 Issues: bytes, bignums, complexes, and how the number type hierarchy interacts with these extensions, and how the pragmas do or don&rsquo;t work for us.
</p>

<p>
Consider that we add (for ES5) a type &ldquo;integer&rdquo; to represent bignums.  Then the DWIM mode will be something along &ldquo;use decimal; use integer;&rdquo;.  But do the current pragma rules 
</p>

<p>
(Discuss.)
</p>

</div>

<a name="math_operations_ticket_83"></a><h2>Math operations (ticket 83)</h2>
<div class="level2">

<p>
 Math operations should somehow be specialized to various numeric types: <code>abs()</code> on an int should produce an int, <code>floor()</code> on a decimal should produce a decimal, and so on.  What&rsquo;s the full list?  What are good (compatible) solutions?
</p>

</div>

<a name="misc"></a><h2>Misc</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Ticket 123: re-bindable <code>Number</code></div>
</li>
</ul>
<hr noshade="noshade" size="1" />

</div>

<a name="decimal_comparisons"></a><h1>Decimal Comparisons</h1>
<div class="level1">

<p>
 IEEE 754r has a multiplicity of comparison modes, some in which 3.0 != 3.000.  What should ES4 do?  There was some discussion of letting (3.0 == 3.000) == true but (3.0 === 3.000) == false.  The consensus of the committee was that this would confuse users.  Instead, we will add methods to the decimal class to allow some of the more esoteric comparison modes, e.g., the 754r concept of total ordering.
</p>

<p>
Comment: there&rsquo;s precedent for making &lsquo;strictly equals&rsquo; detect or not detect a difference in exponent (Java and Rexx do, C# does not).  If the underlying meaning of the operator is &lsquo;if the two operands are converted to a canonical string are those strings identical&rsquo; then the Java &amp; Rexx way is good.  But ES3&rsquo;s === operator is more devious that that, and has at least some numerical overtones, so I think I agree that 3.0===3.000 should give <strong>true</strong>.
</p>

<p>
Adding TotalOrder would be good.  And/or a way to extract the exponent of a decimal number (often handy).   &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/12/15 00:20</em>
</p>

</div>

<a name="odds_and_ends"></a><h1>Odds and ends</h1>
<div class="level1">

<p>
 I was toying with a function <code>parseNumeric</code> that returns the &ldquo;best&rdquo; type depending on the input, but it seems hard to specify it well and it&rsquo;s unclear what the gain is.
</p>

<p>
For symmetry it would be possible to do a function <code>parseNumber</code> which would be affected by <code>use decimal</code> and <code>use double</code> just like <code>Number</code> is.
</p>
<hr noshade="noshade" size="1" />

<p>
 Several questions from the trenches
</p>

<p>
1. Inside a &ldquo;use int&rdquo; (or uint) block, integer literals are affected, but floating point ones are not.  How do &ldquo;use &lt;numbertype&gt;&rdquo; statements nest? 
</p>
<pre class="code">use decimal;
if (test) 
{
  use int;
  ...
  x = 1.5;
}</pre>

<p>
 vs 
</p>
<pre class="code">use double;
  if (test)
  {
    use int;
    ...
    x = 1.5;
  }</pre>

<p>
 Is x given a decimal value in the first case and double in the second?  That&rsquo;s 1.5 assuming that assignment does not convert numeric operands to int.  Or is it supposed to end up with the value 1.0?
</p>
<pre class="code">Sense of committee is that they nest, and that the resulting value is 1.5, not 1.0</pre>

<p>
 (I would have expected a result of 1, as in item 4 below.  Or perhaps it might be better to flag as an error &ndash; since this is a constant probably some error has been made.  Quiet truncation is a not quite as bad as decapitation, but is part of the reason we added intValueExact() and friends to the Java 5 BigDecimal class. &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/12/06 00:39</em>)
</p>

<p>
2. Traditional conversion from double to int throws away the fractional part, essentially using the &ldquo;floor&rdquo; operator.  We&rsquo;ve added the &ldquo;use rounding&rdquo; pragma for decimal numbers.  Should this pragma be observed when converting a decimal number into an int or uint?  i.e., should intvar = 1.6m result in storing 1 or 2 into intvar with rounding HALF_UP?
</p>
<pre class="code">Sense of committee is that values are truncated</pre>

<p>
 3. Inside &ldquo;use uint&rdquo;, all operands are converted to uint.  Are negative ints converted to 0?
</p>
<pre class="code">We need input from Lars and Mike on this (also see what AS3 does)</pre>

<p>
 This applies to both doubles and decimals; the 754r committee went into this in some depth, looking a a wide set of hardware and software implementations.  The current draft says: 
</p>
<ul>
<li class="level1"><div class="li"> When a numeric operand would convert to an integer outside the range of the destination format, the invalid exception shall be signaled if this situation cannot otherwise be indicated.</div>
</li>
</ul>

<p>
 In other words, it&rsquo;s an error of some kind.   &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/12/06 00:20</em>
</p>

<p>
4. I believe that the following is true 
</p>
<pre class="code">var y:decimal = 1.7;
use rounding FLOOR; // if rounding mode affects conversion (see 2.0 above)</pre>
<pre class="code">if (test)
{
  use int;
  ...
  y = y + 1.5;
}</pre>

<p>
 at this point y == 2, since both the old value of y and the literal 1.5 will be converted to ints for the addition.
</p>
<pre class="code">Committee agrees this is the behavior</pre>

<p>
  &mdash; <em><a href="mailto:%26%23x73%3B%26%23x77%3B%26%23x65%3B%26%23x65%3B%26%23x74%3B%26%23x40%3B%26%23x61%3B%26%23x64%3B%26%23x6f%3B%26%23x62%3B%26%23x65%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x73;&#x77;&#x65;&#x65;&#x74;&#x40;&#x61;&#x64;&#x6f;&#x62;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">Dick Sweet</a> 2006/12/04 10:38</em>
</p>

<p>
5. I suspect that the default precision should be 34 (use full precision of decimal128).  What should the default value for rounding be?  I believe I read somewhere that banks use HALF_EVEN.
</p>
<pre class="code">Committee believes HALF_EVEN is proper default, or may be locale dependent</pre>

<p>
 I strongly recommend that it not be locale-dependendent, as then arithmetic results become locale-dependent, which would be an applications/testing nightmare.  The two reasonable options are HALF_EVEN or HALF_UP.  754r recommends HALF_EVEN, but allows HALF_UP for historical reasons (notably COBOL).  I would suggest HALF_EVEN.  &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/12/06 00:20</em>
</p>

<p>
6. Am I right to believe that precision doesn&rsquo;t affect parsing of constants?  Thus
</p>
<pre class="code">use precision 3;
var x:decimal = 123456; // ends up with x == 123456;
x = x + 0; // ends up with x == 123000;</pre>
<pre class="code">Committee wants Mike's opinion</pre>

<p>
 This one&rsquo;s a language issue, mainly.  In Rexx the precision does not affect constants because they are just strings until you carry out some operation on them, and that does seem to work well.  In other words, precision affects <em>Arithmetic operations</em>, not assignments, copies, etc.  That&rsquo;s probably a good rule if it does not conflict with the rest of the language.
</p>

<p>
(There would probably need to be an implicit limit at 34 digits, so any constant longer than that (rare!) would be rounded whatever the rule.)   &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/12/06 00:20</em>
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x73%3B%26%23x77%3B%26%23x65%3B%26%23x65%3B%26%23x74%3B%26%23x40%3B%26%23x61%3B%26%23x64%3B%26%23x6f%3B%26%23x62%3B%26%23x65%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x73;&#x77;&#x65;&#x65;&#x74;&#x40;&#x61;&#x64;&#x6f;&#x62;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">Dick Sweet</a> 2006/12/04 15:14</em>
</p>

</div>

<a name="discussion_of_type_hierarchy"></a><h1>Discussion of type hierarchy</h1>
<div class="level1">

<p>
 (This is older; not part of the proposal as such.)
</p>

<p>
The January 26 draft spec states that <code>Number</code>, <code>int</code>, and <code>uint</code> all are subtypes of <code>Object</code>.  This has come as a surprise to several, who expected there to be a subtype relationship. 
</p>
<ul>
<li class="level1"><div class="li"> <code>Number</code> values are IEEE double precision values</div>
</li>
<li class="level1"><div class="li"> <code>int</code> values are integers in the range -(2^31) .. (2^31)-1</div>
</li>
<li class="level1"><div class="li"> <code>uint</code> values are integers in the range 0 .. (2^32)-1</div>
</li>
</ul>

<p>
 We have also said that there should be conversions among these types.
</p>

<p>
The spec does not say whether these types are subclassable.  I am guessing that <code>Number</code> can be subclassed but <code>int</code> and <code>uint</code> cannot.
</p>

<p>
(The only justification for <code>int</code> and <code>uint</code> types is that they admit efficient processing and representation; ie, though they must fit into some general Object representation scheme (except in fully strict-mode implementations), they do not have to have the same representation as <code>Number</code>.)
</p>

<p>
In addition we have discussed adding a new type <code>Decimal</code> for base-10 floating point numbers; the set of values for this type is a superset of the values for <code>Number</code>.  For this type too we have said that there should be convertibility to the other numeric types.
</p>

<p>
On top of that we have added enough operator overloading machinery to the language that we can expect some users to wish to add new numeric data types (<code>Complex</code>).
</p>

<p>
So what should the type hierarchy be for numeric types?
</p>

</div>

<a name="flat_solution"></a><h2>Flat solution</h2>
<div class="level2">

<p>
 In the &ldquo;flat solution&rdquo; the world remains as it is today: every one of these types is a direct subtype of <code>Object</code>, and interconvertibility is handled with the equivalent of <code>to</code> operators on the types.  We need only define conversion rules from one type to the other.
</p>

<p>
User-defined numeric types define operators and <code>to</code> operators to allow this to work more or less seamlessly.
</p>

</div>

<a name="hierarchical_solution"></a><h2>Hierarchical solution</h2>
<div class="level2">

<p>
 In the &ldquo;hierarchical solution&rdquo; we place the number types in a hierarchy where more general types are closer to the top.
</p>

<p>
It is natural that <code>Number</code> is a base type for <code>int</code> and <code>uint</code>, given both their value sets and their names.  
</p>

<p>
However, neither <code>int</code> nor <code>uint</code> can be a base type of the other; they must(?) instead be interconvertible.  So both are sibling subtypes of <code>Number</code> and there must be special-case conversion rules among them.
</p>

<p>
Nor can <code>Decimal</code> be a subtype of <code>Number</code>, since it contains a superset of values held by <code>Number</code>.  It&rsquo;s really the other way around: <code>Number</code> must be a subtype of <code>Decimal</code>.  Yet the name <code>Number</code> suggests a most general type for numbers, and it&rsquo;s pretty peculiar to suggest that the other number types are subtypes of &ldquo;decimal&rdquo; numbers.
</p>

<p>
Some of the confusion comes from poor choices for the type names: <code>Number</code> when we mean <code>double</code>; <code>Decimal</code> when we mean <code>Base-10 floating point</code>.  Some choices can&rsquo;t be helped for historical reasons.  But it makes it hard to construct a reasonable hierarchy here.
</p>

<p>
The subclass relationship would also introduce assumptions about eg preserving object identity and dynamic properties.  Suppose I have an <code>int</code> object that I store in a <code>Number</code> variable.  If <code>int</code> is represented as an efficient machine type then this really is a type of conversion.  This may be visible.  Consider:
</p>
<pre class="code">
  var a:int=10; 
  var b:Number=a, c:Number=a; 
  a === b;
</pre>

<p>
Here I would expect <code>true</code>, and since <code>Number</code> is a dynamic class I would expect that if I add properties to <code>b</code> then they would become visible through <code>c</code>.  I think this is reasonable; it follows from the general object model of the language.
</p>

</div>

<a name="parameterized_types"></a><h2>Parameterized types</h2>
<div class="level2">

<p>
 Parameterized types do not figure into this.  <code>Array.&lt;int&gt;</code> is not a subtype of <code>Array.&lt;Number&gt;</code> even if <code>int</code> is a subtype of <code>Number</code>, and there is no way to use the parameterized type system to express operations that will take &ldquo;some numeric type&rdquo; as an argument by relying on a type hierarchy below <code>Number</code>.  It is possible to instantiate a class with a concrete type, of course, but that ability does not depend on one structure or the other for numbers.
</p>

</div>

<a name="conclusion"></a><h2>Conclusion</h2>
<div class="level2">

<p>
 A flat model seems most natural for ECMAScript, with ad-hoc conversions among the types.  
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/05/23 05:06</em>
</p>

</div>

<a name="understanding_use_numbertype_in_terms_of_namespaces"></a><h1>Understanding &quot;use &lt;numbertype&gt;&quot; in terms of namespaces</h1>
<div class="level1">

<p>
 The effect of <code>use &lt;numbertype&gt;</code> can be expressed in terms of system-internal namespaces.  In the following, imagine there are system-internal namespaces <code>#decimal</code>, <code>#double</code>, <code>#int</code>, and <code>#uint</code>.   
</p>

</div>

<a name="number"></a><h3>''Number''</h3>
<div class="level3">

<p>
 The four internal namespaces all contain a binding for the name <code>Number</code>: in the <code>#decimal</code> namespace <code>Number</code> maps to <code>decimal</code>; in the <code>#double</code> namespace it maps to <code>double</code>; and so on.  The effect of <code>use double</code> on <code>Number</code> is thus the same as <code>use namespace #double</code>:
</p>
<pre class="code">
    {    use double; 
         Number(x);
    }
</pre>

<p>
becomes
</p>
<pre class="code">
    {    use namespace #double;
         Number(x);  // resolves as #double::Number(x)
    }
</pre>

</div>

<a name="operators"></a><h3>Operators</h3>
<div class="level3">

<p>
 For the interpretation of operators, assume that operators are represented in the environment just in the same way that <code>Number</code> is, and that there are bindings for all operators in all four system-internal namespaces.  In the <code>#double</code> namespace, the operators convert their arguments to <code>double</code> and produce <code>double</code> results; in the <code>#int</code> namespace they convert their arguments to <code>int</code> and produce <code>int</code> results; and so on:
</p>
<pre class="code">
    {    use double; 
         x + y
    }
</pre>

<p>
becomes
</p>
<pre class="code">
    {    use namespace #double;
         x + y   // resolves as #double::+(x,y)
    }
</pre>

</div>

<a name="literals"></a><h3>Literals</h3>
<div class="level3">

<p>
 For the interpretation of literals, the main rule is: 
</p>
<ul>
<li class="level1"><div class="li"> number literals that are suffixed with a type character are never subject to interpretation dependent on the selected number type</div>
</li>
<li class="level1"><div class="li"> number literals that are not so suffixed are always subject to interpretation</div>
</li>
</ul>

<p>
 An interpretation can be phrased in terms of namespaces by imagining that there exist system-internal functions called <code>#uintValue</code> and <code>#floatValue</code> that take constant strings as input and produce numbers as output.  The names of these functions describe the argument type, not the return type: <code>#uintValue</code> takes a string that looks like an unsigned integer; <code>#floatValue</code> takes a string that looks like a floating-point (non-integer) number.  Imagine further that the parser rewrites all nonsuffixed literals as calls to these functions:
</p>
<pre class="code">
    3.5 + -76
</pre>

<p>
becomes
</p>
<pre class="code">
    #floatValue(&quot;3.5&quot;) + -#uintValue(&quot;76&quot;)
</pre>

<p>
The <code>#int</code> and <code>#uint</code> namespaces contain bindings for <code>#uintValue</code> that return <code>int</code> and <code>uint</code> values respectively.
</p>

<p>
The <code>#double</code> and <code>#decimal</code> namespaces contains bindings for both <code>#uintValue</code> and <code>#floatValue</code>; these return <code>double</code> and <code>decimal</code> values respectively depending on the namespace.
</p>

<p>
Then
</p>
<pre class="code">
    {
        use decimal;
        x = 3;
        y = Number(x) + 4.5;
        {
            use int;
            z = 10.5m;
        }
    }
</pre>

<p>
is expressed as
</p>
<pre class="code">
    {
        use namespace #decimal;
        x = #uintValue(&quot;3&quot;);                   // 3m
        y = Number(x) + #floatValue(&quot;4.5&quot;);    // decimal(x) + 4.5m
        {
            use namespace #int;
            z = 10.5m;                        // 10.5m even if ''use int'' is in effect
        }
    }
</pre>

</div>

<a name="shadowing"></a><h3>Shadowing</h3>
<div class="level3">

<p>
 Note that <code>use int</code> and <code>use uint</code> do not provide a new meaning for <code>#floatValue</code>; this meaning depends on settings in the nesting scopes.  So if the nesting scope has <code>use decimal</code>, floating point literals are still interpreted as decimal.  This is by design.
</p>

</div>

<a name="initial_namespace"></a><h3>Initial namespace</h3>
<div class="level3">

<p>
 There is a system-initial namespace (not one of the four) that contains bindings for <code>Number</code>, the operators, and the literal functions that are compatible with 3rd Edition.  In particular:
</p>
<ul>
<li class="level1"><div class="li"> the class name of <code>Number</code> really is <code>Number</code> (visible through <code>toString</code> on the class object)</div>
</li>
<li class="level1"><div class="li"> the operators perform conversion and produce a result that depend on their input types</div>
</li>
<li class="level1"><div class="li"> <code>#uintValue</code> produces a <code>uint</code> and <code>#floatValue</code> produces a <code>double</code></div>
</li>
</ul>
<hr noshade="noshade" size="1" />

<p>
Shouldn&rsquo;t Use perhaps also affect the interpretation of unembellished constants?  i.e., in the example above the 3 be treated as 3m and 4.5 as 4.5m?  
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/05/29 23:43</em>
</p>

<p>
Thanks.  I&rsquo;ve tried to tighten up the prose and fix some bugs in the description.
</p>

<p>
At the May f2f there was some discussion about whether the expansion suggested above can capture all it needs to capture.  I&rsquo;m not aware of holes, but it feels pretty artificial, and I&rsquo;m unsure if it describes what we want.  Perhaps I should go for a less operational approach when describing this, or write up more requirements for the system.  For example, I might expect that the addition in this program:
</p>
<pre class="code">
    {    use int;
         3.5m + 4m;
    }
</pre>

<p>
is a decimal addition, but the way the spec&rsquo;s written it is not.  What behavior do we think is best here?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/05/30 02:58</em>
</p>

</div>

<a name="number_tokens"></a><h3>Number tokens</h3>
<div class="level3">

<p>
 I generally like the suffix rules, but I don&rsquo;t think you should ever consider 0xNNNd as a (formed or malformed) decimal-suffix. Really I don&rsquo;t think it helps with clarity to say that all suffixes are &ldquo;accepted&rdquo;, but some of those are &ldquo;invalid&rdquo;. What&rsquo;s the utility of accepted-but-invalid? None I can see; just define the valid lexemes explicitly.
</p>

<p>
For example, I think we should just define the hex-literal lexeme as 0x[a-fA-F0-9]+[ui]? and the representation, if it parses, is therefore always unsigned or signed. I think the digit-counting rule proposed in the TODO is not a good idea, nor is denoting decimal  floating point values by hex value a valuable use-case. If there are a few strange cases you need it for, I think it would be more appropriate to defer to a host utility function that composes, say, 4 32-bit uints bitwise into a decimal, and a symmetric operation that decomposes a decimal back to 4 32-bit uints.
</p>

<p>
We discussed this in today&rsquo;s phone call and there was general agreement on this point.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/09/06 10:26</em>
</p>

<p>
I agree.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/09/13 07:57</em>
</p>

</div>

<a name="arithmetic_promotion_rules"></a><h3>Arithmetic promotion rules</h3>
<div class="level3">

<p>
 I find the (a) and (b) conditions for operand-promotion not entirely clear in their phrasing. Rewrite as nested lists of conditions:
</p>
<ul>
<li class="level1"><div class="li"> If there is a &lsquo;use &lt;number&gt;&rsquo; pragma:</div>
<ul>
<li class="level2"><div class="li"> all operands are converted to &lt;number&gt;</div>
</li>
<li class="level2"><div class="li"> the expression result is &lt;number&gt;, even if it involves precision loss</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> If there is no &lsquo;use &lt;number&gt;&rsquo; pragma:</div>
<ul>
<li class="level2"><div class="li"> operands are converted to a common representation that loses the least precision.</div>
</li>
<li class="level2"><div class="li"> once a common operand representation is chosen for the operands:</div>
<ul>
<li class="level3"><div class="li"> if the operands are double, the result is double</div>
</li>
<li class="level3"><div class="li"> if the operands are decimal, the result is decimal</div>
</li>
<li class="level3"><div class="li"> if the operands are int and the result is representable as an int without loss of precision, the result is an int.</div>
</li>
<li class="level3"><div class="li"> if the operands are uint and the result is representable as an uint without loss of precision, the result is an uint.</div>
</li>
<li class="level3"><div class="li"> else the result is a double</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>
  &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/09/06 10:36</em>
</p>

<p>
I agree that the phrasing in the proposal is not very good.  I like yours better, though it is slightly incorrect: in the no-pragma case the first rule is too open-ended (a nonnegative int can be converted to any of the other three representations by this rule, and there may be hard cases regarding whether to convert a double to decimal or a decimal to double is best, given that 128-bit decimal can&rsquo;t represent all doubles).  Thus I believe we need to impose an explicit ordering here. 
</p>
<ul>
<li class="level1"><div class="li"> operands are converted to a common representation by choosing the first of the following rules :</div>
<ul>
<li class="level2"><div class="li"> If one operand is decimal, the other is converted to decimal</div>
</li>
<li class="level2"><div class="li"> If one operand is double, the other is converted to double</div>
</li>
<li class="level2"><div class="li"> (Otherwise, one operand is uint and the other is int.)  If the int is nonnegative then it is converted to uint.  Otherwise both operands are converted to double.</div>
</li>
</ul>
</li>
</ul>

<p>
  &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x6f%3B%26%23x70%3B%26%23x65%3B%26%23x72%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x6f;&#x70;&#x65;&#x72;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">Lars T Hansen</a> 2006/09/13 07:57</em>
</p>

<p>
Agreed. Loose wording on my part; and unforgivable considering the hundred-or-so email thread the 754r group has just emerged from regarding the use of the word &ldquo;number&rdquo; in the spec :)
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/09/13 10:01</em>
</p>

</div>

<a name="int_and_uint_types"></a><h1>int and uint types</h1>
<div class="level1">

<p>
 I was wondering what the rationale was for adding the <code>int</code> and <code>uint</code> types; given the ease-of-use and expected users of the language, int types are really rather dangerous because they fail quietly (notably quiet overflows, where ading two positive numbers can result in a negative number).  See, for specific examples (from Michael Howard&rsquo;s blog): 
</p>
<ul>
<li class="level1"><div class="li"> <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dncode/html/secure04102003.asp" class="urlextern" target="_blank" title="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dncode/html/secure04102003.asp" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Reviewing Code for Integer Manipulation Vulnerabilities</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://msdn.microsoft.com/library/en-us/dncode/html/secure01142004.asp" class="urlextern" target="_blank" title="http://msdn.microsoft.com/library/en-us/dncode/html/secure01142004.asp" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">Integer Handling with the C++ SafeInt Class</a></div>
</li>
<li class="level1"><div class="li"> 19 Deadly Sins of Software Security (Howard, LeBlanc and Viega) chapter 3 – Integer Arithmetic Issues</div>
</li>
<li class="level1"><div class="li"> Secure Coding in C and C++ (Seacord) Chapter 5 Integer Security (also available as a <a href="http://www.awprofessional.com/content/images/0321335724/samplechapter/seacord_ch05.pdf" class="urlextern" target="_blank" title="http://www.awprofessional.com/content/images/0321335724/samplechapter/seacord_ch05.pdf" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">sample chapter</a>).</div>
</li>
</ul>

<p>
 All the values in these two types are a proper subset of both the binary number type and the decimal type.  The decimal type is unnormalized, too, so integer arithmetic is available directly there and has the &lsquo;look and feel&rsquo; of true integer arithmetic.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/10/31 00:46</em>
</p>

<p>
I think there is a fraction of the user community who wish to do &ldquo;bit twiddling&rdquo; as fast as possible. People do actually write code to process raster images, sound, cryptographic primitives, etc. in this language and in some contexts (eg. actionscript) I think they expect to have a smart compiler do things like produce optimized monomorphic <code>uint</code> arrays. Maybe I&rsquo;m exaggerating, it&rsquo;s just the impression I got (and the motivation I&rsquo;ve been working under). 
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/11/01 10:51</em>
</p>

<p>
OK .. so who/where are these people?  <img src="lib/images/smileys/icon_smile.gif" align="middle" alt=":-)" />   If one is really concerned about fast-as-possible bit-twiddling one is going to use C or Assembler, surely.   &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/11/01 13:10</em>
</p>

<p>
I&rsquo;m thinking that the AS3 AVM+ will have its JIT emit native machine instructions for integer arithmetic (etc) if it can decide at compile-time that only integers are involved in an expression. (Someone correct me if I&rsquo;m wrong...)  &mdash; <em><a href="mailto:%26%23x73%3B%26%23x74%3B%26%23x65%3B%26%23x6a%3B%26%23x6f%3B%26%23x68%3B%26%23x6e%3B%26%23x73%3B%26%23x40%3B%26%23x61%3B%26%23x64%3B%26%23x6f%3B%26%23x62%3B%26%23x65%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x73;&#x74;&#x65;&#x6a;&#x6f;&#x68;&#x6e;&#x73;&#x40;&#x61;&#x64;&#x6f;&#x62;&#x65;&#x2e;&#x63;&#x6f;&#x6d;">Steven Johnson</a> 2006/11/01 13:42</em>
</p>

<p>
Mike: alas, one cannot use C/asm and expect the program to be deliverable to a user just by having them type a <acronym title="Uniform Resource Locator">URL</acronym> into a browser. Yet this is what the language may be able to provide: sharp tools like machine arithmetic at a decent speed, hosted in a safe, portable and ultra-convenient execution environment.  &mdash; <em><a href="mailto:%26%23x67%3B%26%23x72%3B%26%23x61%3B%26%23x79%3B%26%23x64%3B%26%23x6f%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x67;&#x72;&#x61;&#x79;&#x64;&#x6f;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x63;&#x6f;&#x6d;">graydon</a> 2006/11/01 17:22</em>
</p>

<p>
Well, that&rsquo;s exactly my concern &ndash; sharp tools have dangers as well as advantages, and these types introduce a particularly subtle danger that doesn&rsquo;t exist in the E3 language. &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/11/02 00:25</em>
</p>

<p>
The sharpness is less than in memory-unsafe languages.  You can&rsquo;t index out of bounds, or under-allocate due to sizeof-scaling overflow. True, you may wrap a <code>uint</code> and overwrite index 0 again, or wrap <code>int</code> to -(2^31). But you won&rsquo;t corrupt memory or make an exploitable security hole.
</p>

<p>
Some uses for <code>int</code> and <code>uint</code> we know will be popular, which should not require writing C or C++ plugins (which are inevitably banished to a plugin-prison rectangle): 2D and 3D graphics screen and even world coordinates; RGBA and similar colors packed in <code>uint</code>s.  Since these types are novel and not default, I don&rsquo;t think they will see unwarranted use. The use-cases that drove their introduction into Waldemar&rsquo;s spec, JScript.NET, and especially ActionScript in the FlashPlayer are worth supporting.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2006/11/02 10:01</em>
</p>

<p>
OK, I am almost convinced.  But not on &ldquo;won&rsquo;t ... make an exploitable security hole&rdquo; ... see the links near the top of this section for some examples.
</p>

<p>
I believe the unpleasant effects go away if a &lsquo;wrap&rsquo; of an int during arithmetic becomes some type of exception or overflow.  The performance cost is negligible (typically a single compare and test after an operation) &ndash; and the types could then become extendable (later) to user-defined integer ranges, which would be really handy.  
</p>

<p>
Another approach would be to use explict binary types only for interfacing to external modules, and not for arithmetic.  [Apologies if this is covered in the use cases you refer to, I could not find them after some searching.]
</p>

<p>
This is the approach I took in NetRexx, btw &ndash; arithmetic in the scripting language is always safe.  Conversions to restricted ranges (such as ints and uints of various sizes) are automatic when calling functions/methods that expect those types.  But any unsafe conversion (Inexact in any sense) raises an exception.  This gives one complete access to existing libraries with essentially no restrictions.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x4d%3B%26%23x46%3B%26%23x43%3B%26%23x40%3B%26%23x75%3B%26%23x6b%3B%26%23x2e%3B%26%23x69%3B%26%23x62%3B%26%23x6d%3B%26%23x2e%3B%26%23x63%3B%26%23x6f%3B%26%23x6d%3B" class="mail" title="&#x4d;&#x46;&#x43;&#x40;&#x75;&#x6b;&#x2e;&#x69;&#x62;&#x6d;&#x2e;&#x63;&#x6f;&#x6d;">Mike Cowlishaw</a> 2006/11/07 12:22</em> 
</p>
<blockquote>
 OK, I am almost convinced.  But not on &ldquo;won&rsquo;t ... make an exploitable security hole&rdquo; ... see the links near the top of this section for some examples.</blockquote>

<p>
 I&rsquo;m painfully aware of those problems in C++ and C, but if ES4 implementations lack memory safety due to silent wrapping on integer overflow, those are implementation bugs. The spec does not require memory-unsafe accesses of any kind, under any circumstances.
</p>

<p>
But your point about overflow exceptions is well-taken and I see it was raised higher up in this page. I&rsquo;ll help keep it on the agenda.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/07/18 14:44</em>
</p>

</div>

<!-- no cachefile used, but created -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        discussion/numbers.txt &middot; Last modified: 2007/07/20 04:42 by lars      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="discussion:numbers" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="discussion:numbers" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="discussion:numbers" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="discussion:numbers" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=discussion:numbers.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=discussion%253Anumbers&amp;1454275585" width="1" height="1" alt=""  /></body>
</html>
