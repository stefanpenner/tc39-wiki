<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <title>strawman:subclassable-builtins [ES Wiki]</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=strawman:subclassable-builtins&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=strawman" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=strawman:subclassable-builtins&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=strawman:subclassable-builtins&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="date" content="2012-07-18T21:03:38+0000" />
  <meta name="robots" content="index,follow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />

  <link rel="shortcut icon" href="lib/images/favicon.ico" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/layout.css" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/tpl/default/design.css" />

  
  <link rel="stylesheet" media="print" type="text/css" href="lib/tpl/default/print.css" />

  <!--[if gte IE 5]>
  <style type="text/css">
    /* that IE 5+ conditional comment makes this only visible in IE 5+ */
    /* IE bugfix for transparent PNGs */
    //DISABLED   img { behavior: url("/lib/scripts/pngbehavior.htc"); }
  </style>
  <![endif]-->

  </head>

<body>
<div class="dokuwiki">
  
  <div class="stylehead">

    <div class="header">
      <div class="pagename">
        [[<a href="doku.php%3Fid=strawman:subclassable-builtins&amp;do=backlink.html" onclick="return svchk()" onkeypress="return svchk()">strawman:subclassable-builtins</a>]]
      </div>
      <div class="logo">
        <a href="doku.php%3Fid=.html" onclick="return svchk()" onkeypress="return svchk()" name="top" accesskey="h" title="[ALT+H]">ES Wiki</a>      </div>
    </div>
  
    
    <div class="bar" id="bar_top">
      <div class="bar-left" id="bar_topleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="strawman:subclassable-builtins" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:subclassable-builtins" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
  
      <div class="bar-right" id="bar_topright">
        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="recent" /><input type="hidden" name="id" value="" /><input type="submit" value="Recent changes" class="button" title="ALT+R" accesskey="r" /></form>        <form action="doku.php%3Fid=.html" accept-charset="utf-8" class="search" name="search" onsubmit="return svchk()"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch_in" accesskey="f" name="id" class="edit" onkeyup="ajax_qsearch.call('qsearch_in','qsearch_out')" /><input type="submit" value="Search" class="button" /><div id="qsearch_out" class="ajax_qsearch" onclick="this.style.display='none'"></div></form>&nbsp;
      </div>
    </div>

        <div class="breadcrumbs">
      Trace: <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:attach.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:attach">attach</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:terminology.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:terminology">terminology</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:unicode_support.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:unicode_support">unicode_support</a> <span class="bcsep">&raquo;</span> <a href="doku.php%3Fid=strawman:identifier_identification.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:identifier_identification">identifier_identification</a> <span class="bcsep">&raquo;</span> <span class="curid"><a href="doku.php%3Fid=strawman:subclassable-builtins.html" onclick="return svchk()" onkeypress="return svchk()" class="breadcrumbs" title="strawman:subclassable-builtins">subclassable-builtins</a></span>          </div>
    
  </div>
  
  
  <div class="page">
    <!-- wikipage start -->
    <div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="level1"><span class="li"><a href="doku.php%3Fid=strawman:subclassable-builtins.html#subclassing_built-in_constructors" class="toc">&quot;Subclassing&quot; Built-in Constructors</a></span><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:subclassable-builtins.html#private_internal_data_properties" class="toc">Private Internal Data Properties</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:subclassable-builtins.html#initializing_subclass_internal_data_properties" class="toc">Initializing Subclass Internal Data Properties.</a></span></li>
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:subclassable-builtins.html#implementation_considerations_for_internal_data_properties" class="toc">Implementation Considerations for Internal Data Properties</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:subclassable-builtins.html#internal_methods" class="toc">Internal Methods</a></span><ul class="toc">
<li class="level3"><span class="li"><a href="doku.php%3Fid=strawman:subclassable-builtins.html#function_subclasses" class="toc">Function Subclasses</a></span></li>
</ul>
</li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=strawman:subclassable-builtins.html#making_subclassed_built-ins_useful" class="toc">Making Subclassed Built-ins Useful</a></span></li>
</ul>
</li>
</ul>
</div>
</div>

<a name="subclassing_built-in_constructors"></a><h1>&quot;Subclassing&quot; Built-in Constructors</h1>
<div class="level1">

<p>
 A historic limitation of ECMAScript has been the inability to create fully functional &ldquo;subclasses&rdquo; of the abstractions defined by most of the built-in constructors in Chapter 15.  While this is commonly referred to as a &ldquo;subclassing&rdquo; problem it is really about how prototypal inheritance works and how built-in ECMAScript objects are specified and constructed.
</p>

<p>
Examples of the problem:
</p>

<p>
ES programmers probably most frequently encounter this problem with ES Arrays (see <a href="http://perfectionkills.com/how-ecmascript-5-still-does-not-allow-to-subclass-an-array/" class="urlextern" target="_blank" title="http://perfectionkills.com/how-ecmascript-5-still-does-not-allow-to-subclass-an-array/" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">http://perfectionkills.com/how-ecmascript-5-still-does-not-allow-to-subclass-an-array/</a> ).  For example, consider the following console session:
</p>
<pre class="code javascript">&gt;function MyArray<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><span class="br0">&#125;</span>
&gt;MyArray.<span class="me1">prototype</span>.__proto__ = Array.<span class="me1">prototype</span>;
&gt;var ma = <span class="kw2">new</span> MyArray;
&gt;ma<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span>=<span class="nu0">0</span>;
<span class="nu0">0</span>
&gt;ma<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span>=<span class="nu0">1</span>;
<span class="nu0">1</span>
&gt;ma.<span class="me1">length</span>
<span class="nu0">0</span>
&gt;ma.<span class="me1">hasOwnProperty</span><span class="br0">&#40;</span><span class="st0">"length"</span><span class="br0">&#41;</span>
<span class="kw2">false</span>
&gt;ma.<span class="me1">forEach</span><span class="br0">&#40;</span><span class="kw2">function</span><span class="br0">&#40;</span>v<span class="br0">&#41;</span> <span class="br0">&#123;</span>console.<span class="me1">log</span><span class="br0">&#40;</span>v<span class="br0">&#41;</span><span class="br0">&#125;</span><span class="br0">&#41;</span>;
---no console output
&gt;ma.<span class="me1">forEach</span>
<span class="kw2">function</span> forEach<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="br0">&#91;</span>native code<span class="br0">&#93;</span> <span class="br0">&#125;</span></pre>
<p>
This example, defines a constructor that creates objects that inherit form Array.prototype.  But those objects don&rsquo;t automatically get their own length property, like built-in array objects.  Array index properties can be added, but doing so does not also add or update the length properties.  Array methods such as toString and forEach can be called but because they depend upon the length property, they don&rsquo;t produce the same result as for a built-in array.
</p>

<p>
You can see a similar problem with other built-ins, such as Date.
</p>
<pre class="code javascript">&gt;function MyDate<span class="br0">&#40;</span>timeValue<span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">this</span>.<span class="me1">setTime</span><span class="br0">&#40;</span>timeValue<span class="br0">&#41;</span>; <span class="br0">&#125;</span>
&gt;MyDate.<span class="me1">prototype</span>.__proto__ = Date.<span class="me1">prototype</span>;
&gt;var md = <span class="kw2">new</span> MyDate<span class="br0">&#40;</span>Date.<span class="me1">now</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;
TypeError on line <span class="nu0">3</span>: Date.<span class="me1">prototype</span>.<span class="me1">setTime</span> called on incompatible Object</pre>
</div>

<a name="private_internal_data_properties"></a><h2>Private Internal Data Properties</h2>
<div class="level2">

<p>
A <em>internal property</em> is defined by  <a href="http://ecma-international.org/ecma-262/5.1/#sec-8.6" class="urlextern" target="_blank" title="http://ecma-international.org/ecma-262/5.1/#sec-8.6" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">ES5.1, 8.6</a>: &ldquo;An internal property has no name and is not directly accessible via ECMAScript language operators. Internal properties exist purely for specification purposes.&rdquo;  In other words, an internal property is not a property at all.  Instead it is a way for specifying that some additional state (that is not directly accessible as a property) is encapsulated by an object.  It is left up to ECMAScript implementations to determine how to actually represent and access that state. Internal properties have none of the regular characteristics of ECMAScript object properties.  In particular, they are not accessible using [[Get]] and they are not inherited using the [[Prototype]] chain. Internal data properties give implementation flexibility in how they represent the corresponding internal state of built-in object instances.  For example, a specific internal property might be represented as a field in a C++ struct that is the runtime representation of a specific kind of built-in object.  In that case, built-in methods would probably access the state corresponding to the internal property via direct C++ field access instead of the generalized ECMAScript property access mechanism. However, such a choice creates a direct coupling between the object representation (the shape of the struct) and the methods that access the internal properties.  If a method that expects some internal property to exist as a specific struct field was applied to an object that was represented using a differently shaped struct a unsafe memory access might occur.  In order to avoid this possibility all such methods need to ensure that they being applied to only the exact kind of object that they designed to operate upon. 
</p>

<p>
Such checks are explicit in the ES specification in many places where internal data properties are used. For example, he Date sample above throws a TypeError because of specification requirements given in <a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.5" class="urlextern" target="_blank" title="http://ecma-international.org/ecma-262/5.1/#sec-15.9.5" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">ES5.1 15.9.5 Properties of the Date Prototype Object</a>: 
</p>
<blockquote>
&ldquo;...properties of the Date prototype object... none of these functions are generic; A TypeError exception is thrown if the this value is not an object for which the value of the [[Class]] internal properties is &ldquo;Date&rdquo;. Also, the phrase &ldquo;this time value&rdquo; refers to ...the value of the [[PrimitiveValue]] internal property of this Date object.&rdquo;</blockquote>

<p>
 All ECMAScript objects are required to have a [[Class]] internal property, but all user defined constructors, such as MyDate in the sample, create objects  whose [[Class]] internal property has the value &ldquo;Object&rdquo;.  So, by specification, all of the built-in methods of the Date prototype object must throw if invoked as methods (via inheritance, using call/apply functios, or by direct assignment to a property value)  on any user defined object.  Hence,  the first step to making Date &ldquo;subclassable&rdquo; must be to remove this [[Class]]==&rdquo;Date&rdquo; requirement from the specification of the Date prototype methods  (or alternatively allow user defined constructors to set an object&rsquo;s [[Class]] internal value, but that would be unsafe).  Before we can safely do this, we need to look closely at the real intent of the requirement.  What the [[Class]] test is doing is making sure that the <strong>this</strong> object of a method call is an object that was created by the built-in Date constructor.  What is it that is unique about such objects?  The answer is given in the last sentence of the above quote from 15.9.5.  Objects created by the Date constructor all have a [[DatePrimitiveValue]]<a href="doku.php%3Fid=strawman:subclassable-builtins.html#fn1" name="fnt1" class="fn_top" onmouseover="fnt('1', this, event);">1)</a> internal property that contains the &ldquo;time value&rdquo; of the date and all of the Date prototype methods access and/or set the [[DatePrimitiveValue]] of the <strong>this</strong> objects that the methods are invoked upon.  The [[DatePrimitiveValue]] property containing a time value is the only thing that is fundamentally different between Date instance objects and any normal user constructed object. 
</p>

<p>
So, the real purpose of the [[Class]]==&rdquo;Date&rdquo; precondition is to make sure that methods that reference the [[DatePrimitiveValue]] internal property are only applied to object that actually have that internal property.  The 15.9.5 requirement could be restated as: A TypeError is thrown if the this value is not an object that has a [[DatePrimitiveValue]] internal property.  If such a change was make to the ES5.1 specification it would have no impact upon current ECMAScript implementations or any existing ECMAScript code.  However, even with such a change Date objects would still not be subclassable because the subclass objects still would not have a [[DatePrimitiveValue]] internal property.  For Date to be subclassable, it must be possible for the subclasses to acquire the [[DatePrimtiiveValue]] internal property that inherited Data prototype methods depend up.
</p>

</div>

<a name="initializing_subclass_internal_data_properties"></a><h3>Initializing Subclass Internal Data Properties.</h3>
<div class="level3">

<p>
In a c-style class-based language, subclass instance initialization often includes the initialization of superclass defined instance invariants. This is usually accomplished by having the subclass constructor invoke a superclass constructor on the subclass instance. Hoswever, because of the static natures of such languages the complete &ldquo;shape&rdquo; of an instance, including private superclass fields can be determined prior to instance allocation.
</p>

<p>
Subclass initialization might be expressed in a similar manner for ECMAScript. For example, using the proposed ECMAScript <a href="doku.php%3Fid=strawman:maximally_minimal_classes.html" class="wikilink1" title="strawman:maximally_minimal_classes" onclick="return svchk()" onkeypress="return svchk()">maximally minimal classes</a> syntax you might expect to see something like:
</p>
<pre class="code javascript"><span class="kw2">class</span> MyDate <span class="kw2">extends</span> Date <span class="br0">&#123;</span>
   constructor<span class="br0">&#40;</span>...<span class="me1">args</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
      <span class="kw2">super</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
      <span class="co1">//process args to further initialize the MyDate instance</span>
   <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
<p>
 In this example, the <code><strong>super</strong>()</code> call invokes the <code>Date</code> constructor as a function with the the <code>new MyDate</code> instance as its <strong>this</strong> value.  The <code>Date</code> constructor presumably should establish all invariants that are needed to invoke inherited <code>Date.prototype</code> methods on the <code>MyDate</code> instance. 
</p>

<p>
In traditional ECMAScript, the same idea might be expressed by code that looks like this:
</p>
<pre class="code javascript"><span class="kw2">function</span> MyDate<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
   Date.<span class="me1">call</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span>;
   <span class="co1">//process the arguments object to further initialize the MyDate instance</span>
<span class="br0">&#125;</span>
MyDate.<span class="me1">prototype</span>.__proto__ = Date.<span class="me1">prototype</span>;</pre>
<p>
This should accomplish exactly the same thing, if it worked at all.  However, the current ES5.1 specification of the Date constructor prevents either of these formulations from work.  The constructor specification has several issue in this regard.
</p>

<p>
The first issue is that under the current specification, calling the <code>Date</code> constructor as a function doesn&rsquo;t initialize its <strong>this</strong> object as a <code>Date</code> instance in the same manner that the Date constructor does when invoked as part of a <code>new</code> expression.  Instead, it does something completely different, it returns a string representation of a date!  This is a general problem with several of the current built-in ECMAScript constructors, when called as functions some of then do things that are unrelated to instance initialization. However, at least for the <code>Date</code> constructor, there appears to be a way to correct this problem.  Under the current specification the Date constructor, when called as a function completely ignores the <strong>this</strong> value that is passed to it.  In practice the <code>Date</code> function is seldom, if ever, called as a method on some other object.  So, in current applications the <strong>this</strong> value is normally the value <strong>undefined</strong> when <code>Date</code> is called as a function.  This fact can be used to obtain the required initialization behavior while still maintaining backwards compatibility with code that calls <code>Date</code> as a function.  Its specification can be changed such that the behavior remains as specified in ES5.1 if the <strong>this</strong> object is <strong>undefined</strong> or <strong>null</strong> but otherwise it performs new <code>Date</code> instance initialization on the this object.
</p>

<p>
The other issue is relatively minor and relates to how [[DatePrimiitveValue]] initialization is currently specified.  The ES5.1 spec. (<a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.3" class="urlextern" target="_blank" title="http://ecma-international.org/ecma-262/5.1/#sec-15.9.3" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">15.9.3.1-15.9.3.3</a>) simply says &ldquo;Set the [[DatePrimtiveValue]] internal property of the new constructed object to ...&rdquo;.  This statement might reasonably be interpreter as assuming that an (uninitialized) [[DatePrimitiveValue]] internal property already exits for the instance in light of the fact <a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.6" class="urlextern" target="_blank" title="http://ecma-international.org/ecma-262/5.1/#sec-15.9.6" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">15.9.6</a> says that all <code>Date</code> instance have that internal property. It the case of the <strong>super</strong> constructor call pattern, the [[DatePrimitiveValue]] internal property cannot be assumed to exist on the instance.  In the specification, this problem can be fixed simply by saying &ldquo;If a [[DatePrimitiveValue]] internal property does not exist create it&rdquo; prior to setting its value.  With these considerations, here is how the <code>Date</code> constructor called as a function (<a href="http://ecma-international.org/ecma-262/5.1/#sec-15.9.2" class="urlextern" target="_blank" title="http://ecma-international.org/ecma-262/5.1/#sec-15.9.2" onclick="return svchk()" onkeypress="return svchk()" rel="nofollow">15.9.2.1</a>) might be respecified  to  support subclassing: 
</p>
<ol>
<li class="level1"><div class="li"> If the <strong>this</strong> value is <strong>undefined</strong>, <strong>null</strong>, or the global object, then</div>
<ol>
<li class="level2"><div class="li"> NOTE This is the current ES5.1 behavior</div>
</li>
<li class="level2"><div class="li"> NOTE The global object is there in case any existing code does says: this.Date() at the global level to access Date</div>
</li>
<li class="level2"><div class="li"> A String is created and returned as-if by the expression: <code>(new Date).toString();</code></div>
</li>
</ol>
</li>
<li class="level1"><div class="li"> Let <em>obj</em> be ToObject(<strong>this</strong> value).</div>
</li>
<li class="level1"><div class="li"> If the [[Extensible]] internal property of <em>obj</em> is <strong>false</strong>, throw a TypeError exception. </div>
</li>
<li class="level1"><div class="li"> If <em>obj</em> already has a [[DatePrimitiveValue]] internal property, then return <em>obj</em>.  NOTE or maybe throw?</div>
</li>
<li class="level1"><div class="li"> Add a [[DatePrimitiveValue]] internal property to <em>obj</em>.</div>
</li>
<li class="level1"><div class="li"> Set the [[DatePrimitiveValue]] internal property of <em>obj</em> to the time value (UTC) identifying the current time.</div>
</li>
<li class="level1"><div class="li"> Return <em>obj</em>.</div>
</li>
</ol>

<p>
A technique similar to  the above is being used in the <a href="doku.php%3Fid=globalization:specification_drafts.html" class="wikilink1" title="globalization:specification_drafts" onclick="return svchk()" onkeypress="return svchk()">ECMAScript Internationalization API</a> to specify that the built-in objects defined by that specification are subclassable.
</p>

<p>
Lazy initialization is another alternative approach that can use for initializing subclass internal properties.  For example, the first reference to [[DatePrimitiveValue]] in each Date prototype method specification could be prefixed with a check that adds the [[DatePrimitiveValue]] internal property if it does not already exist.  For example, Date.prototype.setTime (time)  (15.9.5.27) might be respecified as: 
</p>
<ol>
<li class="level1"><div class="li"> Let <em>obj</em> be ToObject(<strong>this</strong> value).</div>
</li>
<li class="level1"><div class="li"> Let <em>v</em> be TimeClips(ToNumber(<em>time</em>)).</div>
</li>
<li class="level1"><div class="li"> If <em>obj</em> does not have a [[DatePrimitiveValue]] internal property, then</div>
<ol>
<li class="level2"><div class="li"> If the [[Extensible]] internal property of <em>obj</em> is <strong>false</strong>, throw a TypeError exception. </div>
</li>
<li class="level2"><div class="li"> Add a [[DatePrimitiveValue]] internal property to <em>obj</em>.</div>
</li>
</ol>
</li>
<li class="level1"><div class="li"> Set the [[DatePrimitiveValue]] internal property of <em>obj</em> to <em>v</em>.</div>
</li>
<li class="level1"><div class="li"> Return <em>v</em>.</div>
</li>
</ol>

<p>
   This eliminates the user requirement of having to invoke the superclass constructor on the subclass instance but at the apparent cost of having to explicitly check for the existence of [[DatePrimtivieValue]] in every method that accesses that internal property.  However, that test (or its equivalent) is needed regardless in order to ensure that such methods are not invoked on objects that that do not have that internal property.  
</p>

</div>

<a name="implementation_considerations_for_internal_data_properties"></a><h3>Implementation Considerations for Internal Data Properties</h3>
<div class="level3">

<p>
Both the super constructor invocation and the lazy initialization approach have a potentially significant impact upon implementations.  Both approaches assume that internal data properties such as [[DatePrimtiveValue]] can be dynamically added to an object at some arbitrary point in time after its initial creation.  This has not historically been a characteristic of ECMAScript internal properties.  For example, if an implementation has used a specific C++ object or struct type that includes a [[DatePrimtiiveValue]] field to represent Date objects, that implementation type probably needs to be identified at the time the object is actually created.  It may not be possible to dynamically change the object representation to a different struct because of size or other differences between object representations. 
</p>

<p>
Fortunately there is a way to represent internal data properties that can easily support their dynamic attachment to pre-existing objects.  All ECMAScript object are fundamentally capable of dynamically adding normal object properties.  A <a href="doku.php%3Fid=harmony:private_name_objects.html" class="wikilink1" title="harmony:private_name_objects" onclick="return svchk()" onkeypress="return svchk()">Private Name</a> is a unforgeable value that can be used as a property name.  Only code that knows a specific private name can access a normal object property whose key is that private name.  This suggests that a straightforward way to support dynamic addition of ECMAScript internal properties is to represent them as normal object properties that have Private Name keys. If the Private Names of such properties are only know to the implementations of built-in methods that reference the corresponding internal property then the Private Named properties will be invisible outside of those built-in methods, just as they would be if the internal property was represent using any other custom mechanism.
</p>

<p>
The potential of using Private Named properties as an implementation technique for internal properties raises the question of whether private named data properties could be completely eliminated from the ES specification and simply replaced with Private Named properties. This probably could be done.  But it isn&rsquo;t clear if there is any advantage of doing so, once it is understood that Private Name properties are a valid way for an implementation to represent internal properties.   Explicitly keeping internal properties of a specification device allows the Private Name implementation but also leaves open the possibility of implementations choosing other way of representing internal properties that don&rsquo;t depend upon conventional object property mechanisms. At the specification level, the key idea is that subclassing is enabled by treating internal data properties as &ldquo;expando&rdquo; properties, that is properties that can be dynamically added to instances.   
</p>

</div>

<a name="internal_methods"></a><h2>Internal Methods</h2>
<div class="level2">

<p>
In addition to internal data properties such as [[DatePrimitiveValue]] the ECMAScript specification also makes use of <em>internal method</em> properties. An internal method method is a procedure  that is internal to an object&rsquo;s implementation and which is only indirectly accessible from ECMAScript code.  An internal method can not be directly called. There a really two kinds of internal methods used within the ES5 specification. Some internal methods, such as the [[Match]] internal expression of RegExp objects are only referenced by other built-in methods of the same kind or closely related kinds of objects. We will call internal methods of this kind <em>private internal methods</em>. Core language features generally don&rsquo;t have any dependencies upon private internal methods. For this reason, they can be treated very similarly to internal data properties, they are simply internal state and can be represented as such.  In order for built-in objects that have <em>private internal methods</em> to be &ldquo;subclassable&rdquo; the private internal methods need to be represented as &ldquo;expando&rdquo; properties just as was described for internal data properties. They must be dynamically initialized, either by a super constructor invocation or lazily. They might be represented either using private name keyed properties or via an implementation level expando mechanism.  
</p>

<p>
The other kind of internal method properties are implementations of the nine &ldquo;common to all objects&rdquo; methods defined in Table 8 of the ES5 specification. These methods are directly tied to the semantics of core language features. For example, Array objects provide a unique [[DefineOwnProperty]] internal method that automatically updates the array&rsquo;s length property when new array elements are added beyond the current length. It also automatically deletes array elements  when the length property is decreased.
</p>

<p>
We call these nine internal methods the <em>essential internal methods</em>.  Every object must internally expose an implementation of the essential internal methods but not necessarily the same implementation.  It is the use of a non-inheritable essential internal methods that currently prevents the ES5 built-in Array &ldquo;class&rdquo; from being subclassed. This issue conceptually can be address in the same manner as internal data properties and private internal methods.  However, the dynamic attachment of specialized  essential internal methods probably has to be done via super constructor invocation rather than lazily.  The reason is because essential internal method innovation is triggered by the semantics of core language features so there is no place to trigger their delayed lazy initialization.  Also, because the implementation level mechanisms of the dynamic attachment for essential internal methods are likely to differ from  the &ldquo;expando&rdquo; mechanisms used for internal data properties and internal private method properties. Finally and particularly for the built-in Array &ldquo;class&rdquo;, implementations frequently apply various representation level optimizations to Array objects.  Depending upon the implementation, subclasses of Array might not share those optimizations and super constructor dynamic installation of essential internal methods might actually need to install different versions of those methods other than the ones that are used for optimized array representations.
</p>

</div>

<a name="function_subclasses"></a><h3>Function Subclasses</h3>
<div class="level3">

<p>
The other basic usage of internal methods and data properties is for Function objects. Such function objects are exception because of their direct connect to the execution mechanisms of the language.  Some of the Function internal properties are relatively routine internal data properties.  However, [[Call]] and [[Constructor]] are more similar to the essential internal methods.  From a usage perspective, the value of subclassing Function seems small if the only way to create a callable subclass instance is via a source code string passed to a constructor.  It may be that for ES6, we can reasonably defer addressing the issues of making Function subclassable.
</p>

</div>

<a name="making_subclassed_built-ins_useful"></a><h2>Making Subclassed Built-ins Useful</h2>
<div class="level2">

<p>
 This strawman only addresses how to make it technically possible to subclass built-in ECMAScript library objects.  Even after this is done, there remains a number of legacy specification issues that would limit the utility of such subclasses. For example, the <code>concat</code> method of Arrays is currently specified to always create a new instance of the built-in Array constructor.  So, use of it by a subclass of Array would yield an Array instance rather than a subclass instance. If subclassing of built-in is going to actually be useful, these sorts of issues also need to be addressed in the specifications.
</p>

<p>
A separate strawman addresses what has to be done in this regard:<a href="doku.php%3Fid=strawman:es5_internal_nominal_typing.html" class="wikilink1" title="strawman:es5_internal_nominal_typing" onclick="return svchk()" onkeypress="return svchk()">Cleanup/Generalize ES5 Internal Nominal Object Typing</a>.
</p>

</div>
<div class="footnotes">
<div class="fn"><a href="doku.php%3Fid=strawman:subclassable-builtins.html#fnt1" id="fn1" name="fn1" class="fn_bot">1)</a> 
The ES5.1 specification actually names this [[PrimitiveValue]] but the specification also uses that same name for other unrelated internal properties of other built-in objects. We add &ldquo;Date&rdquo; to the name to make it clear that we are specifically talking about the Date [PrimitiveValue]] property.</div>
</div>

<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/6/62eedadae81670b24e0124da871795ad.xhtml used -->
    <!-- wikipage stop -->
  </div>

  <div class="clearer">&nbsp;</div>

  
  <div class="stylefoot">

    <div class="meta">
      <div class="user">
              </div>
      <div class="doc">
        strawman/subclassable-builtins.txt &middot; Last modified: 2012/07/18 21:03 by rwaldron      </div>
    </div>

   
    <div class="bar" id="bar_bottom">
      <div class="bar-left" id="bar_bottomleft">
        <form class="button" method="post" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="edit" /><input type="hidden" name="rev" value="" /><input type="hidden" name="id" value="strawman:subclassable-builtins" /><input type="submit" value="Show pagesource" class="button" title="ALT+V" accesskey="v" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="revisions" /><input type="hidden" name="id" value="strawman:subclassable-builtins" /><input type="submit" value="Old revisions" class="button" title="ALT+O" accesskey="o" /></form>      </div>
      <div class="bar-right" id="bar_bottomright">
                        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="login" /><input type="hidden" name="id" value="strawman:subclassable-builtins" /><input type="submit" value="Login" class="button" /></form>        <form class="button" method="get" action="index.html" onsubmit="return svchk()"><input type="hidden" name="do" value="index" /><input type="hidden" name="id" value="strawman:subclassable-builtins" /><input type="submit" value="Index" class="button" title="ALT+X" accesskey="x" /></form>        <a href="doku.php%3Fid=strawman:subclassable-builtins.html#top"><input type="button" class="button" value="Back to top" onclick="window.scrollTo(0, 0)" /></a>&nbsp;
      </div>
    </div>

  </div>

</div>

<div align="center" class="footerinc">
  <a target="_blank" href="feed.php" title="Recent changes RSS feed"><img src="lib/tpl/default/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.0/" rel="license" title="Creative Commons License"><img src="lib/tpl/default/images/button-cc.gif" width="80" height="15" alt="Creative Commons License" border="0" /></a>

  <a target="_blank" href="https://www.paypal.com/xclick/business=andi%40splitbrain.org&amp;item_name=DokuWiki+Donation&amp;no_shipping=1&amp;no_note=1&amp;tax=0&amp;currency_code=EUR&amp;lc=US" title="Donate"><img src="lib/tpl/default/images/button-donate.gif" alt="Donate" border="0" /></a>

  <a target="_blank" href="http://www.php.net" title="Powered by PHP"><img src="lib/tpl/default/images/button-php.gif" width="80" height="15" alt="Powered by PHP" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="lib/tpl/default/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="lib/tpl/default/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="lib/tpl/default/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>



<!--

<rdf:RDF xmlns="http://web.resource.org/cc/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
<Work rdf:about="">
   <dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
   <license rdf:resource="http://creativecommons.org/licenses/by-nc-sa/2.0/" />
</Work>

<License rdf:about="http://creativecommons.org/licenses/by-nc-sa/2.0/">
   <permits rdf:resource="http://web.resource.org/cc/Reproduction" />
   <permits rdf:resource="http://web.resource.org/cc/Distribution" />
   <requires rdf:resource="http://web.resource.org/cc/Notice" />
   <requires rdf:resource="http://web.resource.org/cc/Attribution" />
   <prohibits rdf:resource="http://web.resource.org/cc/CommercialUse" />
   <permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" />
   <requires rdf:resource="http://web.resource.org/cc/ShareAlike" />
</License>

</rdf:RDF>

-->
</div>

<img src="lib/exe/indexer.php%3Fid=strawman%253Asubclassable-builtins&amp;1454275650" width="1" height="1" alt=""  /></body>
</html>
