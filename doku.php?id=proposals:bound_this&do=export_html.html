<html>
<head>
  <meta name="generator" content="DokuWiki Release 2005-09-22e" />
  <link rel="start" href="index.html" />
  <link rel="contents" href="doku.php%3Fid=proposals:bound_this&amp;do=index.html" title="" />
  <link rel="alternate" type="application/rss+xml" title="Recent Changes" href="feed.php" />
  <link rel="alternate" type="application/rss+xml" title="Current Namespace" href="feed.php%3Fmode=list&amp;ns=proposals" />
  <link rel="alternate" type="text/html" title="Plain HTML" href="doku.php%3Fid=proposals:bound_this&amp;do=export_html.html" />
  <link rel="alternate" type="text/plain" title="Wiki Markup" href="doku.php%3Fid=proposals:bound_this&amp;do=export_raw" />
  <link rel="stylesheet" media="screen" type="text/css" href="lib/styles/style.css" />
  <meta name="robots" content="noindex,nofollow" />
  <script language="javascript" type="text/javascript" charset="utf-8">
    var alertText   = 'Please enter the text you want to format.\nIt will be appended to the end of the document.'
    var notSavedYet = 'Unsaved changes will be lost.\nReally continue?'
    var DOKU_BASE   = '/'
  </script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/script.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/tw-sack.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/ajax.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domLib.js"></script>
  <script language="javascript" type="text/javascript" charset="utf-8" src="lib/scripts/domTT.js"></script>
  <link rel="stylesheet" type="text/css" href="lib/plugins/plugin/style.css" />
</head>
<body>
<div class="toc">
<div class="tocheader"> <script type="text/javascript">showTocToggle("+","-")</script>Table of Contents</div>
<div id="tocinside">
<ul class="toc">
<li class="clear"><ul class="toc">
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:bound_this&amp;do=export_html.html#motivation" class="toc">Motivation</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:bound_this&amp;do=export_html.html#syntax" class="toc">Syntax</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:bound_this&amp;do=export_html.html#examples" class="toc">Examples</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:bound_this&amp;do=export_html.html#semantics" class="toc">Semantics</a></span></li>
<li class="level2"><span class="li"><a href="doku.php%3Fid=proposals:bound_this&amp;do=export_html.html#typing" class="toc">Typing</a></span></li>
</ul>
</li>
<li class="level1"><span class="li"><a href="doku.php%3Fid=proposals:bound_this&amp;do=export_html.html#deprecatedalternative_syntactic_proposals" class="toc">Deprecated: Alternative Syntactic Proposals</a></span></li>
</ul>
</div>
</div>

<a name="motivation"></a><h2>Motivation</h2>
<div class="level2">

<p>
 Class methods have &ldquo;bound this&rdquo;, where <code>this</code> in the method body is always bound to the class instance from which the method was extracted, regardless of what <code>this</code> parameter is actually passed in to the method (the <code>this</code> parameter to the method is ignored).
</p>

<p>
Conversely, functions in structural objects use &ldquo;argument this&rdquo;, so the value of <code>this</code> in the function body is whatever object was the base of the reference by which the &ldquo;structural method&rdquo; was called.
</p>

<p>
In the absence of <a href="doku.php%3Fid=proposals:self_type.html" class="wikilink1" title="proposals:self_type" onclick="return svchk()" onkeypress="return svchk()">self types</a>, we have no good way to specify the type of the <code>this</code> parameter to a method in a structural object. That is, we cannot provide strong typing for &ldquo;argument this&rdquo;.
</p>

<p>
An alternative is to enable functions outside of classes to use &ldquo;bound this&rdquo;. This introduces less complexity than self types, and is analogous to the use of &ldquo;bound this&rdquo; in classes. &ldquo;bound this&rdquo; seems most useful in structural objects, but conceivably it could be used elsewhere too, and would always capture the current binding for <code>this</code>. 
</p>

</div>
<!-- SECTION [1-1054] -->
<a name="syntax"></a><h2>Syntax</h2>
<div class="level2">

<p>
 &ldquo;Bound this&rdquo; is achieved via the type-annotation-like syntax, where the first parameter binding in an parameter list is &ldquo;this:bound&rdquo;.   The <code>bound</code> pseudo-type annotation could be used in function type definitions, global functions, function expressions within object initialisers, etc. I.e., anywhere outside of the nominal type system (class and interface methods) where it is implied by default and allowed if redundantly declared.
</p>

</div>
<!-- SECTION [1055-1512] -->
<a name="examples"></a><h2>Examples</h2>
<div class="level2">
<pre class="code javascript"><span class="kw2">function</span> g<span class="br0">&#40;</span><span class="kw1">this</span>:bound, x:int<span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="kw1">this</span>.<span class="me1">x</span> = x; <span class="br0">&#125;</span>
&nbsp;
o = <span class="br0">&#123;</span> f: <span class="kw2">function</span> <span class="br0">&#40;</span><span class="kw1">this</span>:bound,...<span class="br0">&#41;</span> : ..., ... <span class="br0">&#125;</span>
&nbsp;
<span class="kw2">class</span> Counter <span class="br0">&#123;</span>
       <span class="kw2">var</span> c : int;
       <span class="kw2">function</span> inc<span class="br0">&#40;</span><span class="kw1">this</span>:bound<span class="br0">&#41;</span> : int <span class="br0">&#123;</span> c++; <span class="kw1">return</span> c; <span class="br0">&#125;</span>  <span class="co1">// redundant annotation</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">var</span> f : <span class="br0">&#40;</span><span class="kw2">function</span><span class="br0">&#40;</span><span class="kw1">this</span>:bound<span class="br0">&#41;</span> : int<span class="br0">&#41;</span>;
f = <span class="br0">&#40;</span><span class="kw2">new</span> Counter<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>.<span class="me1">inc</span>;</pre><pre class="code javascript">type IteratorType.&lt;T&gt; = <span class="br0">&#123;</span>next: <span class="kw2">function</span> <span class="br0">&#40;</span><span class="kw1">this</span>: bound<span class="br0">&#41;</span>: T<span class="br0">&#125;</span>;
&nbsp;
<span class="kw2">function</span> global_method<span class="br0">&#40;</span><span class="kw1">this</span>: bound<span class="br0">&#41;</span> ...
&nbsp;
<span class="me1">let</span> obj = <span class="br0">&#123;</span>meth: <span class="kw2">function</span> <span class="br0">&#40;</span><span class="kw1">this</span>: bound, args<span class="br0">&#41;</span> ...<span class="br0">&#125;</span>;</pre>
</div>
<!-- SECTION [1513-2026] -->
<a name="semantics"></a><h2>Semantics</h2>
<div class="level2">

<p>
 In value expressions, a bound-this function denoted via <code>this:bound</code> captures the current binding of the nearest enclosing initialiser&rsquo;s object (an <code>Object</code> or <code>Array</code>) when the function closure is created, stores that binding in the closure, and uses that binding when the function is later called. If the function is not expressed as the value of a property in an initialiser, the <code>this</code> binding in its lexical environment is used.
</p>

<p>
In type expressions, a bound-this function type captures the fact that function objects typed by the function type must bind this as if the objects were all defined or expressed with <code>this:bound</code> as their first formal parameter. Without use of <code>wrap</code> (<a href="doku.php%3Fid=clarification:runtime_types_and_conversions.html#solution_9write_barrier_with_deep_checking" class="wikilink1" title="clarification:runtime_types_and_conversions" onclick="return svchk()" onkeypress="return svchk()">solution 9 or 10</a>), attempts to type function objects having unbound-this with a bound-this type result in errors. Note that <code>like</code> is not enough for unbound-this function objects to match bound-this types.
</p>

<p>
The evaluation of the object &ldquo;o&rdquo; above therefore proceeds as follows: the object is allocated; a closure is created for the function &ldquo;f&rdquo; that binds &ldquo;this&rdquo; to the newly-allocated object; then the field &ldquo;f&rdquo; of the object is updated with that function closure.
</p>

<p>
&ldquo;this:bound&rdquo; is also permitted for functions inside classes and interfaces, but is redundant.  
</p>
<hr noshade="noshade" size="1" />

<p>
ES3: 
</p>
<pre class="code">var o = { x: this } </pre>

<p>
 yields a value for o.x that is never o.  Your proposal, according to the wording above, seems to break this, so the wording is probably off.
</p>

<p>
What I suspect we have is a system variable &ldquo;this-for-binding-bound-this&rdquo; that is set to the object being created when appropriate and which is otherwise the same as &ldquo;this&rdquo;; function creation that binds &ldquo;this&rdquo; picks this value up.  That variable can in turn be optimized away by the compiler, I think, but it may be good as a specification device.
</p>

<p>
What about this? 
</p>
<pre class="code">var o = [ function (this:bound) { ... } ]</pre>

<p>
 Is o the bound value of &ldquo;this&rdquo; inside o[0]?  If not, why not?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/09/27 15:23</em> 
</p>

<p>
Yes, <code>this:bound</code> should bind to the enclosing array initialiser as well as object initialiser. Fix attempted above, thanks.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/09/27 16:56</em>
</p>

<p>
In fact, ignoring type definitions for the moment, a related syntax would be something like this: 
</p>
<pre class="code">o = { x: function (this=o) { ... } }</pre>

<p>
 It&rsquo;s not compatible with ES3 either since o is updated as part of the assignment happening after object creation, so I&rsquo;m not proposing this as such, but the fact is that what&rsquo;s being proposed is really equivalent to 
</p>
<pre class="code">tmp = {}
tmp.x = function (this=tmp) { ... }
o = tmp</pre>

<p>
 And it may be that by implementing this more general syntax one may enable more general behaviors.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/09/27 15:36</em>
</p>

<p>
WRT the type definition, what does it mean, really? 
</p>
<pre class="code">type t = function (this:bound);</pre>

<p>
 Now what can I do with t?  Presumably it can be a constraint on a variable, say: 
</p>
<pre class="code">var v : t = ...;</pre>

<p>
 What does it constrain?  The type of the bound-this of the function being assigned?  The value of the bound-this?  The fact that the function must have a bound-this?
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x6c%3B%26%23x74%3B%26%23x68%3B%26%23x40%3B%26%23x61%3B%26%23x63%3B%26%23x6d%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x6c;&#x74;&#x68;&#x40;&#x61;&#x63;&#x6d;&#x2e;&#x6f;&#x72;&#x67;">Lars T Hansen</a> 2007/09/27 15:50</em>
</p>

<p>
The fact that the function must have bound-this. That necessarily constrains the type and in a checkable way, as far as I can tell.
</p>

<p>
Agreed that there may be a more general and straightforward syntax than <code>this:bound</code>. We should try to find it. It probably does not involve assignment since that has no correspondence in type expressions, and it seems to me we do want to be able to type bound-this functions more strongly than as &ldquo;self-this&rdquo;. I.e. we want the type system to help enforce this-binding for structural types as it does by default for nominal types.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x62%3B%26%23x72%3B%26%23x65%3B%26%23x6e%3B%26%23x64%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x6d%3B%26%23x6f%3B%26%23x7a%3B%26%23x69%3B%26%23x6c%3B%26%23x6c%3B%26%23x61%3B%26%23x2e%3B%26%23x6f%3B%26%23x72%3B%26%23x67%3B" class="mail" title="&#x62;&#x72;&#x65;&#x6e;&#x64;&#x61;&#x6e;&#x40;&#x6d;&#x6f;&#x7a;&#x69;&#x6c;&#x6c;&#x61;&#x2e;&#x6f;&#x72;&#x67;">Brendan Eich</a> 2007/09/27 16:56</em>
</p>

</div>
<!-- SECTION [2027-5924] -->
<a name="typing"></a><h2>Typing</h2>
<div class="level2">

<p>
 A &ldquo;bound this&rdquo; function is assigned a type that reflects its &ldquo;bound-this&rdquo; nature. For example: 
</p>
<pre class="code javascript">    <span class="kw2">function</span> <span class="br0">&#40;</span><span class="kw1">this</span>:bound, x:int<span class="br0">&#41;</span> : int <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="kw1">this</span>.<span class="me1">y</span>+x; <span class="br0">&#125;</span></pre>
<p>
 has type 
</p>
<pre class="code javascript">    <span class="kw2">function</span> <span class="br0">&#40;</span><span class="kw1">this</span>:bound, int<span class="br0">&#41;</span> : int</pre>
<p>
The only interesting subtyping rule is that the &ldquo;bound-this&rdquo; nature of a function can be hidden via subtyping, so that it looks like an &ldquo;argument-this&rdquo; function that accepts any kind of &ldquo;this&rdquo; argument. Thus, if we have 
</p>
<pre class="code javascript">    type T1 = <span class="kw2">function</span> <span class="br0">&#40;</span><span class="kw1">this</span>:bound, int<span class="br0">&#41;</span> : int;
    type T2 = <span class="kw2">function</span> <span class="br0">&#40;</span><span class="kw1">this</span>:*, int<span class="br0">&#41;</span> : int;</pre>
<p>
 then we have that <code>T1</code> is a subtype of <code>T2</code>. Hence, <code>T1</code> is also consistent with <code>T2</code>.
</p>

<p>
An interesting question is whether <code>T2</code> is consistent with <code>T1</code>, and more generally, if an untyped function should be considered <code>like T1</code>.
</p>

</div>
<!-- SECTION [5925-6779] -->
<a name="deprecatedalternative_syntactic_proposals"></a><h1>Deprecated: Alternative Syntactic Proposals</h1>
<div class="level1">

<p>
 Since strong typing for structural objects seems to require bound-this, the syntax <code>this:bound,</code> might be used on very many functions, so perhaps a lighter-weight syntax would be preferable. One backward-compatible alternative is: 
</p>
<pre class="code javascript">   o = <span class="br0">&#123;</span> f: <span class="kw2">function</span> <span class="br0">&#40;</span>,...<span class="br0">&#41;</span> : ..., ... <span class="br0">&#125;</span></pre>
<p>
 Could we use the &ldquo;method&rdquo; keyword instead?
</p>

<p>
Also, bound-this is really a property of the function&rsquo;s implementation rather than its interface, although it does imply that the function can accept any <code>this</code> argument (which is then ignored), so including <code>this:bound</code> in function types (eg see below) is strange but perhaps ok.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x63%3B%26%23x6f%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x63%3B%26%23x40%3B%26%23x73%3B%26%23x6f%3B%26%23x65%3B%26%23x2e%3B%26%23x75%3B%26%23x63%3B%26%23x73%3B%26%23x63%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x63;&#x6f;&#x72;&#x6d;&#x61;&#x63;&#x40;&#x73;&#x6f;&#x65;&#x2e;&#x75;&#x63;&#x73;&#x63;&#x2e;&#x65;&#x64;&#x75;">Cormac Flanagan</a> 2007/09/14 21:07</em>
</p>

<p>
An alternative syntactic proposal: <code>method</code> means bound this but <code>function</code> is still bound-this in a class context.
</p>
<pre class="code javascript"><span class="kw2">class</span> Foo <span class="br0">&#123;</span>
    <span class="kw2">function</span> f<span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span>  <span class="co1">// same thing</span>
    method f<span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span>    <span class="co1">// same thing</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw2">var</span> obj = <span class="br0">&#123;</span> f: method<span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span> <span class="br0">&#125;</span> <span class="co1">// bound this</span>
<span class="kw2">var</span> obj = <span class="br0">&#123;</span> f: <span class="kw2">function</span><span class="br0">&#40;</span>x<span class="br0">&#41;</span> <span class="br0">&#123;</span> ... <span class="br0">&#125;</span> <span class="br0">&#125;</span> <span class="co1">// argument this</span></pre>
<p>
Reactions: <code>method</code> seems like a pretty heavyweight syntax/vocabulary change.
</p>

<p>
 &mdash; <em><a href="mailto:%26%23x64%3B%26%23x68%3B%26%23x65%3B%26%23x72%3B%26%23x6d%3B%26%23x61%3B%26%23x6e%3B%26%23x40%3B%26%23x63%3B%26%23x63%3B%26%23x73%3B%26%23x2e%3B%26%23x6e%3B%26%23x65%3B%26%23x75%3B%26%23x2e%3B%26%23x65%3B%26%23x64%3B%26%23x75%3B" class="mail" title="&#x64;&#x68;&#x65;&#x72;&#x6d;&#x61;&#x6e;&#x40;&#x63;&#x63;&#x73;&#x2e;&#x6e;&#x65;&#x75;&#x2e;&#x65;&#x64;&#x75;">Dave Herman</a> 2007/09/18 17:56</em> 
</p>

</div>
<!-- SECTION [6780-] -->
<!-- cachefile /usr/local/www/es-lang.org/wiki/data/cache/a/aeceb4e204ca348b8f6f9d6398f656ef.xhtml used -->
</body>
</html>
